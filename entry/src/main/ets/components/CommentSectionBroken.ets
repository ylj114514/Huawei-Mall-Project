import { Comment } from '../model/DataModel'
import { CommentService } from '../services/CommentService'

@Component
export struct CommentSectionSimple {
  @Prop productId: string
  @State comments: Comment[] = []
  @State isLoading: boolean = true
  @State currentPage: number = 1
  @State hasMore: boolean = true
  @State showWriteComment: boolean = false
  @State rating: number = 0
  @State commentContent: string = ''
  private commentService: CommentService = CommentService.getInstance()

  aboutToAppear() {
    this.loadComments()
  }

  private async loadComments(): Promise<void> {
    try {
      this.isLoading = true
      this.comments = this.commentService.getProductComments(this.productId, this.currentPage)
      // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÊõ¥Â§öÊï∞ÊçÆ
      const totalCount = this.commentService.getProductCommentCount(this.productId)
      this.hasMore = this.currentPage * 10 < totalCount
      this.isLoading = false
    } catch (error) {
      console.error('Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•:', error)
      this.isLoading = false
    }
  }

  private async loadMoreComments(): Promise<void> {
    if (this.isLoading || !this.hasMore) return

    try {
      this.isLoading = true
      this.currentPage++
      const moreComments = this.commentService.getProductComments(this.productId, this.currentPage)
      this.comments = [...this.comments, ...moreComments]

      const totalCount = this.commentService.getProductCommentCount(this.productId)
      this.hasMore = this.currentPage * 10 < totalCount
      this.isLoading = false
    } catch (error) {
      console.error('Âä†ËΩΩÊõ¥Â§öËØÑËÆ∫Â§±Ë¥•:', error)
      this.isLoading = false
    }
  }

  private async submitComment(): Promise<void> {
    if (this.rating === 0 || this.commentContent.trim() === '') {
      console.error('ËØ∑ËØÑÂàÜÂπ∂Â°´ÂÜôËØÑËÆ∫ÂÜÖÂÆπ')
      return
    }

    try {
      const newComment = new Comment(
        this.productId,
        'current_user', // ÂÆûÈôÖÈ°πÁõÆ‰∏≠Â∫îËØ•‰ªéÁî®Êà∑ÊúçÂä°Ëé∑Âèñ
        'ÂΩìÂâçÁî®Êà∑',
        this.rating,
        this.commentContent.trim()
      )

      const success = await this.commentService.addComment(newComment)
      if (success) {
        // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫
        this.currentPage = 1
        this.comments = this.commentService.getProductComments(this.productId, this.currentPage)
        this.showWriteComment = false
        this.rating = 0
        this.commentContent = ''
      }
    } catch (error) {
      console.error('Êèê‰∫§ËØÑËÆ∫Â§±Ë¥•:', error)
    }
  }

  build() {
    Column() {
      // ËØÑËÆ∫ÁªüËÆ°
      CommentStats({ productId: this.productId })

      // ÂÜôËØÑËÆ∫ÊåâÈíÆ
      Button('ÂÜôËØÑËÆ∫')
        .width('100%')
        .height(44)
        .fontSize(16)
        .backgroundColor($r('app.color.primary'))
        .margin({ left: 16, right: 16, top: 16, bottom: 8 })
        .onClick(() => {
          this.showWriteComment = true
        })

      // ËØÑËÆ∫ÂàóË°®
      if (this.comments.length === 0 && !this.isLoading) {
        Column() {
          Text('üí¨')
            .fontSize(60)
            .margin({ bottom: 16 })
          Text('ÊöÇÊó†ËØÑËÆ∫')
            .fontSize(16)
            .fontColor($r('app.color.text_secondary'))
            .margin({ bottom: 8 })
          Text('Âø´Êù•ÂèëË°®Á¨¨‰∏ÄÊù°ËØÑËÆ∫Âêß')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
        }
        .width('100%')
        .padding(32)
        .justifyContent(FlexAlign.Center)
      } else {
        List() {
          ForEach(this.comments, (comment: Comment) => {
            ListItem() {
              CommentCard({
                comment: comment,
                onLike: (): void => this.commentService.toggleLike(comment.id, 'current_user')
              })
            }
          })
        }
        .width('100%')
        .layoutWeight(1)

        // Âä†ËΩΩÊõ¥Â§ö
        if (this.hasMore) {
          Button('Âä†ËΩΩÊõ¥Â§ö')
            .width('100%')
            .height(44)
            .fontSize(14)
            .backgroundColor(Color.Transparent)
            .fontColor($r('app.color.primary'))
            .onClick(() => this.loadMoreComments())
        }
      }
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor($r('app.color.background'))

    // ÂÜôËØÑËÆ∫ÂºπÁ™ó
    if (this.showWriteComment) {
      WriteCommentDialog({
        visible: this.showWriteComment,
        rating: this.rating,
        content: this.commentContent,
        onRatingChange: (rating: number): void => {
          this.rating = rating
        },
        onContentChange: (content: string): void => {
          this.commentContent = content
        },
        onSubmit: (): void => this.submitComment(),
        onCancel: (): void => {
          this.showWriteComment = false
          this.rating = 0
          this.commentContent = ''
        }
      })
    }
  }
}

// ËØÑËÆ∫ÁªüËÆ°ÁªÑ‰ª∂
@Component
struct CommentStats {
  @Prop productId: string
  private commentService: CommentService = CommentService.getInstance()

  build() {
    Column() {
      Row() {
        Column() {
          Row() {
            Text('‚≠ê')
              .fontSize(20)
            Text('4.8')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
            Text('ÂàÜ')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
          }
          Text('1286Êù°ËØÑ‰ª∑')
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
        }

        Blank()

        // ËØÑÂàÜÂàÜÂ∏É
        Column() {
          ForEach([5, 4, 3, 2, 1], (star: number) => {
            Row() {
              Text(`${star}Êòü`)
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
                .width(30)

              // ËøõÂ∫¶Êù°
              Progress({
                value: this.getStarPercentage(star),
                total: 100,
                type: ProgressType.Linear
              })
                .width(100)
                .height(6)
                .color($r('app.color.primary'))
                .backgroundColor($r('app.color.background'))

              Text(`${this.getStarCount(star)}`)
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
                .width(30)
                .textAlign(TextAlign.End)
            }
            .width('100%')
            .margin({ bottom: 4 })
          })
        }
        .width(180)
      }
      .width('100%')
      .padding(16)
      .backgroundColor($r('app.color.white'))
      .borderRadius(8)
      .margin(16)
    }
  }

  private getStarCount(star: number): number {
    const result = this.commentService.calculateProductRating(this.productId)
    if (star >= 1 && star <= 5) {
      return result.distribution[star - 1] || 0
    }
    return 0
  }

  private getStarPercentage(star: number): number {
    const totalCount = this.commentService.getProductCommentCount(this.productId)
    if (totalCount === 0) return 0
    const starCount = this.getStarCount(star)
    return Math.round((starCount / totalCount) * 100)
  }
}

// ËØÑËÆ∫Âç°ÁâáÁªÑ‰ª∂
@Component
struct CommentCard {
  @Prop comment: Comment
  onLike: () => void = () => {}

  build() {
    Column() {
      Row() {
        // Áî®Êà∑Â§¥ÂÉè
        Text('üë§')
          .fontSize(40)
          .margin({ right: 12 })

        Column() {
          Row() {
            Text(this.comment.username)
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))

            if (this.comment.isTopComment) {
              Text('ÁΩÆÈ°∂')
                .fontSize(10)
                .fontColor($r('app.color.primary'))
                .backgroundColor($r('app.color.primary_light'))
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .borderRadius(4)
                .margin({ left: 8 })
            }

            Blank()

            Text(this.comment.getFormattedTime())
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
          }
          .width('100%')

          // ËØÑÂàÜ
          Row() {
            ForEach([1, 2, 3, 4, 5], (star: number) => {
              Text(star <= this.comment.rating ? '‚òÖ' : '‚òÜ')
                .fontSize(12)
                .fontColor(star <= this.comment.rating ? $r('app.color.primary') : $r('app.color.text_secondary'))
            })
          }
          .width('100%')
          .margin({ top: 4 })
        }
        .layoutWeight(1)
      }
      .width('100%')

      // ËØÑËÆ∫ÂÜÖÂÆπ
      Text(this.comment.content)
        .fontSize(14)
        .fontColor($r('app.color.text_primary'))
        .lineHeight(20)
        .width('100%')
        .margin({ top: 12 })

      // Â∫ïÈÉ®Êìç‰ΩúÊ†è
      Row() {
        Button() {
          Row() {
            Text(this.comment.isLiked ? '‚ù§Ô∏è' : 'ü§ç')
              .fontSize(16)
            Text(this.comment.likes.toString())
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .margin({ left: 4 })
          }
        }
        .height(32)
        .backgroundColor(Color.Transparent)
        .onClick(() => this.onLike())

        Blank()

        Button() {
          Row() {
            Text('üí¨')
              .fontSize(16)
            Text('ÂõûÂ§ç')
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .margin({ left: 4 })
          }
        }
        .height(32)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          // ÂõûÂ§çÂäüËÉΩ
        })
      }
      .width('100%')
      .margin({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.white'))
    .borderRadius(8)
    .margin({ left: 16, right: 16, bottom: 8 })
  }
}

// ÂÜôËØÑËÆ∫ÂºπÁ™óÁªÑ‰ª∂
@Component
struct WriteCommentDialog {
  @Prop visible: boolean
  @Prop rating: number
  @Prop content: string
  onRatingChange: (rating: number) => void = () => {}
  onContentChange: (content: string) => void = () => {}
  onSubmit: () => void = () => {}
  onCancel: () => void = () => {}

  build() {
    if (this.visible) {
      Column() {
        // ÈÅÆÁΩ©Â±Ç
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.5)')
          .onClick(() => this.onCancel())

        // ÂºπÁ™óÂÜÖÂÆπ
        Column() {
          Text('ÂÜôËØÑËÆ∫')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .width('100%')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 24 })

          // ËØÑÂàÜÈÄâÊã©
          Text('ËØÑÂàÜ')
            .fontSize(14)
            .fontColor($r('app.color.text_primary'))
            .width('100%')
            .margin({ bottom: 12 })

          Row() {
            ForEach([1, 2, 3, 4, 5], (star: number) => {
              Text(star <= this.rating ? '‚òÖ' : '‚òÜ')
                .fontSize(32)
                .fontColor(star <= this.rating ? $r('app.color.primary') : $r('app.color.text_secondary'))
                .margin({ right: 8 })
                .onClick(() => this.onRatingChange(star))
            })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .margin({ bottom: 24 })

          // ËØÑËÆ∫ÂÜÖÂÆπ
          Text('ËØÑËÆ∫ÂÜÖÂÆπ')
            .fontSize(14)
            .fontColor($r('app.color.text_primary'))
            .width('100%')
            .margin({ bottom: 12 })

          TextArea({
            placeholder: 'ÂàÜ‰∫´ÊÇ®ÁöÑ‰ΩøÁî®ÊÑüÂèó...',
            text: this.content
          })
            .width('100%')
            .height(120)
            .fontSize(14)
            .backgroundColor($r('app.color.background'))
            .borderRadius(8)
            .padding(12)
            .onChange((value: string) => this.onContentChange(value))

          // ÊåâÈíÆ
          Row() {
            Button('ÂèñÊ∂à')
              .height(44)
              .fontSize(16)
              .backgroundColor($r('app.color.background'))
              .fontColor($r('app.color.text_primary'))
              .layoutWeight(1)
              .margin({ right: 8 })
              .onClick(() => this.onCancel())

            Button('Êèê‰∫§')
              .height(44)
              .fontSize(16)
              .backgroundColor($r('app.color.primary'))
              .fontColor(Color.White)
              .layoutWeight(1)
              .margin({ left: 8 })
              .onClick(() => this.onSubmit())
          }
          .width('100%')
          .margin({ top: 24 })
        }
        .width(320)
        .backgroundColor($r('app.color.white'))
        .borderRadius(12)
        .padding(24)
        .position({ x: '50%', y: '50%' })
        .translate({ x: '-50%', y: '-50%' })
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
    }
  }
}