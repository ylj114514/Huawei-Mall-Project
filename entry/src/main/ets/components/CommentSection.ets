import promptAction from '@ohos.promptAction'

// ==========================================
// 1. Êú¨Âú∞ÂÆö‰πâÊï∞ÊçÆÊ®°Âûã (Á°Æ‰øùÂåÖÂê´ images Âíå isLiked)
// ==========================================
class Comment {
  id: string
  productId: string
  userId: string
  username: string
  rating: number
  content: string
  timestamp: number
  likes: number
  isLiked: boolean // UIÈúÄË¶ÅÁöÑÂ≠óÊÆµ
  images: string[] // UIÈúÄË¶ÅÁöÑÂ≠óÊÆµ

  constructor(productId: string, userId: string, username: string, rating: number, content: string, images: string[] = []) {
    this.id = Date.now().toString() + Math.floor(Math.random() * 1000)
    this.productId = productId
    this.userId = userId
    this.username = username
    this.rating = rating
    this.content = content
    this.timestamp = Date.now()
    this.likes = 0
    this.isLiked = false
    this.images = images
  }

  getFormattedTime(): string {
    const date = new Date(this.timestamp)
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`
  }
}

// ==========================================
// 2. Êú¨Âú∞Ê®°ÊãüÊúçÂä° (ÂåÖÂê´ÂõæÁâáÊï∞ÊçÆÁöÑ Mock)
// ==========================================
class CommentService {
  private static instance: CommentService
  private comments: Comment[] = []

  private constructor() {
    this.initMockData()
  }

  public static getInstance(): CommentService {
    if (!CommentService.instance) {
      CommentService.instance = new CommentService()
    }
    return CommentService.instance
  }

  private initMockData() {
    // Ê®°ÊãüÂ∏¶ÂõæÁâáÂíå‰∏çÂ∏¶ÂõæÁâáÁöÑÊï∞ÊçÆ
    this.comments = [
      new Comment('1', 'u1', 'Âº†‰∏â', 5, 'ÊâãÊú∫ÈùûÂ∏∏Â•ΩÁî®ÔºåÊãçÁÖßÊ∏ÖÊô∞ÔºÅ', [
        'https://img.alicdn.com/imgextra/i2/O1CN015k5k5k1k5k5k5k5k5_!!0-item_pic.jpg_468x468q75.jpg_.webp',
        'https://img.alicdn.com/imgextra/i4/O1CN015k5k5k1k5k5k5k5k5_!!0-item_pic.jpg_468x468q75.jpg_.webp'
      ]),
      new Comment('1', 'u2', 'ÊùéÂõõ', 4, 'Áâ©ÊµÅÂæàÂø´ÔºåÂåÖË£ÖÂÆåÂ•Ω„ÄÇ', []),
      new Comment('1', 'u3', 'Áéã‰∫î', 5, 'ÈÅ•ÈÅ•È¢ÜÂÖàÔºÅÈ∏øËíôÁ≥ªÁªüÂæàÊµÅÁïÖ„ÄÇ', []),
      new Comment('1', 'u4', 'ËµµÂÖ≠', 3, 'ÊÑüËßâ‰∏ÄËà¨Ëà¨ÂêßÔºåÊ≤°ÊúâÊÉ≥Ë±°‰∏≠ÈÇ£‰πàÊÉäËâ≥„ÄÇ', []),
      new Comment('1', 'u5', 'Áî®Êà∑888', 5, 'Âº∫ÁÉàÊé®ËçêÔºåÊÄß‰ª∑ÊØîÂæàÈ´ò„ÄÇ', []),
      new Comment('1', 'u6', 'ÊµãËØïÂè∑', 4, 'Ëøò‰∏çÈîôÔºåÁªô‰∏™Â•ΩËØÑ„ÄÇ', [])
    ]
    // Ê®°Êãü‰∏Ä‰∫õÂàùÂßãÁÇπËµûÊï∞
    this.comments[0].likes = 12
    this.comments[2].likes = 5
  }

  // ÂàÜÈ°µËé∑ÂèñËØÑËÆ∫
  getProductComments(productId: string, page: number = 1): Comment[] {
    const pageSize = 10
    const startIndex = (page - 1) * pageSize
    // ÁÆÄÂçïÊ®°ÊãüÔºöÂÆûÈôÖÂ∫îÊ†πÊçÆ productId Á≠õÈÄâ
    return this.comments.slice(startIndex, startIndex + pageSize)
  }

  getProductCommentCount(productId: string): number {
    return this.comments.length
  }

  addComment(comment: Comment): boolean {
    this.comments.unshift(comment)
    return true
  }

  toggleLike(commentId: string): void {
    const comment = this.comments.find(c => c.id === commentId)
    if (comment) {
      comment.isLiked = !comment.isLiked
      comment.likes = comment.isLiked ? comment.likes + 1 : comment.likes - 1
    }
  }
}

// ==========================================
// 3. ÁªÑ‰ª∂ UI
// ==========================================
@Component
export struct CommentSection {
  @Prop productId: string
  @State comments: Comment[] = []
  @State isLoading: boolean = true
  @State currentPage: number = 1
  @State hasMore: boolean = true
  @State showWriteComment: boolean = false
  @State rating: number = 0
  @State commentContent: string = ''
  private commentService: CommentService = CommentService.getInstance()

  aboutToAppear() {
    this.loadComments()
  }

  private loadComments(): void {
    this.isLoading = true
    // Ê®°ÊãüÁΩëÁªúÂª∂Ëøü
    setTimeout(() => {
      this.comments = this.commentService.getProductComments(this.productId, this.currentPage)
      const totalCount = this.commentService.getProductCommentCount(this.productId)
      this.hasMore = this.comments.length < totalCount
      this.isLoading = false
    }, 500)
  }

  private loadMoreComments(): void {
    if (this.isLoading || !this.hasMore) return

    this.isLoading = true
    setTimeout(() => {
      this.currentPage++
      const moreComments = this.commentService.getProductComments(this.productId, this.currentPage)
      this.comments = [...this.comments, ...moreComments]

      const totalCount = this.commentService.getProductCommentCount(this.productId)
      this.hasMore = this.comments.length < totalCount
      this.isLoading = false
    }, 500)
  }

  private submitComment(): void {
    if (this.rating === 0 || this.commentContent.trim() === '') {
      promptAction.showToast({ message: 'ËØ∑ËØÑÂàÜÂπ∂Â°´ÂÜôËØÑËÆ∫ÂÜÖÂÆπ' })
      return
    }

    const newComment = new Comment(
      this.productId,
      'current_user',
      'Êàë', // ÂΩìÂâçÁî®Êà∑
      this.rating,
      this.commentContent.trim()
    )

    const success = this.commentService.addComment(newComment)
    if (success) {
      this.currentPage = 1
      // ÈáçÊñ∞Âä†ËΩΩÁ¨¨‰∏ÄÈ°µ
      this.comments = this.commentService.getProductComments(this.productId, 1)
      this.showWriteComment = false
      this.rating = 0
      this.commentContent = ''
      promptAction.showToast({ message: 'ËØÑËÆ∫ÂèëÂ∏ÉÊàêÂäü' })
    }
  }

  // ÂàáÊç¢ÁÇπËµûÁä∂ÊÄÅ
  private handleToggleLike(comment: Comment) {
    this.commentService.toggleLike(comment.id)
    // Âº∫Âà∂Âà∑Êñ∞ÂàóË°®Áä∂ÊÄÅ (ArkUI State Êõ¥Êñ∞Êú∫Âà∂)
    const index = this.comments.findIndex(c => c.id === comment.id)
    if (index !== -1) {
      // ÂàõÂª∫Êñ∞ÂØπË±°Ëß¶Âèë UI Êõ¥Êñ∞
      let updatedComment = this.comments[index]
      this.comments[index] = new Comment(
        updatedComment.productId,
        updatedComment.userId,
        updatedComment.username,
        updatedComment.rating,
        updatedComment.content,
        updatedComment.images
      )
      // ÊÅ¢Â§çÂ±ûÊÄß
      this.comments[index].id = updatedComment.id
      this.comments[index].timestamp = updatedComment.timestamp
      this.comments[index].likes = updatedComment.likes
      this.comments[index].isLiked = updatedComment.isLiked
    }
  }

  build() {
    Column() {
      // ËØÑËÆ∫ÁªüËÆ°
      Column() {
        Text('ÂïÜÂìÅËØÑ‰ª∑')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .width('100%')
          .margin({ bottom: 12 })

        Row() {
          Text('‚≠ê 4.8ÂàÜ')
            .fontSize(16)
            .fontColor($r('app.color.text_primary'))
          Text(`(${this.commentService.getProductCommentCount(this.productId)}Êù°ËØÑ‰ª∑)`)
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
            .margin({ left: 8 })
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
      }
      .width('100%')
      .padding(16)
      .backgroundColor($r('app.color.white'))
      .borderRadius(8)
      .margin({ left: 16, right: 16, top: 16, bottom: 8 })

      // ÂÜôËØÑËÆ∫ÊåâÈíÆ
      Button('ÂÜôËØÑËÆ∫')
        .width('90%')
        .height(44)
        .fontSize(16)
        .backgroundColor($r('app.color.primary'))
        .margin({ bottom: 16 })
        .onClick(() => {
          this.showWriteComment = true
        })

      // ËØÑËÆ∫ÂàóË°®ÂÆπÂô®
      Column() {
        if (this.comments.length === 0 && !this.isLoading) {
          Column() {
            Text('üí¨')
              .fontSize(60)
              .margin({ bottom: 16 })
            Text('ÊöÇÊó†ËØÑËÆ∫')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 8 })
            Text('Âø´Êù•ÂèëË°®Á¨¨‰∏ÄÊù°ËØÑËÆ∫Âêß')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
          }
          .width('100%')
          .padding(32)
          .justifyContent(FlexAlign.Center)
        } else {
          List({ space: 8 }) {
            ForEach(this.comments, (comment: Comment) => {
              ListItem() {
                Column() {
                  Row() {
                    Text('üë§')
                      .fontSize(40)
                      .margin({ right: 12 })

                    Column() {
                      Row() {
                        Text(comment.username)
                          .fontSize(14)
                          .fontWeight(FontWeight.Medium)
                          .fontColor($r('app.color.text_primary'))

                        Text(comment.getFormattedTime())
                          .fontSize(12)
                          .fontColor($r('app.color.text_secondary'))
                          .margin({ left: 8 })
                      }
                      .width('100%')

                      Row() {
                        ForEach([1, 2, 3, 4, 5], (star: number) => {
                          Text(star <= comment.rating ? '‚òÖ' : '‚òÜ')
                            .fontSize(12)
                            .fontColor(star <= comment.rating ? $r('app.color.primary') : $r('app.color.text_secondary'))
                        })
                      }
                      .width('100%')
                      .margin({ top: 4 })
                    }
                    .layoutWeight(1)
                  }
                  .width('100%')

                  // ËØÑËÆ∫ÂÜÖÂÆπ
                  Text(comment.content)
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                    .lineHeight(20)
                    .width('100%')
                    .margin({ top: 12 })

                  // ËØÑËÆ∫ÂõæÁâáÔºàÂ¶ÇÊûúÊúâÔºâ
                  if (comment.images && comment.images.length > 0) {
                    Row() {
                      ForEach(comment.images.slice(0, 3), (image: string) => {
                        Image(image)
                          .width(80)
                          .height(80)
                          .borderRadius(4)
                          .objectFit(ImageFit.Cover)
                          .backgroundColor('#F5F5F5') // Âç†‰ΩçËÉåÊôØËâ≤
                          .margin({ right: 8 })
                      })
                    }
                    .width('100%')
                    .margin({ top: 8 })
                  }

                  // Â∫ïÈÉ®Êìç‰ΩúÊ†è
                  Row() {
                    Button() {
                      Row() {
                        Text(comment.isLiked ? '‚ù§Ô∏è' : 'ü§ç')
                          .fontSize(14)
                        Text(comment.likes > 0 ? comment.likes.toString() : 'ÁÇπËµû')
                          .fontSize(12)
                          .fontColor($r('app.color.text_secondary'))
                          .margin({ left: 4 })
                      }
                    }
                    .height(28)
                    .backgroundColor(Color.Transparent)
                    .onClick(() => {
                      this.handleToggleLike(comment)
                    })

                    Blank()

                    Text('ÂõûÂ§ç')
                      .fontSize(12)
                      .fontColor($r('app.color.text_secondary'))
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.SpaceBetween)
                  .alignItems(VerticalAlign.Center)
                  .margin({ top: 8, bottom: 4 })
                }
                .width('100%')
                .padding(16)
                .backgroundColor($r('app.color.white'))
                .borderRadius(8)
                .margin({ left: 16, right: 16, bottom: 12 })
              }
            }, (item: Comment) => item.id) // Ê∑ªÂä† Key ÁîüÊàêÂô®‰ºòÂåñÊÄßËÉΩ
          }
          .width('100%')
          .height('100%')
          .scrollBar(BarState.Auto)
          .edgeEffect(EdgeEffect.Spring)
          .divider({ strokeWidth: 1, color: '#F0F0F0' })

          // Âä†ËΩΩÊõ¥Â§öÊåâÈíÆ
          if (this.hasMore) {
            Button('Âä†ËΩΩÊõ¥Â§ö')
              .width('100%')
              .height(44)
              .fontSize(14)
              .backgroundColor(Color.Transparent)
              .fontColor($r('app.color.primary'))
              .onClick(() => this.loadMoreComments())
              .margin({ bottom: 20 })
          } else if (this.comments.length > 0) {
            Text('Ê≤°ÊúâÊõ¥Â§öËØÑËÆ∫‰∫Ü')
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 10, bottom: 20 })
          }
        }
      }
      .width('100%')
      .layoutWeight(1)
      // ËÆæÁΩÆÊúÄÂ∞èÈ´òÂ∫¶ÔºåÈò≤Ê≠¢ÂÜÖÂÆπÂ∞ëÊó∂Â°åÈô∑
      .constraintSize({ minHeight: 300 })

      // ÂÜôËØÑËÆ∫ÂºπÁ™ó (Ê®°ÊÄÅÂ±Ç)
      if (this.showWriteComment) {
        Stack() {
          // ÈÅÆÁΩ©Â±Ç
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.showWriteComment = false
            })

          // ÂºπÁ™óÂÜÖÂÆπ
          Column() {
            Text('ÂÜôËØÑËÆ∫')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .width('100%')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 24 })

            // ËØÑÂàÜÈÄâÊã©
            Text('ËØÑÂàÜ')
              .fontSize(14)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .margin({ bottom: 12 })

            Row() {
              ForEach([1, 2, 3, 4, 5], (star: number) => {
                Text(star <= this.rating ? '‚òÖ' : '‚òÜ')
                  .fontSize(32)
                  .fontColor(star <= this.rating ? $r('app.color.primary') : $r('app.color.text_secondary'))
                  .margin({ right: 8 })
                  .onClick(() => {
                    this.rating = star
                  })
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ bottom: 24 })

            // ËØÑËÆ∫ÂÜÖÂÆπ
            Text('ËØÑËÆ∫ÂÜÖÂÆπ')
              .fontSize(14)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .margin({ bottom: 12 })

            TextArea({
              placeholder: 'ÂàÜ‰∫´ÊÇ®ÁöÑ‰ΩøÁî®ÊÑüÂèó...',
              text: this.commentContent
            })
              .width('100%')
              .height(120)
              .fontSize(14)
              .backgroundColor($r('app.color.background'))
              .borderRadius(8)
              .padding(12)
              .onChange((value: string) => {
                this.commentContent = value
              })

            // ÊåâÈíÆ
            Row() {
              Button('ÂèñÊ∂à')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.background'))
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.showWriteComment = false
                })

              Button('Êèê‰∫§')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => {
                  this.submitComment()
                })
            }
            .width('100%')
            .margin({ top: 24 })
          }
          .width('85%')
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .padding(24)
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(999) // Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç
        .alignContent(Alignment.Center)
      }
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor($r('app.color.background'))
  }
}