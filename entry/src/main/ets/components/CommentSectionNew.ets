import { Comment } from '../model/DataModel'
import { CommentService } from '../services/CommentService'
import { StorageManager } from '../utils/StorageManager'

@Component
export struct CommentSectionNew {
  @Prop productId: string
  @State comments: Comment[] = []
  @State isLoading: boolean = true
  @State currentPage: number = 1
  @State hasMore: boolean = true
  @State showWriteComment: boolean = false
  @State rating: number = 0
  @State commentContent: string = ''
  @State currentUserId: string = ''
  @State currentUsername: string = ''
  @State showReplyDialog: boolean = false
  @State replyingToComment: Comment | null = null
  @State replyContent: string = ''
  private commentService: CommentService = CommentService.getInstance()
  private storage: StorageManager = StorageManager.getInstance()

  aboutToAppear() {
    this.loadCurrentUser()
    this.loadComments()
  }

  private async loadCurrentUser(): Promise<void> {
    try {
      const user = await this.storage.loadUser()
      if (user) {
        this.currentUserId = user.username
        this.currentUsername = user.username
      } else {
        // æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼
        this.currentUserId = 'current_user'
        this.currentUsername = 'å½“å‰ç”¨æˆ·'
      }
    } catch (error) {
      console.error('åŠ è½½å½“å‰ç”¨æˆ·å¤±è´¥:', error)
      // ä½¿ç”¨é»˜è®¤å€¼ä½œä¸ºå½“å‰ç”¨æˆ·
      this.currentUserId = 'current_user'
      this.currentUsername = 'å½“å‰ç”¨æˆ·'
    }
  }

  private async loadComments(): Promise<void> {
    this.isLoading = true
    try {
      // æ€»æ˜¯ä¼˜å…ˆä»å­˜å‚¨åŠ è½½è¯„è®º
      const savedComments = await this.storage.loadComments()
      const filteredComments = savedComments.filter(comment => comment.productId === this.productId)

      console.log('åŠ è½½è¯„è®º - å­˜å‚¨ä¸­çš„è¯„è®ºæ•°é‡:', filteredComments.length, 'å•†å“ID:', this.productId)

      // å¦‚æœå­˜å‚¨ä¸­æœ‰è¯„è®ºï¼Œå°±ä½¿ç”¨å­˜å‚¨çš„
      if (filteredComments.length > 0) {
        this.comments = filteredComments
        console.log('ä½¿ç”¨å­˜å‚¨çš„è¯„è®º:', this.comments.length, 'æ¡')
      } else {
        // åªæœ‰å­˜å‚¨ä¸­æ²¡æœ‰è¯„è®ºæ—¶ï¼Œæ‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        this.comments = this.commentService.getProductComments(this.productId, this.currentPage)
        console.log('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¯„è®º:', this.comments.length, 'æ¡')
      }

      const totalCount = this.comments.length
      this.hasMore = false // å­˜å‚¨çš„è¯„è®ºä¸åˆ†é¡µï¼Œæ‰€ä»¥æ²¡æœ‰æ›´å¤š
    } catch (error) {
      console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error)
      // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡
      this.comments = this.commentService.getProductComments(this.productId, this.currentPage)
    }
    this.isLoading = false
  }

  private loadMoreComments(): void {
    if (this.isLoading || !this.hasMore) return

    this.isLoading = true
    this.currentPage++
    const moreComments = this.commentService.getProductComments(this.productId, this.currentPage)
    this.comments = [...this.comments, ...moreComments]

    const totalCount = this.commentService.getProductCommentCount(this.productId)
    this.hasMore = this.currentPage * 10 < totalCount
    this.isLoading = false
  }

  private async submitComment(): Promise<void> {
    if (this.rating === 0 || this.commentContent.trim() === '') {
      console.error('è¯·è¯„åˆ†å¹¶å¡«å†™è¯„è®ºå†…å®¹')
      return
    }

    try {
      console.log('å¼€å§‹æäº¤è¯„è®º...')

      const newComment = new Comment(
        this.productId,
        this.currentUserId,
        this.currentUsername,
        this.rating,
        this.commentContent.trim()
      )

      // ç›´æ¥ä¿å­˜åˆ°å­˜å‚¨ï¼Œä¸ä½¿ç”¨commentService
      const allComments = await this.storage.loadComments()
      allComments.push(newComment)
      await this.storage.saveComments(allComments)

      console.log('è¯„è®ºå·²ä¿å­˜åˆ°å­˜å‚¨')

      // é‡æ–°åŠ è½½è¯„è®º
      await this.loadComments()

      // å…³é—­å¼¹çª—å’Œé‡ç½®è¡¨å•
      this.showWriteComment = false
      this.rating = 0
      this.commentContent = ''
      console.log('è¯„è®ºå‘è¡¨æˆåŠŸï¼Œå¼¹çª—å·²å…³é—­')
    } catch (error) {
      console.error('å‘è¡¨è¯„è®ºå¤±è´¥:', error)
    }
  }

  private async deleteComment(commentId: string): Promise<void> {
    try {
      // ä»è¯„è®ºæœåŠ¡ä¸­åˆ é™¤
      this.commentService.deleteComment(commentId)

      // ä»å­˜å‚¨ä¸­åˆ é™¤
      const allComments = await this.storage.loadComments()
      const filteredComments = allComments.filter(comment => comment.id !== commentId)
      await this.storage.saveComments(filteredComments)

      // é‡æ–°åŠ è½½è¯„è®º
      await this.loadComments()

      console.log('è¯„è®ºåˆ é™¤æˆåŠŸ')
    } catch (error) {
      console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error)
    }
  }

  // æ˜¾ç¤ºå›å¤å¯¹è¯æ¡†
  private openReplyDialog(comment: Comment): void {
    this.replyingToComment = comment
    this.replyContent = ''
    this.showReplyDialog = true
  }

  // å…³é—­å›å¤å¯¹è¯æ¡†
  private closeReplyDialog(): void {
    this.showReplyDialog = false
    this.replyingToComment = null
    this.replyContent = ''
  }

  // æäº¤å›å¤
  private async submitReply(): Promise<void> {
    if (!this.replyContent.trim() || !this.replyingToComment) {
      console.error('è¯·è¾“å…¥å›å¤å†…å®¹')
      return
    }

    try {
      // åˆ›å»ºå›å¤è¯„è®º
      const replyComment = new Comment(
        this.productId,
        this.currentUserId,
        this.currentUsername,
        5, // å›å¤é»˜è®¤ç»™5æ˜Ÿ
        `å›å¤ ${this.replyingToComment.username}: ${this.replyContent.trim()}`
      )

      // ä¿å­˜åˆ°å­˜å‚¨
      const allComments = await this.storage.loadComments()
      allComments.push(replyComment)
      await this.storage.saveComments(allComments)

      // é‡æ–°åŠ è½½è¯„è®º
      await this.loadComments()
      this.closeReplyDialog()
      console.log('å›å¤å‘è¡¨æˆåŠŸ')
    } catch (error) {
      console.error('å›å¤å‘è¡¨å¤±è´¥:', error)
    }
  }

  build() {
    Column() {
      // è¯„è®ºç»Ÿè®¡
      Column() {
        Text('å•†å“è¯„ä»·')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .width('100%')
          .margin({ bottom: 12 })

        Row() {
          Text('â­ 4.8åˆ†')
            .fontSize(16)
            .fontColor($r('app.color.text_primary'))
          Text('(1286æ¡è¯„ä»·)')
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
            .margin({ left: 8 })
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
      }
      .width('100%')
      .padding(16)
      .backgroundColor($r('app.color.white'))
      .borderRadius(8)
      .margin({ left: 16, right: 16, top: 16, bottom: 8 })

      // å†™è¯„è®ºæŒ‰é’®
      Button('å†™è¯„è®º')
        .width('100%')
        .height(44)
        .fontSize(16)
        .backgroundColor($r('app.color.primary'))
        .margin({ left: 16, right: 16, top: 8, bottom: 16 })
        .onClick(() => {
          this.showWriteComment = true
        })

      // è¯„è®ºåˆ—è¡¨ - ä½¿ç”¨Scrollç¡®ä¿å¯ä»¥æ»šåŠ¨
      Scroll() {
        Column() {
          if (this.comments.length === 0 && !this.isLoading) {
            Column() {
              Text('ğŸ’¬')
                .fontSize(60)
                .margin({ bottom: 16 })
              Text('æš‚æ— è¯„è®º')
                .fontSize(16)
                .fontColor($r('app.color.text_secondary'))
                .margin({ bottom: 8 })
              Text('å¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('100%')
            .padding(32)
            .justifyContent(FlexAlign.Center)
          } else {
            // è¯„è®ºåˆ—è¡¨
            Column() {
              ForEach(this.comments, (comment: Comment) => {
                Column() {
                  Row() {
                    Text('ğŸ‘¤')
                      .fontSize(40)
                      .margin({ right: 12 })

                    Column() {
                      Row() {
                        Text(comment.username)
                          .fontSize(14)
                          .fontWeight(FontWeight.Medium)
                          .fontColor($r('app.color.text_primary'))

                        Text(comment.getFormattedTime())
                          .fontSize(12)
                          .fontColor($r('app.color.text_secondary'))
                          .margin({ left: 8 })
                      }
                      .width('100%')

                      Row() {
                        ForEach([1, 2, 3, 4, 5], (star: number) => {
                          Text(star <= comment.rating ? 'â˜…' : 'â˜†')
                            .fontSize(12)
                            .fontColor(star <= comment.rating ? $r('app.color.primary') : $r('app.color.text_secondary'))
                        })
                      }
                      .width('100%')
                      .margin({ top: 4 })
                    }
                    .layoutWeight(1)
                  }
                  .width('100%')

                  // è¯„è®ºå†…å®¹
                  Text(comment.content)
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                    .lineHeight(20)
                    .width('100%')
                    .margin({ top: 12 })

                  // è¯„è®ºå›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
                  if (comment.images && comment.images.length > 0) {
                    Row() {
                      ForEach(comment.images.slice(0, 3), (image: string) => {
                        Image(image)
                          .width(60)
                          .height(60)
                          .borderRadius(4)
                          .objectFit(ImageFit.Cover)
                          .margin({ right: 8 })
                      })
                    }
                    .width('100%')
                    .margin({ top: 8 })
                  }

                  // åº•éƒ¨æ“ä½œæ 
                  Row() {
                    Button() {
                      Row() {
                        Text(comment.isLiked ? 'â¤ï¸' : 'ğŸ¤')
                          .fontSize(14)
                        Text(comment.likes.toString())
                          .fontSize(12)
                          .fontColor($r('app.color.text_secondary'))
                          .margin({ left: 4 })
                      }
                    }
                    .height(28)
                    .backgroundColor(Color.Transparent)
                    .onClick(() => {
                      this.commentService.toggleLike(comment.id, this.currentUserId)
                    })

                    Blank()

                    // åˆ é™¤æŒ‰é’® - åªå¯¹å½“å‰ç”¨æˆ·è‡ªå·±çš„è¯„è®ºæ˜¾ç¤º
                    if (comment.userId === this.currentUserId) {
                      Button('åˆ é™¤')
                        .height(28)
                        .fontSize(12)
                        .backgroundColor($r('app.color.error'))
                        .fontColor(Color.White)
                        .margin({ right: 8 })
                        .onClick(() => {
                          this.deleteComment(comment.id)
                        })
                    }

                    Button('å›å¤')
                      .height(32)
                      .fontSize(12)
                      .backgroundColor($r('app.color.primary'))
                      .fontColor(Color.White)
                      .borderRadius(16)
                      .onClick(() => {
                        console.log('ç‚¹å‡»å›å¤è¯„è®º:', comment.id)
                        // ç®€å•çš„å›å¤åŠŸèƒ½ç¤ºä¾‹
                        this.openReplyDialog(comment)
                      })
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.SpaceBetween)
                  .alignItems(VerticalAlign.Center)
                  .margin({ top: 8, bottom: 12 })
                }
                .width('100%')
                .padding(16)
                .backgroundColor($r('app.color.white'))
                .borderRadius(8)
                .margin({ left: 16, right: 16, bottom: 12 })
                .border({
                  width: 1,
                  color: '#F0F0F0'
                })
              })

              // åŠ è½½æ›´å¤šæŒ‰é’®
              if (this.hasMore) {
                Button('åŠ è½½æ›´å¤š')
                  .width('100%')
                  .height(44)
                  .fontSize(14)
                  .backgroundColor(Color.Transparent)
                  .fontColor($r('app.color.primary'))
                  .margin({ left: 16, right: 16, bottom: 20 })
                  .onClick(() => this.loadMoreComments())
              }
            }
            .width('100%')
            .padding({ bottom: 20 })
          }

          if (this.isLoading) {
            LoadingProgress()
              .width(40)
              .height(40)
            Text('åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 16 })
          }
        }
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)

      // å†™è¯„è®ºå¼¹çª—
      if (this.showWriteComment) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.showWriteComment = false
              this.rating = 0
              this.commentContent = ''
            })

          // å¼¹çª—å†…å®¹
          Column() {
            Text('å†™è¯„è®º')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .width('100%')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 24 })

            // è¯„åˆ†é€‰æ‹©
            Text('è¯„åˆ†')
              .fontSize(14)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .margin({ bottom: 12 })

            Row() {
              ForEach([1, 2, 3, 4, 5], (star: number) => {
                Button() {
                  Text(star <= this.rating ? 'â˜…' : 'â˜†')
                    .fontSize(32)
                    .fontColor(star <= this.rating ? $r('app.color.primary') : $r('app.color.text_secondary'))
                }
                .backgroundColor(Color.Transparent)
                .onClick(() => {
                  this.rating = star
                })
                .margin({ right: 8 })
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ bottom: 24 })

            // è¯„è®ºå†…å®¹
            Text('è¯„è®ºå†…å®¹')
              .fontSize(14)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .margin({ bottom: 12 })

            TextArea({
              placeholder: 'åˆ†äº«æ‚¨çš„ä½¿ç”¨æ„Ÿå—...',
              text: this.commentContent
            })
              .width('100%')
              .height(120)
              .fontSize(14)
              .backgroundColor($r('app.color.background'))
              .borderRadius(8)
              .padding(12)
              .onChange((value: string) => {
                this.commentContent = value
                console.log('è¯„è®ºå†…å®¹å˜åŒ–:', value)
              })

            // æŒ‰é’®
            Row() {
              Button('å–æ¶ˆ')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.background'))
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.showWriteComment = false
                  this.rating = 0
                  this.commentContent = ''
                })

              Button('æäº¤')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => {
                  this.submitComment()
                })
            }
            .width('100%')
            .margin({ top: 24 })
          }
          .width(320)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .padding(24)
          .position({ x: '50%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
      }

      // å›å¤å¯¹è¯æ¡†
      if (this.showReplyDialog && this.replyingToComment) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.closeReplyDialog()
            })

          // å¼¹çª—å†…å®¹
          Column() {
            Text('å›å¤è¯„è®º')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .width('100%')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 16 })

            // è¢«å›å¤çš„è¯„è®ºä¿¡æ¯
            Column() {
              Text(`å›å¤ ${this.replyingToComment.username}`)
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .width('100%')
                .margin({ bottom: 8 })

              Text(this.replyingToComment.content)
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
                .width('100%')
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .backgroundColor($r('app.color.background'))
                .padding(8)
                .borderRadius(4)
            }
            .width('100%')
            .margin({ bottom: 16 })

            // å›å¤å†…å®¹è¾“å…¥
            TextArea({
              placeholder: 'è¯·è¾“å…¥æ‚¨çš„å›å¤...',
              text: this.replyContent
            })
              .width('100%')
              .height(100)
              .fontSize(14)
              .backgroundColor($r('app.color.background'))
              .borderRadius(8)
              .padding(12)
              .onChange((value: string) => {
                this.replyContent = value
              })

            // æŒ‰é’®
            Row() {
              Button('å–æ¶ˆ')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.background'))
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.closeReplyDialog()
                })

              Button('å›å¤')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => {
                  this.submitReply()
                })
            }
            .width('100%')
            .margin({ top: 16 })
          }
          .width(300)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .padding(24)
          .position({ x: '50%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(1000)
      }
    }
    .width('100%')
    .layoutWeight(1)
    .backgroundColor($r('app.color.background'))
  }
}