import router from '@ohos.router'
import { ProductModel } from '../model/ProductModel'

// å¯å¤ç”¨çš„å•†å“å¡ç‰‡ç»„ä»¶ï¼Œæ”¯æŒæ‡’åŠ è½½
@Reusable
@Component
export struct ProductCardLazy {
  @Prop product: ProductModel
  @State imageLoaded: boolean = false
  @State imageError: boolean = false
  @State isLiked: boolean = false

  build() {
    Column() {
      // å•†å“å›¾ç‰‡å®¹å™¨ - æ‡’åŠ è½½å®ç°
      Stack() {
        // åŠ è½½å ä½å›¾
        if (!this.imageLoaded) {
          Column() {
            LoadingProgress()
              .width(24)
              .height(24)
              .color($r('app.color.primary'))
            Text('åŠ è½½ä¸­...')
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 8 })
          }
          .width('100%')
          .height(200)
          .backgroundColor($r('app.color.background'))
          .justifyContent(FlexAlign.Center)
        }

        // é”™è¯¯çŠ¶æ€
        if (this.imageError) {
          Column() {
            Text('ğŸ“·')
              .fontSize(40)
            Text('å›¾ç‰‡åŠ è½½å¤±è´¥')
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 8 })
          }
          .width('100%')
          .height(200)
          .backgroundColor($r('app.color.background'))
          .justifyContent(FlexAlign.Center)
        }

        // å®é™…å›¾ç‰‡
        Image(this.product.images[0])
          .width('100%')
          .height(200)
          .objectFit(ImageFit.Cover)
          .borderRadius({ topLeft: 12, topRight: 12 })
          .alt('å•†å“å›¾ç‰‡')
          .onComplete(() => {
            this.imageLoaded = true
          })
          .onError(() => {
            this.imageError = true
          })
          .opacity(this.imageLoaded ? 1 : 0)
          .animation({
            duration: 300,
            curve: Curve.EaseInOut
          })
      }
      .width('100%')
      .height(200)
      .borderRadius({ topLeft: 12, topRight: 12 })

      // æ”¶è—æŒ‰é’®
      if (this.imageLoaded && !this.imageError) {
        Button(this.isLiked ? 'â¤ï¸' : 'ğŸ¤')
          .width(32)
          .height(32)
          .backgroundColor('rgba(0,0,0,0.3)')
          .fontSize(16)
          .position({ x: '85%', y: 8 })
          .borderRadius(16)
          .onClick(() => {
            this.isLiked = !this.isLiked
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ”¶è—é€»è¾‘
          })
      }

      // å•†å“ä¿¡æ¯
      Column() {
        // å•†å“åç§°
        Text(this.product.name)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .margin({ bottom: 4 })

        // å•†å“æè¿°
        Text(this.product.description)
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .margin({ bottom: 8 })

        // è¯„åˆ†å’Œé”€é‡
        Row() {
          Row() {
            Text('â­')
              .fontSize(12)
            Text(this.product.rating.toFixed(1))
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
            Text(`(${this.product.reviewCount})`)
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .margin({ left: 4 })
          }
          .layoutWeight(1)

          // åº“å­˜çŠ¶æ€
          Text(this.getStockText())
            .fontSize(10)
            .fontColor(this.getStockColor())
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)
        .margin({ bottom: 8 })

        // æ ‡ç­¾
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
          ForEach(this.product.tags, (tag: string) => {
            Text(tag)
              .fontSize(10)
              .fontColor($r('app.color.primary'))
              .backgroundColor($r('app.color.primary_light'))
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(4)
              .margin({ right: 4 })
              .margin({ bottom: 4 })
          })
        }
        .width('100%')
        .margin({ bottom: 8 })

        // ä»·æ ¼åŒºåŸŸ
        Row() {
          Text(`Â¥${this.product.price}`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.price'))

          if (this.product.originalPrice > this.product.price) {
            Text(`Â¥${this.product.originalPrice}`)
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .decoration({ type: TextDecorationType.LineThrough })
              .margin({ left: 8 })
          }

          Blank()

          // é”€é‡æ ‡ç­¾
          if (this.product.reviewCount > 1000) {
            Text('çƒ­é”€')
              .fontSize(10)
              .fontColor(Color.White)
              .backgroundColor($r('app.color.secondary'))
              .padding({ left: 4, right: 4, top: 2, bottom: 2 })
              .borderRadius(4)
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
        .alignItems(VerticalAlign.Bottom)
      }
      .padding(12)
      .width('100%')
      .layoutWeight(1)
    }
    .backgroundColor($r('app.color.white'))
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: '#1A000000',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      // è·³è½¬åˆ°å•†å“è¯¦æƒ…é¡µ
      router.pushUrl({
        url: 'pages/ProductDetailPage',
        params: {
          productId: this.product.id
        }
      }).catch((error: Error) => {
        console.error('è·³è½¬å•†å“è¯¦æƒ…é¡µå¤±è´¥:', error.message)
      })
    })
  }

  private getStockText(): string {
    if (this.product.stock <= 0) return 'å·²å”®ç½„'
    if (this.product.stock <= 10) return `ä»…å‰©${this.product.stock}ä»¶`
    return `åº“å­˜${this.product.stock}`
  }

  private getStockColor(): Resource {
    if (this.product.stock <= 0) return $r('app.color.text_secondary')
    if (this.product.stock <= 10) return $r('app.color.warning')
    return $r('app.color.success')
  }
}