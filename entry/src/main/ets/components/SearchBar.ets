import { MockData } from '../model/ProductModel'

@Component
export struct SearchBar {
  @State searchText: string = ''
  @State showSuggestions: boolean = false
  @State searchHistory: string[] = []
  @State suggestions: string[] = []
  onSearch: (query: string) => void = () => {}

  aboutToAppear() {
    // åˆå§‹åŒ–æœç´¢å»ºè®®
    this.suggestions = MockData.generateSearchSuggestions()
    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æœç´¢å†å²
    this.loadSearchHistory()
  }

  private loadSearchHistory() {
    try {
      const history = AppStorage.get<string[]>('searchHistory')
      if (history) {
        this.searchHistory = history
      }
    } catch (error) {
      console.error('åŠ è½½æœç´¢å†å²å¤±è´¥:', error)
    }
  }

  private saveSearchHistory(query: string) {
    if (!query || query.trim() === '') return

    // é¿å…é‡å¤
    const index = this.searchHistory.indexOf(query)
    if (index > -1) {
      this.searchHistory.splice(index, 1)
    }

    // æ·»åŠ åˆ°å¼€å¤´
    this.searchHistory.unshift(query)

    // æœ€å¤šä¿å­˜10æ¡
    if (this.searchHistory.length > 10) {
      this.searchHistory = this.searchHistory.slice(0, 10)
    }

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    try {
      AppStorage.set('searchHistory', this.searchHistory)
    } catch (error) {
      console.error('ä¿å­˜æœç´¢å†å²å¤±è´¥:', error)
    }
  }

  build() {
    Column() {
      // æœç´¢æ¡†
      Row() {
        Search({
          placeholder: 'æœç´¢å•†å“ã€å“ç‰Œã€åˆ†ç±»',
          value: this.searchText
        })
          .width('100%')
          .height(40)
          .backgroundColor($r('app.color.background'))
          .borderRadius(20)
          .onChange((value: string) => {
            this.searchText = value
            this.showSuggestions = value.length > 0
          })
          .onSubmit(() => {
            this.performSearch()
          })

        if (this.searchText.length > 0) {
          Button('æ¸…é™¤')
            .height(40)
            .fontSize(12)
            .backgroundColor(Color.Transparent)
            .fontColor($r('app.color.text_secondary'))
            .onClick(() => {
              this.searchText = ''
              this.showSuggestions = false
            })
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
      .margin({ bottom: 8 })

      // æœç´¢å»ºè®®å’Œå†å²è®°å½•
      if (this.showSuggestions && this.searchText.length > 0) {
        Column() {
          // æœç´¢å»ºè®®
          if (this.suggestions.some(suggestion =>
            suggestion.toLowerCase().includes(this.searchText.toLowerCase()))) {
            Text('æœç´¢å»ºè®®')
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .width('100%')
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })

            ForEach(this.suggestions.filter(suggestion =>
              suggestion.toLowerCase().includes(this.searchText.toLowerCase())
            ), (suggestion: string) => {
              Row() {
                Text('ğŸ”')
                  .fontSize(14)
                  .margin({ right: 8 })
                Text(suggestion)
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
                  .layoutWeight(1)
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 12, bottom: 12 })
              .backgroundColor(Color.Transparent)
              .onClick(() => {
                this.searchText = suggestion
                this.performSearch()
              })
            })
          }

          // æœç´¢å†å²
          if (this.searchHistory.length > 0) {
            Row() {
              Text('æœç´¢å†å²')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
                .layoutWeight(1)

              Button('æ¸…ç©º')
                .height(24)
                .fontSize(10)
                .backgroundColor(Color.Transparent)
                .fontColor($r('app.color.text_secondary'))
                .onClick(() => {
                  this.searchHistory = []
                  AppStorage.set('searchHistory', [])
                })
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })

            ForEach(this.searchHistory, (historyItem: string) => {
              Row() {
                Text('ğŸ•')
                  .fontSize(14)
                  .margin({ right: 8 })
                Text(historyItem)
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
                  .layoutWeight(1)
                Button('Ã—')
                  .height(20)
                  .width(20)
                  .fontSize(12)
                  .backgroundColor(Color.Transparent)
                  .fontColor($r('app.color.text_secondary'))
                  .onClick(() => {
                    const index = this.searchHistory.indexOf(historyItem)
                    if (index > -1) {
                      this.searchHistory.splice(index, 1)
                      AppStorage.set('searchHistory', this.searchHistory)
                    }
                  })
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 12, bottom: 12 })
              .onClick(() => {
                this.searchText = historyItem
                this.performSearch()
              })
            })
          }

          // çƒ­é—¨æœç´¢
          Text('çƒ­é—¨æœç´¢')
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
            .width('100%')
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })

          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
            ForEach(this.suggestions.slice(0, 6), (hotSearch: string) => {
              Text(hotSearch)
                .fontSize(12)
                .fontColor($r('app.color.text_primary'))
                .backgroundColor($r('app.color.background'))
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .borderRadius(16)
                .margin({ right: 8 })
                .margin({ bottom: 8 })
                .onClick(() => {
                  this.searchText = hotSearch
                  this.performSearch()
                })
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 8 })
        }
        .width('100%')
        .backgroundColor($r('app.color.white'))
        .borderRadius(8)
        .shadow({
          radius: 4,
          color: '#0A000000',
          offsetX: 0,
          offsetY: 2
        })
      }
    }
    .width('100%')
    .onBlur(() => {
      // å»¶è¿Ÿéšè—å»ºè®®åˆ—è¡¨ï¼Œé¿å…ç‚¹å‡»äº‹ä»¶è¢«æ‹¦æˆª
      setTimeout(() => {
        this.showSuggestions = false
      }, 200)
    })
  }

  private performSearch() {
    if (this.searchText.trim() === '') return

    this.saveSearchHistory(this.searchText)
    this.showSuggestions = false
    this.onSearch(this.searchText)
  }
}