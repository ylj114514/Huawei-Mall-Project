import { StorageManager } from '../utils/StorageManager'

@Component
export struct SearchBarEnhanced {
  @Link searchText: string
  @State showHistory: boolean = false
  @State searchHistory: string[] = []
  @State hotSearches: string[] = ['åŽä¸ºMate 60', 'iPhone 15', 'MacBook Pro', 'AirPods Pro', 'å°ç±³14']
  @State isFocused: boolean = false
  private storageManager: StorageManager = StorageManager.getInstance()

  onSearch: (query: string) => void = () => {}
  onTextChange?: (value: string) => void

  aboutToAppear() {
    this.loadSearchHistory()
  }

  private async loadSearchHistory() {
    try {
      this.searchHistory = await this.storageManager.getSearchHistory() || []
    } catch (error) {
      console.error('åŠ è½½æœç´¢åŽ†å²å¤±è´¥:', error)
    }
  }

  private async saveSearchHistory(query: string) {
    if (!query.trim()) return

    try {
      // åŽ»é‡å¹¶æ·»åŠ åˆ°å¼€å¤´
      const newHistory = [query, ...this.searchHistory.filter(item => item !== query)].slice(0, 10)
      this.searchHistory = newHistory
      await this.storageManager.saveSearchHistory(newHistory)
    } catch (error) {
      console.error('ä¿å­˜æœç´¢åŽ†å²å¤±è´¥:', error)
    }
  }

  private handleSearch(query: string) {
    if (query.trim()) {
      this.saveSearchHistory(query)
    }
    this.showHistory = false
    this.onSearch(query)
  }

  private clearHistory() {
    this.searchHistory = []
    this.storageManager.saveSearchHistory([])
  }

  private selectHistoryItem(item: string) {
    this.searchText = item
    this.handleSearch(item)
  }

  build() {
    Column() {
      // æœç´¢æ ä¸»ä½“
      Row() {
        // æœç´¢å›¾æ ‡
        Text('ðŸ”')
          .fontSize(18)
          .fontColor($r('app.color.text_tertiary'))
          .margin({ left: 12 })

        // è¾“å…¥æ¡†
        TextInput({
          placeholder: 'æœç´¢å•†å“ã€å“ç‰Œã€åž‹å·',
          text: this.searchText
        })
          .width('100%')
          .height(44)
          .fontSize(15)
          .fontColor($r('app.color.text_primary'))
          .backgroundColor(Color.Transparent)
          .placeholderColor($r('app.color.text_tertiary'))
          .layoutWeight(1)
          .onChange((value: string) => {
            this.searchText = value
            this.onTextChange?.(value)
          })
          .onFocus(() => {
            this.isFocused = true
            this.showHistory = true
          })
          .onBlur(() => {
            // å»¶è¿Ÿéšè—ï¼Œä»¥ä¾¿ç‚¹å‡»åŽ†å²é¡¹
            setTimeout(() => {
              this.showHistory = false
              this.isFocused = false
            }, 200)
          })
          .onSubmit(() => {
            this.handleSearch(this.searchText)
          })

        // æ¸…é™¤æŒ‰é’®
        if (this.searchText) {
          Button() {
            Text('âœ•')
              .fontSize(16)
              .fontColor($r('app.color.text_tertiary'))
          }
          .width(32)
          .height(32)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.searchText = ''
            this.onTextChange?.('')
            this.handleSearch('')
          })
        }

        // æœç´¢æŒ‰é’®
        Button('æœç´¢')
          .height(36)
          .fontSize(14)
          .fontColor($r('app.color.primary'))
          .fontWeight(FontWeight.Medium)
          .backgroundColor(Color.Transparent)
          .padding({ left: 12, right: 12 })
          .onClick(() => {
            this.handleSearch(this.searchText)
          })
      }
      .width('100%')
      .height(52)
      .backgroundColor($r('app.color.white'))
      .borderRadius(26)
      .shadow({
        radius: 8,
        color: $r('app.color.shadow_light'),
        offsetX: 0,
        offsetY: 2
      })
      .padding({ right: 4 })

      // æœç´¢åŽ†å²å’Œçƒ­é—¨æœç´¢
      if (this.showHistory) {
        Column() {
          // æœç´¢åŽ†å²
          if (this.searchHistory.length > 0) {
            Column() {
              Row() {
                Text('æœç´¢åŽ†å²')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r('app.color.text_primary'))
                  .layoutWeight(1)

                Button('æ¸…ç©º')
                  .fontSize(13)
                  .fontColor($r('app.color.text_tertiary'))
                  .backgroundColor(Color.Transparent)
                  .height(32)
                  .onClick(() => this.clearHistory())
              }
              .width('100%')
              .padding({ bottom: 12 })

              Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
                ForEach(this.searchHistory, (item: string, index: number) => {
                  Button(item)
                    .height(32)
                    .fontSize(13)
                    .fontColor($r('app.color.text_secondary'))
                    .backgroundColor($r('app.color.background_gray'))
                    .borderRadius(16)
                    .padding({ left: 16, right: 16 })
                    .margin({ right: 8, bottom: 8 })
                    .onClick(() => this.selectHistoryItem(item))
                })
              }
              .width('100%')
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.white'))
            .borderRadius({ topLeft: 0, topRight: 0, bottomLeft: 12, bottomRight: 12 })
            .margin({ top: 8 })
          }

          // çƒ­é—¨æœç´¢
          Column() {
            Row() {
              Text('ðŸ”¥')
                .fontSize(16)
                .margin({ right: 6 })

              Text('çƒ­é—¨æœç´¢')
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.text_primary'))
            }
            .width('100%')
            .alignItems(VerticalAlign.Center)
            .padding({ bottom: 12 })

            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
              ForEach(this.hotSearches, (item: string, index: number) => {
                Button(item)
                  .height(32)
                  .fontSize(13)
                  .fontColor(index < 3 ? $r('app.color.error') : $r('app.color.text_secondary'))
                  .backgroundColor(index < 3 ? $r('app.color.secondary_light') : $r('app.color.background_gray'))
                  .borderRadius(16)
                  .padding({ left: 16, right: 16 })
                  .margin({ right: 8, bottom: 8 })
                  .onClick(() => this.selectHistoryItem(item))
              })
            }
            .width('100%')
          }
          .width('100%')
          .padding(16)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .margin({ top: 8 })
        }
        .width('100%')
        .backgroundColor($r('app.color.background'))
        .margin({ top: 12 })
        .shadow({
          radius: 12,
          color: $r('app.color.shadow_medium'),
          offsetX: 0,
          offsetY: 4
        })
        .zIndex(1000)
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
    .backgroundColor($r('app.color.background'))
  }
}