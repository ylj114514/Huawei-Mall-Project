import router from '@ohos.router'
import { StorageManager } from '../utils/StorageManager'
import { User } from '../model/DataModel'

/**
 * æƒé™å®ˆå«ç»„ä»¶ - ä¿æŠ¤éœ€è¦ç™»å½•çš„åŠŸèƒ½
 */
@Component
export struct AuthGuard {
  @BuilderParam content: () => void
  @Prop required: boolean = false // æ˜¯å¦éœ€è¦ç™»å½•

  @State user: User | null = null
  @State isLoading: boolean = true
  private storage: StorageManager = StorageManager.getInstance()

  aboutToAppear() {
    this.checkAuthStatus()
  }

  private async checkAuthStatus() {
    try {
      this.user = await this.storage.loadUser()
    } catch (error) {
      console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  private redirectToLogin() {
    router.pushUrl({
      url: 'pages/LoginPage'
    })
  }

  build() {
    if (this.isLoading) {
      // åŠ è½½çŠ¶æ€
      Column() {
        LoadingProgress()
          .width(40)
          .height(40)
        Text('æ£€æŸ¥æƒé™ä¸­...')
          .fontSize(14)
          .margin({ top: 16 })
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
    } else if (this.required && !this.user) {
      // éœ€è¦ç™»å½•ä½†æœªç™»å½•
      Column() {
        Text('ğŸ”’')
          .fontSize(48)
          .margin({ bottom: 16 })
        Text('è¯·å…ˆç™»å½•')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ bottom: 24 })

        Button('ç«‹å³ç™»å½•')
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor('#FF0000')
          .borderRadius(24)
          .padding({ left: 32, right: 32, top: 12, bottom: 12 })
          .height(48)
          .onClick(() => {
            this.redirectToLogin()
          })
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#FFFFFF')
    } else {
      // å·²ç™»å½•æˆ–ä¸éœ€è¦ç™»å½•ï¼Œæ˜¾ç¤ºå†…å®¹
      this.content()
    }
  }
}

/**
 * è´­ç‰©è½¦å®ˆå«ç»„ä»¶
 */
@Component
export struct CartGuard {
  @BuilderParam content: () => void
  @Prop cartCount: number = 0

  build() {
    Column() {
      this.content()
    }
    .width('100%')
    .onClick(() => {
      if (this.cartCount === 0) {
        // è´­ç‰©è½¦ä¸ºç©ºæ—¶çš„æç¤º
        console.log('è´­ç‰©è½¦æ˜¯ç©ºçš„')
      }
    })
  }
}

/**
 * è¯„è®ºå®ˆå«ç»„ä»¶
 */
@Component
export struct CommentGuard {
  @BuilderParam content: () => void
  @BuilderParam prompt: () => void

  build() {
    Column() {
      this.prompt()
    }
    .width('100%')
    .onClick(() => {
      // ç‚¹å‡»è¯„è®ºåŒºåŸŸæ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
      this.checkAndNavigate()
    })
  }

  private async checkAndNavigate() {
    const storage = StorageManager.getInstance()
    const user = await storage.loadUser()
    if (!user) {
      router.pushUrl({ url: 'pages/LoginPage' })
    }
  }
}