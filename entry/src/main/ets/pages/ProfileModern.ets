import router from '@ohos.router'
import { StorageManager } from '../utils/StorageManagerSimple'
import { User } from '../model/DataModel'
// import { OrderStats } from '../model/PageModels'
import common from '@ohos.app.ability.common'

// è®¢å•ç»Ÿè®¡ç±»
class OrderStatistics {
  unpaid: number = 0
  toShip: number = 0
  toReceive: number = 0
  toReview: number = 0
}

interface ColorScheme {
  background: string
  surface: string
  primary: string
  secondary: string
  text: string
  textSecondary: string
  accent: string
  danger: string
}

const COLORS: ColorScheme = {
  background: '#F5F7FA',
  surface: '#FFFFFF',
  primary: '#1A1A1A',
  secondary: '#6C757D',
  text: '#2C3E50',
  textSecondary: '#7F8C8D',
  accent: '#3498DB',
  danger: '#E74C3C'
}

@Entry
@Component
struct ProfileModern {
  @State user: User | null = null
  @State isLoading: boolean = true
  @State cartCount: number = 0
  @State orderStats: OrderStatistics = new OrderStatistics()
  @State dialogMessage: string = ''
  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
    this.loadUserData()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
    } catch (error) {
      console.error('åˆå§‹åŒ–å­˜å‚¨å¤±è´¥:', error)
    }
  }

  private async loadUserData() {
    try {
      this.user = await this.storage.loadUser()

      // æ¨¡æ‹ŸåŠ è½½è´­ç‰©è½¦æ•°é‡
      const cartItems = await this.storage.loadCart()
      this.cartCount = cartItems.length

      // æ¨¡æ‹ŸåŠ è½½è®¢å•ç»Ÿè®¡
      this.orderStats.unpaid = 2
      this.orderStats.toShip = 1
      this.orderStats.toReceive = 3
      this.orderStats.toReview = 5

      this.isLoading = false
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error)
      this.isLoading = false
    }
  }

  private async logout() {
    try {
      await this.storage.saveUser(null)
      router.replaceUrl({ url: 'pages/LoginPageModern' })
    } catch (error) {
      console.error('ç™»å‡ºå¤±è´¥:', error)
    }
  }

  private navigateTo(page: string) {
    console.log(`å¯¼èˆªåˆ°é¡µé¢: ${page}`)
    router.pushUrl({ url: page }).catch((error: Error) => {
      console.error('å¯¼èˆªå¤±è´¥:', error)
    })
  }

  @Builder
  Header() {
    Row() {
      Button() {
        Text('â† è¿”å›')
          .fontSize(24)
          .fontColor(COLORS.text)
      }
      .width(100)
      .height(48)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.log('è¿”å›æŒ‰é’®è¢«ç‚¹å‡»')
        router.back()
      })

      Text('ä¸ªäººä¸­å¿ƒ')
        .fontSize(20)
        .fontWeight(FontWeight.Medium)
        .fontColor(COLORS.text)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Button() {
        Text('è®¾ç½® âš™ï¸')
          .fontSize(24)
          .fontColor(COLORS.text)
      }
      .width(100)
      .height(48)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.log('è®¾ç½®æŒ‰é’®è¢«ç‚¹å‡»')
      })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 12, bottom: 12 })
    .backgroundColor(COLORS.surface)
  }

  @Builder
  UserInfoSection() {
    Column() {
      // ç”¨æˆ·å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯
      Row() {
        // å¤´åƒ
        Stack() {
          Circle({ width: 80, height: 80 })
            .fill(COLORS.accent)

          Text(this.user ? this.user.username[0].toUpperCase() : 'U')
            .fontSize(32)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)

          // VIPæ ‡ç­¾
          if (this.user) {
            Text('VIP')
              .fontSize(10)
              .fontColor('#FFD700')
              .fontWeight(FontWeight.Bold)
              .backgroundColor('#1A1A1A')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
              .position({ x: 45, y: 0 })
          }
        }
        .margin({ right: 20 })

        // ç”¨æˆ·ä¿¡æ¯
        Column() {
          if (this.user) {
            Text(this.user.username || 'ç”¨æˆ·æ˜µç§°')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .fontColor(COLORS.text)
              .margin({ bottom: 8 })

            Row() {
              Text('ä¼šå‘˜ç­‰çº§: ')
                .fontSize(14)
                .fontColor(COLORS.textSecondary)
              Text(this.user.getLevelText())
                .fontSize(14)
                .fontColor(this.user.getLevelColor())
                .fontWeight(FontWeight.Medium)
            }
            .margin({ bottom: 4 })

            Text(`ç§¯åˆ†: ${this.user.points}`)
              .fontSize(14)
              .fontColor(COLORS.textSecondary)
          } else {
            Text('æœªç™»å½•')
              .fontSize(18)
              .fontColor(COLORS.text)
              .margin({ bottom: 8 })

            Button('å»ç™»å½•')
              .fontSize(14)
              .fontColor(Color.White)
              .backgroundColor(COLORS.primary)
              .padding({ left: 20, right: 20, top: 8, bottom: 8 })
              .borderRadius(20)
              .onClick(() => {
                router.pushUrl({ url: 'pages/LoginPageModern' })
              })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
    }
    .width('100%')
    .backgroundColor(COLORS.surface)
    .margin({ top: 1 })
  }

  @Builder
  OrderSection() {
    if (this.user) {
      Column() {
        Text('æˆ‘çš„è®¢å•')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(COLORS.text)
          .width('100%')
          .margin({ bottom: 20 })
          .padding({ left: 20 })

        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceAround }) {
          Column() {
            Text('ğŸ’³')
              .fontSize(30)
              .margin({ bottom: 8 })
            Text('å¾…ä»˜æ¬¾')
              .fontSize(12)
            Text('2')
              .fontSize(14)
              .fontColor(Color.Red)
          }
          .width(80)
          .height(80)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .onClick(() => {
            console.log('å¾…ä»˜æ¬¾æŒ‰é’®è¢«ç‚¹å‡»ï¼')
            this.showDialog('å¾…ä»˜æ¬¾', 'æ‚¨æœ‰2ä¸ªå¾…ä»˜æ¬¾è®¢å•')
          })

          Column() {
            Text('ğŸ“¦')
              .fontSize(30)
              .margin({ bottom: 8 })
            Text('å¾…å‘è´§')
              .fontSize(12)
            Text('1')
              .fontSize(14)
              .fontColor(Color.Red)
          }
          .width(80)
          .height(80)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .onClick(() => {
            console.log('å¾…å‘è´§æŒ‰é’®è¢«ç‚¹å‡»ï¼')
            this.showDialog('å¾…å‘è´§', 'æ‚¨æœ‰1ä¸ªå¾…å‘è´§è®¢å•')
          })

          Column() {
            Text('ğŸšš')
              .fontSize(30)
              .margin({ bottom: 8 })
            Text('å¾…æ”¶è´§')
              .fontSize(12)
            Text('3')
              .fontSize(14)
              .fontColor(Color.Red)
          }
          .width(80)
          .height(80)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .onClick(() => {
            console.log('å¾…æ”¶è´§æŒ‰é’®è¢«ç‚¹å‡»ï¼')
            this.showDialog('å¾…æ”¶è´§', 'æ‚¨æœ‰3ä¸ªå¾…æ”¶è´§è®¢å•')
          })

          Column() {
            Text('â­')
              .fontSize(30)
              .margin({ bottom: 8 })
            Text('å¾…è¯„ä»·')
              .fontSize(12)
            Text('5')
              .fontSize(14)
              .fontColor(Color.Red)
          }
          .width(80)
          .height(80)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .onClick(() => {
            console.log('å¾…è¯„ä»·æŒ‰é’®è¢«ç‚¹å‡»ï¼')
            this.showDialog('å¾…è¯„ä»·', 'æ‚¨æœ‰5ä¸ªå¾…è¯„ä»·è®¢å•')
          })
        }
        .width('100%')
      }
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(COLORS.surface)
    .margin({ top: 12 })
    } else {
      // æœªç™»å½•çŠ¶æ€çš„è®¢å•æç¤º
      Column() {
        Row() {
          Text('ğŸ“‹')
            .fontSize(20)
            .fontColor('#CCCCCC')
            .margin({ right: 12 })
          Text('ç™»å½•åæŸ¥çœ‹è®¢å•')
            .fontSize(16)
            .fontColor('#999999')
        }
        .justifyContent(FlexAlign.Center)
        .width('100%')
        .height(80)
        .backgroundColor('#FAFAFA')
        .borderRadius(8)
        .onClick(() => {
          router.pushUrl({ url: 'pages/LoginPageModern' })
        })
      }
      .width('100%')
      .padding(20)
      .backgroundColor(COLORS.surface)
      .margin({ top: 12 })
    }
  }

  private showDialog(title: string, message: string) {
    AlertDialog.show({
      title: title,
      message: message,
      primaryButton: {
        value: 'ç¡®å®š',
        action: () => {
          console.log(`å¯¹è¯æ¡†ç¡®å®šæŒ‰é’®è¢«ç‚¹å‡»`)
        }
      },
      secondaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
          console.log(`å¯¹è¯æ¡†å–æ¶ˆæŒ‰é’®è¢«ç‚¹å‡»`)
        }
      }
    })
  }

  @Builder
  ToolsSection() {
    Column() {
      Row() {
        Text('æˆ‘çš„å·¥å…·')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(COLORS.text)
      }
      .width('100%')
      .margin({ bottom: 20 })

      // å·¥å…·åˆ—è¡¨
      if (this.user) {
        Column({ space: 1 }) {
        // è´­ç‰©è½¦
        Row() {
          Row() {
            Text('ğŸ›’')
              .fontSize(22)
              .width(40)
            Column() {
              Text('è´­ç‰©è½¦')
                .fontSize(16)
                .fontColor(COLORS.text)
              Text(`${this.cartCount}ä»¶å•†å“`)
                .fontSize(12)
                .fontColor(COLORS.textSecondary)
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
            .margin({ left: 12 })
          }
          .width('100%')
          .padding(20)
          .backgroundColor(COLORS.surface)
          .onClick(() => {
            router.pushUrl({ url: 'pages/CartPage' })
          })
        }

        // åœ°å€ç®¡ç†
        Row() {
          Row() {
            Text('ğŸ“')
              .fontSize(22)
              .width(40)
            Column() {
              Text('åœ°å€ç®¡ç†')
                .fontSize(16)
                .fontColor(COLORS.text)
              Text('ç®¡ç†æ”¶è´§åœ°å€')
                .fontSize(12)
                .fontColor(COLORS.textSecondary)
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
            .margin({ left: 12 })
          }
          .width('100%')
          .padding(20)
          .backgroundColor(COLORS.surface)
          .onClick(() => {
            console.log('åœ°å€ç®¡ç†')
          })
        }

        // å®¢æœä¸­å¿ƒ
        Row() {
          Row() {
            Text('ğŸ’¬')
              .fontSize(22)
              .width(40)
            Column() {
              Text('å®¢æœä¸­å¿ƒ')
                .fontSize(16)
                .fontColor(COLORS.text)
              Text('åœ¨çº¿å®¢æœåé¦ˆ')
                .fontSize(12)
                .fontColor(COLORS.textSecondary)
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
            .margin({ left: 12 })
          }
          .width('100%')
          .padding(20)
          .backgroundColor(COLORS.surface)
          .onClick(() => {
            console.log('å®¢æœä¸­å¿ƒ')
          })
        }
      }
      .width('100%')
      .borderRadius(16)
      .margin({ top: 12 })
      }
    .width('100%')
    .padding(20)
    .backgroundColor(COLORS.background)
      } else {
        // æœªç™»å½•çŠ¶æ€çš„å·¥å…·æç¤º
        Column() {
          Row() {
            Text('ğŸ”§')
              .fontSize(20)
              .fontColor('#CCCCCC')
              .margin({ right: 12 })
            Text('ç™»å½•åä½¿ç”¨æ›´å¤šåŠŸèƒ½')
              .fontSize(16)
              .fontColor('#999999')
          }
          .justifyContent(FlexAlign.Center)
          .width('100%')
          .height(80)
          .backgroundColor('#FAFAFA')
          .borderRadius(8)
          .onClick(() => {
            router.pushUrl({ url: 'pages/LoginPageModern' })
          })
        }
        .width('100%')
        .padding(20)
        .backgroundColor(COLORS.surface)
        .margin({ top: 12 })
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(COLORS.background)
  }

  @Builder
  LogoutSection() {
    Button('é€€å‡ºç™»å½•')
      .width('100%')
      .height(48)
      .fontSize(16)
      .fontColor(COLORS.danger)
      .backgroundColor(Color.Transparent)
      .border({ width: 1, color: COLORS.danger })
      .borderRadius(24)
      .margin({ top: 20 })
      .onClick(() => {
        AlertDialog.show({
          title: 'æç¤º',
          message: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
          primaryButton: {
            value: 'ç¡®å®š',
            action: () => this.logout()
          },
          secondaryButton: {
            value: 'å–æ¶ˆ',
            action: () => {}
          }
        })
      })
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆª
        this.Header()

        // ä¸»å†…å®¹
        Scroll() {
          Column() {
            // ç”¨æˆ·ä¿¡æ¯
            this.UserInfoSection()

            // è®¢å•éƒ¨åˆ† - ç›´æ¥æ¸²æŸ“ï¼Œç»„ä»¶å†…éƒ¨ä¼šå¤„ç†ç”¨æˆ·æ˜¯å¦ç™»å½•
            this.OrderSection()
            this.ToolsSection()
            if (this.user) {
              this.LogoutSection()
            }
          }
          .width('100%')
          .padding({ bottom: 80 })
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor(COLORS.background)
        .edgeEffect(EdgeEffect.Spring)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(COLORS.background)

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor(COLORS.textSecondary)
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('rgba(0,0,0,0.5)')
        .zIndex(9999)
      }
    }
    .width('100%')
    .height('100%')
  }
}