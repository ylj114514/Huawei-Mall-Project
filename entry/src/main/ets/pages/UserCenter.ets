import router from '@ohos.router'
import { StorageManager } from '../utils/StorageManagerSimple'
import { User } from '../model/DataModel'
import common from '@ohos.app.ability.common'

interface ColorScheme {
  background: string
  primary: string
  accent: string
  secondary: string
  cardBg: string
  gold: string
  shadow: string
}

const COLORS: ColorScheme = {
  background: '#FAFAFA',
  primary: '#000000',
  accent: '#CF0A2C',
  secondary: '#666666',
  cardBg: '#FFFFFF',
  gold: '#D4AF37',
  shadow: 'rgba(0, 0, 0, 0.08)'
}

@Entry
@Component
struct UserCenter {
  @State user: User | null = null
  @State orderCount: number = 5
  @State couponCount: number = 8
  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
    this.loadUserData()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
      console.log('UserCenter: StorageManageråˆå§‹åŒ–æˆåŠŸ')
    } catch (error) {
      console.error('UserCenter: StorageManageråˆå§‹åŒ–å¤±è´¥:', error)
    }
  }

  private async loadUserData() {
    try {
      this.user = await this.storage.loadUser()
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error)
    }
  }

  private async logout() {
    try {
      await this.storage.saveUser(null)
      router.replaceUrl({ url: 'pages/LoginPage' })
    } catch (error) {
      console.error('ç™»å‡ºå¤±è´¥:', error)
    }
  }

  private onNavigate(page: string) {
    router.pushUrl({ url: page })
  }

  @Builder
  HeaderSection() {
    Column() {
      // è¿”å›žæŒ‰é’®
      Row() {
        Button() {
          Text('â†')
            .fontSize(24)
            .fontColor(COLORS.primary)
        }
        .width(48)
        .height(48)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          router.back()
        })

        Text('ä¸ªäººä¸­å¿ƒ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(COLORS.primary)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Blank()
          .width(48)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 20 })

      // ç”¨æˆ·ä¿¡æ¯
      Row() {
        // å¤´åƒ
        Text(this.user ? this.user.username[0].toUpperCase() : 'æœª')
          .fontSize(36)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Bold)
          .width(80)
          .height(80)
          .backgroundColor(COLORS.accent)
          .borderRadius(40)
          .textAlign(TextAlign.Center)

        Column() {
          Text(this.user ? this.user.username : 'æœªç™»å½•')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(COLORS.primary)
            .margin({ bottom: 4 })

          Text(this.user ? `ID: ${this.user.account}` : 'è¯·å…ˆç™»å½•')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 20 })

        if (this.user) {
          Button('é€€å‡ºç™»å½•')
            .fontSize(14)
            .fontColor(COLORS.secondary)
            .backgroundColor(COLORS.background)
            .borderRadius(20)
            .padding({ left: 20, right: 20, top: 8, bottom: 8 })
            .onClick(() => {
              this.logout()
            })
        }
      }
      .width('100%')
      .padding(20)
      .backgroundColor(COLORS.cardBg)
      .borderRadius(16)
      .shadow({
        radius: 10,
        color: COLORS.shadow,
        offsetX: 0,
        offsetY: 2
      })
      .margin({ bottom: 20 })
    }
  }

  @Builder
  OrderSection() {
    Column() {
      Row() {
        Text('æˆ‘çš„è®¢å•')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor(COLORS.primary)
          .layoutWeight(1)

        Text('å…¨éƒ¨è®¢å• >')
          .fontSize(14)
          .fontColor(COLORS.secondary)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 16 })

      Row() {
        Column() {
          Text('ðŸ’³')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('å¾…ä»˜æ¬¾')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)

        Column() {
          Text('ðŸ“¦')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('å¾…å‘è´§')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)

        Column() {
          Text('ðŸšš')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('å¾…æ”¶è´§')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)

        Column() {
          Text('â­')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('å¾…è¯„ä»·')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(COLORS.cardBg)
    .borderRadius(16)
    .shadow({
      radius: 10,
      color: COLORS.shadow,
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 20 })
  }

  @Builder
  ToolSection() {
    Column({ space: 1 }) {
      // æ”¶è—
      Row() {
        Text('â¤ï¸')
          .fontSize(24)
          .width(40)

        Text('æˆ‘çš„æ”¶è—')
          .fontSize(16)
          .fontColor(COLORS.primary)
          .layoutWeight(1)

        Text('>')
          .fontSize(18)
          .fontColor(COLORS.secondary)
      }
      .width('100%')
      .padding(20)
      .backgroundColor(COLORS.cardBg)
      .onClick(() => {
        this.onNavigate('pages/FavoritePage')
      })

      // è´­ç‰©è½¦
      Row() {
        Text('ðŸ›’')
          .fontSize(24)
          .width(40)

        Text('è´­ç‰©è½¦')
          .fontSize(16)
          .fontColor(COLORS.primary)
          .layoutWeight(1)

        Text('>')
          .fontSize(18)
          .fontColor(COLORS.secondary)
      }
      .width('100%')
      .padding(20)
      .backgroundColor(COLORS.cardBg)
      .onClick(() => {
        this.onNavigate('pages/CartPageNew')
      })

      // åœ°å€ç®¡ç†
      Row() {
        Text('ðŸ“')
          .fontSize(24)
          .width(40)

        Text('æ”¶è´§åœ°å€')
          .fontSize(16)
          .fontColor(COLORS.primary)
          .layoutWeight(1)

        Text('>')
          .fontSize(18)
          .fontColor(COLORS.secondary)
      }
      .width('100%')
      .padding(20)
      .backgroundColor(COLORS.cardBg)
      .onClick(() => {
        this.onNavigate('pages/AddressManagePage')
      })

      // å®¢æœ
      Row() {
        Text('ðŸŽ§')
          .fontSize(24)
          .width(40)

        Text('å®¢æœä¸­å¿ƒ')
          .fontSize(16)
          .fontColor(COLORS.primary)
          .layoutWeight(1)

        Text('>')
          .fontSize(18)
          .fontColor(COLORS.secondary)
      }
      .width('100%')
      .padding(20)
      .backgroundColor(COLORS.cardBg)

      // è®¾ç½®
      Row() {
        Text('âš™ï¸')
          .fontSize(24)
          .width(40)

        Text('è®¾ç½®')
          .fontSize(16)
          .fontColor(COLORS.primary)
          .layoutWeight(1)

        Text('>')
          .fontSize(18)
          .fontColor(COLORS.secondary)
      }
      .width('100%')
      .padding(20)
      .backgroundColor(COLORS.cardBg)
    }
    .width('100%')
    .borderRadius(16)
    .shadow({
      radius: 10,
      color: COLORS.shadow,
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 20 })
  }

  build() {
    Column() {
      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          this.HeaderSection()
          this.OrderSection()
          this.ToolSection()
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor(COLORS.background)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(COLORS.background)
  }
}