import router from '@ohos.router'
import { StorageManager } from '../utils/StorageManagerSimple'
import { User } from '../model/DataModel'
import common from '@ohos.app.ability.common'

interface ColorScheme {
  background: string
  primary: string
  accent: string
  secondary: string
  cardBg: string
  gold: string
  shadow: string
  darkBg: string
  yellowCard: string
  yellowCardText: string
}

const COLORS: ColorScheme = {
  background: '#F5F5F5',
  primary: '#000000',
  accent: '#CF0A2C',
  secondary: '#666666',
  cardBg: '#FFFFFF',
  gold: '#D4AF37',
  shadow: 'rgba(0, 0, 0, 0.08)',
  darkBg: '#2F2F2F',
  yellowCard: '#FFD700',
  yellowCardText: '#8B6914'
}

@Entry
@Component
struct UserCenter {
  @State user: User | null = null
  @State orderCount: number = 5
  @State couponCount: number = 8
  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
    this.loadUserData()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
      console.log('UserCenter: StorageManagerÂàùÂßãÂåñÊàêÂäü')
    } catch (error) {
      console.error('UserCenter: StorageManagerÂàùÂßãÂåñÂ§±Ë¥•:', error)
    }
  }

  private async loadUserData() {
    try {
      this.user = await this.storage.loadUser()
    } catch (error) {
      console.error('Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', error)
    }
  }

  private async logout() {
    try {
      await this.storage.saveUser(null)
      router.replaceUrl({ url: 'pages/LoginPage' })
    } catch (error) {
      console.error('ÁôªÂá∫Â§±Ë¥•:', error)
    }
  }

  private onNavigate(page: string) {
    router.pushUrl({ url: page })
  }

  @Builder
  HeaderSection() {
    Column() {
      // È°∂ÈÉ®Ê∑±Ëâ≤ËÉåÊôØÂå∫Âüü
      Column() {
        // ËøîÂõûÊåâÈíÆÂíåËÆæÁΩÆ
        Row() {
          Button() {
            Text('‚Üê')
              .fontSize(24)
              .fontColor(Color.White)
          }
          .width(48)
          .height(48)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.back()
          })

          Text('ÊàëÁöÑ')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Row() {
            Text('‚Ä¢‚Ä¢‚Ä¢')
              .fontSize(24)
              .fontColor(Color.White)
              .margin({ right: 20 })
            Text('üîç')
              .fontSize(24)
              .fontColor(Color.White)
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 20, bottom: 10 })

        // Áî®Êà∑‰ø°ÊÅØ
        Row() {
          // Â§¥ÂÉè
          Text(this.user ? this.user.username[0].toUpperCase() : 'i')
            .fontSize(36)
            .fontColor('#FF7F50')
            .fontWeight(FontWeight.Bold)
            .width(80)
            .height(80)
            .backgroundColor(Color.White)
            .borderRadius(40)
            .textAlign(TextAlign.Center)

          Column() {
            Text(this.user ? 'ÁÇπÂáªÁôªÂΩï' : 'ÁÇπÂáªÁôªÂΩï')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .margin({ bottom: 4 })

            Text(this.user ? this.user.username : 'ÁôªÂΩïÊõ¥Á≤æÂΩ©')
              .fontSize(14)
              .fontColor('#CCCCCC')
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
          .margin({ left: 20 })
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 20 })

        // Á§ºÂà∏ÂíåÊî∂ÁõäÂç°Áâá
        Row() {
          // Á§ºÂà∏‰ΩôÈ¢ù
          Column() {
            Text('Á§ºÂà∏‰ΩôÈ¢ù')
              .fontSize(14)
              .fontColor(COLORS.yellowCardText)
              .margin({ bottom: 8 })
            Text('0')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(COLORS.yellowCardText)
              .margin({ bottom: 16 })
            Button('Á´ãÂç≥Êü•Áúã')
              .fontSize(14)
              .fontColor(COLORS.yellowCardText)
              .backgroundColor('#FFFFFF')
              .borderRadius(20)
              .padding({ left: 20, right: 20, top: 6, bottom: 6 })
          }
          .width('50%')
          .height(120)
          .padding(20)
          .backgroundColor(COLORS.yellowCard)
          .borderRadius({ topLeft: 12, bottomLeft: 12 })
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)

          // Êî∂Áõä‰ΩôÈ¢ù
          Column() {
            Text('Êî∂Áõä‰ΩôÈ¢ù (ÂÖÉ)')
              .fontSize(14)
              .fontColor(COLORS.yellowCardText)
              .margin({ bottom: 8 })
            Text('0')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(COLORS.yellowCardText)
              .margin({ bottom: 16 })
            Button('Á´ãÂç≥ÊèêÁé∞')
              .fontSize(14)
              .fontColor(COLORS.yellowCardText)
              .backgroundColor('#FFFFFF')
              .borderRadius(20)
              .padding({ left: 20, right: 20, top: 6, bottom: 6 })
          }
          .width('50%')
          .height(120)
          .padding(20)
          .backgroundColor(COLORS.yellowCard)
          .borderRadius({ topRight: 12, bottomRight: 12 })
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
        .width('90%')
        .margin({ bottom: -40 })
        .shadow({
          radius: 10,
          color: 'rgba(0, 0, 0, 0.1)',
          offsetX: 0,
          offsetY: 4
        })
      }
      .width('100%')
      .backgroundColor(COLORS.darkBg)
      .padding({ bottom: 40 })
    }
  }

  @Builder
  OrderSection() {
    Column() {
      Row() {
        Text('ÊàëÁöÑËÆ¢Âçï')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor(COLORS.primary)
          .layoutWeight(1)

        Text('Êü•ÁúãÂÖ®ÈÉ® >')
          .fontSize(14)
          .fontColor(COLORS.secondary)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 16 })

      Row() {
        Column() {
          Row() {
            Column() {
              Text('üí≥')
                .fontSize(32)
                .backgroundColor('#FFF0F5')
                .width(60)
                .height(60)
                .borderRadius(30)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
            }
          }
          .margin({ bottom: 8 })
          Text('ÂæÖ‰ªòÊ¨æ')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)

        Column() {
          Row() {
            Column() {
              Text('üì¶')
                .fontSize(32)
                .backgroundColor('#F0F8FF')
                .width(60)
                .height(60)
                .borderRadius(30)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
            }
          }
          .margin({ bottom: 8 })
          Text('ÂæÖÂèëË¥ß')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)

        Column() {
          Row() {
            Column() {
              Text('üöö')
                .fontSize(32)
                .backgroundColor('#F0FFF0')
                .width(60)
                .height(60)
                .borderRadius(30)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
            }
          }
          .margin({ bottom: 8 })
          Text('ÂæÖÊî∂Ë¥ß')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)

        Column() {
          Row() {
            Column() {
              Text('üîÑ')
                .fontSize(32)
                .backgroundColor('#FFFFF0')
                .width(60)
                .height(60)
                .borderRadius(30)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
            }
          }
          .margin({ bottom: 8 })
          Text('ÈÄÄÊç¢/ÂîÆÂêé')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(COLORS.cardBg)
    .borderRadius(16)
    .shadow({
      radius: 10,
      color: COLORS.shadow,
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 20 })
  }

  @Builder
  ToolSection() {
    Column({ space: 1 }) {
      // ÊúçÂä°Ê†áÈ¢ò
      Text('ÊàëÁöÑÊúçÂä°')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(COLORS.primary)
        .width('100%')
        .padding(20)
        .backgroundColor(COLORS.cardBg)

      // Á¨¨‰∏ÄË°åÊúçÂä°
      Row() {
        Column() {
          Text('üìç')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('Êî∂Ë¥ßÂú∞ÂùÄ')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)
        .padding(16)
        .backgroundColor(COLORS.cardBg)
        .onClick(() => {
          this.onNavigate('pages/AddressManagePage')
        })

        Column() {
          Text('üë§')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('ÈîÄÂîÆÂÆ¢Êúç')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)
        .padding(16)
        .backgroundColor(COLORS.cardBg)

        Column() {
          Text('üì¶')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('ÊàëÁöÑÂåÖÂõæ')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)
        .padding(16)
        .backgroundColor(COLORS.cardBg)

        Column() {
          Text('üì§')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('ÂàÜ‰∫´Â•ΩÂèã')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)
        .padding(16)
        .backgroundColor(COLORS.cardBg)
      }

      // Á¨¨‰∫åË°åÊúçÂä°
      Row() {
        Column() {
          Text('üìñ')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('Êñ∞ÊâãÊïôÁ®ã')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)
        .padding(16)
        .backgroundColor(COLORS.cardBg)

        Column() {
          Text('‚ù§Ô∏è')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('ÊàëÁöÑÊî∂Ëóè')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)
        .padding(16)
        .backgroundColor(COLORS.cardBg)
        .onClick(() => {
          this.onNavigate('pages/FavoritePage')
        })

        Column() {
          Text('üõí')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('Ë¥≠Áâ©ËΩ¶')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)
        .padding(16)
        .backgroundColor(COLORS.cardBg)
        .onClick(() => {
          this.onNavigate('pages/CartPageNew')
        })

        Column() {
          Text('üéß')
            .fontSize(32)
            .margin({ bottom: 8 })
          Text('ÂÆ¢Êúç‰∏≠ÂøÉ')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .width('25%')
        .alignItems(HorizontalAlign.Center)
        .padding(16)
        .backgroundColor(COLORS.cardBg)
      }

      // ÂÖ≥‰∫éÊàë‰ª¨
      Text('ÂÖ≥‰∫éÊàë‰ª¨')
        .fontSize(16)
        .fontColor(COLORS.primary)
        .width('100%')
        .padding(20)
        .backgroundColor(COLORS.cardBg)
    }
    .width('100%')
    .borderRadius(16)
    .shadow({
      radius: 10,
      color: COLORS.shadow,
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 20 })
  }

  build() {
    Column() {
      // ÂÜÖÂÆπÂå∫Âüü
      Scroll() {
        Column() {
          this.HeaderSection()
          this.OrderSection()
          this.ToolSection()
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor(COLORS.background)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(COLORS.background)
  }
}