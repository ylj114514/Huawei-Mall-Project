import router from '@ohos.router'
import { StorageManager } from '../utils/StorageManagerSimple'
import { User } from '../model/DataModel'
import common from '@ohos.app.ability.common'

interface ColorScheme {
  background: string
  primary: string
  accent: string
  secondary: string
  cardBg: string
  gold: string
  shadow: string
  headerBg: string
  headerBgLight: string
  textLight: string
  textSecondary: string
}

const COLORS: ColorScheme = {
  background: '#F8F9FA',
  primary: '#1976D2',
  accent: '#FF4081',
  secondary: '#424242',
  cardBg: '#FFFFFF',
  gold: '#FFB300',
  shadow: 'rgba(0, 0, 0, 0.1)',
  headerBg: '#1976D2',
  headerBgLight: '#42A5F5',
  textLight: '#FFFFFF',
  textSecondary: '#757575'
}

@Entry
@Component
struct UserCenter {
  @State user: User | null = null
  @State orderCount: number = 5
  @State couponCount: number = 8
  @State orders: { status: string, icon: string, count: number }[] = [
    { status: 'å¾…ä»˜æ¬¾', icon: 'ðŸ’³', count: 2 },
    { status: 'å¾…å‘è´§', icon: 'ðŸ“¦', count: 1 },
    { status: 'å¾…æ”¶è´§', icon: 'ðŸšš', count: 3 },
    { status: 'é€€æ¢/å”®åŽ', icon: 'ðŸ”„', count: 0 }
  ]
  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
    this.loadUserData()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
      console.log('UserCenter: StorageManageråˆå§‹åŒ–æˆåŠŸ')
    } catch (error) {
      console.error('UserCenter: StorageManageråˆå§‹åŒ–å¤±è´¥:', error)
    }
  }

  private async loadUserData() {
    try {
      this.user = await this.storage.loadUser()
      // æ¨¡æ‹ŸåŠ è½½è®¢å•æ•°æ®
      this.orders = [
        { status: 'å¾…ä»˜æ¬¾', icon: 'ðŸ’³', count: Math.floor(Math.random() * 5) },
        { status: 'å¾…å‘è´§', icon: 'ðŸ“¦', count: Math.floor(Math.random() * 3) },
        { status: 'å¾…æ”¶è´§', icon: 'ðŸšš', count: Math.floor(Math.random() * 4) },
        { status: 'é€€æ¢/å”®åŽ', icon: 'ðŸ”„', count: Math.floor(Math.random() * 2) }
      ]
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error)
    }
  }

  private async logout() {
    try {
      await this.storage.saveUser(null)
      router.replaceUrl({ url: 'pages/LoginPage' })
    } catch (error) {
      console.error('ç™»å‡ºå¤±è´¥:', error)
    }
  }

  private onNavigate(page: string) {
    router.pushUrl({ url: page })
  }

  @Builder
  HeaderSection() {
    Column() {
      // é¡¶éƒ¨æ¸å˜èƒŒæ™¯åŒºåŸŸ
      Column() {
        // è¿”å›žæŒ‰é’®å’Œè®¾ç½®
        Row() {
          Button() {
            Text('â†')
              .fontSize(24)
              .fontColor(Color.White)
          }
          .width(48)
          .height(48)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.back()
          })

          Text('æˆ‘çš„')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Row() {
            Button() {
              Text('â€¢â€¢â€¢')
                .fontSize(24)
                .fontColor(Color.White)
            }
            .width(48)
            .height(48)
            .backgroundColor(Color.Transparent)
            .margin({ right: 16 })
            .onClick(() => {
              // è®¾ç½®åŠŸèƒ½
            })
            Button() {
              Text('ðŸ”')
                .fontSize(24)
                .fontColor(Color.White)
            }
            .width(48)
            .height(48)
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              // æœç´¢åŠŸèƒ½
            })
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 20, bottom: 10 })

        // ç”¨æˆ·ä¿¡æ¯
        Row() {
          // å¤´åƒ
          Text(this.user ? this.user.username[0].toUpperCase() : 'U')
            .fontSize(36)
            .fontColor(COLORS.accent)
            .width(80)
            .height(80)
            .backgroundColor(Color.White)
            .borderRadius(40)
            .textAlign(TextAlign.Center)
            .lineHeight(80)
            .shadow({
              radius: 8,
              color: 'rgba(0, 0, 0, 0.15)',
              offsetX: 0,
              offsetY: 4
            })

          Column() {
            Text(this.user ? this.user.username : 'æœªç™»å½•')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(COLORS.textLight)
              .margin({ bottom: 4 })

            if (!this.user) {
              Button('åŽ»ç™»å½•')
                .fontSize(14)
                .fontColor(COLORS.textLight)
                .backgroundColor('rgba(255, 255, 255, 0.2)')
                .borderRadius(16)
                .padding({ left: 16, right: 16, top: 4, bottom: 4 })
                .onClick(() => {
                  router.pushUrl({ url: 'pages/LoginPageModern' })
                })
            } else {
              Text(this.user.phone || '')
                .fontSize(14)
                .fontColor('rgba(255, 255, 255, 0.8)')
            }
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
          .margin({ left: 20 })
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 20 })

        // ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ
        Row() {
          // å¾…ä»˜æ¬¾è®¢å•
          Column() {
            Text(this.orders[0].count.toString())
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor(COLORS.accent)
              .margin({ bottom: 4 })
            Text('å¾…ä»˜æ¬¾')
              .fontSize(14)
              .fontColor(COLORS.textLight)
              .opacity(0.9)
          }
          .width('25%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .onClick(() => {
            this.onNavigate('pages/OrderListPage?status=unpaid')
          })

          // å¾…å‘è´§è®¢å•
          Column() {
            Text(this.orders[1].count.toString())
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor(COLORS.accent)
              .margin({ bottom: 4 })
            Text('å¾…å‘è´§')
              .fontSize(14)
              .fontColor(COLORS.textLight)
              .opacity(0.9)
          }
          .width('25%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .onClick(() => {
            this.onNavigate('pages/OrderListPage?status=shipping')
          })

          // å¾…æ”¶è´§è®¢å•
          Column() {
            Text(this.orders[2].count.toString())
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor(COLORS.accent)
              .margin({ bottom: 4 })
            Text('å¾…æ”¶è´§')
              .fontSize(14)
              .fontColor(COLORS.textLight)
              .opacity(0.9)
          }
          .width('25%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .onClick(() => {
            this.onNavigate('pages/OrderListPage?status=delivering')
          })

          // å¾…è¯„ä»·è®¢å•
          Column() {
            Text(this.orders[3].count.toString())
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor(COLORS.accent)
              .margin({ bottom: 4 })
            Text('å¾…è¯„ä»·')
              .fontSize(14)
              .fontColor(COLORS.textLight)
              .opacity(0.9)
          }
          .width('25%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .onClick(() => {
            this.onNavigate('pages/OrderListPage?status=review')
          })
        }
        .width('90%')
        .padding(20)
        .backgroundColor('rgba(255, 255, 255, 0.1)')
        .borderRadius(16)
        .margin({ bottom: -40 })
        .shadow({
          radius: 10,
          color: 'rgba(0, 0, 0, 0.1)',
          offsetX: 0,
          offsetY: 4
        })
      }
      .width('100%')
      .backgroundLinearGradient({
        colors: [COLORS.headerBg, COLORS.headerBgLight],
        direction: GradientDirection.Top
      })
      .padding({ bottom: 40 })
    }
  }

  @Builder
  OrderSection() {
    Column() {
      Row() {
        Text('æˆ‘çš„è®¢å•')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor(COLORS.primary)
          .layoutWeight(1)

        Button() {
          Text('æŸ¥çœ‹å…¨éƒ¨ >')
            .fontSize(14)
            .fontColor(COLORS.secondary)
        }
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.onNavigate('pages/OrderListPage')
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 16 })

      Row() {
        ForEach(this.orders, (order, index) => {
          Column() {
            Row() {
              Column() {
                Stack() {
                  Text(order.icon)
                    .fontSize(32)
                  if (order.count > 0) {
                    Text(order.count.toString())
                      .fontSize(12)
                      .fontWeight(FontWeight.Bold)
                      .fontColor(Color.White)
                      .backgroundColor(COLORS.accent)
                      .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                      .borderRadius(10)
                      .align(Alignment.TopEnd)
                      .position({ x: 35, y: -5 })
                  }
                }
                .width(60)
                .height(60)
                .borderRadius(30)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
                .backgroundColor(this.getIconBgColor(index))
                .shadow({
                  radius: 4,
                  color: 'rgba(0, 0, 0, 0.05)',
                  offsetX: 0,
                  offsetY: 2
                })
              }
            }
            .margin({ bottom: 8 })
            Text(order.status)
              .fontSize(14)
              .fontColor(COLORS.secondary)
          }
          .width('25%')
          .alignItems(HorizontalAlign.Center)
          .onClick(() => {
            const statusMap = ['unpaid', 'shipping', 'delivering', 'aftersale']
            this.onNavigate(`pages/OrderListPage?status=${statusMap[index]}`)
          })
        })
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(COLORS.cardBg)
    .borderRadius(16)
    .shadow({
      radius: 10,
      color: COLORS.shadow,
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 20 })
  }

  @Builder
  ToolSection() {
    Column({ space: 1 }) {
      // æœåŠ¡æ ‡é¢˜
      Text('æˆ‘çš„æœåŠ¡')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(COLORS.primary)
        .width('100%')
        .padding(20)
        .backgroundColor(COLORS.cardBg)

      // ç¬¬ä¸€è¡ŒæœåŠ¡
      Row() {
        this.ToolItem('ðŸ“', 'æ”¶è´§åœ°å€', 0, () => {
          this.onNavigate('pages/AddressManagePage')
        })
        this.ToolItem('ðŸ‘¤', 'é”€å”®å®¢æœ', 1)
        this.ToolItem('ðŸ“¦', 'æˆ‘çš„åŒ…å›¾', 2)
        this.ToolItem('ðŸ“¤', 'åˆ†äº«å¥½å‹', 3)
      }

      // ç¬¬äºŒè¡ŒæœåŠ¡
      Row() {
        this.ToolItem('ðŸ“–', 'æ–°æ‰‹æ•™ç¨‹', 4)
        this.ToolItem('â¤ï¸', 'æˆ‘çš„æ”¶è—', 5, () => {
          this.onNavigate('pages/FavoritePage')
        })
        this.ToolItem('ðŸ›’', 'è´­ç‰©è½¦', 6, () => {
          this.onNavigate('pages/CartPageNew')
        })
        this.ToolItem('ðŸŽ§', 'å®¢æœä¸­å¿ƒ', 7)
      }

      // é€€å‡ºç™»å½•æŒ‰é’®ï¼ˆå¦‚æžœå·²ç™»å½•ï¼‰
      if (this.user) {
        Button('é€€å‡ºç™»å½•')
          .fontSize(16)
          .fontColor(COLORS.primary)
          .backgroundColor(Color.Transparent)
          .width('100%')
          .padding(20)
          .borderRadius(0)
          .onClick(() => {
            this.logout()
          })
      }
    }
    .width('100%')
    .borderRadius(16)
    .shadow({
      radius: 10,
      color: COLORS.shadow,
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 20 })
  }

  @Builder
  ToolItem(icon: string, text: string, index: number, onClick?: () => void) {
    Column() {
      Row() {
        Text(icon)
          .fontSize(32)
          .backgroundColor(this.getIconBgColor(index))
          .width(60)
          .height(60)
          .borderRadius(30)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .shadow({
            radius: 4,
            color: 'rgba(0, 0, 0, 0.05)',
            offsetX: 0,
            offsetY: 2
          })
      }
      .margin({ bottom: 8 })
      Text(text)
        .fontSize(14)
        .fontColor(COLORS.textSecondary)
    }
    .width('25%')
    .alignItems(HorizontalAlign.Center)
    .padding(16)
    .backgroundColor(COLORS.cardBg)
    .onClick(() => {
      if (onClick) onClick()
    })
  }

  private getIconBgColor(index: number): string {
    const colors = ['#FFF0F5', '#F0F8FF', '#F0FFF0', '#FFFFF0', '#F5F5F5', '#FFF5EE', '#F0F8FF', '#F5FFFA']
    return colors[index % colors.length]
  }

  build() {
    Column() {
      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          this.HeaderSection()
          this.OrderSection()
          this.ToolSection()
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor(COLORS.background)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(COLORS.background)
  }
}