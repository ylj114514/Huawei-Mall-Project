import router from '@ohos.router'

// ==========================================
// 1. å®šä¹‰ç±»æ¨¡å‹ (è§£å†³ä¸¥æ ¼æ¨¡å¼ Object literal æŠ¥é”™)
// ==========================================
class User {
  username: string = ''
}

class Comment {
  id: string = ''
  userId: string = ''
  username: string = ''
  avatar: string | Resource = ''
  productId: string = ''
  content: string = ''
  rating: number = 0
  timestamp: number = 0

  // è¾…åŠ©æ–¹æ³•ï¼šæ ¼å¼åŒ–æ—¶é—´
  getFormattedTime(): string {
    const date = new Date(this.timestamp)
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`
  }
}

// ==========================================
// 2. æœ¬åœ°æ¨¡æ‹Ÿå­˜å‚¨æœåŠ¡ (è§£å†³ä¾èµ–ç¼ºå¤±æŠ¥é”™)
// ==========================================
class LocalStorageUtils {
  // æ¨¡æ‹Ÿè·å–å½“å‰ç™»å½•ç”¨æˆ·
  static async loadUser(): Promise<User> {
    return new Promise((resolve) => {
      setTimeout(() => {
        // å¿…é¡»å®ä¾‹åŒ–ç±»
        let user = new User()
        user.username = 'user_001'
        resolve(user)
      }, 500)
    })
  }

  // æ¨¡æ‹Ÿè·å–æ‰€æœ‰è¯„è®ºæ•°æ®
  static async loadComments(): Promise<Comment[]> {
    return new Promise((resolve) => {
      setTimeout(() => {
        // åˆ›å»ºè¯„è®º1
        let c1 = new Comment()
        c1.id = '1'
        c1.userId = 'user_001'
        c1.username = 'user_001'
        c1.productId = '1001'
        c1.content = 'æ‰‹æœºéå¸¸å¥½ç”¨ï¼Œè¿è¡Œæµç•…ï¼Œæ‹ç…§ä¹Ÿå¾ˆæ¸…æ™°ï¼'
        c1.rating = 5
        c1.timestamp = 1709856000000

        // åˆ›å»ºè¯„è®º2
        let c2 = new Comment()
        c2.id = '2'
        c2.userId = 'user_001'
        c2.username = 'user_001'
        c2.productId = '1002'
        c2.content = 'ç‰©æµå¾ˆå¿«ï¼Œä½†æ˜¯åŒ…è£…ç¨å¾®æœ‰ç‚¹ç ´æŸï¼Œå¸Œæœ›æ”¹è¿›ã€‚'
        c2.rating = 4
        c2.timestamp = 1709942400000

        resolve([c1, c2])
      }, 800)
    })
  }

  // æ¨¡æ‹Ÿåˆ é™¤è¯„è®º
  static async deleteComment(commentId: string): Promise<boolean> {
    return new Promise((resolve) => {
      setTimeout(() => {
        console.info(`æ¨¡æ‹Ÿåˆ é™¤è¯„è®º: ${commentId}`)
        resolve(true)
      }, 500)
    })
  }
}

// ==========================================
// 3. é¡µé¢ç»„ä»¶
// ==========================================
@Entry
@Component
struct MyReviewsPage {
  @State userReviews: Comment[] = []
  @State isLoading: boolean = true
  @State currentUserId: string = ''
  @State currentUsername: string = ''

  aboutToAppear() {
    this.loadUserData()
    this.loadUserReviews()
  }

  private async loadUserData(): Promise<void> {
    try {
      const user = await LocalStorageUtils.loadUser()
      if (user) {
        this.currentUserId = user.username
        this.currentUsername = user.username
      } else {
        router.back()
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', JSON.stringify(error))
    }
  }

  private async loadUserReviews(): Promise<void> {
    try {
      this.isLoading = true
      const allComments = await LocalStorageUtils.loadComments()
      if (allComments) {
        this.userReviews = allComments.filter((comment: Comment) => comment.userId === this.currentUserId)
      }
      this.isLoading = false
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·è¯„ä»·å¤±è´¥:', JSON.stringify(error))
      this.isLoading = false
    }
  }

  private async deleteReview(reviewId: string): Promise<void> {
    try {
      await LocalStorageUtils.deleteComment(reviewId)
      // æœ¬åœ°ç§»é™¤
      this.userReviews = this.userReviews.filter((item) => item.id !== reviewId)
      console.info('è¯„ä»·åˆ é™¤æˆåŠŸ')
    } catch (error) {
      console.error('åˆ é™¤è¯„ä»·å¤±è´¥:', JSON.stringify(error))
    }
  }

  private goToProductDetail(productId: string): void {
    router.pushUrl({
      url: 'pages/ProductDetailPage',
      params: { productId: productId }
    })
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â†')
          .width(40)
          .height(40)
          .backgroundColor(Color.Transparent)
          .fontColor(Color.White)
          .fontSize(18)
          .onClick(() => {
            router.back()
          })

        Text('æˆ‘çš„è¯„ä»·')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .fontColor(Color.White)

        Blank().width(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor($r('app.color.primary'))
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      } else {
        if (this.userReviews.length === 0) {
          // ç©ºçŠ¶æ€
          Column() {
            Text('ğŸ“')
              .fontSize(60)
              .margin({ bottom: 16 })
            Text('æš‚æ— è¯„ä»·')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 8 })
            Text('æ‚¨è¿˜æ²¡æœ‰å‘è¡¨ä»»ä½•å•†å“è¯„ä»·')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
            Button('å»è´­ç‰©')
              .height(36)
              .fontSize(14)
              .margin({ top: 16 })
              .backgroundColor($r('app.color.primary'))
              .fontColor(Color.White)
              .onClick(() => {
                router.replaceUrl({ url: 'pages/Index' })
              })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .backgroundColor($r('app.color.background'))
        } else {
          // è¯„ä»·åˆ—è¡¨
          Scroll() {
            Column() {
              ForEach(this.userReviews, (review: Comment) => {
                Column() {
                  Row() {
                    Text('ğŸ‘¤')
                      .fontSize(40)
                      .margin({ right: 12 })

                    Column() {
                      Row() {
                        Text(review.username)
                          .fontSize(14)
                          .fontWeight(FontWeight.Medium)
                          .fontColor($r('app.color.text_primary'))

                        Text(review.getFormattedTime())
                          .fontSize(12)
                          .fontColor($r('app.color.text_secondary'))
                          .margin({ left: 8 })
                      }
                      .width('100%')

                      Row() {
                        ForEach([1, 2, 3, 4, 5], (star: number) => {
                          Text(star <= review.rating ? 'â˜…' : 'â˜†')
                            .fontSize(12)
                            .fontColor(star <= review.rating ? $r('app.color.primary') : $r('app.color.text_secondary'))
                        })
                      }
                      .width('100%')
                      .margin({ top: 4 })
                    }
                    .layoutWeight(1)
                  }
                  .width('100%')

                  // è¯„ä»·å†…å®¹
                  Text(review.content)
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                    .lineHeight(20)
                    .width('100%')
                    .margin({ top: 12 })

                  // å•†å“ä¿¡æ¯
                  Row() {
                    Text('ğŸ›ï¸')
                      .fontSize(16)
                      .margin({ right: 8 })
                    Text('å•†å“ID: ' + review.productId)
                      .fontSize(12)
                      .fontColor($r('app.color.text_secondary'))
                    Blank()
                    Button('æŸ¥çœ‹å•†å“')
                      .height(28)
                      .fontSize(12)
                      .backgroundColor($r('app.color.primary'))
                      .fontColor(Color.White)
                      .onClick(() => this.goToProductDetail(review.productId))
                  }
                  .width('100%')
                  .alignItems(VerticalAlign.Center)
                  .margin({ top: 12 })

                  // åº•éƒ¨æ“ä½œæ 
                  Row() {
                    Button('åˆ é™¤è¯„ä»·')
                      .height(32)
                      .fontSize(12)
                      .backgroundColor($r('app.color.error'))
                      .fontColor(Color.White)
                      .onClick(() => {
                        this.deleteReview(review.id)
                      })
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.End)
                  .margin({ top: 8, bottom: 12 })
                }
                .width('100%')
                .padding(16)
                .backgroundColor($r('app.color.white'))
                .borderRadius(8)
                .margin({ left: 16, right: 16, bottom: 12 })
                .border({
                  width: 1,
                  color: '#F0F0F0'
                })
              })
            }
            .width('100%')
            .padding({ top: 16, bottom: 20 })
          }
          .width('100%')
          .layoutWeight(1)
          .scrollBar(BarState.Auto)
          .edgeEffect(EdgeEffect.Spring)
          .backgroundColor($r('app.color.background'))
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}