import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { CartService } from '../services/CartService'
import { FavoriteService } from '../services/FavoriteService'
import { CommentSectionNew } from '../components/CommentSectionNew'

interface ProductParam {
  label: string
  value: string
}

@Entry
@Component
struct ProductDetailPageEnhanced {
  @State product: ProductModel | null = null
  @State currentImageIndex: number = 0
  @State quantity: number = 1
  @State isLoading: boolean = true
  @State showCartDialog: boolean = false
  @State showAlreadyInCartDialog: boolean = false
  @State scrollY: number = 0
  @State imageHeight: number = 375
  @State isFavorite: boolean = false
  @State showSpecSelector: boolean = false
  @State selectedSpec: string = 'é»˜è®¤è§„æ ¼'
  @State scrollPercent: number = 0
  @State navBgOpacity: number = 0
  private cartService: CartService = CartService.getInstance()
  private favoriteService: FavoriteService = FavoriteService.getInstance()

  aboutToAppear() {
    this.loadProductData()
  }

  private async loadProductData() {
    interface RouteParams {
      productId: string
    }
    const params = router.getParams() as RouteParams
    if (params && params.productId) {
      const products = MockData.generateProducts()
      this.product = products.find(p => p.id === params.productId) || null

      // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
      if (this.product) {
        const favResult = await this.favoriteService.isFavorite(this.product.id)
        this.isFavorite = favResult ? favResult : false
      }
    }
    this.isLoading = false
  }

  private onImageChange(index: number) {
    this.currentImageIndex = index
  }

  private onQuantityChange(change: number) {
    const newQuantity = this.quantity + change
    if (newQuantity >= 1 && newQuantity <= (this.product?.stock || 0)) {
      this.quantity = newQuantity
    }
  }

  private async onToggleFavorite() {
    if (!this.product) return

    try {
      const isFav = await this.favoriteService.isFavorite(this.product.id)
      if (isFav) {
        await this.favoriteService.removeFromFavorites(this.product.id)
        this.isFavorite = false
      } else {
        await this.favoriteService.addToFavorites(this.product)
        this.isFavorite = true
      }
    } catch (error) {
      console.error('åˆ‡æ¢æ”¶è—çŠ¶æ€å¤±è´¥:', error)
    }
  }

  private onAddToCart() {
    if (!this.product) return

    if (this.quantity > this.product.stock) {
      console.error('åº“å­˜ä¸è¶³')
      return
    }

    try {
      if (this.cartService.isProductInCart(this.product.id)) {
        this.showAlreadyInCartDialog = true
      } else {
        const success = this.cartService.addToCart(this.product, this.quantity)
        if (!success) {
          console.error('æ·»åŠ åˆ°è´­ç‰©è½¦å¤±è´¥')
          return
        }
        console.log('æ·»åŠ åˆ°è´­ç‰©è½¦æˆåŠŸ')
        this.showCartSuccessDialog()
      }
    } catch (error) {
      console.error('æ·»åŠ åˆ°è´­ç‰©è½¦å¼‚å¸¸:', error)
    }
  }

  private showCartSuccessDialog(): void {
    this.showCartDialog = true
  }

  private goToCart(): void {
    this.showCartDialog = false
    router.pushUrl({ url: 'pages/CartPageNew' })
  }

  private continueShopping(): void {
    this.showCartDialog = false
  }

  private closeAlreadyInCartDialog(): void {
    this.showAlreadyInCartDialog = false
  }

  private onBuyNow() {
    if (!this.product) return
    console.log('ç«‹å³è´­ä¹°:', this.product.name, 'æ•°é‡:', this.quantity)
  }

  private onScroll(xOffset: number, yOffset: number, scrollHeight: number) {
    this.scrollY = yOffset
    this.scrollPercent = yOffset / (scrollHeight - 720) // 720æ˜¯å¯è§†åŒºåŸŸé«˜åº¦
    this.navBgOpacity = Math.min(this.scrollPercent * 2, 0.95)
  }

  @Builder
  NavigationBar() {
    Row() {
      // è¿”å›žæŒ‰é’®
      Button() {
        Row() {
          Text('â†')
            .fontSize(20)
            .fontColor(this.navBgOpacity > 0.5 ? $r('app.color.text_primary') : Color.White)
        }
      }
      .width(40)
      .height(40)
      .backgroundColor(this.navBgOpacity > 0.5 ? 'rgba(0,0,0,0.05)' : 'rgba(0,0,0,0.3)')
      .borderRadius(20)
      .onClick(() => {
        try {
          router.back()
        } catch (error) {
          console.error('è¿”å›žå¤±è´¥:', error)
        }
      })

      Blank()

      // æ›´å¤šæ“ä½œæŒ‰é’®
      Row() {
        // æ”¶è—æŒ‰é’®
        Button() {
          Text(this.isFavorite ? 'â¤ï¸' : 'ðŸ¤')
            .fontSize(20)
        }
        .width(40)
        .height(40)
        .backgroundColor(this.navBgOpacity > 0.5 ? 'rgba(0,0,0,0.05)' : 'rgba(0,0,0,0.3)')
        .borderRadius(20)
        .margin({ right: 8 })
        .onClick(() => this.onToggleFavorite())

        // åˆ†äº«æŒ‰é’®
        Button() {
          Text('â†—')
            .fontSize(20)
            .fontColor(this.navBgOpacity > 0.5 ? $r('app.color.text_primary') : Color.White)
        }
        .width(40)
        .height(40)
        .backgroundColor(this.navBgOpacity > 0.5 ? 'rgba(0,0,0,0.05)' : 'rgba(0,0,0,0.3)')
        .borderRadius(20)
        .onClick(() => {
          console.log('åˆ†äº«å•†å“')
        })
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(`rgba(255,255,255,${this.navBgOpacity})`)
    .backdropBlur(20)
    .justifyContent(FlexAlign.SpaceBetween)
    .position({ x: 0, y: 0 })
    .zIndex(1000)
    .transition({ type: TransitionType.All })
  }

  @Builder
  ProductImages() {
    Column() {
      Swiper() {
        ForEach(this.product?.images || [], (image: string, index: number) => {
          Image(image)
            .width('100%')
            .height(this.imageHeight)
            .objectFit(ImageFit.Contain)
            .backgroundColor('#fafafa')
            .alt('å•†å“å›¾ç‰‡')
            .transition({ type: TransitionType.All })
        })
      }
      .width('100%')
      .height(this.imageHeight)
      .loop(true)
      .indicator(true)
      .indicatorStyle({
        size: 8,
        color: 'rgba(255,255,255,0.4)',
        selectedColor: 'rgba(255,255,255,0.9)'
      })
      .onChange(this.onImageChange.bind(this))

      // å›¾ç‰‡æŒ‡ç¤ºå™¨
      Row() {
        ForEach(this.product?.images || [], (_: string, index: number) => {
          Column()
            .width(8)
            .height(8)
            .borderRadius(4)
            .backgroundColor(this.currentImageIndex === index ? Color.White : 'rgba(255,255,255,0.4)')
            .margin({ right: 6 })
            .transition({ type: TransitionType.All })
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .margin({ top: -30 })
      .position({ x: 0, y: 20 })
      .zIndex(100)
    }
  }

  @Builder
  ProductInfo() {
    Column() {
      // å•†å“åç§°
      Text(this.product?.name || '')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .width('100%')
        .margin({ bottom: 12 })

      // ä»·æ ¼å’ŒæŠ˜æ‰£
      Row() {
        Column() {
          Row() {
            Text('Â¥')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.price'))
              .margin({ top: 3 })
            Text(`${this.product?.price || 0}`)
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.price'))
          }

          // åŽŸä»·
          if (this.product?.originalPrice && this.product.originalPrice > this.product.price) {
            Row() {
              Text(`Â¥${this.product.originalPrice}`)
                .fontSize(14)
                .fontColor($r('app.color.text_tertiary'))
                .decoration({ type: TextDecorationType.LineThrough })

              Text(`çœ${Math.floor(((this.product.originalPrice - this.product.price) / this.product.originalPrice) * 100)}%`)
                .fontSize(12)
                .fontColor($r('app.color.error'))
                .backgroundColor($r('app.color.secondary_light'))
                .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                .borderRadius(10)
                .margin({ left: 12 })
            }
            .margin({ top: 4 })
          }
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        // è¯„åˆ†
        if (this.product?.rating) {
          Column() {
            Row() {
              Text('â­')
                .fontSize(16)
              Text(this.product.rating.toFixed(1))
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
            }
            Text(`${this.product.reviewCount}æ¡è¯„ä»·`)
              .fontSize(11)
              .fontColor($r('app.color.text_tertiary'))
              .margin({ top: 2 })
          }
        }
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 16 })

      // æœåŠ¡ä¿éšœ
      Row() {
        Row() {
          Text('âœ“')
            .fontSize(14)
            .fontColor($r('app.color.success'))
            .margin({ right: 4 })
          Text('æ­£å“ä¿è¯')
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
        }

        Row() {
          Text('âœ“')
            .fontSize(14)
            .fontColor($r('app.color.success'))
            .margin({ right: 4 })
          Text('æžé€Ÿå‘è´§')
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
        }
        .margin({ left: 20 })

        Row() {
          Text('âœ“')
            .fontSize(14)
            .fontColor($r('app.color.success'))
            .margin({ right: 4 })
          Text('ä¸ƒå¤©é€€æ¢')
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
        }
        .margin({ left: 20 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .padding(16)
      .backgroundColor($r('app.color.white'))
      .borderRadius(12)
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.white'))
    .borderRadius(12)
    .margin({ top: 8, left: 12, right: 12 })
  }

  build() {
    Stack() {
      Column() {
        // è‡ªå®šä¹‰å¯¼èˆªæ 
        this.NavigationBar()

        // ä¸»å†…å®¹ - å¯æ»šåŠ¨
        Scroll() {
          Column() {
            // å•†å“å›¾ç‰‡
            this.ProductImages()

            // å•†å“ä¿¡æ¯
            this.ProductInfo()

            // è§„æ ¼é€‰æ‹©
            Column() {
              Row() {
                Text('é€‰æ‹©è§„æ ¼')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r('app.color.text_primary'))
                Text(this.selectedSpec)
                  .fontSize(14)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ left: 12 })
                Blank()
                Text('>')
                  .fontSize(16)
                  .fontColor($r('app.color.text_tertiary'))
              }
              .width('100%')
              .padding(16)
              .backgroundColor($r('app.color.white'))
              .borderRadius(12)
              .margin({ top: 8, left: 12, right: 12 })
              .onClick(() => {
                this.showSpecSelector = true
              })
            }

            // å•†å“è¯¦æƒ…
            Column() {
              Text('å•†å“è¯¦æƒ…')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .width('100%')
                .margin({ bottom: 12 })

              Text(this.product?.detailDescription || 'æš‚æ— è¯¦ç»†æè¿°')
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .lineHeight(24)
                .width('100%')

              // å•†å“å‚æ•°ï¼ˆç¤ºä¾‹ï¼‰
              Column() {
                Text('å•†å“å‚æ•°')
                  .fontSize(15)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r('app.color.text_primary'))
                  .width('100%')
                  .margin({ top: 24, bottom: 12 })

                ForEach([
                  { label: 'å“ç‰Œ', value: 'åŽä¸º' },
                  { label: 'åž‹å·', value: 'æ ‡å‡†ç‰ˆ' },
                  { label: 'é¢œè‰²', value: 'æ·±ç©ºç°' },
                  { label: 'å­˜å‚¨å®¹é‡', value: '128GB' },
                  { label: 'ä¿ä¿®æœŸ', value: '12ä¸ªæœˆ' }
                ], (param: ProductParam) => {
                  Row() {
                    Text(param.label)
                      .fontSize(14)
                      .fontColor($r('app.color.text_secondary'))
                      .width(80)
                    Text(param.value)
                      .fontSize(14)
                      .fontColor($r('app.color.text_primary'))
                      .layoutWeight(1)
                  }
                  .width('100%')
                  .padding({ top: 8, bottom: 8 })
                  .borderRadius(8)
                  .backgroundColor(param.label === 'å“ç‰Œ' || param.label === 'é¢œè‰²' ? $r('app.color.background_gray') : Color.Transparent)
                  .padding({ left: 12, right: 12 })
                })
              }
              .width('100%')
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ top: 8, left: 12, right: 12 })

            // ç”¨æˆ·è¯„ä»·
            Column() {
              Text('ç”¨æˆ·è¯„ä»·')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .width('100%')
                .margin({ bottom: 12 })

              CommentSectionNew({ productId: this.product?.id || '' })
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ top: 8, left: 12, right: 12, bottom: 120 })
          }
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .onScroll((xOffset: number, yOffset: number) => {
          const scrollHeight = 800 // é¢„ä¼°æ»šåŠ¨é«˜åº¦
          this.onScroll(xOffset, yOffset, scrollHeight)
        })
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.background'))

      // åº•éƒ¨è´­ä¹°æ 
      if (this.product) {
        Row() {
          // è”ç³»å®¢æœ
          Button() {
            Column() {
              Text('ðŸ’¬')
                .fontSize(20)
                .fontColor($r('app.color.text_secondary'))
              Text('å®¢æœ')
                .fontSize(10)
                .fontColor($r('app.color.text_secondary'))
                .margin({ top: 2 })
            }
          }
          .width(60)
          .height(48)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            console.log('è”ç³»å®¢æœ')
          })

          // åŠ å…¥è´­ç‰©è½¦
          Button('åŠ å…¥è´­ç‰©è½¦')
            .height(48)
            .fontSize(15)
            .backgroundColor($r('app.color.secondary'))
            .fontColor(Color.White)
            .borderRadius(24)
            .layoutWeight(1)
            .margin({ left: 8, right: 8 })
            .onClick(() => this.onAddToCart())

          // ç«‹å³è´­ä¹°
          Button('ç«‹å³è´­ä¹°')
            .height(48)
            .fontSize(15)
            .backgroundColor($r('app.color.primary'))
            .fontColor(Color.White)
            .borderRadius(24)
            .layoutWeight(1)
            .onClick(() => this.onBuyNow())
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .backgroundColor($r('app.color.white'))
        .backdropBlur(20)
        .shadow({
          radius: 8,
          color: $r('app.color.shadow_medium'),
          offsetX: 0,
          offsetY: -2
        })
        .position({ x: 0, y: '100%' })
        .translate({ x: 0, y: -64 })
        .zIndex(1001)
      }

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      }

      // åŠ å…¥è´­ç‰©è½¦æˆåŠŸå¼¹çª—
      if (this.showCartDialog) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.continueShopping()
            })

          // å¼¹çª—å†…å®¹
          Column() {
            Text('âœ“')
              .fontSize(48)
              .fontColor($r('app.color.success'))
              .margin({ bottom: 16 })

            Text('åŠ å…¥è´­ç‰©è½¦æˆåŠŸ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 8 })

            Text('å•†å“å·²æˆåŠŸæ·»åŠ åˆ°è´­ç‰©è½¦')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 24 })

            Row() {
              Button('ç»§ç»­è´­ç‰©')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.background_gray'))
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.continueShopping()
                })

              Button('åŽ»è´­ç‰©è½¦')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => {
                  this.goToCart()
                })
            }
            .width('100%')
          }
          .width(300)
          .backgroundColor($r('app.color.white'))
          .borderRadius(16)
          .padding(24)
          .position({ x: '50%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
          .shadow({
            radius: 20,
            color: $r('app.color.shadow_medium'),
            offsetX: 0,
            offsetY: 10
          })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(9999)
      }

      // å•†å“å·²åœ¨è´­ç‰©è½¦æç¤ºå¼¹çª—
      if (this.showAlreadyInCartDialog) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.closeAlreadyInCartDialog()
            })

          // å¼¹çª—å†…å®¹
          Column() {
            Text('ðŸ›’')
              .fontSize(48)
              .fontColor($r('app.color.secondary'))
              .margin({ bottom: 16 })

            Text('å•†å“å·²åœ¨è´­ç‰©è½¦ä¸­')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 8 })

            Text('è¯¥å•†å“å·²ç»æ·»åŠ åˆ°è´­ç‰©è½¦ï¼Œå¯ä»¥å‰å¾€è´­ç‰©è½¦æŸ¥çœ‹æˆ–è°ƒæ•´æ•°é‡')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 24 })

            Row() {
              Button('ç»§ç»­è´­ç‰©')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.background_gray'))
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.closeAlreadyInCartDialog()
                })

              Button('æŸ¥çœ‹è´­ç‰©è½¦')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => {
                  this.closeAlreadyInCartDialog()
                  this.goToCart()
                })
            }
            .width('100%')
          }
          .width(320)
          .backgroundColor($r('app.color.white'))
          .borderRadius(16)
          .padding(24)
          .position({ x: '50%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
          .shadow({
            radius: 20,
            color: $r('app.color.shadow_medium'),
            offsetX: 0,
            offsetY: 10
          })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(9999)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}