import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { StorageManager } from '../utils/StorageManagerSimple'
import { User } from '../model/DataModel'
import { CommentData } from '../model/CommentModels'
import common from '@ohos.app.ability.common'

// ‰ªé StorageManagerSimple ÂØºÂÖ•ÁöÑÊé•Âè£
interface IComment {
  id: number
  productId: string
  userId: string
  userName: string
  userAvatar: string
  rating: number
  content: string
  images: string
  helpfulCount: number
  spec: string
  createTime: string
}

interface ProductParams {
  productId: string
}



@Entry
@Component
struct ProductDetailComplete {
  @State product: ProductModel | null = null
  @State selectedSpec: string = '12GB+512GB'
  @State selectedColor: string = 'ÈõÖÂ∑ùÈùí'
  @State quantity: number = 1
  @State isLoading: boolean = true
  @State isSubmittingComment: boolean = false
  @State isFavorite: boolean = false
  @State comments: IComment[] = []
  @State currentImageIndex: number = 0
  @State user: User | null = null
  @State showCommentDialog: boolean = false
  @State commentRating: number = 5
  @State commentContent: string = ''
  @State showAllComments: boolean = false
  @State commentImages: string[] = []

  private specs: string[] = ['12GB+256GB', '12GB+512GB', '16GB+512GB', '16GB+1TB']
  private colors: string[] = ['ÈõÖÂ∑ùÈùí', 'ÈõÖÈªë', 'ÈõÖÁôΩ', 'ÈõÖ‰∏πÈúû']
  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
    this.loadProductData()
    this.loadUserData()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
      console.log('ProductDetailComplete: StorageManagerÂàùÂßãÂåñÊàêÂäü')
    } catch (error) {
      console.error('ProductDetailComplete: StorageManagerÂàùÂßãÂåñÂ§±Ë¥•:', error)
    }
  }

  private async loadUserData() {
    try {
      this.user = await this.storage.loadUser()
      console.log('ProductDetail - Áî®Êà∑Áä∂ÊÄÅ:', this.user ? this.user.username : 'Êú™ÁôªÂΩï')
    } catch (error) {
      console.error('Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', error)
    }
  }

  private async loadProductData() {
    const params = router.getParams() as ProductParams
    if (params?.productId) {
      const products = MockData.generateProducts()
      this.product = products.find(p => p.id === params.productId) || null

      if (this.product) {
        // Êî∂ËóèÂäüËÉΩÂ∑≤ÁßªÈô§
        this.isFavorite = false
        // ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩËØÑËÆ∫
        await this.loadComments()
      }
    }
    this.isLoading = false
  }

  private async loadComments() {
    if (!this.product) return
    try {
      const comments = await this.storage.getProductComments(this.product.id)
      this.comments = comments as IComment[]
      console.log('Âä†ËΩΩËØÑËÆ∫ÂÆåÊàêÔºåÊï∞ÈáèÔºö', this.comments.length)
    } catch (error) {
      console.error('Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•:', error)
      this.comments = []
    }
  }

  private async onAddToCart() {
    if (!this.product) {
      console.error('ÂïÜÂìÅ‰ø°ÊÅØ‰∏çÂ≠òÂú®')
      return
    }

    if (!this.user) {
      console.log('Áî®Êà∑Êú™ÁôªÂΩïÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ')
      router.pushUrl({ url: 'pages/LoginPageModern' })
      return
    }

    try {
      console.log('ÂáÜÂ§áÊ∑ªÂä†Âà∞Ë¥≠Áâ©ËΩ¶:', this.product.name)
      await this.storage.addToCart(this.product, this.quantity, this.selectedSpec)

      // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
      AlertDialog.show({
        title: 'ÊàêÂäü',
        message: 'Â∑≤Ê∑ªÂä†Âà∞Ë¥≠Áâ©ËΩ¶',
        primaryButton: {
          value: 'ÂéªË¥≠Áâ©ËΩ¶',
          action: () => {
            router.pushUrl({ url: 'pages/CartPage' })
          }
        },
        secondaryButton: {
          value: 'ÁªßÁª≠Ë¥≠Áâ©',
          action: () => {}
        }
      })
    } catch (error) {
      console.error('Ê∑ªÂä†Âà∞Ë¥≠Áâ©ËΩ¶Â§±Ë¥•:', error)
      AlertDialog.show({
        title: 'ÈîôËØØ',
        message: 'Ê∑ªÂä†Â§±Ë¥•ÔºåËØ∑ÈáçËØï',
        primaryButton: {
          value: 'Á°ÆÂÆö',
          action: () => {}
        }
      })
    }
  }

  private onBuyNow() {
    console.log('Á´ãÂç≥Ë¥≠‰π∞')
    // ÂÆûÈôÖÁ´ãÂç≥Ë¥≠‰π∞ÁöÑÈÄªËæë
  }

  private async onSubmitComment() {
    if (!this.user || !this.product) {
      router.pushUrl({ url: 'pages/LoginPageModern' })
      return
    }

    if (!this.commentContent.trim()) {
      console.error('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫')
      return
    }

    // Èò≤Ê≠¢ÈáçÂ§çÊèê‰∫§
    if (this.isSubmittingComment) {
      console.log('ËØÑËÆ∫Ê≠£Âú®Êèê‰∫§‰∏≠ÔºåËØ∑ÂãøÈáçÂ§çÁÇπÂáª')
      return
    }

    this.isSubmittingComment = true

    try {
      // ÂàõÂª∫ËØÑËÆ∫Êï∞ÊçÆÂØπË±°
      const commentData = new CommentData(
        this.product.id,
        this.commentRating,
        this.commentContent.trim(),
        '',
        this.selectedSpec
      )

      await this.storage.addComment(commentData)

      // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫
      await this.loadComments()

      // ÂÖ≥Èó≠ÂØπËØùÊ°ÜÂπ∂ÈáçÁΩÆË°®Âçï
      this.showCommentDialog = false
      this.commentContent = ''
      this.commentRating = 5
      this.commentImages = []

      console.log('ËØÑËÆ∫ÂèëË°®ÊàêÂäü')
      AlertDialog.show({
        title: 'ÊàêÂäü',
        message: 'ËØÑËÆ∫ÂèëË°®ÊàêÂäü',
        primaryButton: {
          value: 'Á°ÆÂÆö',
          action: () => {}
        }
      })
    } catch (error) {
      console.error('ËØÑËÆ∫ÂèëË°®Â§±Ë¥•:', error)
      AlertDialog.show({
        title: 'ÈîôËØØ',
        message: 'ËØÑËÆ∫ÂèëË°®Â§±Ë¥•ÔºåËØ∑ÈáçËØï',
        primaryButton: {
          value: 'Á°ÆÂÆö',
          action: () => {}
        }
      })
    } finally {
      this.isSubmittingComment = false
    }
  }

  private async onLikeComment(commentId: number) {
    try {
      await this.storage.likeComment(commentId.toString())
      // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫‰ª•Êõ¥Êñ∞ÁÇπËµûÊï∞
      await this.loadComments()
    } catch (error) {
      console.error('ÁÇπËµûËØÑËÆ∫Â§±Ë¥•:', error)
    }
  }

  @Builder
  NavigationBar() {
    Row() {
      // ËøîÂõûÊåâÈíÆ
      Button() {
        Text('‚Üê')
          .fontSize(24)
          .fontColor('#FFFFFF')
      }
      .width(48)
      .height(48)
      .backgroundColor(Color.Transparent)
      .onClick(() => router.back())

      Blank()

      Text('ÂïÜÂìÅËØ¶ÊÉÖ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#FFFFFF')

      Blank()

      // ÂàÜ‰∫´ÊåâÈíÆ
      Button() {
        Text('‚Üó')
          .fontSize(24)
          .fontColor('#FFFFFF')
      }
      .width(48)
      .height(48)
      .backgroundColor(Color.Transparent)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .position({ x: 0, y: 0 })
    .zIndex(1000)
  }

  @Builder
  HeroSection() {
    Column() {
      Swiper() {
        ForEach(this.product?.images || [this.product?.image], (image: string, index?: number) => {
          Image(image)
            .width('100%')
            .height(450)
            .objectFit(ImageFit.Contain)
            .backgroundColor('#0A0A0A')
            .borderRadius(0)
        })
      }
      .width('100%')
      .height(450)
      .loop(true)
      .autoPlay(true)
      .interval(3000)
      .indicatorStyle({
        size: 8,
        left: 0,
        right: 0,
        top: 400,
        color: 'rgba(255,255,255,0.3)',
        selectedColor: '#FFFFFF'
      })
      .onChange((index: number) => {
        this.currentImageIndex = index
      })
    }
    .width('100%')
    .linearGradient({
      direction: GradientDirection.Bottom,
      colors: [
        ['#0A0A0A', 0.0],
        ['#1A1A1A', 0.3],
        ['#0A0A0A', 1.0]
      ]
    })
  }

  @Builder
  CommentInputArea() {
    Row() {
      Row() {
          Text(this.user ? this.user.username[0] : 'Êú™')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Bold)
          .width(36)
          .height(36)
          .backgroundColor('#FF3B30')
          .borderRadius(18)
          .textAlign(TextAlign.Center)

        TextInput({
          placeholder: 'ËØ¥ËØ¥‰Ω†ÁöÑ‰ΩøÁî®ÊÑüÂèó...',
          text: ''
        })
          .fontSize(14)
          .fontColor('#1A1A1A')
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
          .padding({ left: 16, right: 16 })
          .layoutWeight(1)
          .margin({ left: 12 })
      }
      .width('100%')
      .layoutWeight(1)

      Button('ÂèëË°®')
        .fontSize(14)
        .fontColor('#FFFFFF')
        .backgroundColor('#FF3B30')
        .borderRadius(20)
        .padding({ left: 20, right: 20 })
        .height(36)
        .margin({ left: 12 })
        .onClick(() => {
          this.showCommentDialog = true
        })
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .margin({ top: 12 })
  }
}

  @Builder
  CommentDialog() {
    if (this.showCommentDialog) {
      Stack() {
        // ÈÅÆÁΩ©Â±Ç
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.5)')
          .onClick(() => {
            this.showCommentDialog = false
          })

        // ÂØπËØùÊ°ÜÂÜÖÂÆπ
        Column() {
          Text('ÂèëË°®ËØÑËÆ∫')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .width('100%')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 20 })

          // ËØÑÂàÜ
          Text('ËØÑÂàÜ')
            .fontSize(14)
            .fontColor('#666666')
            .width('100%')
            .margin({ bottom: 8 })

          Row() {
            ForEach([1, 2, 3, 4, 5], (star: number) => {
              Text('‚òÖ')
                .fontSize(32)
                .fontColor(star <= this.commentRating ? '#FFD700' : '#E0E0E0')
                .onClick(() => {
                  this.commentRating = star
                })
            })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .margin({ bottom: 20 })

          // ËØÑËÆ∫ÂÜÖÂÆπ
          TextArea({
            placeholder: 'ÂàÜ‰∫´‰Ω†ÁöÑ‰ΩøÁî®ÂøÉÂæóÔºåÂ∏ÆÂä©Êõ¥Â§ö‰∫∫‰∫ÜËß£ËøôÊ¨æ‰∫ßÂìÅ...',
            text: this.commentContent
          })
            .fontSize(14)
            .fontColor('#1A1A1A')
            .backgroundColor('#F5F5F7')
            .borderRadius(12)
            .padding(16)
            .width('100%')
            .height(150)
            .onChange((value: string) => {
              this.commentContent = value
            })
            .margin({ bottom: 16 })

          // ÂõæÁâá‰∏ä‰º†Âå∫ÂüüÔºàÁÆÄÂåñÁâàÔºâ
          Column() {
            Text('Ê∑ªÂä†ÂõæÁâá')
              .fontSize(14)
              .fontColor('#666666')
              .width('100%')
              .margin({ bottom: 8 })

            Button() {
              Text('+ ÁÇπÂáª‰∏ä‰º†ÂõæÁâáÔºàÂäüËÉΩÂºÄÂèë‰∏≠Ôºâ')
                .fontSize(14)
                .fontColor('#999999')
            }
            .width('100%')
            .height(80)
            .backgroundColor('#F5F5F7')
            .borderRadius(8)
            .onClick(() => {
              console.log('ÂõæÁâá‰∏ä‰º†ÂäüËÉΩÂºÄÂèë‰∏≠')
            })

            Text('ÂõæÁâáÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠ÔºåÊöÇÊó∂Êó†Ê≥ï‰∏ä‰º†')
              .fontSize(12)
              .fontColor('#999999')
              .width('100%')
              .margin({ top: 8 })
              .textAlign(TextAlign.Center)
          }
          .width('100%')
          .margin({ bottom: 16 })

          // Êìç‰ΩúÊåâÈíÆ
          Row() {
            Button('ÂèñÊ∂à')
              .fontSize(16)
              .fontColor('#666666')
              .backgroundColor('#F5F5F7')
              .borderRadius(8)
              .width(100)
              .height(44)
              .onClick(() => {
                this.showCommentDialog = false
              })

            Blank()

            Button(this.isSubmittingComment ? 'ÂèëË°®‰∏≠...' : 'ÂèëË°®')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor(this.isSubmittingComment ? '#CCCCCC' : '#FF3B30')
              .borderRadius(8)
              .width(100)
              .height(44)
              .enabled(this.commentContent.trim().length > 0 && !this.isSubmittingComment)
              .onClick(() => {
                this.onSubmitComment()
              })
          }
          .width('100%')
          .margin({ top: 20 })
        }
        .width('90%')
        .padding(24)
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .justifyContent(FlexAlign.Center)
        .shadow({
          radius: 24,
          color: '#00000030',
          offsetX: 0,
          offsetY: 8
        })
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(2000)
    }
  }

  @Builder
  CommentList() {
    Column() {
      Row() {
        Text('Áî®Êà∑ËØÑ‰ª∑')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .layoutWeight(1)

        Text(`${this.comments.length}Êù°`)
          .fontSize(14)
          .fontColor('#666666')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 20 })

      // ËØÑËÆ∫ËæìÂÖ•Âå∫
      this.CommentInputArea()

      // ËØÑËÆ∫ÂàóË°®
      if (this.comments.length > 0) {
        ForEach(this.showAllComments ? this.comments : this.comments.slice(0, 3), (comment: IComment, index?: number) => {
          Column() {
            Row() {
              Text(comment.userName[0])
                .fontSize(16)
                .fontColor('#FFFFFF')
                .fontWeight(FontWeight.Bold)
                .width(36)
                .height(36)
                .backgroundColor('#FF3B30')
                .borderRadius(18)
                .textAlign(TextAlign.Center)

              Column() {
                Text(comment.userName)
                  .fontSize(14)
                  .fontColor('#1A1A1A')
                  .fontWeight(FontWeight.Medium)
                Text(comment.spec || 'ÈªòËÆ§ËßÑÊ†º')
                  .fontSize(12)
                  .fontColor('#999999')
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              .margin({ left: 12 })

              Text(new Date(comment.createTime).toLocaleDateString())
                .fontSize(12)
                .fontColor('#999999')
            }
            .width('100%')
            .alignItems(VerticalAlign.Top)
            .margin({ bottom: 12 })

            // ËØÑÂàÜ
            Row() {
              ForEach([1, 2, 3, 4, 5], (star: number) => {
                Text('‚òÖ')
                  .fontSize(14)
                  .fontColor(star <= comment.rating ? '#FFD700' : '#E0E0E0')
              })
            }
            .margin({ bottom: 12 })

            Text(comment.content)
              .fontSize(14)
              .fontColor('#333333')
              .lineHeight(22)
              .width('100%')
              .margin({ bottom: 12 })

            // ÊòæÁ§∫ËØÑËÆ∫ÂõæÁâáÔºàÁÆÄÂåñÁâàÔºâ
            if (comment.images && comment.images !== '') {
              Text('ÂõæÁâáÔºö' + comment.images)
                .fontSize(12)
                .fontColor('#999999')
                .margin({ bottom: 8 })
            }

            Row() {
              Button(`ÊúâÁî® (${comment.helpfulCount})`)
                .fontSize(12)
                .fontColor('#666666')
                .backgroundColor('#F5F5F5')
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .borderRadius(4)
                .onClick(() => {
                  this.onLikeComment(comment.id)
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.End)
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .margin({ bottom: 12 })
        })

        // Êü•ÁúãÊõ¥Â§öÊåâÈíÆ
        if (this.comments.length > 3 && !this.showAllComments) {
          Button('Êü•ÁúãÂÖ®ÈÉ®ËØÑËÆ∫')
            .fontSize(14)
            .fontColor('#666666')
            .backgroundColor('#F5F5F7')
            .width('100%')
            .height(44)
            .borderRadius(8)
            .margin({ top: 12 })
            .onClick(() => {
              this.showAllComments = true
            })
        }
      } else {
        // ÊöÇÊó†ËØÑËÆ∫
        Column() {
          Text('ÊöÇÊó†ËØÑËÆ∫')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 40, bottom: 40 })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .padding({ left: 20, right: 20 })
    .margin({ top: 12 })
  }

  build() {
    Stack() {
      Scroll() {
        Column() {
          // Hero Âå∫Âüü
          this.HeroSection()

          // ÂïÜÂìÅ‰ø°ÊÅØ
          Column() {
            // ‰ª∑Ê†ºÂíåÊ†áÈ¢ò
            Column() {
              Row() {
                Text(`¬•${this.product?.price || 0}`)
                  .fontSize(32)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FFFFFF')

                if (this.product?.originalPrice && this.product.originalPrice > this.product.price) {
                  Text(`¬•${this.product.originalPrice}`)
                    .fontSize(20)
                    .fontColor('rgba(255,255,255,0.5)')
                    .decoration({ type: TextDecorationType.LineThrough })
                    .margin({ left: 16 })
                }
              }
              .width('100%')
              .margin({ bottom: 16 })

              Text(this.product?.name || '')
                .fontSize(24)
                .fontWeight(FontWeight.Medium)
                .fontColor('#FFFFFF')
                .width('100%')
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .padding(24)
            .backgroundColor('#1A1A1A')
            .borderRadius(24)
            .margin({ top: -40 })
            .zIndex(10)

            // ÂïÜÂìÅËØ¶ÊÉÖ
            Column() {
              Text('ÂïÜÂìÅËØ¶ÊÉÖ')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#1A1A1A')
                .width('100%')
                .margin({ bottom: 20 })

              Text(this.product?.detailDescription || '')
                .fontSize(14)
                .fontColor('#666666')
                .lineHeight(24)
                .width('100%')
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#FFFFFF')
            .borderRadius(24)
            .margin({ top: 12 })
          }
          .width('100%')

          // ËØÑËÆ∫ÂàóË°®
          this.CommentList()
        }
        .width('100%')
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F7')

      // ÂØºËà™Ê†è
      this.NavigationBar()

      // Â∫ïÈÉ®Êìç‰ΩúÊ†è
      Row() {
        // Ë¥≠Áâ©ËΩ¶ÊåâÈíÆ
        Column() {
          Text('üõí')
            .fontSize(28)
            .fontColor('#1A1A1A')

          Text('Ë¥≠Áâ©ËΩ¶')
            .fontSize(12)
            .fontColor('#666666')
            .margin({ top: 4 })
        }
        .width(48)
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          router.pushUrl({ url: 'pages/CartPage' })
        })

        Button('Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶')
          .height(50)
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#1A1A1A')
          .borderRadius(25)
          .layoutWeight(1)
          .margin({ left: 20, right: 12 })
          .onClick(() => this.onAddToCart())

        Button('Á´ãÂç≥Ë¥≠‰π∞')
          .height(50)
          .fontSize(16)
          .fontColor('#FFFFFF')
          .backgroundColor('#FF3B30')
          .borderRadius(25)
          .layoutWeight(1)
          .onClick(() => this.onBuyNow())
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 20, top: 12 })
      .backgroundColor('rgba(255,255,255,0.98)')
      .backdropBlur(20)
      .border({ width: { top: 0.5 }, color: '#E5E5E5' })
      .position({ x: 0, y: '100%' })
      .translate({ x: 0, y: -110 })

      // ËØÑËÆ∫ÂºπÁ™ó
      this.CommentDialog()

      // Âä†ËΩΩÁä∂ÊÄÅ
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('Âä†ËΩΩ‰∏≠...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#F5F5F7')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F7')
  }
}