import router from '@ohos.router'
import { StorageManager } from '../utils/StorageManagerSimple'
import { User } from '../model/DataModel'
import common from '@ohos.app.ability.common'

// È¢úËâ≤Á±ª
class ColorScheme {
  static background: string = '#F5F7FA'
  static surface: string = '#FFFFFF'
  static primary: string = '#1A1A1A'
  static secondary: string = '#6C757D'
  static text: string = '#2C3E50'
  static textSecondary: string = '#7F8C8D'
  static accent: string = '#3498DB'
  static danger: string = '#E74C3C'
}

@Entry
@Component
struct ProfileModernFixed {
  @State user: User | null = null
  @State isLoading: boolean = true
  @State cartCount: number = 0
  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
    this.loadUserData()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
    } catch (error) {
      console.error('ÂàùÂßãÂåñÂ≠òÂÇ®Â§±Ë¥•:', error)
    }
  }

  private async loadUserData() {
    try {
      this.user = await this.storage.loadUser()

      // Ê®°ÊãüÂä†ËΩΩË¥≠Áâ©ËΩ¶Êï∞Èáè
      if (this.user) {
        const cartItems = await this.storage.loadCart()
        this.cartCount = cartItems.length
      }

      this.isLoading = false
    } catch (error) {
      console.error('Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', error)
      this.isLoading = false
    }
  }

  private async logout() {
    try {
      await this.storage.saveUser(null)
      router.replaceUrl({ url: 'pages/LoginPageModern' })
    } catch (error) {
      console.error('ÁôªÂá∫Â§±Ë¥•:', error)
    }
  }

  private navigateTo(page: string) {
    console.log(`ÂØºËà™Âà∞È°µÈù¢: ${page}`)
    router.pushUrl({ url: page }).catch((error: Error) => {
      console.error('ÂØºËà™Â§±Ë¥•:', error)
    })
  }

  @Builder
  Header() {
    Row() {
      Button() {
        Text('‚Üê ËøîÂõû')
          .fontSize(24)
          .fontColor(ColorScheme.text)
      }
      .width(100)
      .height(48)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.log('ËøîÂõûÊåâÈíÆË¢´ÁÇπÂáª')
        router.back()
      })

      Text('‰∏™‰∫∫‰∏≠ÂøÉ')
        .fontSize(20)
        .fontWeight(FontWeight.Medium)
        .fontColor(ColorScheme.text)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Button() {
        Text('ËÆæÁΩÆ ‚öôÔ∏è')
          .fontSize(24)
          .fontColor(ColorScheme.text)
      }
      .width(100)
      .height(48)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.log('ËÆæÁΩÆÊåâÈíÆË¢´ÁÇπÂáª')
      })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 12, bottom: 12 })
    .backgroundColor(ColorScheme.surface)
  }

  @Builder
  UserInfoSection() {
    Column() {
      // Áî®Êà∑Â§¥ÂÉèÂíåÂü∫Êú¨‰ø°ÊÅØ
      Row() {
        // Â§¥ÂÉè
        Stack() {
          Circle({ width: 80, height: 80 })
            .fill(ColorScheme.accent)

          Text(this.user ? this.user.username[0].toUpperCase() : 'U')
            .fontSize(32)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)

          // VIPÊ†áÁ≠æ
          if (this.user) {
            Text('VIP')
              .fontSize(10)
              .fontColor('#FFD700')
              .fontWeight(FontWeight.Bold)
              .backgroundColor('#1A1A1A')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
              .position({ x: 45, y: 0 })
          }
        }
        .margin({ right: 20 })

        // Áî®Êà∑‰ø°ÊÅØ
        Column() {
          if (this.user) {
            Text(this.user.username || 'Áî®Êà∑ÊòµÁß∞')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .fontColor(ColorScheme.text)
              .margin({ bottom: 8 })

            Row() {
              Text('‰ºöÂëòÁ≠âÁ∫ß: ')
                .fontSize(14)
                .fontColor(ColorScheme.textSecondary)
              Text(this.user.getLevelText())
                .fontSize(14)
                .fontColor(this.user.getLevelColor())
                .fontWeight(FontWeight.Medium)
            }
            .margin({ bottom: 4 })

            Text(`ÁßØÂàÜ: ${this.user.points}`)
              .fontSize(14)
              .fontColor(ColorScheme.textSecondary)
          } else {
            Text('Êú™ÁôªÂΩï')
              .fontSize(18)
              .fontColor(ColorScheme.text)
              .margin({ bottom: 8 })

            Button('ÂéªÁôªÂΩï')
              .fontSize(14)
              .fontColor(Color.White)
              .backgroundColor(ColorScheme.primary)
              .padding({ left: 20, right: 20, top: 8, bottom: 8 })
              .borderRadius(20)
              .onClick(() => {
                router.pushUrl({ url: 'pages/LoginPageModern' })
              })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
    }
    .width('100%')
    .backgroundColor(ColorScheme.surface)
    .margin({ top: 1 })
  }

  @Builder
  OrderSection() {
    if (this.user) {
      Column() {
        Text('ÊàëÁöÑËÆ¢Âçï')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(ColorScheme.text)
          .width('100%')
          .margin({ bottom: 20 })
          .padding({ left: 20 })

        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceAround }) {
          Column() {
            Text('üí≥')
              .fontSize(30)
              .margin({ bottom: 8 })
            Text('ÂæÖ‰ªòÊ¨æ')
              .fontSize(12)
            Text('2')
              .fontSize(14)
              .fontColor(Color.Red)
          }
          .width(80)
          .height(80)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .onClick(() => {
            this.showOrderDialog('ÂæÖ‰ªòÊ¨æ', 'ÊÇ®Êúâ2‰∏™ÂæÖ‰ªòÊ¨æËÆ¢Âçï')
          })

          Column() {
            Text('üì¶')
              .fontSize(30)
              .margin({ bottom: 8 })
            Text('ÂæÖÂèëË¥ß')
              .fontSize(12)
            Text('1')
              .fontSize(14)
              .fontColor(Color.Red)
          }
          .width(80)
          .height(80)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .onClick(() => {
            this.showOrderDialog('ÂæÖÂèëË¥ß', 'ÊÇ®Êúâ1‰∏™ÂæÖÂèëË¥ßËÆ¢Âçï')
          })

          Column() {
            Text('üöö')
              .fontSize(30)
              .margin({ bottom: 8 })
            Text('ÂæÖÊî∂Ë¥ß')
              .fontSize(12)
            Text('3')
              .fontSize(14)
              .fontColor(Color.Red)
          }
          .width(80)
          .height(80)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .onClick(() => {
            this.showOrderDialog('ÂæÖÊî∂Ë¥ß', 'ÊÇ®Êúâ3‰∏™ÂæÖÊî∂Ë¥ßËÆ¢Âçï')
          })

          Column() {
            Text('‚≠ê')
              .fontSize(30)
              .margin({ bottom: 8 })
            Text('ÂæÖËØÑ‰ª∑')
              .fontSize(12)
            Text('5')
              .fontSize(14)
              .fontColor(Color.Red)
          }
          .width(80)
          .height(80)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .onClick(() => {
            this.showOrderDialog('ÂæÖËØÑ‰ª∑', 'ÊÇ®Êúâ5‰∏™ÂæÖËØÑ‰ª∑ËÆ¢Âçï')
          })
        }
        .width('100%')
      }
      .width('100%')
      .padding(20)
      .backgroundColor(ColorScheme.surface)
      .margin({ top: 12 })
    } else {
      // Êú™ÁôªÂΩïÁä∂ÊÄÅÁöÑËÆ¢ÂçïÊèêÁ§∫
      Column() {
        Row() {
          Text('üìã')
            .fontSize(20)
            .fontColor('#CCCCCC')
            .margin({ right: 12 })
          Text('ÁôªÂΩïÂêéÊü•ÁúãËÆ¢Âçï')
            .fontSize(16)
            .fontColor('#999999')
        }
        .justifyContent(FlexAlign.Center)
        .width('100%')
        .height(80)
        .backgroundColor('#FAFAFA')
        .borderRadius(8)
        .onClick(() => {
          router.pushUrl({ url: 'pages/LoginPageModern' })
        })
      }
      .width('100%')
      .padding(20)
      .backgroundColor(ColorScheme.surface)
      .margin({ top: 12 })
    }
  }

  private showOrderDialog(title: string, message: string) {
    AlertDialog.show({
      title: title,
      message: message,
      primaryButton: {
        value: 'Á°ÆÂÆö',
        action: () => {
          console.log(`ÂØπËØùÊ°ÜÁ°ÆÂÆöÊåâÈíÆË¢´ÁÇπÂáª`)
        }
      },
      secondaryButton: {
        value: 'ÂèñÊ∂à',
        action: () => {
          console.log(`ÂØπËØùÊ°ÜÂèñÊ∂àÊåâÈíÆË¢´ÁÇπÂáª`)
        }
      }
    })
  }

  @Builder
  ToolsSection() {
    Column() {
      Row() {
        Text('ÊàëÁöÑÂ∑•ÂÖ∑')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(ColorScheme.text)
      }
      .width('100%')
      .margin({ bottom: 20 })

      // Â∑•ÂÖ∑ÂàóË°®
      if (this.user) {
        Column({ space: 1 }) {
          // Ë¥≠Áâ©ËΩ¶
          Row() {
            Row() {
              Text('üõí')
                .fontSize(22)
                .width(40)
              Column() {
                Text('Ë¥≠Áâ©ËΩ¶')
                  .fontSize(16)
                  .fontColor(ColorScheme.text)
                Text(`${this.cartCount}‰ª∂ÂïÜÂìÅ`)
                  .fontSize(12)
                  .fontColor(ColorScheme.textSecondary)
                  .margin({ top: 2 })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              .margin({ left: 12 })
            }
            .width('100%')
            .padding(20)
            .backgroundColor(ColorScheme.surface)
            .onClick(() => {
              router.pushUrl({ url: 'pages/CartPage' })
            })
          }

          // Âú∞ÂùÄÁÆ°ÁêÜ
          Row() {
            Row() {
              Text('üìç')
                .fontSize(22)
                .width(40)
              Column() {
                Text('Âú∞ÂùÄÁÆ°ÁêÜ')
                  .fontSize(16)
                  .fontColor(ColorScheme.text)
                Text('ÁÆ°ÁêÜÊî∂Ë¥ßÂú∞ÂùÄ')
                  .fontSize(12)
                  .fontColor(ColorScheme.textSecondary)
                  .margin({ top: 2 })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              .margin({ left: 12 })
            }
            .width('100%')
            .padding(20)
            .backgroundColor(ColorScheme.surface)
            .onClick(() => {
              console.log('Âú∞ÂùÄÁÆ°ÁêÜ')
            })
          }

          // ÂÆ¢Êúç‰∏≠ÂøÉ
          Row() {
            Row() {
              Text('üí¨')
                .fontSize(22)
                .width(40)
              Column() {
                Text('ÂÆ¢Êúç‰∏≠ÂøÉ')
                  .fontSize(16)
                  .fontColor(ColorScheme.text)
                Text('Âú®Á∫øÂÆ¢ÊúçÂèçÈ¶à')
                  .fontSize(12)
                  .fontColor(ColorScheme.textSecondary)
                  .margin({ top: 2 })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              .margin({ left: 12 })
            }
            .width('100%')
            .padding(20)
            .backgroundColor(ColorScheme.surface)
            .onClick(() => {
              console.log('ÂÆ¢Êúç‰∏≠ÂøÉ')
            })
          }
        }
        .width('100%')
        .borderRadius(16)
        .margin({ top: 12 })
      } else {
        // Êú™ÁôªÂΩïÁä∂ÊÄÅÁöÑÂ∑•ÂÖ∑ÊèêÁ§∫
        Column() {
          Row() {
            Text('üîß')
              .fontSize(20)
              .fontColor('#CCCCCC')
              .margin({ right: 12 })
            Text('ÁôªÂΩïÂêé‰ΩøÁî®Êõ¥Â§öÂäüËÉΩ')
              .fontSize(16)
              .fontColor('#999999')
          }
          .justifyContent(FlexAlign.Center)
          .width('100%')
          .height(80)
          .backgroundColor('#FAFAFA')
          .borderRadius(8)
          .onClick(() => {
            router.pushUrl({ url: 'pages/LoginPageModern' })
          })
        }
        .width('100%')
        .padding(20)
        .backgroundColor(ColorScheme.surface)
        .margin({ top: 12 })
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(ColorScheme.background)
  }

  @Builder
  LogoutSection() {
    Button('ÈÄÄÂá∫ÁôªÂΩï')
      .width('100%')
      .height(48)
      .fontSize(16)
      .fontColor(ColorScheme.danger)
      .backgroundColor(Color.Transparent)
      .border({ width: 1, color: ColorScheme.danger })
      .borderRadius(24)
      .margin({ top: 20 })
      .onClick(() => {
        AlertDialog.show({
          title: 'ÊèêÁ§∫',
          message: 'Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü',
          primaryButton: {
            value: 'Á°ÆÂÆö',
            action: () => this.logout()
          },
          secondaryButton: {
            value: 'ÂèñÊ∂à',
            action: () => {}
          }
        })
      })
  }

  build() {
    Stack() {
      Column() {
        // È°∂ÈÉ®ÂØºËà™
        this.Header()

        // ‰∏ªÂÜÖÂÆπ
        Scroll() {
          Column() {
            // Áî®Êà∑‰ø°ÊÅØ
            this.UserInfoSection()

            // ËÆ¢ÂçïÈÉ®ÂàÜ
            this.OrderSection()
            this.ToolsSection()
            if (this.user) {
              this.LogoutSection()
            }
          }
          .width('100%')
          .padding({ bottom: 80 })
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor(ColorScheme.background)
        .edgeEffect(EdgeEffect.Spring)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(ColorScheme.background)

      // Âä†ËΩΩÁä∂ÊÄÅ
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('Âä†ËΩΩ‰∏≠...')
            .fontSize(14)
            .fontColor(ColorScheme.textSecondary)
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('rgba(0,0,0,0.5)')
        .zIndex(9999)
      }
    }
    .width('100%')
    .height('100%')
  }
}