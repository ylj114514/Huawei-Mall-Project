import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { ProductCardLazy } from '../components/ProductCardLazy'
import { SearchBar } from '../components/SearchBar'
import { BottomNavBar } from '../components/BottomNavBar'
import { AppService } from '../services/AppService'

@Entry
@Component
struct Index {
  @State products: ProductModel[] = []
  @State filteredProducts: ProductModel[] = []
  @State selectedCategory: string = 'å…¨éƒ¨'
  @State searchText: string = ''
  @State categories: string[] = []
  @State isLoading: boolean = true
  @State isSearching: boolean = false
  private appService: AppService = AppService.getInstance()

  aboutToAppear() {
    this.initApp()
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨
   */
  private async initApp(): Promise<void> {
    try {
      // åˆå§‹åŒ–AppServiceï¼ˆåŒ…å«æ•°æ®åº“åˆå§‹åŒ–ï¼‰
      await this.appService.init(getContext(this))
      console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ')

      // åŠ è½½é¡µé¢æ•°æ®
      this.loadData()
    } catch (error) {
      console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error)
      // å³ä½¿åˆå§‹åŒ–å¤±è´¥ï¼Œä¹ŸåŠ è½½åŸºæœ¬æ•°æ®
      this.loadData()
    }
  }

  private loadData() {
    // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
    setTimeout(() => {
      this.products = MockData.generateProducts()
      this.filteredProducts = this.products
      this.categories = MockData.generateCategories()

      this.isLoading = false
    }, 1000)
  }

  private onCategoryChange(category: string) {
    this.selectedCategory = category
    this.filterProducts()
  }

  private onSearch(query: string) {
    this.searchText = query
    this.isSearching = true
    this.filterProducts()
  }

  private filterProducts() {
    let filtered = this.products

    // æŒ‰åˆ†ç±»ç­›é€‰
    if (this.selectedCategory !== 'å…¨éƒ¨') {
      filtered = filtered.filter(product => product.category === this.selectedCategory)
    }

    // æŒ‰æœç´¢å…³é”®è¯ç­›é€‰
    if (this.searchText.trim() !== '') {
      const query = this.searchText.toLowerCase()
      filtered = filtered.filter(product =>
        product.name.toLowerCase().includes(query) ||
        product.description.toLowerCase().includes(query) ||
        product.category.toLowerCase().includes(query) ||
        product.tags.some(tag => tag.toLowerCase().includes(query))
      )
    }

    this.filteredProducts = filtered

    // å¦‚æœæ˜¯æœç´¢çŠ¶æ€ï¼Œæ˜¾ç¤ºæœç´¢ç»“æœæç¤º
    if (this.isSearching) {
      setTimeout(() => {
        this.isSearching = false
      }, 100)
    }
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨æœç´¢æ 
        SearchBar({ onSearch: this.onSearch.bind(this) })
          .backgroundColor($r('app.color.primary'))
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })

        // ç©ºç™½åŒºåŸŸï¼ˆç§»é™¤é‡å¤çš„åˆ†ç±»æ ‡ç­¾ï¼‰
        Column()
          .width('100%')
          .height(8)

        // æœç´¢çŠ¶æ€æç¤º
        if (this.isSearching && this.searchText.trim() !== '') {
          Text(`æœç´¢"${this.searchText}"çš„ç»“æœ`)
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .width('100%')
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .backgroundColor($r('app.color.background'))
        }

        // å•†å“ç½‘æ ¼åˆ—è¡¨ï¼ˆç®€åŒ–ç‰ˆç€‘å¸ƒæµæ•ˆæœï¼‰
        if (this.filteredProducts.length > 0) {
          Grid() {
            ForEach(this.filteredProducts, (product: ProductModel, index: number) => {
              GridItem() {
                ProductCardLazy({ product: product })
              }
            }, (product: ProductModel) => product.id)
          }
          .columnsTemplate('1fr 1fr')
          .columnsGap('4%')
          .rowsGap(12)
          .padding({ left: 16, right: 16, top: 8, bottom: 16 })
          .layoutWeight(1)
          .width('100%')
          .backgroundColor($r('app.color.background'))
        } else if (!this.isLoading) {
          // ç©ºçŠ¶æ€
          Column() {
            Text('ğŸ“¦')
              .fontSize(60)
              .margin({ bottom: 16 })
            Text(this.searchText.trim() !== '' ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“' : 'æš‚æ— å•†å“')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
            if (this.searchText.trim() !== '') {
              Button('æ¸…é™¤æœç´¢æ¡ä»¶')
                .height(36)
                .fontSize(14)
                .margin({ top: 16 })
                .onClick(() => {
                  this.searchText = ''
                  this.selectedCategory = 'å…¨éƒ¨'
                  this.filterProducts()
                })
            }
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .backgroundColor($r('app.color.background'))
        }

        // åŠ è½½çŠ¶æ€
        if (this.isLoading) {
          Row() {
            LoadingProgress()
              .width(24)
              .height(24)
            Text('åŠ è½½å•†å“ä¸­...')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ left: 8 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .padding(20)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.background'))
    }

    // åº•éƒ¨å¯¼èˆªæ  - å›ºå®šåœ¨åº•éƒ¨
    BottomNavBar()
      .position({ x: 0, y: '100%' })
      .translate({ x: 0, y: -60 })
  }
  .width('100%')
  .height('100%')
  .backgroundColor($r('app.color.background'))
}