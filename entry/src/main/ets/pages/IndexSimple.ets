import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { StorageManager } from '../utils/StorageManager'
import { User } from '../model/DataModel'
import common from '@ohos.app.ability.common'

@Entry
@Component
struct IndexSimple {
  @State products: ProductModel[] = []
  @State isLoading: boolean = true
  @State user: User | null = null
  @State cartCount: number = 0
  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
    this.loadData()
    this.checkLoginStatus()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
      console.log('IndexSimple: StorageManageråˆå§‹åŒ–æˆåŠŸ')
    } catch (error) {
      console.error('IndexSimple: StorageManageråˆå§‹åŒ–å¤±è´¥:', error)
    }
  }

  private async loadData() {
    setTimeout(() => {
      this.products = MockData.generateProducts()
      this.isLoading = false
      console.log('åŠ è½½å•†å“æ•°æ®å®Œæˆï¼Œæ•°é‡ï¼š', this.products.length)
    }, 500)
  }

  private async checkLoginStatus() {
    try {
      this.user = await this.storage.loadUser()
      console.log('ç™»å½•çŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œç”¨æˆ·ï¼š', this.user?.username)
    } catch (error) {
      console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error)
    }
  }

  private onProductClick(product: ProductModel) {
    router.pushUrl({
      url: 'pages/ProductDetailComplete',
      params: {
        productId: product.id
      }
    })
  }

  @Builder
  HeroBanner() {
    Swiper() {
      ForEach([
        {
          title: 'åä¸º Mate 60 Pro',
          subtitle: 'ç‹è€…å½’æ¥ å¼ºåŠ¿ç™»åœº',
          desc: 'éº’éºŸå›å½’ Â· å«æ˜Ÿé€šè¯ Â· è¶…å…‰å˜å½±åƒ',
          image: 'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/mkt/imgs/2024/01/mate-60-pro-list-kv.png',
          color: '#000000'
        },
        {
          title: 'é¸¿è’™ç”Ÿæ€',
          subtitle: 'ä¸‡ç‰©äº’è” æ™ºæ…§ç”Ÿæ´»',
          desc: 'ç³»ç»Ÿçº§è¿æ¥ Â· æç®€ä½“éªŒ',
          image: 'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/mkt/imgs/2023/08/harmonyos-pc-kv.png',
          color: '#CF0A2C'
        },
        {
          title: 'WATCH GT 4',
          subtitle: 'ä¸“ä¸šè¿åŠ¨å¥åº·ç®¡å®¶',
          desc: '14å¤©è¶…é•¿ç»­èˆª Â· ç²¾å‡†å®šä½',
          image: 'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/market/wearables/watch-gt-4/img/kv/watch-gt-4-kv-black.png',
          color: '#1A5CFF'
        }
      ], (banner: Record<string, string>, index: number) => {
        Stack() {
          Image(banner.image)
            .width('100%')
            .height(180)
            .objectFit(ImageFit.Cover)
            .borderRadius(12)

          Column() {
            Text(banner.title || '')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .margin({ bottom: 4 })

            Text(banner.subtitle || '')
              .fontSize(16)
              .fontColor('rgba(255,255,255,0.9)')
              .margin({ bottom: 8 })

            Text(banner.desc || '')
              .fontSize(14)
              .fontColor('rgba(255,255,255,0.8)')
              .lineHeight(20)
          }
          .width('100%')
          .padding(20)
          .position({ x: 0, y: 0 })
          .linearGradient({
            direction: GradientDirection.Bottom,
            colors: [
              ['rgba(0,0,0,0.6)', 0.0],
              ['rgba(0,0,0,0.3)', 0.7],
              ['rgba(0,0,0,0)', 1.0]
            ]
          })
          .borderRadius({ topLeft: 12, topRight: 12 })
        }
      })
    }
    .width('100%')
    .height(180)
    .autoPlay(true)
    .interval(3000)
    .indicatorStyle({
      size: 6,
      left: 0,
      right: 0,
      bottom: 12,
      color: 'rgba(255,255,255,0.4)',
      selectedColor: Color.White
    })
    .borderRadius(12)
    .margin({ bottom: 16 })
  }

  @Builder
  ProductCard(product: ProductModel) {
    Column() {
      // å›¾ç‰‡å®¹å™¨
      Stack() {
        Image(product.image)
          .width('100%')
          .height(160)
          .objectFit(ImageFit.Contain)
          .backgroundColor('#F5F5F5')
          .borderRadius({ topLeft: 12, topRight: 12 })

        // æŠ˜æ‰£æ ‡ç­¾
        if (product.originalPrice && product.originalPrice > product.price) {
          Text(`${Math.floor(((product.originalPrice - product.price) / product.originalPrice) * 100)}%`)
            .fontSize(12)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#FF0000')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius({ bottomLeft: 8, topRight: 12 })
            .position({ x: 0, y: 0 })
        }
      }

      // å•†å“ä¿¡æ¯
      Column() {
        Text(product.name)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .margin({ bottom: 8 })

        // æ ‡ç­¾
        if (product.tags && product.tags.length > 0) {
          Text(product.tags[0])
            .fontSize(12)
            .fontColor('#999999')
            .backgroundColor('#F5F5F5')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(4)
            .margin({ bottom: 8 })
        }

        // ä»·æ ¼
        Row() {
          Row() {
            Text('Â¥')
              .fontSize(12)
              .fontColor('#FF0000')
              .margin({ top: 2 })
            Text(`${product.price}`)
              .fontSize(18)
              .fontColor('#FF0000')
              .fontWeight(FontWeight.Bold)
          }
          .alignItems(VerticalAlign.Bottom)

          // é”€é‡
          Text(`æœˆé”€ ${Math.floor(Math.random() * 1000 + 100)}`)
            .fontSize(12)
            .fontColor('#999999')
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('100%')
      .padding(12)
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({
      radius: 6,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.onProductClick(product)
    })
  }

  @Builder
  BottomNav() {
    Row() {
      Column() {
        Text('ğŸ ')
          .fontSize(24)
          .margin({ bottom: 4 })
        Text('é¦–é¡µ')
          .fontSize(12)
          .fontColor('#FF0000')
      }
      .width('33.33%')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        // å½“å‰é¡µé¢
      })

      Column() {
        Text('ğŸ›’')
          .fontSize(24)
          .margin({ bottom: 4 })
        Text('è´­ç‰©è½¦')
          .fontSize(12)
          .fontColor('#666666')
      }
      .width('33.33%')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        router.pushUrl({ url: 'pages/CartPageNew' })
      })

      Column() {
        Text(this.user ? 'ğŸ‘¤' : 'ğŸ‘¤')
          .fontSize(24)
          .margin({ bottom: 4 })
        Text(this.user ? 'æˆ‘çš„' : 'ç™»å½•')
          .fontSize(12)
          .fontColor('#666666')
      }
      .width('33.33%')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        if (!this.user) {
          router.pushUrl({ url: 'pages/LoginPage' })
        } else {
          router.pushUrl({ url: 'pages/UserCenterPage' })
        }
      })
    }
    .width('100%')
    .height(60)
    .backgroundColor(Color.White)
    .position({ x: 0, y: '100%' })
    .translate({ x: 0, y: -60 })
    .shadow({
      radius: 10,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: -2
    })
  }

  build() {
    Stack() {
      // ä¸»å†…å®¹
      Scroll() {
        Column() {
          // é¡¶éƒ¨æ ‡é¢˜
          Row() {
            Text('åä¸ºå•†åŸ')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#000000')

            Blank()

            Button('ç™»å½•')
              .fontSize(16)
              .fontColor('#FF0000')
              .backgroundColor(Color.Transparent)
              .border({ width: 1, color: '#FF0000' })
              .borderRadius(20)
              .padding({ left: 20, right: 20 })
              .height(36)
              .onClick(() => {
                router.pushUrl({ url: 'pages/LoginPage' })
              })
          }
          .width('100%')
          .padding(20)
          .margin({ bottom: 20 })

          // Hero æ¨ªå¹…
          this.HeroBanner()

          // å•†å“åˆ—è¡¨
          if (this.products.length > 0) {
            Grid() {
              ForEach(this.products, (product: ProductModel) => {
                GridItem() {
                  this.ProductCard(product)
                }
              })
            }
            .columnsTemplate('1fr 1fr')
            .rowsGap(12)
            .columnsGap(12)
            .padding({ left: 16, right: 16, bottom: 80 })
          } else {
            Text('æš‚æ— å•†å“')
              .fontSize(18)
              .fontColor('#666666')
              .margin({ top: 100 })
          }
        }
        .width('100%')
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')

      // åº•éƒ¨å¯¼èˆª
      this.BottomNav()

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#FF0000')
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#F5F5F5')
        .zIndex(1000)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}