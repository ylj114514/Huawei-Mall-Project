import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { StorageManager } from '../utils/StorageManagerSimple'
import { User } from '../model/DataModel'
import { BannerData } from '../model/PageModels'
import common from '@ohos.app.ability.common'

// ç°ä»£åŒ–é…è‰²æ–¹æ¡ˆ
interface ColorScheme {
  background: string
  surface: string
  primary: string
  secondary: string
  text: string
  textSecondary: string
  accent: string
}

const COLORS: ColorScheme = {
  background: '#F5F7FA',
  surface: '#FFFFFF',
  primary: '#1A1A1A',
  secondary: '#6C757D',
  text: '#2C3E50',
  textSecondary: '#7F8C8D',
  accent: '#3498DB'
}

// å›¾æ ‡æ•°æ®ç±»
class IconData {
  name: string
  icon: string

  constructor(name: string, icon: string) {
    this.name = name
    this.icon = icon
  }
}

@Entry
@Component
struct IndexNewModern {
  @State allProducts: ProductModel[] = []
  @State products: ProductModel[] = []
  @State user: User | null = null
  @State isLoading: boolean = true
  @State searchText: string = ''
  @State currentCategory: string = 'æ¨è'
  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  // å½“å‰é€‰ä¸­çš„åˆ†ç±»
  @State selectedCategory: string = ''

  aboutToAppear() {
    this.initStorage()
    this.loadData()
    this.checkLoginStatus()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
    } catch (error) {
      console.error('åˆå§‹åŒ–å­˜å‚¨å¤±è´¥:', error)
    }
  }

  private loadData() {
    setTimeout(() => {
      this.allProducts = MockData.generateProducts()
      this.products = this.allProducts
      this.isLoading = false
    }, 500)
  }

  // æ ¹æ®åˆ†ç±»ç­›é€‰å•†å“
  private filterProducts(category: string) {
    if (category === '' || category === 'å…¨éƒ¨') {
      this.products = this.allProducts
    } else {
      // å¤„ç†åˆ†ç±»æ˜ å°„
      let actualCategory = category
      if (category === 'è€³æœº') actualCategory = 'éŸ³é¢‘'
      if (category === 'æ‰‹è¡¨') actualCategory = 'æ™ºèƒ½ç©¿æˆ´'

      this.products = this.allProducts.filter(product => product.category === actualCategory)
    }
  }

  private async checkLoginStatus() {
    this.user = await this.storage.loadUser()
  }

  private onProductClick(product: ProductModel) {
    router.pushUrl({
      url: 'pages/ProductDetailFixed',
      params: { productId: product.id }
    })
  }

  private onCategoryClick(category: IconData) {
    this.selectedCategory = category.name
    console.log('ç‚¹å‡»åˆ†ç±»:', category.name)
  }

  @Builder
  Header() {
    Row() {
      // Logo
      Column() {
        Text('HUAWEI')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(COLORS.primary)
        Text('åä¸ºå•†åŸ')
          .fontSize(12)
          .fontColor(COLORS.secondary)
          .margin({ top: -4 })
      }
      .alignItems(HorizontalAlign.Start)

      Blank()

      // æœç´¢æ 
      Row() {
        TextInput({ placeholder: 'æœç´¢å•†å“' })
          .width(200)
          .height(36)
          .fontSize(14)
          .backgroundColor('#F0F2F5')
          .borderRadius(18)
          .padding({ left: 16 })
          .onChange((value: string) => {
            this.searchText = value
          })
      }

      Blank().width(20)

      // ç”¨æˆ·
      Button() {
        Text(this.user ? 'ğŸ‘¤' : 'ğŸ‘¤')
          .fontSize(22)
      }
      .width(36)
      .height(36)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.log('ç”¨æˆ·å¤´åƒç‚¹å‡»')
        router.pushUrl({
          url: 'pages/ProfileModernFixed'
        }).then(() => {
          console.log('å¯¼èˆªåˆ°ä¸ªäººä¸­å¿ƒæˆåŠŸ')
        }).catch((err: Error) => {
          console.error('å¯¼èˆªå¤±è´¥:', err)
        })
      })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 12, bottom: 12 })
    .backgroundColor(COLORS.surface)
  }

  @Builder
  HeroBanner() {
    Swiper() {
      ForEach([
        {
          title: 'Mate 60 ç³»åˆ—',
          subtitle: 'ç„æ­¦æ¶æ„ é¸¿è’™ç”Ÿæ€',
          desc: 'è¶…å…‰å˜å½±åƒ Â· å«æ˜Ÿé€šè¯',
          bgColor: '#1A1A1A'
        },
        {
          title: 'nova 12 ç³»åˆ—',
          subtitle: 'æ½®æµå½±åƒ è¶…çº§å¿«å……',
          desc: 'äººåƒå¤§ç‰‡ Â· è¶…çº§é—ªå……',
          bgColor: '#FF6B6B'
        },
        {
          title: 'WATCH GT 4',
          subtitle: 'ä¸“ä¸šè¿åŠ¨ å¥åº·ç®¡ç†',
          desc: '100+è¿åŠ¨æ¨¡å¼ Â· ç§‘å­¦ç¡çœ ',
          bgColor: '#4ECDC4'
        }
      ], (banner: Record<string, string>) => {
        Column() {
          Text(banner.title)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .margin({ bottom: 8 })

          Text(banner.subtitle)
            .fontSize(16)
            .fontColor('rgba(255,255,255,0.9)')
            .margin({ bottom: 8 })

          Text(banner.desc)
            .fontSize(14)
            .fontColor('rgba(255,255,255,0.8)')
        }
        .width('100%')
        .height(200)
        .padding(20)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(banner.bgColor)
        .borderRadius(16)
      })
    }
    .width('100%')
    .height(200)
    .autoPlay(true)
    .interval(3000)
    .indicatorStyle({
      size: 6,
      left: 20,
      right: 20,
      bottom: 12,
      color: 'rgba(255,255,255,0.4)',
      selectedColor: Color.White
    })
    .padding({ left: 20, right: 20 })
  }

  @Builder
  CategoryGrid() {
    Column() {
      Text('å•†å“åˆ†ç±»')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(COLORS.text)
        .width('100%')
        .margin({ bottom: 20 })
        .padding({ left: 20 })

      Scroll() {
        Row({ space: 12 }) {
          ForEach(['æ‰‹æœº', 'ç¬”è®°æœ¬', 'å¹³æ¿', 'æ‰‹è¡¨', 'è€³æœº', 'æ™ºæ…§å±', 'ç›¸æœº', 'éŸ³å“'], (item: string) => {
            Column() {
              Text(this.getIcon(item))
                .fontSize(30)
                .margin({ bottom: 8 })
              Text(item)
                .fontSize(12)
                .fontColor(COLORS.text)
            }
            .width(80)
            .height(80)
            .justifyContent(FlexAlign.Center)
            .backgroundColor(this.selectedCategory === item ? '#E8E8E8' : Color.Transparent)
            .borderRadius(8)
            .onClick(() => {
              this.selectedCategory = item
              console.log(`åˆ†ç±»æŒ‰é’®ç‚¹å‡»: ${item}`)
              this.filterProducts(item)
            })
          })
        }
        .padding({ left: 20, right: 20 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .width('100%')
      .height(120)
    }
    .width('100%')
    .backgroundColor(COLORS.surface)
    .margin({ top: 12 })
  }

  private getIcon(category: string): string {
    if (category === 'æ‰‹æœº') return 'ğŸ“±'
    if (category === 'ç¬”è®°æœ¬') return 'ğŸ’»'
    if (category === 'å¹³æ¿') return 'ğŸ“²'
    if (category === 'æ‰‹è¡¨') return 'âŒš'
    if (category === 'è€³æœº') return 'ğŸ§'
    if (category === 'æ™ºæ…§å±') return 'ğŸ“º'
    if (category === 'ç›¸æœº') return 'ğŸ“·'
    if (category === 'éŸ³å“') return 'ğŸ”Š'
    return 'ğŸ“±'
  }

  @Builder
  ProductCard(product: ProductModel) {
    Column() {
      // å›¾ç‰‡å®¹å™¨
      Stack() {
        Image(product.image)
          .width('100%')
          .height(180)
          .objectFit(ImageFit.Contain)
          .backgroundColor('#F8F9FA')
          .borderRadius({ topLeft: 12, topRight: 12 })

        // æŠ˜æ‰£æ ‡ç­¾
        if (product.originalPrice && product.originalPrice > product.price) {
          Text(`-${Math.floor(((product.originalPrice - product.price) / product.originalPrice) * 100)}%`)
            .fontSize(12)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#FF6B6B')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius({ bottomLeft: 8, topRight: 12 })
            .position({ x: 0, y: 0 })
        }
      }

      // å•†å“ä¿¡æ¯
      Column() {
        Text(product.name)
          .fontSize(14)
          .fontColor(COLORS.text)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .margin({ bottom: 8 })

        // è¯„åˆ†
        Row() {
          ForEach([1, 2, 3, 4, 5], (star: number) => {
            Text('â˜…')
              .fontSize(12)
              .fontColor(star <= 4 ? '#FFD700' : '#E0E0E0')
          })
          Text(' 4.8')
            .fontSize(12)
            .fontColor(COLORS.textSecondary)
            .margin({ left: 4 })
          Text('(2k+)')
            .fontSize(12)
            .fontColor(COLORS.textSecondary)
        }
        .width('100%')
        .margin({ bottom: 8 })

        // ä»·æ ¼
        Row() {
          Text(`Â¥${product.price}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B6B')

          if (product.originalPrice && product.originalPrice > product.price) {
            Text(`Â¥${product.originalPrice}`)
              .fontSize(14)
              .fontColor(COLORS.textSecondary)
              .decoration({ type: TextDecorationType.LineThrough })
              .margin({ left: 8 })
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
      }
      .padding(12)
      .width('100%')
    }
    .width('100%')
    .backgroundColor(COLORS.surface)
    .borderRadius(12)
    .shadow({
      radius: 6,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => this.onProductClick(product))
  }

  @Builder
  BottomNav() {
    Row() {
      // é¦–é¡µ
      Column() {
        Text('ğŸ ')
          .fontSize(28)
          .margin({ bottom: 4 })
        Text('é¦–é¡µ')
          .fontSize(12)
          .fontColor(COLORS.primary)
      }
      .width('50%')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#F0F2F5')
      .onClick(() => {
        // å½“å‰é¡µé¢
      })

      // ä¸ªäººä¸­å¿ƒ
      Column() {
        Text('ğŸ‘¤')
          .fontSize(28)
          .margin({ bottom: 4 })
        Text('æˆ‘çš„')
          .fontSize(12)
          .fontColor(COLORS.secondary)
      }
      .width('50%')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.log('å¯¼èˆªåˆ°ä¸ªäººä¸­å¿ƒ')
        router.pushUrl({
          url: 'pages/ProfileModernFixed'
        }).then(() => {
          console.log('å¯¼èˆªæˆåŠŸ')
        }).catch((err: Error) => {
          console.error('å¯¼èˆªå¤±è´¥:', err)
        })
      })
    }
    .width('100%')
    .height(60)
    .backgroundColor(COLORS.surface)
    .border({ width: { top: 0.5 }, color: '#E5E5E5' })
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      this.Header()

      // ä¸»å†…å®¹
      Scroll() {
        Column() {
          // è½®æ’­å›¾
          this.HeroBanner()

          // åˆ†ç±»ç½‘æ ¼
          this.CategoryGrid()

          // æ¨èå•†å“
          Column() {
            Row() {
              Text('æ¨èå•†å“')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor(COLORS.text)
              Blank()
              Text('æŸ¥çœ‹å…¨éƒ¨')
                .fontSize(14)
                .fontColor(COLORS.textSecondary)
            }
            .width('100%')
            .padding({ left: 20, right: 20, top: 24, bottom: 16 })

            // å•†å“ç½‘æ ¼
            Grid() {
              ForEach(this.products, (product: ProductModel) => {
                GridItem() {
                  this.ProductCard(product)
                }
              })
            }
            .columnsTemplate('1fr 1fr')
            .rowsGap(12)
            .columnsGap(12)
            .padding({ left: 20, right: 20, bottom: 80 })
          }
        }
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor(COLORS.background)
      .edgeEffect(EdgeEffect.Spring)

      // åº•éƒ¨å¯¼èˆª
      this.BottomNav()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(COLORS.background)
  }
}