import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { DatabaseManager } from '../database/DatabaseManager' // âœ… å¼•å…¥ DB
import { BottomNavBar } from '../components/BottomNavBar'

@Entry
@Component
struct Index {
  @State products: ProductModel[] = []
  @State filteredProducts: ProductModel[] = []
  @State searchText: string = ''
  @State selectedCategory: string = 'å…¨éƒ¨'
  @State isLoading: boolean = true
  @State isSearching: boolean = false

  // å•†å“åˆ†ç±»
  private categories: string[] = ['å…¨éƒ¨', 'æ‰‹æœº', 'å¹³æ¿', 'ç”µè„‘', 'è€³æœº', 'æ™ºèƒ½æ‰‹è¡¨']

  // âœ… æ”¹ç”¨ onPageShowï¼Œè¿™æ ·ä»Žè¯¦æƒ…é¡µå›žæ¥ä¹Ÿèƒ½åˆ·æ–°çŠ¶æ€
  onPageShow() {
    this.loadData()
  }

  // âœ… æ ¸å¿ƒä¿®æ”¹ï¼šä»Žæ•°æ®åº“åŠ è½½ï¼Œä½†ä¿ç•™å›¾ç‰‡èµ„æº
  private async loadData() {
    this.isLoading = true
    try {
      // 1. èŽ·å– DB æ•°æ®
      const dbRows = await DatabaseManager.getInstance().getAllProducts()

      // 2. èŽ·å– Mock æ•°æ®ï¼ˆä»…ç”¨äºŽæ‰¾å›žå›¾ç‰‡èµ„æºï¼‰
      const mockProducts = MockData.generateProducts()

      const combinedProducts: ProductModel[] = []

      for (const row of dbRows) {
        // å°† DB è¡Œè½¬ä¸º Model
        const p = new ProductModel(
          row.id, row.name, row.price, row.originalPrice,
          row.description, row.detailDescription,
          [], // å…ˆç½®ç©ºï¼Œä¸‹é¢è¡¥
          row.category, row.tags, row.rating, row.reviewCount, row.stock
        )
        // è¡¥å…¨å­—æ®µ
        p.sales = row.sales
        p.isNew = row.isNew

        // 3. å›¾ç‰‡â€œå«æŽ¥â€ï¼šå¦‚æžœ Mock é‡Œæœ‰è¿™ä¸ª IDï¼Œå°±ç”¨ Mock çš„ Resource å›¾ç‰‡
        const mockMatch = mockProducts.find(m => m.id === row.id)
        if (mockMatch && mockMatch.images.length > 0) {
          p.image = mockMatch.image
          p.images = mockMatch.images
        } else {
          // å¦‚æžœæ˜¯æ–°å¢žçš„å•†å“ï¼Œç»™ä¸ªé»˜è®¤å›¾
          p.image = $r('app.media.APP')
          p.images = [$r('app.media.APP')]
        }

        combinedProducts.push(p)
      }

      this.products = combinedProducts
      // é‡æ–°åº”ç”¨å½“å‰çš„è¿‡æ»¤æ¡ä»¶ï¼ˆæœç´¢/åˆ†ç±»ï¼‰
      this.filterProducts()

    } catch (e) {
      console.error('åŠ è½½é¦–é¡µæ•°æ®å¤±è´¥:', e)
    } finally {
      this.isLoading = false
    }
  }

  /**
   * æœç´¢å¤„ç† (ä¿ç•™åŽŸé€»è¾‘)
   */
  private onSearch(text: string) {
    this.searchText = text
    this.isSearching = text.trim() !== ''
    this.filterProducts()
  }

  /**
   * ç­›é€‰å•†å“ (ä¿ç•™åŽŸé€»è¾‘)
   */
  private filterProducts() {
    let filtered = this.products

    // æŒ‰åˆ†ç±»ç­›é€‰
    if (this.selectedCategory !== 'å…¨éƒ¨') {
      filtered = filtered.filter(product => {
        return product.category === this.selectedCategory
      })
    }

    // æŒ‰æœç´¢å…³é”®è¯ç­›é€‰
    if (this.searchText.trim() !== '') {
      const query = this.searchText.toLowerCase()
      filtered = filtered.filter(product =>
      product.name.toLowerCase().includes(query) ||
      product.description.toLowerCase().includes(query)
      )
    }

    this.filteredProducts = filtered
  }

  /**
   * é€‰æ‹©åˆ†ç±»
   */
  private onCategorySelect(category: string) {
    this.selectedCategory = category
    this.filterProducts()
  }

  /**
   * ç‚¹å‡»å•†å“ (è·³è½¬ä¿æŒä¸å˜)
   */
  private onProductClick(product: ProductModel) {
    router.pushUrl({
      url: 'pages/ProductDetailPage', // âœ… ç¡®ä¿è·³åˆ°æ­£ç¡®çš„è¯¦æƒ…é¡µæ–‡ä»¶å
      params: {
        product: product // âœ… ä¼ é€’æ•´ä¸ªå¯¹è±¡ï¼Œæˆ–è€…åªä¼ IDä¹Ÿå¯ä»¥ï¼Œå–å†³äºŽè¯¦æƒ…é¡µæ€Žä¹ˆæ”¶
      }
    })
  }

  @Builder
  HeroSection() {
    Stack() {
      // èƒŒæ™¯æ¸å˜
      Column()
        .width('100%')
        .height(280)
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [
            ['#1a1a1a', 0.0],
            ['#2d2d2d', 0.5],
            ['#1a1a1a', 1.0]
          ]
        })

      // ä¸»è¦å†…å®¹
      Column() {
        // å“ç‰Œæ ‡é¢˜
        Text('HUAWEI')
          .fontSize(32)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Bold)
          .letterSpacing(4)
          .margin({ top: 60, bottom: 20 })

        // æœç´¢æ 
        Row() {
          Text('ðŸ”')
            .fontSize(18)
            .fontColor('#666666')
            .margin({ left: 16 })
          TextInput({
            placeholder: 'æœç´¢æ‚¨æƒ³è¦çš„äº§å“',
            text: this.searchText
          })
            .fontSize(16)
            .fontColor(Color.White)
            .backgroundColor(Color.Transparent)
            .layoutWeight(1)
            .placeholderColor('#666666')
            .onChange((value: string) => {
              this.searchText = value
              this.onSearch(value)
            })
        }
        .width('90%')
        .height(48)
        .backgroundColor('#ffffff15')
        .borderRadius(24)
        .backdropBlur(10)
        .padding({ right: 16 })

        // å“ç‰Œæ ‡è¯­
        Text('æž„å»ºä¸‡ç‰©äº’è”çš„æ™ºèƒ½ä¸–ç•Œ')
          .fontSize(14)
          .fontColor('#ffffff80')
          .letterSpacing(2)
          .margin({ top: 20 })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height(280)
  }

  build() {
    Column() {
      // HeroåŒºåŸŸ
      this.HeroSection()

      // ä¸»è¦å†…å®¹
      Scroll() {
        Column() {
          // åˆ†ç±»æ ‡é¢˜
          Row() {
            Text('äº§å“åˆ†ç±»')
              .fontSize(24)
              .fontColor('#1a1a1a')
              .fontWeight(FontWeight.Bold)
            Blank()
          }
          .width('100%')
          .padding(20)

          // åˆ†ç±»æ ‡ç­¾
          Scroll() {
            Row({ space: 12 }) {
              ForEach(this.categories, (category: string) => {
                Button(category)
                  .fontSize(14)
                  .fontColor(this.selectedCategory === category ? Color.White : '#1a1a1a')
                  .backgroundColor(this.selectedCategory === category ? '#007AFF' : '#f0f0f0')
                  .borderRadius(20)
                  .padding({ left: 24, right: 24, top: 12, bottom: 12 })
                  .shadow(this.selectedCategory === category ? {
                    radius: 8,
                    color: '#007AFF30',
                    offsetX: 0,
                    offsetY: 2
                  } : undefined)
                  .onClick(() => this.onCategorySelect(category))
              })
            }
            .width('100%')
            .padding({ left: 20, right: 20 })
          }
          .width('100%')
          .scrollBar(BarState.Off)
          .scrollable(ScrollDirection.Horizontal)
          .height(50)
          .margin({ bottom: 20 })

          // å•†å“ç½‘æ ¼åˆ—è¡¨
          if (this.filteredProducts.length > 0) {
            Grid() {
              ForEach(this.filteredProducts, (product: ProductModel) => {
                GridItem() {
                  this.ProductCard(product)
                }
              }, (product: ProductModel) => product.id)
            }
            .columnsTemplate('1fr 1fr')
            .rowsGap(16)
            .columnsGap(16)
            .padding(20)
            .width('100%')
          } else if (!this.isLoading) {
            // ç©ºçŠ¶æ€
            Column() {
              Text('ðŸ“¦')
                .fontSize(60)
                .margin({ bottom: 16 })
              Text(this.searchText.trim() !== '' ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“' : 'æš‚æ— å•†å“')
                .fontSize(16)
                .fontColor('#666666')
            }
            .width('100%')
            .layoutWeight(1)
            .justifyContent(FlexAlign.Center)
          } else {
            // åŠ è½½çŠ¶æ€
            Column() {
              LoadingProgress()
                .width(40)
                .height(40)
              Text('åŠ è½½ä¸­...')
                .fontSize(14)
                .fontColor('#666666')
                .margin({ top: 16 })
            }
            .width('100%')
            .layoutWeight(1)
            .justifyContent(FlexAlign.Center)
          }
        }
        .width('100%')
        .padding({ bottom: 80 })
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#f5f5f7')

      // åº•éƒ¨å¯¼èˆªæ 
      BottomNavBar()
        .position({ x: 0, y: '100%' })
        .translate({ x: 0, y: -60 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f7')
  }

  @Builder
  ProductCard(product: ProductModel) {
    Column() {
      // å›¾ç‰‡å®¹å™¨
      Stack() {
        // å•†å“å›¾ç‰‡
        Image(product.image)
          .width('100%')
          .height(200)
          .objectFit(ImageFit.Cover)
          .borderRadius({ topLeft: 20, topRight: 20 })
          .backgroundColor('#f0f0f0')
          .alt('å•†å“å›¾ç‰‡')

        // æŠ˜æ‰£æ ‡ç­¾
        if (product.originalPrice > product.price) {
          Text(`${Math.floor(((product.originalPrice - product.price) / product.originalPrice) * 100)}% OFF`)
            .fontSize(12)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#FF3B30')
            .padding({ left: 10, right: 10, top: 5, bottom: 5 })
            .borderRadius({ bottomLeft: 12, topRight: 20 })
            .position({ x: 0, y: 0 })
        }
      }

      // å•†å“ä¿¡æ¯
      Column() {
        // å•†å“åç§°
        Text(product.name)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1a1a1a')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .margin({ bottom: 8 })

        // ä»·æ ¼åŒºåŸŸ
        Row() {
          Row() {
            Text('Â¥')
              .fontSize(12)
              .fontColor('#FF3B30')
              .margin({ top: 2 })
            Text(`${product.price}`)
              .fontSize(20)
              .fontColor('#FF3B30')
              .fontWeight(FontWeight.Bold)
          }

          Blank()

          // åŠ å·æŒ‰é’®
          Button() {
            Text('+')
              .fontSize(20)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
          }
          .width(32)
          .height(32)
          .backgroundColor('#007AFF')
          .borderRadius(16)
          .shadow({
            radius: 8,
            color: '#007AFF40',
            offsetX: 0,
            offsetY: 2
          })
          .onClick((e) => {
            // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è·³åˆ°è¯¦æƒ…é¡µ
            // e.stopPropagation() // ArkTS æ—§ç‰ˆå¯èƒ½ä¸æ”¯æŒï¼Œå¦‚æžœæ”¯æŒè¯·åŠ ä¸Š
            // è¿™é‡Œå¯ä»¥åšä¸€ä¸ªå¿«é€ŸåŠ è´­ç‰©è½¦çš„é€»è¾‘ï¼Œæš‚æ—¶å…ˆä¸å†™ï¼Œä»¥å…æŠ¥é”™
          })
        }
        .width('100%')
        .alignItems(VerticalAlign.Bottom)
      }
      .width('100%')
      .padding(16)
    }
    .width('100%')
    .height(300)
    .backgroundColor(Color.White)
    .borderRadius(20)
    .shadow({
      radius: 12,
      color: '#00000010',
      offsetX: 0,
      offsetY: 4
    })
    .onClick(() => {
      this.onProductClick(product)
    })
  }
}