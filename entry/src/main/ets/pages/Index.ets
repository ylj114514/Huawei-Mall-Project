import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { User } from '../model/DataModel'
import { AuthService } from '../services/AuthService'
import common from '@ohos.app.ability.common'

// =========================================
// 1. æ•°æ®æ¨¡åž‹å®šä¹‰
// =========================================

// è·¯ç”±å‚æ•°ç±»
class ProductParams {
  productId: string
  constructor(productId: string) {
    this.productId = productId
  }
}

// è½®æ’­å›¾æ•°æ®ç±»
class BannerItem {
  title: string
  subtitle: string
  desc: string
  bgColor: string

  constructor(title: string, subtitle: string, desc: string, bgColor: string) {
    this.title = title
    this.subtitle = subtitle
    this.desc = desc
    this.bgColor = bgColor
  }
}

// çŽ°ä»£åŒ–é…è‰²æ–¹æ¡ˆ
interface ColorScheme {
  background: string
  surface: string
  primary: string
  secondary: string
  text: string
  textSecondary: string
  accent: string
}

const COLORS: ColorScheme = {
  background: '#F5F7FA',
  surface: '#FFFFFF',
  primary: '#1A1A1A',
  secondary: '#6C757D',
  text: '#2C3E50',
  textSecondary: '#7F8C8D',
  accent: '#3498DB'
}

@Entry
@Component
struct Index {
  @State allProducts: ProductModel[] = []
  @State products: ProductModel[] = []

  // âœ… æ–°å¢žï¼šæœç´¢ç›¸å…³çŠ¶æ€
  @State searchSuggestions: ProductModel[] = []
  @State isSearching: boolean = false
  @State searchText: string = ''

  @State user: User | null = null
  @State isLoading: boolean = true
  @State selectedCategory: string = ''

  private authService: AuthService = AuthService.getInstance()

  // è½®æ’­å›¾æ•°æ® (ä¿ç•™åŽŸé…ç½®)
  private banners: BannerItem[] = [
    new BannerItem('Mate 60 ç³»åˆ—', 'çŽ„æ­¦æž¶æž„ é¸¿è’™ç”Ÿæ€', 'è¶…å…‰å˜å½±åƒ Â· å«æ˜Ÿé€šè¯', '#1A1A1A'),
    new BannerItem('nova 12 ç³»åˆ—', 'æ½®æµå½±åƒ è¶…çº§å¿«å……', 'äººåƒå¤§ç‰‡ Â· è¶…çº§é—ªå……', '#FF6B6B'),
    new BannerItem('WATCH GT 4', 'ä¸“ä¸šè¿åŠ¨ å¥åº·ç®¡ç†', '100+è¿åŠ¨æ¨¡å¼ Â· ç§‘å­¦ç¡çœ ', '#4ECDC4')
  ]

  private categoryNames: string[] = ['æ‰‹æœº', 'ç¬”è®°æœ¬', 'å¹³æ¿', 'æ‰‹è¡¨', 'è€³æœº', 'æ™ºæ…§å±', 'ç›¸æœº', 'éŸ³å“']

  aboutToAppear() {
    this.loadData()
    this.checkLoginStatus()
  }

  onPageShow() {
    this.checkLoginStatus()
  }

  private loadData() {
    setTimeout(() => {
      this.allProducts = MockData.generateProducts()
      this.products = this.allProducts
      this.isLoading = false
    }, 500)
  }

  private async checkLoginStatus() {
    this.user = await this.authService.getCurrentUser()
  }

  // âœ… æ–°å¢žï¼šæœç´¢è¾“å…¥å¤„ç†é€»è¾‘
  private handleSearchInput(value: string) {
    this.searchText = value
    if (value.trim().length === 0) {
      this.isSearching = false
      this.searchSuggestions = []
      this.products = this.allProducts
      return
    }

    this.isSearching = true
    const query = value.toLowerCase()

    // æ¨¡ç³ŠåŒ¹é…
    this.searchSuggestions = this.allProducts.filter(p =>
    p.name.toLowerCase().includes(query) ||
      (p.description && p.description.toLowerCase().includes(query))
    )

    // ä¸»åˆ—è¡¨ä¹ŸåŒæ­¥æ›´æ–°
    this.products = this.searchSuggestions
  }

  // æ ¹æ®åˆ†ç±»ç­›é€‰å•†å“
  private filterProducts(category: string) {
    if (category === '' || category === 'å…¨éƒ¨') {
      this.products = this.allProducts
    } else {
      let actualCategory = category
      if (category === 'æ‰‹è¡¨') actualCategory = 'æ™ºèƒ½æ‰‹è¡¨'
      if (category === 'ç”µè„‘') actualCategory = 'ç¬”è®°æœ¬'

      this.products = this.allProducts.filter(product =>
      product.category.includes(actualCategory) ||
      product.name.includes(actualCategory)
      )
    }
  }

  private onProductClick(product: ProductModel) {
    this.isSearching = false // ç‚¹å‡»åŽå…³é—­æœç´¢çŠ¶æ€
    router.pushUrl({
      url: 'pages/ProductDetailPage',
      params: new ProductParams(product.id)
    })
  }

  private getIcon(category: string): string {
    if (category === 'æ‰‹æœº') return 'ðŸ“±'
    if (category === 'ç¬”è®°æœ¬') return 'ðŸ’»'
    if (category === 'å¹³æ¿') return 'ðŸ“²'
    if (category === 'æ‰‹è¡¨') return 'âŒš'
    if (category === 'è€³æœº') return 'ðŸŽ§'
    if (category === 'æ™ºæ…§å±') return 'ðŸ“º'
    if (category === 'ç›¸æœº') return 'ðŸ“·'
    if (category === 'éŸ³å“') return 'ðŸ”Š'
    return 'ðŸ“±'
  }

  // =========================================
  // UI æž„å»ºéƒ¨åˆ†
  // =========================================

  @Builder
  Header() {
    Column() {
      Row() {
        // Logo
        Column() {
          Text('HUAWEI')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(COLORS.primary)
          Text('åŽä¸ºå•†åŸŽ')
            .fontSize(12)
            .fontColor(COLORS.secondary)
            .margin({ top: -4 })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        // æœç´¢æ 
        Row() {
          TextInput({ placeholder: 'æœç´¢å•†å“', text: this.searchText })
            .width(200)
            .height(36)
            .fontSize(14)
            .backgroundColor('#F0F2F5')
            .borderRadius(18)
            .padding({ left: 16 })
            .onChange((value: string) => {
              this.handleSearchInput(value) // âœ… ç»‘å®šæœç´¢é€»è¾‘
            })
        }

        Blank().width(20)

        // ç”¨æˆ·å¤´åƒ
        Button() {
          if (this.user && this.user.avatar) {
            Image(this.user.avatar)
              .width(36)
              .height(36)
              .borderRadius(18)
          } else {
            Text('ðŸ‘¤')
              .fontSize(22)
          }
        }
        .width(36)
        .height(36)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          if (this.user) {
            router.pushUrl({ url: 'pages/UserCenterPage' })
          } else {
            router.pushUrl({ url: 'pages/LoginPage' })
          }
        })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 12, bottom: 12 })
      .backgroundColor(COLORS.surface)

      // âœ… æ–°å¢žï¼šæœç´¢è”æƒ³åˆ—è¡¨ (æ‚¬æµ®åœ¨ Header ä¸‹æ–¹)
      if (this.isSearching && this.searchSuggestions.length > 0) {
        List() {
          ForEach(this.searchSuggestions, (item: ProductModel) => {
            ListItem() {
              Row() {
                Text('ðŸ”').fontSize(12).fontColor(COLORS.secondary).margin({ right: 8 })
                Text(item.name)
                  .fontSize(14)
                  .fontColor(COLORS.text)
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .layoutWeight(1)
              }
              .width('100%')
              .padding(12)
              .backgroundColor(COLORS.surface)
              .onClick(() => this.onProductClick(item))
            }
          })
        }
        .width('100%')
        .backgroundColor(COLORS.surface)
        .shadow({ radius: 10, color: 'rgba(0,0,0,0.1)', offsetY: 5 })
        .position({ x: 0, y: 60 })
        .zIndex(999)
        // âœ… æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ constraintSize è€Œä¸æ˜¯ constraints
        .constraintSize({ maxHeight: 200 })
      }
    }
    .zIndex(100) // ç¡®ä¿ Header æ•´ä½“åœ¨æœ€ä¸Šå±‚
  }

  @Builder
  HeroBanner() {
    Swiper() {
      ForEach(this.banners, (banner: BannerItem) => {
        Column() {
          Text(banner.title)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .margin({ bottom: 8 })

          Text(banner.subtitle)
            .fontSize(16)
            .fontColor('rgba(255,255,255,0.9)')
            .margin({ bottom: 8 })

          Text(banner.desc)
            .fontSize(14)
            .fontColor('rgba(255,255,255,0.8)')
        }
        .width('100%')
        .height(200)
        .padding(20)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(banner.bgColor)
        .borderRadius(16)
      })
    }
    .width('100%')
    .height(200)
    .autoPlay(true)
    .interval(3000)
    .indicatorStyle({
      size: 6,
      left: 20,
      right: 20,
      bottom: 12,
      color: 'rgba(255,255,255,0.4)',
      selectedColor: Color.White
    })
    .padding({ left: 20, right: 20 })
  }

  @Builder
  CategoryGrid() {
    Column() {
      Text('å•†å“åˆ†ç±»')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(COLORS.text)
        .width('100%')
        .margin({ bottom: 20 })
        .padding({ left: 20 })

      Scroll() {
        Row({ space: 12 }) {
          ForEach(this.categoryNames, (item: string) => {
            Column() {
              Text(this.getIcon(item))
                .fontSize(30)
                .margin({ bottom: 8 })
              Text(item)
                .fontSize(12)
                .fontColor(COLORS.text)
            }
            .width(80)
            .height(80)
            .justifyContent(FlexAlign.Center)
            .backgroundColor(this.selectedCategory === item ? '#E8E8E8' : Color.Transparent)
            .borderRadius(8)
            .onClick(() => {
              this.selectedCategory = item
              this.filterProducts(item)
            })
          })
        }
        .padding({ left: 20, right: 20 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .width('100%')
      .height(120)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .backgroundColor(COLORS.surface)
    .margin({ top: 12 })
  }

  @Builder
  ProductCard(product: ProductModel) {
    Column() {
      // å›¾ç‰‡å®¹å™¨
      Stack() {
        Image(product.image)
          .width('100%')
          .height(180)
          .objectFit(ImageFit.Contain)
          .backgroundColor('#F8F9FA')
          .borderRadius({ topLeft: 12, topRight: 12 })

        // æŠ˜æ‰£æ ‡ç­¾
        if (product.originalPrice && product.originalPrice > product.price) {
          Text(`-${Math.floor(((product.originalPrice - product.price) / product.originalPrice) * 100)}%`)
            .fontSize(12)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#FF6B6B')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius({ bottomLeft: 8, topRight: 12 })
            .position({ x: 0, y: 0 })
        }
      }

      // å•†å“ä¿¡æ¯
      Column() {
        Text(product.name)
          .fontSize(14)
          .fontColor(COLORS.text)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .margin({ bottom: 8 })

        // è¯„åˆ†
        Row() {
          ForEach([1, 2, 3, 4, 5], (star: number) => {
            Text('â˜…')
              .fontSize(12)
              .fontColor(star <= 4 ? '#FFD700' : '#E0E0E0')
          })
          Text(' 4.8')
            .fontSize(12)
            .fontColor(COLORS.textSecondary)
            .margin({ left: 4 })
          Text('(2k+)')
            .fontSize(12)
            .fontColor(COLORS.textSecondary)
        }
        .width('100%')
        .margin({ bottom: 8 })

        // ä»·æ ¼
        Row() {
          Text(`Â¥${product.price}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B6B')

          if (product.originalPrice && product.originalPrice > product.price) {
            Text(`Â¥${product.originalPrice}`)
              .fontSize(14)
              .fontColor(COLORS.textSecondary)
              .decoration({ type: TextDecorationType.LineThrough })
              .margin({ left: 8 })
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
      }
      .padding(12)
      .width('100%')
    }
    .width('100%')
    .backgroundColor(COLORS.surface)
    .borderRadius(12)
    .shadow({
      radius: 6,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => this.onProductClick(product))
  }

  @Builder
  BottomNav() {
    Row() {
      // é¦–é¡µ
      Column() {
        Text('ðŸ ')
          .fontSize(28)
          .margin({ bottom: 4 })
        Text('é¦–é¡µ')
          .fontSize(12)
          .fontColor(COLORS.primary)
      }
      .width('50%')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#F0F2F5')

      // ä¸ªäººä¸­å¿ƒ
      Column() {
        Text('ðŸ‘¤')
          .fontSize(28)
          .margin({ bottom: 4 })
        Text('æˆ‘çš„')
          .fontSize(12)
          .fontColor(COLORS.secondary)
      }
      .width('50%')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        if (this.user) {
          router.pushUrl({ url: 'pages/UserCenterPage' })
        } else {
          router.pushUrl({ url: 'pages/LoginPage' })
        }
      })
    }
    .width('100%')
    .height(60)
    .backgroundColor(COLORS.surface)
    .border({ width: { top: 0.5 }, color: '#E5E5E5' })
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      this.Header()

      // ä¸»å†…å®¹
      Scroll() {
        Column() {
          // è½®æ’­å›¾
          this.HeroBanner()

          // åˆ†ç±»ç½‘æ ¼
          this.CategoryGrid()

          // æŽ¨èå•†å“
          Column() {
            Row() {
              Text('æŽ¨èå•†å“')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor(COLORS.text)
              Blank()
              Text('æŸ¥çœ‹å…¨éƒ¨')
                .fontSize(14)
                .fontColor(COLORS.textSecondary)
            }
            .width('100%')
            .padding({ left: 20, right: 20, top: 24, bottom: 16 })

            // å•†å“ç½‘æ ¼
            Grid() {
              ForEach(this.products, (product: ProductModel) => {
                GridItem() {
                  this.ProductCard(product)
                }
              }, (product: ProductModel) => product.id)
            }
            .columnsTemplate('1fr 1fr')
            .rowsGap(12)
            .columnsGap(12)
            .padding({ left: 20, right: 20, bottom: 80 })
          }
        }
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor(COLORS.background)
      .edgeEffect(EdgeEffect.Spring)
      .scrollBar(BarState.Off)

      // åº•éƒ¨å¯¼èˆª
      this.BottomNav()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(COLORS.background)
  }
}