import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { SearchBarSimple } from '../components/SearchBarSimple'
import { BottomNavBar } from '../components/BottomNavBar'
import { AppService } from '../services/AppService'

@Component
struct ProductCard {
  @Prop product: ProductModel
  onProductClick: (product: ProductModel) => void = () => {}

  build() {
    Column() {
      // å•†å“å›¾ç‰‡å®¹å™¨
      Stack() {
        // å•†å“å›¾ç‰‡
        Image(this.product.image)
          .width('100%')
          .height(180)
          .borderRadius({ topLeft: 12, topRight: 12 })
          .objectFit(ImageFit.Cover)
          .backgroundColor('#f8f8f8')
          .alt('å•†å“å›¾ç‰‡')

        // æŠ˜æ‰£æ ‡ç­¾
        if (this.product.originalPrice > this.product.price) {
          Text(`çœ${Math.floor(((this.product.originalPrice - this.product.price) / this.product.originalPrice) * 100)}%`)
            .fontSize(10)
            .fontColor(Color.White)
            .backgroundColor('#ff4444')
            .borderRadius(8)
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .position({ x: 8, y: 8 })
        }
      }

      // å•†å“ä¿¡æ¯
      Column() {
        // å•†å“åç§°
        Text(this.product.name)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .margin({ bottom: 6 })
          .lineHeight(20)

        // å•†å“æè¿°/æ ‡ç­¾
        if (this.product.tags && this.product.tags.length > 0) {
          Row() {
            ForEach(this.product.tags.slice(0, 2), (tag: string, index: number) => {
              Text(tag)
                .fontSize(10)
                .fontColor($r('app.color.primary'))
                .backgroundColor('#f0f8ff')
                .borderRadius(4)
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .margin({ right: index === 0 ? 6 : 0 })
            })
          }
          .width('100%')
          .margin({ bottom: 8 })
        }

        // ä»·æ ¼åŒºåŸŸ
        Row() {
          Column() {
            Row() {
              Text('Â¥')
                .fontSize(12)
                .fontWeight(FontWeight.Bold)
                .fontColor('#ff4444')
                .margin({ top: 2 })
              Text(`${this.product.price}`)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#ff4444')
            }

            // åŸä»·
            if (this.product.originalPrice > this.product.price) {
              Text(`Â¥${this.product.originalPrice}`)
                .fontSize(12)
                .fontColor('#999999')
                .decoration({ type: TextDecorationType.LineThrough })
            }
          }
          .alignItems(HorizontalAlign.Start)

          Blank()

          // è¯„åˆ†
          if (this.product.rating) {
            Row() {
              Text('â­')
                .fontSize(10)
              Text(this.product.rating.toFixed(1))
                .fontSize(10)
                .fontColor('#666666')
            }
          }
        }
        .width('100%')
        .alignItems(VerticalAlign.Bottom)

        // é”€é‡ä¿¡æ¯
        Text(`å·²å”®${Math.floor(this.product.reviewCount * 10)}+`)
          .fontSize(10)
          .fontColor('#999999')
          .width('100%')
          .margin({ top: 4 })
      }
      .width('100%')
      .padding(12)
      .layoutWeight(1)
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
    .height(300)
    .backgroundColor($r('app.color.white'))
    .borderRadius(12)
    .shadow({
      radius: 6,
      color: '#10000000',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.onProductClick(this.product)
    })
  }
}

@Entry
@Component
struct Index {
  @State products: ProductModel[] = []
  @State filteredProducts: ProductModel[] = []
  @State searchText: string = ''
  @State selectedCategory: string = 'å…¨éƒ¨'
  @State isLoading: boolean = true
  @State isSearching: boolean = false
  private appService: AppService = AppService.getInstance()

  // å•†å“åˆ†ç±»
  private categories: string[] = ['å…¨éƒ¨', 'æ‰‹æœº', 'å¹³æ¿', 'ç”µè„‘', 'è€³æœº', 'æ™ºèƒ½æ‰‹è¡¨']

  aboutToAppear() {
    this.initApp()
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨
   */
  private async initApp(): Promise<void> {
    try {
      // åˆå§‹åŒ–AppServiceï¼ˆåŒ…å«æ•°æ®åº“åˆå§‹åŒ–ï¼‰
      await this.appService.init(getContext(this))
      console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ')

      // åŠ è½½é¡µé¢æ•°æ®
      this.loadData()
    } catch (error) {
      console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error)
      // å³ä½¿åˆå§‹åŒ–å¤±è´¥ï¼Œä¹ŸåŠ è½½åŸºæœ¬æ•°æ®
      this.loadData()
    }
  }

  private loadData() {
    // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
    setTimeout(() => {
      this.products = MockData.generateProducts()
      this.filteredProducts = this.products

      this.isLoading = false
    }, 1000)
  }

  /**
   * æœç´¢å¤„ç†
   */
  private onSearch(text: string) {
    this.searchText = text
    this.isSearching = text.trim() !== ''
    this.filterProducts()
  }

  /**
   * ç­›é€‰å•†å“
   */
  private filterProducts() {
    let filtered = this.products

    // æŒ‰åˆ†ç±»ç­›é€‰ - æ›´ä¸¥æ ¼çš„åŒ¹é…
    if (this.selectedCategory !== 'å…¨éƒ¨') {
      filtered = filtered.filter(product => {
        // ç›´æ¥åŒ¹é…åˆ†ç±»
        if (product.category === this.selectedCategory) {
          return true
        }
        // åŒ¹é…åˆ†ç±»åˆ«å
        if (this.selectedCategory === 'æ‰‹æœº' && product.category === 'æ™ºèƒ½æ‰‹æœº') {
          return true
        }
        if (this.selectedCategory === 'æ™ºèƒ½æ‰‹è¡¨' && product.category === 'æ™ºèƒ½ç©¿æˆ´') {
          return true
        }
        if (this.selectedCategory === 'å¹³æ¿' && product.category === 'å¹³æ¿ç”µè„‘') {
          return true
        }
        if (this.selectedCategory === 'ç”µè„‘' && (product.category === 'ç¬”è®°æœ¬' || product.category === 'å°å¼æœº')) {
          return true
        }
        if (this.selectedCategory === 'è€³æœº' && (product.category === 'éŸ³é¢‘' || product.name.includes('è€³æœº') || product.name.includes('FreeBuds'))) {
          return true
        }
        return false
      })
    }

    // æŒ‰æœç´¢å…³é”®è¯ç­›é€‰
    if (this.searchText.trim() !== '') {
      const query = this.searchText.toLowerCase()
      filtered = filtered.filter(product =>
        product.name.toLowerCase().includes(query) ||
        product.description.toLowerCase().includes(query) ||
        product.tags.some(tag => tag.toLowerCase().includes(query))
      )
    }

    this.filteredProducts = filtered
  }

  /**
   * é€‰æ‹©åˆ†ç±»
   */
  private onCategorySelect(category: string) {
    this.selectedCategory = category
    this.filterProducts()
  }

  /**
   * ç‚¹å‡»å•†å“
   */
  private onProductClick(product: ProductModel) {
    router.pushUrl({
      url: 'pages/ProductDetailPage',
      params: {
        productId: product.id
      }
    })
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨æœç´¢æ 
        Column() {
          SearchBarSimple({ onSearch: this.onSearch.bind(this) })
        }
        .backgroundColor($r('app.color.primary'))
        .padding({ top: 8, bottom: 8 })

        // ç©ºç™½åŒºåŸŸ
        Column()
          .width('100%')
          .height(8)

        // æœç´¢çŠ¶æ€æç¤º
        if (this.isSearching && this.searchText.trim() !== '') {
          Text(`æœç´¢"${this.searchText}"çš„ç»“æœ`)
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .width('100%')
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .backgroundColor($r('app.color.background'))
        }

        // å•†å“åˆ†ç±»
        Scroll() {
          Row({ space: 12 }) {
            ForEach(this.categories, (category: string) => {
              Button(category)
                .fontSize(14)
                .fontColor(this.selectedCategory === category ? Color.White : $r('app.color.text_primary'))
                .backgroundColor(this.selectedCategory === category ? $r('app.color.primary') : $r('app.color.background'))
                .borderRadius(18)
                .padding({ left: 20, right: 20, top: 10, bottom: 10 })
                .margin({ right: category === this.categories[this.categories.length - 1] ? 16 : 0 })
                .onClick(() => this.onCategorySelect(category))
                .shadow(this.selectedCategory === category ? {
                  radius: 4,
                  color: '#33000000',
                  offsetX: 0,
                  offsetY: 2
                } : undefined)
            })
          }
          .width('100%')
          .padding({ left: 16, top: 12, bottom: 12 })
        }
        .width('100%')
        .height(50)
        .scrollBar(BarState.Off)
        .scrollable(ScrollDirection.Horizontal)
        .edgeEffect(EdgeEffect.Spring)
        .backgroundColor($r('app.color.white'))

        // å•†å“ç½‘æ ¼åˆ—è¡¨
        if (this.filteredProducts.length > 0) {
          Grid() {
            ForEach(this.filteredProducts, (product: ProductModel) => {
              GridItem() {
                ProductCard({ product: product, onProductClick: this.onProductClick.bind(this) })
              }
            }, (product: ProductModel) => product.id)
          }
          .columnsTemplate('1fr 1fr')
          .rowsGap(12)
          .columnsGap(12)
          .padding(16)
          .width('100%')
          .layoutWeight(1)
        } else if (!this.isLoading) {
          // ç©ºçŠ¶æ€
          Column() {
            Text('ğŸ“¦')
              .fontSize(60)
              .margin({ bottom: 16 })
            Text(this.searchText.trim() !== '' ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“' : 'æš‚æ— å•†å“')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
            if (this.searchText.trim() !== '') {
              Button('æ¸…é™¤æœç´¢æ¡ä»¶')
                .height(36)
                .fontSize(14)
                .margin({ top: 16 })
                .onClick(() => {
                  this.searchText = ''
                  this.selectedCategory = 'å…¨éƒ¨'
                  this.filterProducts()
                })
            }
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .backgroundColor($r('app.color.background'))
        } else {
          // åŠ è½½çŠ¶æ€
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
            Text('åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 16 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .backgroundColor($r('app.color.background'))
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.background'))

      // åº•éƒ¨å¯¼èˆªæ  - å›ºå®šåœ¨åº•éƒ¨
      BottomNavBar()
        .position({ x: 0, y: '100%' })
        .translate({ x: 0, y: -60 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}