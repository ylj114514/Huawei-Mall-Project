import router from '@ohos.router'
import { User } from '../model/DataModel'
import { StorageManager } from '../utils/StorageManager'
import { CartService } from '../services/CartService'
import { AppService } from '../services/AppService'

@Entry
@Component
struct UserCenterPageSimple {
  @State user: User | null = null
  @State isLoading: boolean = true
  @State cartCount: number = 0
  private appService: AppService = AppService.getInstance()
  private storage: StorageManager = StorageManager.getInstance()
  private cartService: CartService = CartService.getInstance()

  aboutToAppear() {
    this.refreshData()
  }

  /**
   * åŠ è½½ç”¨æˆ·æ•°æ®
   */
  private async loadUserData(): Promise<void> {
    try {
      this.user = await this.storage.loadUser()
      if (this.user) {
        this.isLoading = false
      } else {
        // æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
        this.isLoading = false
        router.replaceUrl({ url: 'pages/LoginPage' })
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error)
      this.isLoading = false
    }
  }

  /**
   * åŠ è½½ç»Ÿè®¡ä¿¡æ¯
   */
  private async loadStatistics(): Promise<void> {
    try {
      this.cartCount = this.cartService.getTotalCount()
    } catch (error) {
      console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error)
      this.cartCount = 0
    }
  }

  private navigateToPage(page: string): void {
    try {
      console.log('å¯¼èˆªåˆ°é¡µé¢:', page)
      router.pushUrl({ url: page })
    } catch (error) {
      console.error('é¡µé¢å¯¼èˆªå¤±è´¥:', error)
    }
  }

  /**
   * åˆ·æ–°æ•°æ®
   */
  private async refreshData(): Promise<void> {
    await Promise.all([
      this.loadUserData(),
      this.loadStatistics()
    ])
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â†')
          .width(40)
          .height(40)
          .backgroundColor(Color.Transparent)
          .fontColor(Color.White)
          .fontSize(18)
          .onClick(() => {
            router.replaceUrl({ url: 'pages/Index' })
          })

        Text('ä¸ªäººä¸­å¿ƒ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .fontColor(Color.White)

        Blank().width(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor($r('app.color.primary'))
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      } else if (this.user) {
        // å·²ç™»å½•çŠ¶æ€
        Scroll() {
          Column() {
            // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
            Row() {
              Text('ğŸ‘¤')
                .fontSize(40)
                .margin({ right: 16 })

              Column() {
                Text(this.user.username)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .width('100%')

                Text(`${this.user.getLevelText()} | ç§¯åˆ†: ${this.user.points}`)
                  .fontSize(14)
                  .fontColor($r('app.color.text_secondary'))
                  .width('100%')
                  .margin({ top: 4 })
              }
              .layoutWeight(1)

              Text('>')
                .fontSize(16)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ left: 16, right: 16, top: 16 })
            .onClick(() => {})

            // ç»Ÿè®¡ä¿¡æ¯
            Row() {
              Column() {
                Text('ğŸ›’')
                  .fontSize(24)
                  .margin({ bottom: 4 })
                Text(this.cartCount.toString())
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 2 })
                Text('è´­ç‰©è½¦')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('33%')
              .justifyContent(FlexAlign.Center)
              .onClick(() => this.navigateToPage('pages/CartPageNew'))

              Column() {
                Text('ğŸ“¦')
                  .fontSize(24)
                  .margin({ bottom: 4 })
                Text('0')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 2 })
                Text('è®¢å•')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('33%')
              .justifyContent(FlexAlign.Center)

              Column() {
                Text('ğŸ’¬')
                  .fontSize(24)
                  .margin({ bottom: 4 })
                Text('0')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 2 })
                Text('è¯„ä»·')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('34%')
              .justifyContent(FlexAlign.Center)
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ left: 16, right: 16, top: 12 })

            // åŠŸèƒ½èœå•
            Column() {
              Text('æˆ‘çš„æœåŠ¡')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .width('100%')
                .margin({ bottom: 12 })

              
              Row() {
                Text('ğŸ’¬')
                  .fontSize(20)
                  .margin({ right: 12 })

                Column() {
                  Text('æˆ‘çš„è¯„ä»·')
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                    .width('100%')
                  Text('æŸ¥çœ‹è¯„ä»·è®°å½•')
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary'))
                    .width('100%')
                    .margin({ top: 2 })
                }
                .layoutWeight(1)

                Text('>')
                  .fontSize(16)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('100%')
              .padding(16)
              .justifyContent(FlexAlign.Start)
              .onClick(() => {
                this.navigateToPage('pages/MyReviewsPage')
              })

              Divider()
                .width('100%')
                .margin({ left: 16, right: 16 })

              Row() {
                Text('ğŸ“')
                  .fontSize(20)
                  .margin({ right: 12 })

                Column() {
                  Text('æ”¶è´§åœ°å€')
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                    .width('100%')
                  Text('ç®¡ç†æ”¶è´§åœ°å€')
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary'))
                    .width('100%')
                    .margin({ top: 2 })
                }
                .layoutWeight(1)

                Text('>')
                  .fontSize(16)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('100%')
              .padding(16)
              .justifyContent(FlexAlign.Start)
              .onClick(() => this.navigateToPage('pages/AddressManagePage'))
            }
            .width('100%')
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ left: 16, right: 16, bottom: 12 })

            // è®¾ç½®
            Column() {
              Row() {
                Text('ğŸšª')
                  .fontSize(20)
                  .margin({ right: 12 })

                Text('é€€å‡ºç™»å½•')
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
                  .layoutWeight(1)

                Text('>')
                  .fontSize(16)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('100%')
              .padding(16)
              .backgroundColor($r('app.color.white'))
              .borderRadius(12)
              .margin({ left: 16, right: 16, bottom: 16 })
              .justifyContent(FlexAlign.Start)
              .onClick(async () => {
                try {
                  // æ¸…é™¤ç”¨æˆ·æ•°æ®
                  await this.storage.saveUser(null)
                  this.user = null
                  console.log('ç”¨æˆ·é€€å‡ºç™»å½•')
                  // è·³è½¬åˆ°ç™»å½•é¡µ
                  router.replaceUrl({ url: 'pages/LoginPage' })
                } catch (error) {
                  console.error('é€€å‡ºç™»å½•å¤±è´¥:', error)
                }
              })
            }
            .width('100%')

            // åº•éƒ¨å ä½
            Column()
              .width('100%')
              .height(20)
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor($r('app.color.background'))
      } else {
        // æœªç™»å½•çŠ¶æ€
        Column() {
          // ç”¨æˆ·å¤´åƒå’Œç™»å½•æŒ‰é’®
          Column() {
            Text('ğŸ‘¤')
              .fontSize(80)
              .margin({ bottom: 24 })
            Text('ç™»å½•åäº«å—æ›´å¤šæœåŠ¡')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 32 })

            Button('ç«‹å³ç™»å½•')
              .width(200)
              .height(44)
              .fontSize(16)
              .backgroundColor($r('app.color.primary'))
              .fontColor(Color.White)
              .borderRadius(22)
              .onClick(() => {
                router.pushUrl({ url: 'pages/LoginPage' })
              })
          }
          .width('100%')
          .padding(48)
          .justifyContent(FlexAlign.Center)

          // å¿«é€Ÿè®¿é—®
          Row() {
            Column() {
              Text('ğŸ ')
                .fontSize(24)
                .margin({ bottom: 4 })
              Text('é¦–é¡µ')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('25%')
            .justifyContent(FlexAlign.Center)
            .onClick(() => {
              router.replaceUrl({ url: 'pages/Index' })
            })

            Column() {
              Text('ğŸ›’')
                .fontSize(24)
                .margin({ bottom: 4 })
              Text('è´­ç‰©è½¦')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('25%')
            .justifyContent(FlexAlign.Center)
            .onClick(() => this.navigateToPage('pages/CartPageNew'))

            
            Column() {
              Text('ğŸ“¦')
                .fontSize(24)
                .margin({ bottom: 4 })
              Text('è®¢å•')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('25%')
            .justifyContent(FlexAlign.Center)
          }
          .width('100%')
          .padding(16)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .margin({ left: 16, right: 16, bottom: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}