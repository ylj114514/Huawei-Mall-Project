import router from '@ohos.router'
import { User } from '../model/DataModel'
// import { StorageManager } from '../utils/StorageManager' // âŒ å·²ç§»é™¤ï¼Œä¸å†å¼•ç”¨
import { AuthService } from '../services/AuthService' // âœ… ä½¿ç”¨æ–°æœåŠ¡
import { CartService } from '../services/CartService'
import { AppService } from '../services/AppService'

@Entry
@Component
struct UserCenterPageSimple {
  @State user: User | null = null
  @State isLoading: boolean = true
  @State cartCount: number = 0
  @State isAdmin: boolean = false // âœ… æ–°å¢ç®¡ç†å‘˜çŠ¶æ€

  // è·å–æœåŠ¡å®ä¾‹
  private appService: AppService = AppService.getInstance()
  private authService: AuthService = AuthService.getInstance() // âœ… æ›¿æ¢ StorageManager
  private cartService: CartService = CartService.getInstance()

  aboutToAppear() {
    this.refreshData()
  }

  // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°ï¼Œç¡®ä¿æ•°æ®æœ€æ–°
  onPageShow() {
    this.refreshData()
  }

  /**
   * åŠ è½½ç”¨æˆ·æ•°æ® (ä¿®å¤æŠ¥é”™)
   */
  private async loadUserData(): Promise<void> {
    try {
      // âœ… æ”¹ç”¨ AuthService è·å–å½“å‰ç”¨æˆ·
      this.user = await this.authService.getCurrentUser()

      if (this.user) {
        // âœ… æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        this.isAdmin = await this.authService.isAdmin()
        this.isLoading = false
      } else {
        // æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
        this.isLoading = false
        // router.replaceUrl({ url: 'pages/LoginPage' }) // æš‚æ—¶æ³¨é‡Šï¼Œå…è®¸æŸ¥çœ‹æœªç™»å½•æ€UI
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error)
      this.isLoading = false
    }
  }

  /**
   * åŠ è½½ç»Ÿè®¡ä¿¡æ¯
   */
  private async loadStatistics(): Promise<void> {
    try {
      // âœ… ç¡®ä¿è´­ç‰©è½¦æ•°æ®æ˜¯æœ€æ–°çš„
      await this.cartService.refreshCart()
      this.cartCount = this.cartService.getTotalCount()
    } catch (error) {
      console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error)
      this.cartCount = 0
    }
  }

  /**
   * è¾…åŠ©æ–¹æ³•ï¼šè·å–ä¼šå‘˜ç­‰çº§æ–‡æœ¬
   * (åœ¨é¡µé¢å†…å¤„ç†ï¼Œé˜²æ­¢ User å¯¹è±¡ä¸¢å¤±æ–¹æ³•å¯¼è‡´å´©æºƒ)
   */
  private getLevelText(level: string | undefined): string {
    switch (level) {
      case 'bronze': return 'é’é“œä¼šå‘˜'
      case 'silver': return 'ç™½é“¶ä¼šå‘˜'
      case 'gold': return 'é»„é‡‘ä¼šå‘˜'
      case 'platinum': return 'é“‚é‡‘ä¼šå‘˜' // å¯¹åº”ä½ çš„DataModel
      default: return 'æ™®é€šä¼šå‘˜'
    }
  }

  private navigateToPage(page: string): void {
    try {
      console.log('å¯¼èˆªåˆ°é¡µé¢:', page)
      router.pushUrl({ url: page })
    } catch (error) {
      console.error('é¡µé¢å¯¼èˆªå¤±è´¥:', error)
    }
  }

  /**
   * åˆ·æ–°æ•°æ®
   */
  private async refreshData(): Promise<void> {
    await Promise.all([
      this.loadUserData(),
      this.loadStatistics()
    ])
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ  (å®Œå…¨ä¿ç•™)
      Row() {
        Button('â†')
          .width(40)
          .height(40)
          .backgroundColor(Color.Transparent)
          .fontColor(Color.White)
          .fontSize(18)
          .onClick(() => {
            router.replaceUrl({ url: 'pages/Index' })
          })

        Text('ä¸ªäººä¸­å¿ƒ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .fontColor(Color.White)

        Blank().width(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor($r('app.color.primary'))
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      } else if (this.user) {
        // å·²ç™»å½•çŠ¶æ€ (UI å¸ƒå±€å®Œå…¨ä¿ç•™)
        Scroll() {
          Column() {
            // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
            Row() {
              Text('ğŸ‘¤')
                .fontSize(40)
                .margin({ right: 16 })

              Column() {
                Text(this.user.username)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .width('100%')

                // âœ… ä¿®å¤ï¼šä½¿ç”¨æœ¬åœ°æ–¹æ³•è·å–ç­‰çº§æ–‡æœ¬ï¼Œé˜²æ­¢æŠ¥é”™
                Text(`${this.getLevelText(this.user.level)} | ç§¯åˆ†: ${this.user.points || 0}`)
                  .fontSize(14)
                  .fontColor($r('app.color.text_secondary'))
                  .width('100%')
                  .margin({ top: 4 })
              }
              .layoutWeight(1)

              Text('>')
                .fontSize(16)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ left: 16, right: 16, top: 16 })
            .onClick(() => {})

            // ç»Ÿè®¡ä¿¡æ¯
            Row() {
              Column() {
                Text('ğŸ›’')
                  .fontSize(24)
                  .margin({ bottom: 4 })
                Text(this.cartCount.toString())
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 2 })
                Text('è´­ç‰©è½¦')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('33%')
              .justifyContent(FlexAlign.Center)
              .onClick(() => this.navigateToPage('pages/CartPage')) // âœ… ä¿®æ­£ï¼šè·³è½¬åˆ° CartPage

              Column() {
                Text('ğŸ“¦')
                  .fontSize(24)
                  .margin({ bottom: 4 })
                Text('0')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 2 })
                Text('è®¢å•')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('33%')
              .justifyContent(FlexAlign.Center)

              Column() {
                Text('ğŸ’¬')
                  .fontSize(24)
                  .margin({ bottom: 4 })
                Text('0')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 2 })
                Text('è¯„ä»·')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('34%')
              .justifyContent(FlexAlign.Center)
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ left: 16, right: 16, top: 12 })

            // åŠŸèƒ½èœå•
            Column() {
              Text('æˆ‘çš„æœåŠ¡')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .width('100%')
                .margin({ bottom: 12 })

              Row() {
                Text('ğŸ’¬')
                  .fontSize(20)
                  .margin({ right: 12 })

                Column() {
                  Text('æˆ‘çš„è¯„ä»·')
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                    .width('100%')
                  Text('æŸ¥çœ‹è¯„ä»·è®°å½•')
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary'))
                    .width('100%')
                    .margin({ top: 2 })
                }
                .layoutWeight(1)

                Text('>')
                  .fontSize(16)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('100%')
              .padding(16)
              .justifyContent(FlexAlign.Start)
              .onClick(() => {
                this.navigateToPage('pages/MyReviewsPage')
              })

              Divider()
                .width('100%')
                .margin({ left: 16, right: 16 })

              Row() {
                Text('ğŸ“')
                  .fontSize(20)
                  .margin({ right: 12 })

                Column() {
                  Text('æ”¶è´§åœ°å€')
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                    .width('100%')
                  Text('ç®¡ç†æ”¶è´§åœ°å€')
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary'))
                    .width('100%')
                    .margin({ top: 2 })
                }
                .layoutWeight(1)

                Text('>')
                  .fontSize(16)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('100%')
              .padding(16)
              .justifyContent(FlexAlign.Start)
              .onClick(() => this.navigateToPage('pages/AddressManagePage'))

              // âœ… ç®¡ç†å‘˜åå°å…¥å£ (ä¿ç•™é€»è¾‘ï¼Œä»…ç®¡ç†å‘˜å¯è§)
              if (this.isAdmin) {
                Divider()
                  .width('100%')
                  .margin({ left: 16, right: 16 })

                Row() {
                  Text('âš™ï¸')
                    .fontSize(20)
                    .margin({ right: 12 })

                  Column() {
                    Text('ç®¡ç†å‘˜åå°')
                      .fontSize(14)
                      .fontColor($r('app.color.text_primary'))
                      .width('100%')
                    Text('å•†å“ç®¡ç†')
                      .fontSize(12)
                      .fontColor($r('app.color.text_secondary'))
                      .width('100%')
                      .margin({ top: 2 })
                  }
                  .layoutWeight(1)

                  Text('>')
                    .fontSize(16)
                    .fontColor($r('app.color.text_secondary'))
                }
                .width('100%')
                .padding(16)
                .justifyContent(FlexAlign.Start)
                .onClick(() => this.navigateToPage('pages/AdminDashboard'))
              }
            }
            .width('100%')
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ left: 16, right: 16, bottom: 12 })

            // é€€å‡ºç™»å½•
            Column() {
              Row() {
                Text('ğŸšª')
                  .fontSize(20)
                  .margin({ right: 12 })

                Text('é€€å‡ºç™»å½•')
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
                  .layoutWeight(1)

                Text('>')
                  .fontSize(16)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('100%')
              .padding(16)
              .backgroundColor($r('app.color.white'))
              .borderRadius(12)
              .margin({ left: 16, right: 16, bottom: 16 })
              .justifyContent(FlexAlign.Start)
              .onClick(async () => {
                try {
                  // âœ… ä¿®å¤ï¼šä½¿ç”¨ AuthService é€€å‡º
                  this.authService.logout()
                  this.user = null
                  console.log('ç”¨æˆ·é€€å‡ºç™»å½•')
                  router.replaceUrl({ url: 'pages/LoginPage' })
                } catch (error) {
                  console.error('é€€å‡ºç™»å½•å¤±è´¥:', error)
                }
              })
            }
            .width('100%')

            // åº•éƒ¨å ä½
            Column()
              .width('100%')
              .height(20)
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor($r('app.color.background'))
      } else {
        // æœªç™»å½•çŠ¶æ€ (UI å¸ƒå±€å®Œå…¨ä¿ç•™)
        Column() {
          // ç”¨æˆ·å¤´åƒå’Œç™»å½•æŒ‰é’®
          Column() {
            Text('ğŸ‘¤')
              .fontSize(80)
              .margin({ bottom: 24 })
            Text('ç™»å½•åäº«å—æ›´å¤šæœåŠ¡')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 32 })

            Button('ç«‹å³ç™»å½•')
              .width(200)
              .height(44)
              .fontSize(16)
              .backgroundColor($r('app.color.primary'))
              .fontColor(Color.White)
              .borderRadius(22)
              .onClick(() => {
                router.pushUrl({ url: 'pages/LoginPage' })
              })
          }
          .width('100%')
          .padding(48)
          .justifyContent(FlexAlign.Center)

          // å¿«é€Ÿè®¿é—®
          Row() {
            Column() {
              Text('ğŸ ')
                .fontSize(24)
                .margin({ bottom: 4 })
              Text('é¦–é¡µ')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('25%')
            .justifyContent(FlexAlign.Center)
            .onClick(() => {
              router.replaceUrl({ url: 'pages/Index' })
            })

            Column() {
              Text('ğŸ›’')
                .fontSize(24)
                .margin({ bottom: 4 })
              Text('è´­ç‰©è½¦')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('25%')
            .justifyContent(FlexAlign.Center)
            .onClick(() => this.navigateToPage('pages/CartPage')) // âœ… ä¿®æ­£ï¼šè·³è½¬åˆ° CartPage


            Column() {
              Text('ğŸ“¦')
                .fontSize(24)
                .margin({ bottom: 4 })
              Text('è®¢å•')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('25%')
            .justifyContent(FlexAlign.Center)
          }
          .width('100%')
          .padding(16)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .margin({ left: 16, right: 16, bottom: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}