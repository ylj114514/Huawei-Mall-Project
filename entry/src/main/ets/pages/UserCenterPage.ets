import router from '@ohos.router';
import { User } from '../model/DataModel';
// âœ… ä¿®å¤å¼•ç”¨ï¼šä½¿ç”¨ AuthService æ›¿ä»£å·²ç§»é™¤çš„ StorageManager
import { AuthService } from '../services/AuthService';
import { CartService } from '../services/CartService';
import { AppService } from '../services/AppService';

@Entry
@Component
struct UserCenterPage {
  @State user: User | null = null;
  @State isLoading: boolean = true;
  @State cartCount: number = 0;
  @State isAdmin: boolean = false; // âœ… é€‚é…ç®¡ç†å‘˜é€»è¾‘

  // è·å–æœåŠ¡å®ä¾‹
  private appService: AppService = AppService.getInstance();
  private authService: AuthService = AuthService.getInstance(); // âœ… æ›¿æ¢ StorageManager
  private cartService: CartService = CartService.getInstance();

  aboutToAppear() {
    this.refreshData();
  }

  // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°ï¼Œç¡®ä¿æ•°æ®æœ€æ–°
  onPageShow() {
    this.refreshData();
  }

  /**
   * åŠ è½½ç”¨æˆ·æ•°æ®
   */
  private async loadUserData(): Promise<void> {
    try {
      // âœ… é€‚é…é€»è¾‘ï¼šä½¿ç”¨ AuthService è·å–å½“å‰ç”¨æˆ·
      this.user = await this.authService.getCurrentUser();

      if (this.user) {
        // âœ… é€‚é…é€»è¾‘ï¼šæ£€æŸ¥ç®¡ç†å‘˜æƒé™
        this.isAdmin = await this.authService.isAdmin();
        this.isLoading = false;
      } else {
        this.isLoading = false;
        // æœªç™»å½•æ—¶ä¸å¼ºåˆ¶è·³è½¬ï¼Œå…è®¸æ˜¾ç¤ºæœªç™»å½• UI
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
      this.isLoading = false;
    }
  }

  /**
   * åŠ è½½ç»Ÿè®¡ä¿¡æ¯
   */
  private async loadStatistics(): Promise<void> {
    try {
      // âœ… é€‚é…é€»è¾‘ï¼šåˆ·æ–°è´­ç‰©è½¦
      await this.cartService.refreshCart();
      this.cartCount = this.cartService.getTotalCount();
    } catch (error) {
      console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
      this.cartCount = 0;
    }
  }

  /**
   * è¾…åŠ©æ–¹æ³•ï¼šè·å–ä¼šå‘˜ç­‰çº§æ–‡æœ¬
   */
  private getLevelText(level: string | undefined): string {
    switch (level) {
      case 'bronze': return 'é’é“œä¼šå‘˜';
      case 'silver': return 'ç™½é“¶ä¼šå‘˜';
      case 'gold': return 'é»„é‡‘ä¼šå‘˜';
      case 'platinum': return 'é“‚é‡‘ä¼šå‘˜';
      default: return 'æ™®é€šä¼šå‘˜';
    }
  }

  private navigateToPage(page: string): void {
    try {
      router.pushUrl({ url: page });
    } catch (error) {
      console.error('é¡µé¢å¯¼èˆªå¤±è´¥:', error);
    }
  }

  private async refreshData(): Promise<void> {
    await Promise.all([
      this.loadUserData(),
      this.loadStatistics()
    ]);
  }

  build() {
    Column() {
      // ----------------------------------------------------------------
      // 1. é¡¶éƒ¨å¯¼èˆªæ  (ä¿æŒ GitHub åŸç‰ˆ UI)
      // ----------------------------------------------------------------
      Row() {
        Button('â†')
          .width(40)
          .height(40)
          .backgroundColor(Color.Transparent)
          .fontColor(Color.White)
          .fontSize(18)
          .onClick(() => {
            router.replaceUrl({ url: 'pages/Index' });
          })

        Text('ä¸ªäººä¸­å¿ƒ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .fontColor(Color.White)

        Blank().width(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor($r('app.color.primary'))
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      } else if (this.user) {
        // ----------------------------------------------------------------
        // 2. å·²ç™»å½•çŠ¶æ€ (ä¿æŒ GitHub åŸç‰ˆ UI)
        // ----------------------------------------------------------------
        Scroll() {
          Column() {
            // (A) ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
            Row() {
              // å¤´åƒåŒºåŸŸ
              Text('ğŸ‘¤') // è¿™é‡Œå¯ä»¥ç”¨ Image(this.user.avatar) ä¼˜åŒ–ï¼Œä½†åŸç‰ˆæ˜¯ emoji å°±å…ˆä¿ç•™
                .fontSize(40)
                .margin({ right: 16 })

              Column() {
                // âœ… é€‚é…å­—æ®µï¼šusername
                Text(this.user.username)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .width('100%')

                Text(`${this.getLevelText(this.user.level)} | ç§¯åˆ†: ${this.user.points || 0}`)
                  .fontSize(14)
                  .fontColor($r('app.color.text_secondary'))
                  .width('100%')
                  .margin({ top: 4 })
              }
              .layoutWeight(1)

              Text('>')
                .fontSize(16)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ left: 16, right: 16, top: 16 })
            .onClick(() => {
              // âœ… è·³è½¬åˆ°ç¼–è¾‘èµ„æ–™é¡µé¢
              this.navigateToPage('pages/EditProfilePage');
            })

            // (B) ç»Ÿè®¡ä¿¡æ¯æ  (è´­ç‰©è½¦/è®¢å•/è¯„ä»·)
            Row() {
              Column() {
                Text('ğŸ›’')
                  .fontSize(24)
                  .margin({ bottom: 4 })
                Text(this.cartCount.toString())
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 2 })
                Text('è´­ç‰©è½¦')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('33%')
              .justifyContent(FlexAlign.Center)
              .onClick(() => this.navigateToPage('pages/CartPage'))

              Column() {
                Text('ğŸ“¦')
                  .fontSize(24)
                  .margin({ bottom: 4 })
                Text('0') // è®¢å•æ•°æš‚æœªå¯¹æ¥
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 2 })
                Text('è®¢å•')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('33%')
              .justifyContent(FlexAlign.Center)

              Column() {
                Text('ğŸ’¬')
                  .fontSize(24)
                  .margin({ bottom: 4 })
                Text('0') // è¯„ä»·æ•°æš‚æœªå¯¹æ¥
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .margin({ bottom: 2 })
                Text('è¯„ä»·')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('34%')
              .justifyContent(FlexAlign.Center)
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ left: 16, right: 16, top: 12 })

            // (C) åŠŸèƒ½èœå•
            Column() {
              Text('æˆ‘çš„æœåŠ¡')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .width('100%')
                .margin({ bottom: 12 })

              // æˆ‘çš„è¯„ä»·
              Row() {
                Text('ğŸ’¬')
                  .fontSize(20)
                  .margin({ right: 12 })

                Column() {
                  Text('æˆ‘çš„è¯„ä»·')
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                    .width('100%')
                  Text('æŸ¥çœ‹è¯„ä»·è®°å½•')
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary'))
                    .width('100%')
                    .margin({ top: 2 })
                }
                .layoutWeight(1)

                Text('>')
                  .fontSize(16)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('100%')
              .padding(16)
              .justifyContent(FlexAlign.Start)
              .onClick(() => {
                this.navigateToPage('pages/MyReviewsPage');
              })

              Divider()
                .width('100%')
                .margin({ left: 16, right: 16 })

              // æ”¶è´§åœ°å€
              Row() {
                Text('ğŸ“')
                  .fontSize(20)
                  .margin({ right: 12 })

                Column() {
                  Text('æ”¶è´§åœ°å€')
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                    .width('100%')
                  Text('ç®¡ç†æ”¶è´§åœ°å€')
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary'))
                    .width('100%')
                    .margin({ top: 2 })
                }
                .layoutWeight(1)

                Text('>')
                  .fontSize(16)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('100%')
              .padding(16)
              .justifyContent(FlexAlign.Start)
              .onClick(() => this.navigateToPage('pages/AddressManagePage'))

              // ç®¡ç†å‘˜åå° (ä»…ç®¡ç†å‘˜æ˜¾ç¤º)
              if (this.isAdmin) {
                Divider()
                  .width('100%')
                  .margin({ left: 16, right: 16 })

                Row() {
                  Text('âš™ï¸')
                    .fontSize(20)
                    .margin({ right: 12 })

                  Column() {
                    Text('ç®¡ç†å‘˜åå°')
                      .fontSize(14)
                      .fontColor($r('app.color.text_primary'))
                      .width('100%')
                    Text('å•†å“ç®¡ç†')
                      .fontSize(12)
                      .fontColor($r('app.color.text_secondary'))
                      .width('100%')
                      .margin({ top: 2 })
                  }
                  .layoutWeight(1)

                  Text('>')
                    .fontSize(16)
                    .fontColor($r('app.color.text_secondary'))
                }
                .width('100%')
                .padding(16)
                .justifyContent(FlexAlign.Start)
                .onClick(() => this.navigateToPage('pages/AdminDashboard'))
              }
            }
            .width('100%')
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ left: 16, right: 16, bottom: 12 })

            // (D) é€€å‡ºç™»å½•
            Column() {
              Row() {
                Text('ğŸšª')
                  .fontSize(20)
                  .margin({ right: 12 })

                Text('é€€å‡ºç™»å½•')
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
                  .layoutWeight(1)

                Text('>')
                  .fontSize(16)
                  .fontColor($r('app.color.text_secondary'))
              }
              .width('100%')
              .padding(16)
              .backgroundColor($r('app.color.white'))
              .borderRadius(12)
              .margin({ left: 16, right: 16, bottom: 16 })
              .justifyContent(FlexAlign.Start)
              .onClick(async () => {
                try {
                  // âœ… é€‚é…é€»è¾‘ï¼šè°ƒç”¨ AuthService é€€å‡º
                  await this.authService.logout();
                  this.user = null;
                  router.replaceUrl({ url: 'pages/LoginPage' });
                } catch (error) {
                  console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                }
              })
            }
            .width('100%')

            Column()
              .width('100%')
              .height(20)
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor($r('app.color.background'))
      } else {
        // ----------------------------------------------------------------
        // 3. æœªç™»å½•çŠ¶æ€ (ä¿æŒ GitHub åŸç‰ˆ UI)
        // ----------------------------------------------------------------
        Column() {
          Column() {
            Text('ğŸ‘¤')
              .fontSize(80)
              .margin({ bottom: 24 })
            Text('ç™»å½•åäº«å—æ›´å¤šæœåŠ¡')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 32 })

            Button('ç«‹å³ç™»å½•')
              .width(200)
              .height(44)
              .fontSize(16)
              .backgroundColor($r('app.color.primary'))
              .fontColor(Color.White)
              .borderRadius(22)
              .onClick(() => {
                router.pushUrl({ url: 'pages/LoginPage' });
              })
          }
          .width('100%')
          .padding(48)
          .justifyContent(FlexAlign.Center)

          // å¿«é€Ÿè®¿é—®æ  (æœªç™»å½•æ€)
          Row() {
            Column() {
              Text('ğŸ ')
                .fontSize(24)
                .margin({ bottom: 4 })
              Text('é¦–é¡µ')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('25%')
            .justifyContent(FlexAlign.Center)
            .onClick(() => {
              router.replaceUrl({ url: 'pages/Index' });
            })

            Column() {
              Text('ğŸ›’')
                .fontSize(24)
                .margin({ bottom: 4 })
              Text('è´­ç‰©è½¦')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('25%')
            .justifyContent(FlexAlign.Center)
            .onClick(() => this.navigateToPage('pages/CartPage'))

            Column() {
              Text('ğŸ“¦')
                .fontSize(24)
                .margin({ bottom: 4 })
              Text('è®¢å•')
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
            }
            .width('25%')
            .justifyContent(FlexAlign.Center)
          }
          .width('100%')
          .padding(16)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .margin({ left: 16, right: 16, bottom: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}