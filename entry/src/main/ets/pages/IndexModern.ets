import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { BottomNavBar } from '../components/BottomNavBar'

@Entry
@Component
struct IndexModern {
  @State products: ProductModel[] = []
  @State currentBanner: number = 0
  @State searchText: string = ''
  @State categories: string[] = ['æ‰‹æœº', 'ç¬”è®°æœ¬', 'å¹³æ¿', 'ç©¿æˆ´', 'éŸ³é¢‘', 'æ™ºæ…§å±']
  private bannerImages = [
    'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/market/mobiles-phones/mate-60-pro/img/kv/mate-60-pro-kv-black.png',
    'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/market/wearables/watch-gt-4/img/kv/watch-gt-4-kv-black.png',
    'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/market/tablets/matepad-pro/img/kv/matepad-pro-kv-gray.png'
  ]

  aboutToAppear() {
    this.loadProducts()
  }

  private async loadProducts() {
    // æ¨¡æ‹Ÿå¼‚æ­¥åŠ è½½
    setTimeout(() => {
      this.products = MockData.generateProducts()
    }, 500)
  }

  @Builder
  HeroSection() {
    Stack() {
      // èƒŒæ™¯æ¸å˜
      Column()
        .width('100%')
        .height(280)
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [
            ['#1a1a1a', 0.0],
            ['#2d2d2d', 0.5],
            ['#1a1a1a', 1.0]
          ]
        })

      // ä¸»è¦å†…å®¹
      Column() {
        // é¡¶éƒ¨æœç´¢æ 
        Row() {
          Button() {
            Row() {
              Text('ğŸ”')
                .fontSize(18)
                .fontColor('#666666')
              TextInput({
                placeholder: 'æœç´¢åä¸ºäº§å“',
                text: this.searchText
              })
                .fontSize(16)
                .backgroundColor(Color.Transparent)
                .layoutWeight(1)
                .placeholderColor('#666666')
            }
          }
          .width('90%')
          .height(44)
          .backgroundColor('#ffffff08')
          .borderRadius(22)
          .backdropBlur(10)
          .padding({ left: 16, right: 16 })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ top: 20, bottom: 30 })

        // è½®æ’­æ¨ªå¹…
        Swiper() {
          ForEach(this.bannerImages, (img: string, index: number) => {
            Column() {
              Image(img)
                .width('100%')
                .height(160)
                .objectFit(ImageFit.Contain)
                .borderRadius(16)
                .shadow({
                  radius: 20,
                  color: '#00000030',
                  offsetX: 0,
                  offsetY: 10
                })
            }
          })
        }
        .width('90%')
        .height(160)
        .loop(true)
        .autoPlay(true)
        .interval(4000)
        .indicatorStyle({
          size: 6,
          color: '#ffffff40',
          selectedColor: '#ffffff'
        })

        // å“ç‰Œæ ‡è¯­
        Text('åä¸º | æ„å»ºä¸‡ç‰©äº’è”çš„æ™ºèƒ½ä¸–ç•Œ')
          .fontSize(14)
          .fontColor('#ffffff80')
          .letterSpacing(2)
          .margin({ top: 20 })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height(280)
  }

  @Builder
  CategorySection() {
    Column() {
      ForEach(this.categories, (category: string, index: number) => {
        Row() {
          // å›¾æ ‡
          Column() {
            Text(this.getCategoryIcon(category))
              .fontSize(24)
          }
          .width(40)
          .height(40)
          .backgroundColor(index % 2 === 0 ? '#FF3B30' : '#007AFF')
          .borderRadius(10)
          .justifyContent(FlexAlign.Center)

          Text(category)
            .fontSize(16)
            .fontColor('#1a1a1a')
            .fontWeight(FontWeight.Medium)
            .margin({ left: 12 })

          Blank()

          Text('>')
            .fontSize(16)
            .fontColor('#999999')
        }
        .width('90%')
        .height(60)
        .padding({ left: 20, right: 20 })
        .backgroundColor(Color.White)
        .borderRadius(16)
        .margin({ bottom: 12 })
        .shadow({
          radius: 8,
          color: '#00000008',
          offsetX: 0,
          offsetY: 2
        })
        .onClick(() => {
          // å¤„ç†åˆ†ç±»ç‚¹å‡»
        })
      })
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#f5f5f7')
  }

  private getCategoryIcon(category: string): string {
    const icons: Record<string, string> = {
      'æ‰‹æœº': 'ğŸ“±',
      'ç¬”è®°æœ¬': 'ğŸ’»',
      'å¹³æ¿': 'ğŸ“‹',
      'ç©¿æˆ´': 'âŒš',
      'éŸ³é¢‘': 'ğŸ§',
      'æ™ºæ…§å±': 'ğŸ“º'
    }
    return icons[category] || 'ğŸ“±'
  }

  @Builder
  ProductCard(product: ProductModel) {
    Column() {
      // å›¾ç‰‡å®¹å™¨
      Stack() {
        Image(product.image)
          .width('100%')
          .height(200)
          .objectFit(ImageFit.Cover)
          .borderRadius(20)
          .backgroundColor('#f5f5f7')

        // æŠ˜æ‰£è§’æ ‡
        if (product.originalPrice > product.price) {
          Column() {
            Text('HOT')
              .fontSize(10)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
          }
          .width(40)
          .height(20)
          .backgroundColor('#FF3B30')
          .borderRadius({ bottomLeft: 12, topRight: 20 })
          .position({ x: 0, y: 0 })
        }

        // æ¸å˜é®ç½©
        Column()
          .width('100%')
          .height(80)
          .linearGradient({
            direction: GradientDirection.Bottom,
            colors: [
              ['rgba(0,0,0,0)', 0.0],
              ['rgba(0,0,0,0.3)', 1.0]
            ]
          })
          .position({ x: 0, y: 120 })
      }

      // äº§å“ä¿¡æ¯
      Column() {
        Text(product.name)
          .fontSize(14)
          .fontColor('#1a1a1a')
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 8 })

        Row() {
          Column() {
            Row() {
              Text('Â¥')
                .fontSize(12)
                .fontColor('#FF3B30')
                .margin({ top: 2 })
              Text(`${product.price}`)
                .fontSize(20)
                .fontColor('#FF3B30')
                .fontWeight(FontWeight.Bold)
            }
          }
          .alignItems(HorizontalAlign.Start)

          Blank()

          Button() {
            Text('+')
              .fontSize(20)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
          }
          .width(32)
          .height(32)
          .backgroundColor('#007AFF')
          .borderRadius(16)
          .shadow({
            radius: 8,
            color: '#007AFF40',
            offsetX: 0,
            offsetY: 2
          })
        }
        .width('100%')
        .alignItems(VerticalAlign.Bottom)
      }
      .padding(16)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(20)
    .shadow({
      radius: 12,
      color: '#00000010',
      offsetX: 0,
      offsetY: 4
    })
    .margin({ bottom: 16 })
    .onClick(() => {
      router.pushUrl({
        url: 'pages/ProductDetailPage',
        params: { productId: product.id }
      })
    })
    .gesture(
      TapGesture()
        .onAction(() => {
          // ç‚¹å‡»åé¦ˆåŠ¨ç”»
        })
    )
  }

  build() {
    Column() {
      // ä¸»è¦å†…å®¹åŒº
      Scroll() {
        Column() {
          // Hero Section
          this.HeroSection()

          // åˆ†ç±»å¿«æ·å…¥å£
          Text('äº§å“åˆ†ç±»')
            .fontSize(24)
            .fontColor('#1a1a1a')
            .fontWeight(FontWeight.Bold)
            .margin({ top: 30, bottom: 20, left: 20 })
            .width('100%')

          this.CategorySection()

          // çƒ­é—¨äº§å“
          Text('çƒ­é—¨äº§å“')
            .fontSize(24)
            .fontColor('#1a1a1a')
            .fontWeight(FontWeight.Bold)
            .margin({ top: 30, bottom: 20, left: 20 })
            .width('100%')

          // äº§å“ç½‘æ ¼
          Grid() {
            ForEach(this.products, (product: ProductModel) => {
              GridItem() {
                this.ProductCard(product)
              }
            })
          }
          .columnsTemplate('1fr')
          .padding({ left: 20, right: 20 })
          .width('100%')
        }
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#f5f5f7')

      // åº•éƒ¨å¯¼èˆª
      BottomNavBar()
        .position({ x: 0, y: '100%' })
        .translate({ x: 0, y: -60 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f7')
  }
}