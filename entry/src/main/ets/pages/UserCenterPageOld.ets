import router from '@ohos.router'
import { User, Order, FavoriteItem } from '../model/DataModel'
import { StorageManager } from '../utils/StorageManager'
import { CartService } from '../services/CartService'
import { CommentService } from '../services/CommentService'

@Entry
@Component
struct UserCenterPage {
  @State user: User | null = null
  @State isLoading: boolean = true
  @State cartCount: number = 0
  @State orderCount: number = 0
  @State favoriteCount: number = 0
  @State commentCount: number = 0
  private storage: StorageManager = StorageManager.getInstance()
  private cartService: CartService = CartService.getInstance()
  private commentService: CommentService = CommentService.getInstance()

  aboutToAppear() {
    this.loadUserData()
    this.loadStatistics()
  }

  private async loadUserData() {
    try {
      this.user = await this.storage.loadUser()
      this.isLoading = false
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error)
      this.isLoading = false
    }
  }

  private loadStatistics() {
    this.cartCount = this.cartService.getTotalCount()
    // æ¨¡æ‹Ÿè®¢å•å’Œæ”¶è—æ•°æ®
    this.orderCount = 3
    this.favoriteCount = 8
    this.commentCount = 12
  }

  private navigateToPage(page: string, params?: Record<string, Object>): void {
    router.pushUrl({
      url: page,
      params: params
    })
  }

  private logout() {
    // æ¸…é™¤ç”¨æˆ·æ•°æ®
    this.user = null
    // è·³è½¬åˆ°ç™»å½•é¡µé¢
    console.log('ç”¨æˆ·é€€å‡ºç™»å½•')
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('ä¸ªäººä¸­å¿ƒ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .width('100%')
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(56)
      .padding(16)
      .backgroundColor($r('app.color.primary'))
      .justifyContent(FlexAlign.Center)

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      } else if (this.user) {
        // å·²ç™»å½•çŠ¶æ€
        Scroll() {
          Column() {
            // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
            UserCard({ user: this.user })

            // ç»Ÿè®¡ä¿¡æ¯
            StatisticsRow({
              cartCount: this.cartCount,
              orderCount: this.orderCount,
              favoriteCount: this.favoriteCount,
              commentCount: this.commentCount
            })

            // æˆ‘çš„è®¢å•
            Column() {
              SectionTitle({ title: 'æˆ‘çš„è®¢å•' })
              OrderSection({
                onViewOrders: (): void => this.navigateToPage('pages/OrderListPage'),
                onViewPending: (): void => this.navigateToPage('pages/OrderListPage'),
                onViewShipped: (): void => this.navigateToPage('pages/OrderListPage'),
                onViewCompleted: (): void => this.navigateToPage('pages/OrderListPage')
              })
            }

            // æˆ‘çš„æœåŠ¡
            Column() {
              SectionTitle({ title: 'æˆ‘çš„æœåŠ¡' })
              ServiceSection({
                onMyFavorite: (): void => this.navigateToPage('pages/FavoritePage'),
                onMyComment: (): void => this.navigateToPage('pages/MyCommentPage'),
                onMyAddress: (): void => this.navigateToPage('pages/AddressListPage'),
                onMyCoupon: (): void => this.navigateToPage('pages/CouponPage')
              })
            }

            // è®¾ç½®
            Column() {
              SectionTitle({ title: 'è®¾ç½®' })
              SettingsSection({
                onLogout: (): void => this.logout(),
                onAbout: (): void => this.navigateToPage('pages/AboutPage')
              })
            }

            // åº•éƒ¨å ä½
            Column()
              .width('100%')
              .height(20)
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor($r('app.color.background'))
      } else {
        // æœªç™»å½•çŠ¶æ€
        Column() {
          // ç”¨æˆ·å¤´åƒå’Œç™»å½•æŒ‰é’®
          Column() {
            Text('ğŸ‘¤')
              .fontSize(80)
              .margin({ bottom: 24 })
            Text('ç™»å½•åäº«å—æ›´å¤šæœåŠ¡')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 32 })

            Button('ç«‹å³ç™»å½•')
              .width(200)
              .height(44)
              .fontSize(16)
              .backgroundColor($r('app.color.primary'))
              .fontColor(Color.White)
              .borderRadius(22)
              .onClick(() => {
                this.navigateToPage('pages/LoginPage')
              })
          }
          .width('100%')
          .padding(48)
          .justifyContent(FlexAlign.Center)

          // æœªç™»å½•æ—¶çš„åŠŸèƒ½å…¥å£
          Column() {
            SectionTitle({ title: 'å¿«é€Ÿè®¿é—®' })
            QuickAccessSection()
          }
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}

// ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
@Component
struct UserCard {
  @Prop user: User

  build() {
    Row() {
      // ç”¨æˆ·å¤´åƒ
      Image(this.user.avatar)
        .width(60)
        .height(60)
        .borderRadius(30)
        .margin({ right: 16 })

      // ç”¨æˆ·ä¿¡æ¯
      Column() {
        Row() {
          Text(this.user.username)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))

          Text(this.user.getLevelText())
            .fontSize(12)
            .fontColor(this.user.getLevelColor())
            .backgroundColor($r('app.color.background'))
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .borderRadius(10)
            .margin({ left: 8 })
        }
        .width('100%')

        Text(`ç§¯åˆ†: ${this.user.points}`)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 4 })
      }
      .layoutWeight(1)

      // ç®­å¤´
      Text('>')
        .fontSize(16)
        .fontColor($r('app.color.text_secondary'))
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.white'))
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 16 })
    .onClick(() => {
      // è·³è½¬åˆ°ç”¨æˆ·è¯¦æƒ…é¡µ
    })
  }
}

// ç»Ÿè®¡ä¿¡æ¯è¡Œ
@Component
struct StatisticsRow {
  @Prop cartCount: number
  @Prop orderCount: number
  @Prop favoriteCount: number
  @Prop commentCount: number

  build() {
    Row() {
      StatisticItem({
        icon: 'ğŸ›’',
        label: 'è´­ç‰©è½¦',
        count: this.cartCount,
        onClick: () => {}
      })

      StatisticItem({
        icon: 'ğŸ“¦',
        label: 'è®¢å•',
        count: this.orderCount,
        onClick: () => {}
      })

      StatisticItem({
        icon: 'â¤ï¸',
        label: 'æ”¶è—',
        count: this.favoriteCount,
        onClick: () => {}
      })

      StatisticItem({
        icon: 'ğŸ’¬',
        label: 'è¯„ä»·',
        count: this.commentCount,
        onClick: () => {}
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.white'))
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12 })
  }
}

// ç»Ÿè®¡é¡¹ç»„ä»¶
@Component
struct StatisticItem {
  @Prop icon: string
  @Prop label: string
  @Prop count: number
  onClick: () => void = () => {}

  build() {
    Column() {
      Text(this.icon)
        .fontSize(24)
        .margin({ bottom: 4 })

      Text(this.count.toString())
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .margin({ bottom: 2 })

      Text(this.label)
        .fontSize(12)
        .fontColor($r('app.color.text_secondary'))
    }
    .width('25%')
    .justifyContent(FlexAlign.Center)
    .onClick(this.onClick)
  }
}

// ç« èŠ‚æ ‡é¢˜ç»„ä»¶
@Component
struct SectionTitle {
  @Prop title: string

  build() {
    Row() {
      Text(this.title)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .layoutWeight(1)

      Text('æŸ¥çœ‹å…¨éƒ¨')
        .fontSize(12)
        .fontColor($r('app.color.primary'))
        .onClick(() => {
          // æŸ¥çœ‹å…¨éƒ¨é€»è¾‘
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 16, bottom: 8 })
  }
}

// è®¢å•éƒ¨åˆ†
@Component
struct OrderSection {
  onViewOrders: () => void = () => {}
  onViewPending: () => void = () => {}
  onViewShipped: () => void = () => {}
  onViewCompleted: () => void = () => {}

  build() {
    Column() {
      // è®¢å•çŠ¶æ€å¿«æ·å…¥å£
      Row() {
        OrderStatusItem({
          icon: 'ğŸ’³',
          label: 'å¾…ä»˜æ¬¾',
          onClick: this.onViewPending
        })

        OrderStatusItem({
          icon: 'ğŸ“¦',
          label: 'å¾…å‘è´§',
          onClick: () => {}
        })

        OrderStatusItem({
          icon: 'ğŸšš',
          label: 'å¾…æ”¶è´§',
          onClick: this.onViewShipped
        })

        OrderStatusItem({
          icon: 'â­',
          label: 'å¾…è¯„ä»·',
          onClick: this.onViewCompleted
        })

        OrderStatusItem({
          icon: 'ğŸ”',
          label: 'å…¨éƒ¨è®¢å•',
          onClick: this.onViewOrders
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor($r('app.color.white'))
      .borderRadius(12)
      .margin({ left: 16, right: 16, bottom: 12 })
    }
    .width('100%')
  }
}

// è®¢å•çŠ¶æ€é¡¹
@Component
struct OrderStatusItem {
  @Prop icon: string
  @Prop label: string
  onClick: () => void = () => {}

  build() {
    Column() {
      Text(this.icon)
        .fontSize(24)
        .margin({ bottom: 4 })

      Text(this.label)
        .fontSize(12)
        .fontColor($r('app.color.text_secondary'))
    }
    .width('20%')
    .justifyContent(FlexAlign.Center)
    .onClick(this.onClick)
  }
}

// æœåŠ¡éƒ¨åˆ†
@Component
struct ServiceSection {
  onMyFavorite: () => void = () => {}
  onMyComment: () => void = () => {}
  onMyAddress: () => void = () => {}
  onMyCoupon: () => void = () => {}

  build() {
    Column() {
      ServiceItem({
        icon: 'â¤ï¸',
        title: 'æˆ‘çš„æ”¶è—',
        description: 'æŸ¥çœ‹æ”¶è—çš„å•†å“',
        onClick: this.onMyFavorite
      })

      ServiceItem({
        icon: 'ğŸ’¬',
        title: 'æˆ‘çš„è¯„ä»·',
        description: 'æŸ¥çœ‹è¯„ä»·è®°å½•',
        onClick: this.onMyComment
      })

      ServiceItem({
        icon: 'ğŸ“',
        title: 'æ”¶è´§åœ°å€',
        description: 'ç®¡ç†æ”¶è´§åœ°å€',
        onClick: this.onMyAddress
      })

      ServiceItem({
        icon: 'ğŸ«',
        title: 'ä¼˜æƒ åˆ¸',
        description: 'æŸ¥çœ‹å¯ç”¨ä¼˜æƒ åˆ¸',
        onClick: this.onMyCoupon
      })
    }
    .width('100%')
    .backgroundColor($r('app.color.white'))
    .borderRadius(12)
    .margin({ left: 16, right: 16, bottom: 12 })
  }
}

// æœåŠ¡é¡¹ç»„ä»¶
@Component
struct ServiceItem {
  @Prop icon: string
  @Prop title: string
  @Prop description: string
  onClick: () => void = () => {}

  build() {
    Row() {
      Text(this.icon)
        .fontSize(20)
        .margin({ right: 12 })

      Column() {
        Text(this.title)
          .fontSize(14)
          .fontColor($r('app.color.text_primary'))
          .width('100%')

        Text(this.description)
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
          .width('100%')
          .margin({ top: 2 })
      }
      .layoutWeight(1)

      Text('>')
        .fontSize(16)
        .fontColor($r('app.color.text_secondary'))
    }
    .width('100%')
    .padding(16)
    .justifyContent(FlexAlign.Start)
    .onClick(this.onClick)

    if (this.description !== '') {
      Divider()
        .width('100%')
        .margin({ left: 16, right: 16 })
    }
  }
}

// è®¾ç½®éƒ¨åˆ†
@Component
struct SettingsSection {
  onLogout: () => void = () => {}
  onAbout: () => void = () => {}

  build() {
    Column() {
      ServiceItem({
        icon: 'â„¹ï¸',
        title: 'å…³äºæˆ‘ä»¬',
        description: '',
        onClick: this.onAbout
      })

      ServiceItem({
        icon: 'ğŸšª',
        title: 'é€€å‡ºç™»å½•',
        description: '',
        onClick: this.onLogout
      })
    }
    .width('100%')
    .backgroundColor($r('app.color.white'))
    .borderRadius(12)
    .margin({ left: 16, right: 16, bottom: 16 })
  }
}

// å¿«é€Ÿè®¿é—®éƒ¨åˆ†ï¼ˆæœªç™»å½•æ—¶ï¼‰
@Component
struct QuickAccessSection {
  build() {
    Column() {
      Row() {
        QuickAccessItem({
          icon: 'ğŸ”',
          title: 'æœç´¢',
          onClick: () => {}
        })

        QuickAccessItem({
          icon: 'ğŸ›’',
          title: 'è´­ç‰©è½¦',
          onClick: () => {}
        })

        QuickAccessItem({
          icon: 'â¤ï¸',
          title: 'æ”¶è—',
          onClick: () => {}
        })

        QuickAccessItem({
          icon: 'ğŸ“¦',
          title: 'è®¢å•',
          onClick: () => {}
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor($r('app.color.white'))
      .borderRadius(12)
      .margin({ left: 16, right: 16, bottom: 16 })
    }
    .width('100%')
  }
}

// å¿«é€Ÿè®¿é—®é¡¹
@Component
struct QuickAccessItem {
  @Prop icon: string
  @Prop title: string
  onClick: () => void = () => {}

  build() {
    Column() {
      Text(this.icon)
        .fontSize(24)
        .margin({ bottom: 4 })

      Text(this.title)
        .fontSize(12)
        .fontColor($r('app.color.text_secondary'))
    }
    .width('25%')
    .justifyContent(FlexAlign.Center)
    .onClick(this.onClick)
  }
}