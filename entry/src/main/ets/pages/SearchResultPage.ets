import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { SearchBarEnhanced } from '../components/SearchBarEnhanced'
import { ProductCardEnhanced } from '../components/ProductCardEnhanced'
import { CartService } from '../services/CartService'

interface RouteParams {
  query?: string
}

@Entry
@Component
struct SearchResultPage {
  @State products: ProductModel[] = []
  @State filteredProducts: ProductModel[] = []
  @State searchText: string = ''
  @State selectedSort: string = 'ç»¼åˆ'
  @State selectedPriceRange: string = 'å…¨éƒ¨'
  @State isLoading: boolean = false
  @State showFilters: boolean = false
  @State resultCount: number = 0
  @State searchHistory: string[] = []
  @State hotSearches: string[] = ['åŽä¸ºMate 60', 'iPhone 15', 'MacBook Pro', 'AirPods Pro', 'å°ç±³14', 'OPPO Find']
  private cartService: CartService = CartService.getInstance()

  private sortOptions = ['ç»¼åˆ', 'é”€é‡', 'ä»·æ ¼â†‘', 'ä»·æ ¼â†“', 'å¥½è¯„']
  private priceRanges = ['å…¨éƒ¨', '0-1000', '1000-3000', '3000-5000', '5000-10000', '10000+']

  aboutToAppear() {
    this.loadAllProducts()
    const params = router.getParams() as RouteParams
    if (params?.query) {
      this.searchText = params.query
      this.performSearch()
    }
  }

  private loadAllProducts() {
    this.products = MockData.generateProducts()
    this.filteredProducts = this.products
    this.resultCount = this.filteredProducts.length
  }

  private performSearch() {
    if (!this.searchText.trim()) {
      this.loadAllProducts()
      return
    }

    this.isLoading = true

    setTimeout(() => {
      const query = this.searchText.toLowerCase()
      this.filteredProducts = this.products.filter(product =>
        product.name.toLowerCase().includes(query) ||
        product.description.toLowerCase().includes(query) ||
        product.tags.some(tag => tag.toLowerCase().includes(query))
      )

      this.applySortAndFilter()
      this.isLoading = false
    }, 500)
  }

  private applySortAndFilter() {
    let filtered = [...this.filteredProducts]

    // ä»·æ ¼ç­›é€‰
    if (this.selectedPriceRange !== 'å…¨éƒ¨') {
      const range = this.selectedPriceRange.split('-').map(v => v === '+' ? Infinity : parseInt(v))
      filtered = filtered.filter(product => {
        if (range.length === 1) {
          return product.price >= range[0]
        }
        return product.price >= range[0] && product.price <= range[1]
      })
    }

    // æŽ’åº
    switch (this.selectedSort) {
      case 'é”€é‡':
        filtered.sort((a, b) => b.reviewCount - a.reviewCount)
        break
      case 'ä»·æ ¼â†‘':
        filtered.sort((a, b) => a.price - b.price)
        break
      case 'ä»·æ ¼â†“':
        filtered.sort((a, b) => b.price - a.price)
        break
      case 'å¥½è¯„':
        filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0))
        break
      default:
        // ç»¼åˆæŽ’åº - ä¿æŒé»˜è®¤
        break
    }

    this.filteredProducts = filtered
    this.resultCount = filtered.length
  }

  private onSearch(text: string) {
    this.searchText = text
    this.performSearch()
  }

  private onSortChange(sort: string) {
    this.selectedSort = sort
    this.applySortAndFilter()
  }

  private onPriceRangeChange(range: string) {
    this.selectedPriceRange = range
    this.applySortAndFilter()
  }

  private onProductClick(product: ProductModel) {
    router.pushUrl({
      url: 'pages/ProductDetailPageEnhanced',
      params: {
        productId: product.id
      }
    })
  }

  private async onQuickAddToCart(product: ProductModel) {
    try {
      if (this.cartService.isProductInCart(product.id)) {
        console.log('å•†å“å·²åœ¨è´­ç‰©è½¦ä¸­')
      } else {
        const success = await this.cartService.addToCart(product, 1)
        if (success) {
          console.log('å¿«é€ŸåŠ è´­æˆåŠŸ')
        }
      }
    } catch (error) {
      console.error('å¿«é€ŸåŠ è´­å¤±è´¥:', error)
    }
  }

  private goBack() {
    router.back()
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor($r('app.color.text_primary'))
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => this.goBack())

        SearchBarEnhanced({
          searchText: $searchText,
          onSearch: this.onSearch.bind(this)
        })
          .layoutWeight(1)
          .margin({ left: 12, right: 12 })
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })
      .backgroundColor($r('app.color.white'))
      .shadow({
        radius: 2,
        color: $r('app.color.shadow_light'),
        offsetX: 0,
        offsetY: 1
      })

      // æœç´¢ç»Ÿè®¡å’Œç­›é€‰
      Column() {
        Row() {
          if (this.searchText) {
            Text(`"${this.searchText}"`)
              .fontSize(16)
              .fontColor($r('app.color.text_primary'))
              .fontWeight(FontWeight.Medium)
            Text(` æ‰¾åˆ°${this.resultCount}ä¸ªå•†å“`)
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ left: 8 })
          } else {
            Text('å…¨éƒ¨å•†å“')
              .fontSize(16)
              .fontColor($r('app.color.text_primary'))
              .fontWeight(FontWeight.Medium)
            Text(` å…±${this.resultCount}ä¸ªå•†å“`)
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ left: 8 })
          }

          Blank()

          // ç­›é€‰æŒ‰é’®
          Button() {
            Row() {
              Text('ç­›é€‰')
                .fontSize(14)
                .fontColor(this.showFilters ? $r('app.color.primary') : $r('app.color.text_primary'))
              Text('âš™')
                .fontSize(16)
                .fontColor(this.showFilters ? $r('app.color.primary') : $r('app.color.text_primary'))
                .margin({ left: 4 })
            }
          }
          .height(36)
          .backgroundColor(this.showFilters ? $r('app.color.primary_light') : $r('app.color.background_gray'))
          .borderRadius(18)
          .padding({ left: 16, right: 16 })
          .onClick(() => {
            this.showFilters = !this.showFilters
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })

        // ç­›é€‰é€‰é¡¹
        if (this.showFilters) {
          Column() {
            // ä»·æ ¼åŒºé—´
            Column() {
              Text('ä»·æ ¼åŒºé—´')
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.text_primary'))
                .width('100%')
                .margin({ bottom: 12 })

              Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
                ForEach(this.priceRanges, (range: string) => {
                  Button(range)
                    .height(32)
                    .fontSize(13)
                    .fontColor(this.selectedPriceRange === range ? $r('app.color.primary') : $r('app.color.text_secondary'))
                    .backgroundColor(this.selectedPriceRange === range ? $r('app.color.primary_light') : $r('app.color.background_gray'))
                    .borderRadius(16)
                    .padding({ left: 16, right: 16 })
                    .margin({ right: 8, bottom: 8 })
                    .onClick(() => this.onPriceRangeChange(range))
                })
              }
              .width('100%')
            }
            .width('100%')
            .padding(16)
            .backgroundColor($r('app.color.white'))
            .borderRadius(12)
            .margin({ bottom: 8 })
            .animation({
              duration: 300,
              curve: Curve.EaseInOut
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16 })
        }

        // æŽ’åºé€‰é¡¹
        Scroll() {
          Row({ space: 12 }) {
            ForEach(this.sortOptions, (sort: string) => {
              Button(sort)
                .fontSize(14)
                .fontColor(this.selectedSort === sort ? Color.White : $r('app.color.text_primary'))
                .backgroundColor(this.selectedSort === sort ? $r('app.color.primary') : $r('app.color.white'))
                .border({ width: 1, color: this.selectedSort === sort ? Color.Transparent : $r('app.color.border_light') })
                .borderRadius(18)
                .padding({ left: 20, right: 20, top: 10, bottom: 10 })
                .onClick(() => this.onSortChange(sort))
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16 })
        }
        .width('100%')
        .height(50)
        .scrollBar(BarState.Off)
        .scrollable(ScrollDirection.Horizontal)
        .edgeEffect(EdgeEffect.Spring)
        .backgroundColor($r('app.color.white'))
      }
      .width('100%')
      .backgroundColor($r('app.color.background_gray'))

      // å•†å“åˆ—è¡¨
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('æœç´¢ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      } else if (this.filteredProducts.length > 0) {
        Grid() {
          ForEach(this.filteredProducts, (product: ProductModel) => {
            GridItem() {
              ProductCardEnhanced({
                product: product,
                onProductClick: this.onProductClick.bind(this),
                onQuickAddToCart: this.onQuickAddToCart.bind(this)
              })
            }
            .animation({
              duration: 300,
              curve: Curve.EaseInOut
            })
          }, (product: ProductModel) => product.id)
        }
        .columnsTemplate('1fr 1fr')
        .rowsGap(12)
        .columnsGap(12)
        .padding(16)
        .width('100%')
        .layoutWeight(1)
        .backgroundColor($r('app.color.background'))
      } else {
        Column() {
          Text('ðŸ”')
            .fontSize(80)
            .fontColor($r('app.color.text_tertiary'))
            .margin({ bottom: 16 })

          Text('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“')
            .fontSize(16)
            .fontColor($r('app.color.text_secondary'))
            .margin({ bottom: 8 })

          Text('è¯•è¯•å…¶ä»–å…³é”®è¯æˆ–æŸ¥çœ‹çƒ­é—¨æŽ¨è')
            .fontSize(14)
            .fontColor($r('app.color.text_tertiary'))
            .margin({ bottom: 24 })

          // çƒ­é—¨æœç´¢
          Column() {
            Text('çƒ­é—¨æœç´¢')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .margin({ bottom: 12 })

            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
              ForEach(this.hotSearches, (item: string) => {
                Button(item)
                  .height(32)
                  .fontSize(13)
                  .fontColor($r('app.color.text_secondary'))
                  .backgroundColor($r('app.color.background_gray'))
                  .borderRadius(16)
                  .padding({ left: 16, right: 16 })
                  .margin({ right: 8, bottom: 8 })
                  .onClick(() => {
                    this.searchText = item
                    this.onSearch(item)
                  })
              })
            }
            .width('100%')
          }
          .width('100%')
          .padding(24)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .margin({ left: 16, right: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}