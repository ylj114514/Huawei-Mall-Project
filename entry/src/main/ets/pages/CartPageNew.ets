import router from '@ohos.router'
import { CartItem } from '../model/DataModel'
import { CartService } from '../services/CartService'

@Entry
@Component
struct CartPage {
  @State cartItems: CartItem[] = []
  @State allSelected: boolean = false
  @State totalAmount: number = 0
  @State selectedCount: number = 0
  @State isLoading: boolean = true
  @State editingMode: boolean = false
  @State refreshing: boolean = false
  private cartService: CartService = CartService.getInstance()

  aboutToAppear() {
    this.loadCartData()
  }

  aboutToDisappear() {
    // é¡µé¢é”€æ¯æ—¶åˆ·æ–°æ•°æ®
  }

  loadCartData() {
    try {
      this.isLoading = true
      this.cartItems = this.cartService.getCartItems()
      this.updateSummary()
      this.isLoading = false
    } catch (error) {
      console.error('åŠ è½½è´­ç‰©è½¦æ•°æ®å¤±è´¥:', error)
      this.isLoading = false
    }
  }

  private updateSummary() {
    this.allSelected = this.cartItems.length > 0 && this.cartItems.every(item => item.selected)
    this.selectedCount = this.cartService.getSelectedCount()
    this.totalAmount = this.cartService.getSelectedTotal()
  }

  // åˆ‡æ¢å•†å“é€‰ä¸­çŠ¶æ€
  toggleItemSelection(item: CartItem) {
    this.cartService.toggleSelected(item.id)
    this.cartItems = this.cartService.getCartItems()
    this.updateSummary()
  }

  // å…¨é€‰/å…¨ä¸é€‰
  toggleAllSelection() {
    this.cartService.toggleAllSelected(!this.allSelected)
    this.cartItems = this.cartService.getCartItems()
    this.updateSummary()
  }

  // æ›´æ–°å•†å“æ•°é‡
  async updateItemQuantity(item: CartItem, quantity: number) {
    try {
      const success = await this.cartService.updateQuantity(item.id, quantity)
      if (success) {
        this.cartItems = this.cartService.getCartItems()
        this.updateSummary()
      } else {
        console.error('æ›´æ–°æ•°é‡å¤±è´¥ï¼Œå¯èƒ½åº“å­˜ä¸è¶³')
      }
    } catch (error) {
      console.error('æ›´æ–°æ•°é‡å¤±è´¥:', error)
    }
  }

  // åˆ é™¤å•†å“
  removeItem(item: CartItem) {
    this.cartService.removeFromCart(item.id)
    this.cartItems = this.cartService.getCartItems()
    this.updateSummary()
  }

  // æ‰¹é‡åˆ é™¤é€‰ä¸­å•†å“
  removeSelectedItems() {
    const selectedIds = this.cartItems.filter(item => item.selected).map(item => item.id)
    selectedIds.forEach(id => {
      this.cartService.removeFromCart(id)
    })
    this.cartItems = this.cartService.getCartItems()
    this.updateSummary()
    this.editingMode = false
  }

  // ç»“ç®—
  checkout() {
    if (!this.cartService.hasSelectedItems()) {
      console.error('è¯·é€‰æ‹©è¦ç»“ç®—çš„å•†å“')
      return
    }

    try {
      console.log('ç»“ç®—å•†å“æ•°é‡:', this.selectedCount)
      console.log('ç»“ç®—æ€»é‡‘é¢:', this.totalAmount)

      // è·³è½¬åˆ°ç»“ç®—é¡µé¢ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
      router.pushUrl({ url: 'pages/UserCenterPage' })
    } catch (error) {
      console.error('ç»“ç®—å¤±è´¥:', error)
    }
  }

  // è¿”å›žé¦–é¡µ
  goHome() {
    router.replaceUrl({ url: 'pages/Index' })
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â†')
          .width(40)
          .height(40)
          .backgroundColor(Color.Transparent)
          .fontColor($r('app.color.text_primary'))
          .onClick(() => {
            router.back()
          })

        if (this.editingMode) {
          Text('ç¼–è¾‘å•†å“')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
        } else {
          Text(`è´­ç‰©è½¦(${this.cartItems.length})`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
        }

        if (this.cartItems.length > 0) {
          Button(this.editingMode ? 'å®Œæˆ' : 'ç®¡ç†')
            .height(40)
            .backgroundColor(Color.Transparent)
            .fontColor($r('app.color.primary'))
            .onClick(() => {
              this.editingMode = !this.editingMode
            })
        } else {
          Blank().width(40)
        }
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
      .backgroundColor($r('app.color.white'))

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½è´­ç‰©è½¦ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.cartItems.length === 0) {
        // ç©ºè´­ç‰©è½¦çŠ¶æ€
        Column() {
          Text('ðŸ›’')
            .fontSize(80)
            .margin({ bottom: 24 })
          Text('è´­ç‰©è½¦è¿˜æ˜¯ç©ºçš„')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_secondary'))
            .margin({ bottom: 12 })
          Text('åŽ»æŒ‘é€‰ä¸€äº›ä½ å–œæ¬¢çš„å•†å“å§')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ bottom: 32 })

          Row() {
            Button('åŽ»é€›é€›')
              .height(44)
              .padding({ left: 32, right: 32 })
              .backgroundColor($r('app.color.background'))
              .fontColor($r('app.color.text_primary'))
              .border({ width: 1, color: $r('app.color.text_secondary') })
              .margin({ right: 16 })
              .onClick(() => this.goHome())

            Button('åŽ»é¦–é¡µ')
              .height(44)
              .padding({ left: 32, right: 32 })
              .backgroundColor($r('app.color.primary'))
              .fontColor(Color.White)
              .onClick(() => this.goHome())
          }
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        // è´­ç‰©è½¦å•†å“åˆ—è¡¨
        Scroll() {
          Column() {
            // å…¨é€‰è¡Œ
            Row() {
              Button() {
                Row() {
                  Circle({ width: 20, height: 20 })
                    .fill(this.allSelected ? $r('app.color.primary') : Color.Transparent)
                    .stroke(this.allSelected ? Color.Transparent : $r('app.color.text_secondary'))
                    .strokeWidth(2)
                    .margin({ right: 8 })
                  Text('å…¨é€‰')
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                }
              }
              .backgroundColor(Color.Transparent)
              .onClick(() => this.toggleAllSelection())

              Blank()

              if (!this.editingMode) {
                Button('æ¸…ç©ºè´­ç‰©è½¦')
                  .height(32)
                  .fontSize(12)
                  .backgroundColor(Color.Transparent)
                  .fontColor($r('app.color.text_secondary'))
                  .onClick(() => {
                    this.cartService.clearCart()
                    this.cartItems = []
                    this.updateSummary()
                  })
              }
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 12, bottom: 12 })
            .backgroundColor($r('app.color.white'))
            .margin({ bottom: 8 })

            // å•†å“åˆ—è¡¨
            ForEach(this.cartItems, (item: CartItem) => {
              Column() {
                Row() {
                  // é€‰æ‹©æ¡†
                  Button() {
                    Circle({ width: 20, height: 20 })
                      .fill(item.selected ? $r('app.color.primary') : Color.Transparent)
                      .stroke(item.selected ? Color.Transparent : $r('app.color.text_secondary'))
                      .strokeWidth(2)
                      .margin({ right: 12 })
                  }
                  .backgroundColor(Color.Transparent)
                  .onClick(() => this.toggleItemSelection(item))

                  // å•†å“å›¾ç‰‡
                  Image(item.product.image)
                    .width(80)
                    .height(80)
                    .borderRadius(8)
                    .objectFit(ImageFit.Cover)
                    .backgroundColor($r('app.color.background'))
                    .margin({ right: 12 })

                  // å•†å“ä¿¡æ¯
                  Column() {
                    Text(item.product.name)
                      .fontSize(14)
                      .fontWeight(FontWeight.Medium)
                      .fontColor($r('app.color.text_primary'))
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .width('100%')

                    Text(item.product.spec || 'æ ‡å‡†ç‰ˆ')
                      .fontSize(12)
                      .fontColor($r('app.color.text_secondary'))
                      .margin({ top: 4 })

                    Row() {
                      Text(`Â¥${item.product.price}`)
                        .fontSize(16)
                        .fontWeight(FontWeight.Bold)
                        .fontColor($r('app.color.price'))

                      if (item.product.originalPrice > item.product.price) {
                        Text(`Â¥${item.product.originalPrice}`)
                          .fontSize(12)
                          .fontColor($r('app.color.text_secondary'))
                          .decoration({ type: TextDecorationType.LineThrough })
                          .margin({ left: 8 })
                      }
                    }
                    .width('100%')
                    .justifyContent(FlexAlign.Start)
                    .alignItems(VerticalAlign.Bottom)
                    .margin({ top: 8 })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)

                  // æ•°é‡é€‰æ‹©å™¨ï¼ˆéžç¼–è¾‘æ¨¡å¼ï¼‰
                  if (!this.editingMode) {
                    Column() {
                      Row() {
                        Button('-')
                          .width(28)
                          .height(28)
                          .fontSize(14)
                          .backgroundColor($r('app.color.background'))
                          .fontColor(item.quantity > 1 ? $r('app.color.text_primary') : $r('app.color.text_secondary'))
                          .enabled(item.quantity > 1)
                          .onClick(() => this.updateItemQuantity(item, item.quantity - 1))

                        Text(item.quantity.toString())
                          .fontSize(14)
                          .fontColor($r('app.color.text_primary'))
                          .width(32)
                          .textAlign(TextAlign.Center)

                        Button('+')
                          .width(28)
                          .height(28)
                          .fontSize(14)
                          .backgroundColor($r('app.color.background'))
                          .fontColor(item.quantity < item.product.stock ? $r('app.color.text_primary') : $r('app.color.text_secondary'))
                          .enabled(item.quantity < item.product.stock)
                          .onClick(() => this.updateItemQuantity(item, item.quantity + 1))
                      }
                      .margin({ top: 8 })
                    }
                  }
                }
                .width('100%')
                .padding(16)

                if (this.editingMode) {
                  Divider()
                    .width('100%')
                    .margin({ left: 48, right: 16 })

                  Row() {
                    Blank()

                    Button('åˆ é™¤')
                      .height(32)
                      .fontSize(12)
                      .backgroundColor($r('app.color.error'))
                      .fontColor(Color.White)
                      .margin({ bottom: 8 })
                      .onClick(() => this.removeItem(item))
                  }
                  .width('100%')
                  .padding({ right: 16 })
                }
              }
              .width('100%')
              .backgroundColor($r('app.color.white'))
              .margin({ left: 16, right: 16, bottom: 8 })
              .borderRadius(8)
            })

            // åº•éƒ¨å ä½
            Column()
              .width('100%')
              .height(100)
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor($r('app.color.background'))
      }

      // åº•éƒ¨æ“ä½œæ 
      if (this.cartItems.length > 0) {
        Column() {
          Row() {
            if (this.editingMode) {
              Button() {
                Row() {
                  Circle({ width: 20, height: 20 })
                    .fill(this.allSelected ? $r('app.color.primary') : Color.Transparent)
                    .stroke(this.allSelected ? Color.Transparent : $r('app.color.text_secondary'))
                    .strokeWidth(2)
                    .margin({ right: 8 })
                  Text('å…¨é€‰')
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                }
              }
              .backgroundColor(Color.Transparent)
              .onClick(() => this.toggleAllSelection())

              Blank()

              Button(`åˆ é™¤(${this.selectedCount})`)
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.error'))
                .fontColor(Color.White)
                .padding({ left: 24, right: 24 })
                .enabled(this.selectedCount > 0)
                .onClick(() => this.removeSelectedItems())
            } else {
              Button() {
                Row() {
                  Circle({ width: 20, height: 20 })
                    .fill(this.allSelected ? $r('app.color.primary') : Color.Transparent)
                    .stroke(this.allSelected ? Color.Transparent : $r('app.color.text_secondary'))
                    .strokeWidth(2)
                    .margin({ right: 8 })
                  Text('å…¨é€‰')
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                }
              }
              .backgroundColor(Color.Transparent)
              .onClick(() => this.toggleAllSelection())

              Blank()

              Column() {
                Row() {
                  Text('åˆè®¡: ')
                    .fontSize(14)
                    .fontColor($r('app.color.text_secondary'))
                  Text(`Â¥${this.totalAmount.toFixed(2)}`)
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor($r('app.color.price'))
                }
                .alignItems(VerticalAlign.Bottom)

                Text(`å·²é€‰${this.selectedCount}ä»¶å•†å“`)
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .alignItems(HorizontalAlign.End)

              Button(`ç»“ç®—(${this.selectedCount})`)
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .padding({ left: 20, right: 20 })
                .margin({ left: 16 })
                .enabled(this.selectedCount > 0)
                .onClick(() => this.checkout())
            }
          }
          .width('100%')
          .height(60)
          .padding({ left: 16, right: 16 })
          .backgroundColor($r('app.color.white'))
          .shadow({
            radius: 4,
            color: '#1A000000',
            offsetX: 0,
            offsetY: -2
          })
          .justifyContent(FlexAlign.SpaceBetween)
          .alignItems(VerticalAlign.Center)
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}