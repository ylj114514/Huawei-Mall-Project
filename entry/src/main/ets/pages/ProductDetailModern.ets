import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { FavoriteService } from '../services/FavoriteService'

interface ProductParams {
  productId: string
}

// è¯„è®ºæ•°æ®æ¨¡å‹
interface Comment {
  id: string
  userName: string
  avatar: string
  rating: number
  content: string
  images: string[]
  date: string
  helpfulCount: number
  spec: string
}

// æ¨¡æ‹Ÿè¯„è®ºæ•°æ®
const MockComments: Comment[] = [
  {
    id: '1',
    userName: 'å¼ å…ˆç”Ÿ',
    avatar: '',
    rating: 5,
    content: 'æ‰‹æœºéå¸¸å‡ºè‰²ï¼Œéº’éºŸèŠ¯ç‰‡æ€§èƒ½å¼ºåŠ²ï¼Œé¸¿è’™ç³»ç»Ÿæµç•…ã€‚æ‹ç…§æ•ˆæœæƒŠè‰³ï¼Œç‰¹åˆ«æ˜¯å¤œæ™¯æ¨¡å¼ã€‚ç»­èˆªèƒ½åŠ›å¼ºï¼Œä¸€å¤©ä½¿ç”¨æ— å‹åŠ›ã€‚',
    images: [],
    date: '2024-01-15',
    helpfulCount: 234,
    spec: '12GB+512GB é›…å·é’'
  },
  {
    id: '2',
    userName: 'æå¥³å£«',
    avatar: '',
    rating: 4,
    content: 'æ•´ä½“ä½¿ç”¨ä½“éªŒå¾ˆå¥½ï¼Œç³»ç»Ÿæµç•…ï¼Œå¤–è§‚è®¾è®¡ç²¾ç¾ã€‚å”¯ä¸€çš„å°ç¼ºç‚¹æ˜¯æœ‰ç‚¹é‡ï¼Œä½†è€ƒè™‘åˆ°é…ç½®å’Œç”µæ± å®¹é‡ï¼Œå¯ä»¥æ¥å—ã€‚',
    images: [],
    date: '2024-01-10',
    helpfulCount: 156,
    spec: '12GB+256GB é›…é»‘'
  }
]

@Entry
@Component
struct ProductDetailModern {
  @State product: ProductModel | null = null
  @State selectedSpec: string = '12GB+512GB'
  @State selectedColor: string = 'é›…å·é’'
  @State quantity: number = 1
  @State isLoading: boolean = true
  @State isFavorite: boolean = false
  @State showReviewModal: boolean = false
  @State comments: Comment[] = MockComments
  @State currentImageIndex: number = 0

  private specs: string[] = ['12GB+256GB', '12GB+512GB', '16GB+512GB', '16GB+1TB']
  private colors: string[] = ['é›…å·é’', 'é›…é»‘', 'é›…ç™½', 'é›…ä¸¹éœ']
  private favoriteService: FavoriteService = FavoriteService.getInstance()

  aboutToAppear() {
    this.loadProductData()
  }

  private async loadProductData() {
    const params = router.getParams() as ProductParams
    if (params?.productId) {
      const products = MockData.generateProducts()
      this.product = products.find(p => p.id === params.productId) || null

      if (this.product) {
        this.isFavorite = await this.favoriteService.isFavorite(this.product.id)
      }
    }
    this.isLoading = false
  }

  private async onToggleFavorite() {
    if (!this.product) return

    try {
      if (this.isFavorite) {
        await this.favoriteService.removeFromFavorites(this.product.id)
        this.isFavorite = false
      } else {
        await this.favoriteService.addToFavorites(this.product)
        this.isFavorite = true
      }
    } catch (error) {
      console.error('åˆ‡æ¢æ”¶è—çŠ¶æ€å¤±è´¥:', error)
    }
  }

  private onAddToCart() {
    // æ·»åŠ åˆ°è´­ç‰©è½¦é€»è¾‘
    console.log('æ·»åŠ åˆ°è´­ç‰©è½¦')
  }

  private onBuyNow() {
    // ç«‹å³è´­ä¹°é€»è¾‘
    console.log('ç«‹å³è´­ä¹°')
  }

  @Builder
  NavigationBar() {
    Row() {
      // è¿”å›æŒ‰é’® - å¢å¤§ç‚¹å‡»åŒºåŸŸ
      Button() {
        Text('â†')
          .fontSize(24)
          .fontColor('#FFFFFF')
      }
      .width(48)
      .height(48)
      .backgroundColor(Color.Transparent)
      .onClick(() => router.back())

      Blank()

      Text('å•†å“è¯¦æƒ…')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#FFFFFF')

      Blank()

      Row({ space: 20 }) {
        // åˆ†äº«æŒ‰é’®
        Button() {
          Text('â†—')
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
        .width(48)
        .height(48)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          console.log('åˆ†äº«')
        })

        // æ”¶è—æŒ‰é’®
        Button() {
          Text(this.isFavorite ? 'â¤ï¸' : 'ğŸ¤')
            .fontSize(20)
        }
        .width(48)
        .height(48)
        .backgroundColor(Color.Transparent)
        .onClick(() => this.onToggleFavorite())
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .position({ x: 0, y: 0 })
    .zIndex(1000)
  }

  @Builder
  HeroSection() {
    Column() {
      Swiper() {
        ForEach(this.product?.images || [this.product?.image], (image: string, index?: number) => {
          Image(image)
            .width('100%')
            .height(450)
            .objectFit(ImageFit.Contain)
            .backgroundColor('#0A0A0A')
            .borderRadius(0)
        })
      }
      .width('100%')
      .height(450)
      .loop(true)
      .autoPlay(true)
      .interval(3000)
      .indicatorStyle({
        size: 8,
        left: 0,
        right: 0,
        top: 400,
        color: 'rgba(255,255,255,0.3)',
        selectedColor: '#FFFFFF'
      })
      .onChange((index: number) => {
        this.currentImageIndex = index
      })

      // å›¾ç‰‡æŒ‡ç¤ºå™¨
      Row() {
        ForEach(this.product?.images || [this.product?.image], (image: string, index?: number) => {
          Circle({ width: 8, height: 8 })
            .fill(index === this.currentImageIndex ? '#FFFFFF' : 'rgba(255,255,255,0.3)')
            .margin({ left: 4, right: 4 })
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .margin({ top: -20 })
      .zIndex(10)
    }
    .width('100%')
    .linearGradient({
      direction: GradientDirection.Bottom,
      colors: [
        ['#0A0A0A', 0.0],
        ['#1A1A1A', 0.3],
        ['#0A0A0A', 1.0]
      ]
    })
  }

  @Builder
  ProductInfo() {
    Column() {
      // ä»·æ ¼å’Œæ ‡é¢˜
      Column() {
        Row() {
          Text(`Â¥${this.product?.price || 0}`)
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')

          if (this.product?.originalPrice && this.product.originalPrice > this.product.price) {
            Text(`Â¥${this.product.originalPrice}`)
              .fontSize(20)
              .fontColor('rgba(255,255,255,0.5)')
              .decoration({ type: TextDecorationType.LineThrough })
              .margin({ left: 16 })
          }
        }
        .width('100%')
        .alignItems(VerticalAlign.Bottom)

        Text(this.product?.name || '')
          .fontSize(24)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .width('100%')
          .margin({ top: 16 })
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        // æ ‡ç­¾
        Row({ space: 8 }) {
          ForEach(this.product?.tags || [], (tag: string) => {
            Text(tag)
              .fontSize(12)
              .fontColor('#FFFFFF')
              .backgroundColor('rgba(255,255,255,0.1)')
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .borderRadius(4)
          })
        }
        .width('100%')
        .margin({ top: 12 })
      }
      .width('100%')
      .padding(24)
      .backgroundColor('#1A1A1A')
      .borderRadius(24)
      .margin({ top: -40 })
      .zIndex(10)

      // è§„æ ¼é€‰æ‹©
      Column() {
        Text('é€‰æ‹©è§„æ ¼')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .width('100%')
          .margin({ bottom: 16 })

        // å†…å­˜ç‰ˆæœ¬
        Column() {
          Row() {
            Text('ç‰ˆæœ¬')
              .fontSize(14)
              .fontColor('#666666')
              .width('20%')
            Blank()
          }
          .width('100%')
          .margin({ bottom: 12 })

          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.specs, (spec: string) => {
              Text(spec)
                .fontSize(14)
                .fontColor(this.selectedSpec === spec ? '#FFFFFF' : '#1A1A1A')
                .backgroundColor(this.selectedSpec === spec ? '#1A1A1A' : '#F5F5F5')
                .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                .borderRadius(8)
                .margin({ right: 12, bottom: 8 })
                .onClick(() => {
                  this.selectedSpec = spec
                })
            })
          }
          .width('100%')
        }
        .width('100%')
        .margin({ bottom: 24 })

        // é¢œè‰²é€‰æ‹©
        Column() {
          Row() {
            Text('é¢œè‰²')
              .fontSize(14)
              .fontColor('#666666')
              .width('20%')
            Text(this.selectedColor)
              .fontSize(14)
              .fontColor('#1A1A1A')
              .margin({ right: 8 })
            Text('>')
              .fontSize(16)
              .fontColor('#666666')
            Blank()
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .onClick(() => {
            console.log('é€‰æ‹©é¢œè‰²')
          })
        }
        .width('100%')
      }
      .width('100%')
      .padding(24)
      .backgroundColor('#FFFFFF')
      .borderRadius(24)
      .margin({ top: 12 })

      // æœåŠ¡ä¿éšœ
      Row() {
        Row() {
          Text('âœ“')
            .fontSize(16)
            .fontColor('#00C853')
            .fontWeight(FontWeight.Bold)
          Text('å®˜æ–¹æ­£å“')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ left: 4 })
        }

        Row() {
          Text('âœ“')
            .fontSize(16)
            .fontColor('#00C853')
            .fontWeight(FontWeight.Bold)
          Text('ä¸ƒå¤©æ— ç†ç”±')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ left: 4 })
        }

        Row() {
          Text('âœ“')
            .fontSize(16)
            .fontColor('#00C853')
            .fontWeight(FontWeight.Bold)
          Text('é¡ºä¸°åŒ…é‚®')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ left: 4 })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius(24)
      .margin({ top: 12 })
    }
    .width('100%')
    .padding({ bottom: 100 })
  }

  @Builder
  CommentSection() {
    Column() {
      Row() {
        Text('ç”¨æˆ·è¯„ä»·')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')

        Row() {
          Text('æŸ¥çœ‹å…¨éƒ¨')
            .fontSize(14)
            .fontColor('#666666')
          Text('>')
            .fontSize(16)
            .fontColor('#666666')
        }
        .onClick(() => {
          this.showReviewModal = true
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 20 })

      // è¯„è®ºåˆ—è¡¨
      ForEach(this.comments, (comment: Comment) => {
        Column() {
          Row() {
            Text(comment.userName[0])
              .fontSize(18)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Bold)
              .width(40)
              .height(40)
              .backgroundColor('#E0E0E0')
              .borderRadius(20)
              .textAlign(TextAlign.Center)

            Column() {
              Text(comment.userName)
                .fontSize(14)
                .fontColor('#1A1A1A')
                .fontWeight(FontWeight.Medium)
              Text(comment.spec)
                .fontSize(12)
                .fontColor('#999999')
                .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
            .margin({ left: 12 })

            Text(comment.date)
              .fontSize(12)
              .fontColor('#999999')
          }
          .width('100%')
          .alignItems(VerticalAlign.Top)
          .margin({ bottom: 12 })

          // è¯„åˆ†
          Row() {
            ForEach([1, 2, 3, 4, 5], (star: number) => {
              Text('â˜…')
                .fontSize(16)
                .fontColor(star <= comment.rating ? '#FFD700' : '#E0E0E0')
            })
          }
          .margin({ bottom: 12 })

          Text(comment.content)
            .fontSize(14)
            .fontColor('#333333')
            .lineHeight(22)
            .width('100%')
            .margin({ bottom: 12 })

          Row() {
            Text('æœ‰ç”¨ (${comment.helpfulCount})')
              .fontSize(12)
              .fontColor('#666666')
              .backgroundColor('#F5F5F5')
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .borderRadius(4)
          }
          .width('100%')
          .justifyContent(FlexAlign.End)
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .margin({ bottom: 12 })
      })
    }
    .width('100%')
    .padding({ left: 20, right: 20 })
    .margin({ top: 12 })
  }

  @Builder
  BottomActionBar() {
    Row() {
      // è´­ç‰©è½¦æŒ‰é’®
      Column() {
        Text('ğŸ›’')
          .fontSize(28)
          .fontColor('#1A1A1A')

        Text('è´­ç‰©è½¦')
          .fontSize(12)
          .fontColor('#666666')
          .margin({ top: 4 })
      }
      .width(48)
      .height(48)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        router.pushUrl({ url: 'pages/CartPageNew' })
      })

      Button('åŠ å…¥è´­ç‰©è½¦')
        .height(50)
        .fontSize(16)
        .fontColor('#FFFFFF')
        .backgroundColor('#1A1A1A')
        .borderRadius(25)
        .layoutWeight(1)
        .margin({ left: 20, right: 12 })
        .onClick(() => this.onAddToCart())

      Button('ç«‹å³è´­ä¹°')
        .height(50)
        .fontSize(16)
        .fontColor('#FFFFFF')
        .backgroundColor('#FF3B30')
        .borderRadius(25)
        .layoutWeight(1)
        .onClick(() => this.onBuyNow())
    }
    .width('100%')
    .padding({ left: 20, right: 20, bottom: 20, top: 12 })
    .backgroundColor('rgba(255,255,255,0.98)')
    .backdropBlur(20)
    .border({ width: { top: 0.5 }, color: '#E5E5E5' })
  }

  build() {
    Stack() {
      Scroll() {
        Column() {
          // Hero åŒºåŸŸ
          this.HeroSection()

          // å•†å“ä¿¡æ¯
          this.ProductInfo()

          // è¯„ä»·åŒºåŸŸ
          this.CommentSection()

          // å•†å“è¯¦æƒ…
          Column() {
            Text('å•†å“è¯¦æƒ…')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#1A1A1A')
              .width('100%')
              .margin({ bottom: 20 })

            Text(this.product?.detailDescription || '')
              .fontSize(14)
              .fontColor('#666666')
              .lineHeight(24)
              .width('100%')
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(24)
          .margin({ top: 12, bottom: 120 })
        }
        .width('100%')
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F7')
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)

      // å¯¼èˆªæ 
      this.NavigationBar()

      // åº•éƒ¨æ“ä½œæ 
      Stack() {
        this.BottomActionBar()
      }
      .position({ x: 0, y: '100%' })
      .translate({ x: 0, y: -110 })

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#1A1A1A')
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#F5F5F7')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F7')
  }
}