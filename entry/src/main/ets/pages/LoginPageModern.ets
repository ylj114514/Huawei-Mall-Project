import router from '@ohos.router'
import { User } from '../model/DataModel'
import { StorageManager } from '../utils/StorageManagerSimple'
import common from '@ohos.app.ability.common'

interface ColorScheme {
  background: string
  surface: string
  primary: string
  primaryDark: string
  secondary: string
  text: string
  textSecondary: string
  accent: string
  error: string
  success: string
}

const COLORS: ColorScheme = {
  background: '#FFFFFF',
  surface: '#F8F9FA',
  primary: '#007AFF',
  primaryDark: '#0056D6',
  secondary: '#6C757D',
  text: '#2C3E50',
  textSecondary: '#7F8C8D',
  accent: '#FF6B6B',
  error: '#E74C3C',
  success: '#27AE60'
}

@Entry
@Component
struct LoginPageModern {
  @State isLoginMode: boolean = true
  @State account: string = ''
  @State password: string = ''
  @State confirmPassword: string = ''
  @State nickname: string = ''
  @State email: string = ''
  @State agreeTerms: boolean = false
  @State isLoading: boolean = false
  @State showPassword: boolean = false
  @State showConfirmPassword: boolean = false
  @State errorMessage: string = ''

  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
    } catch (error) {
      console.error('åˆå§‹åŒ–å­˜å‚¨å¤±è´¥:', error)
    }
  }

  private validateForm(): boolean {
    // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
    this.errorMessage = ''

    if (!this.account) {
      this.errorMessage = 'è¯·è¾“å…¥è´¦å·'
      return false
    }

    if (this.account.length < 3) {
      this.errorMessage = 'è´¦å·è‡³å°‘3ä½'
      return false
    }

    if (!this.password) {
      this.errorMessage = 'è¯·è¾“å…¥å¯†ç '
      return false
    }

    if (this.password.length < 6) {
      this.errorMessage = 'å¯†ç è‡³å°‘6ä½'
      return false
    }

    if (!this.isLoginMode) {
      if (this.password !== this.confirmPassword) {
        this.errorMessage = 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´'
        return false
      }

      if (!this.nickname || !this.nickname.trim()) {
        this.errorMessage = 'è¯·è¾“å…¥æ˜µç§°'
        return false
      }

      if (!this.agreeTerms) {
        this.errorMessage = 'è¯·åŒæ„ç”¨æˆ·åè®®å’Œéšç§æ”¿ç­–'
        return false
      }
    }

    return true
  }

  private async handleLogin() {
    if (!this.validateForm()) return

    this.isLoading = true

    try {
      const existingUser = await this.storage.findUserByAccount(this.account)

      if (existingUser && existingUser.password === this.password) {
        await this.storage.saveUser(existingUser)
        router.replaceUrl({ url: 'pages/IndexNewModern' })
      } else if (existingUser) {
        this.errorMessage = 'å¯†ç é”™è¯¯'
      } else {
        this.errorMessage = 'è´¦å·ä¸å­˜åœ¨'
      }
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
      this.errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    } finally {
      this.isLoading = false
    }
  }

  private async handleRegister() {
    console.log('è¿›å…¥æ³¨å†Œæ–¹æ³•')
    console.log('è´¦å·:', this.account)
    console.log('å¯†ç :', this.password)
    console.log('æ˜µç§°:', this.nickname)
    console.log('åŒæ„åè®®:', this.agreeTerms)

    if (!this.validateForm()) {
      console.log('è¡¨å•éªŒè¯å¤±è´¥:', this.errorMessage)
      return
    }

    console.log('è¡¨å•éªŒè¯é€šè¿‡')
    this.isLoading = true

    try {
      console.log('æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨')
      const existingUser = await this.storage.findUserByAccount(this.account)

      if (existingUser) {
        console.log('è´¦å·å·²å­˜åœ¨')
        this.errorMessage = 'è¯¥è´¦å·å·²æ³¨å†Œ'
      } else {
        console.log('åˆ›å»ºæ–°ç”¨æˆ·')
        const newUser = new User(this.account, this.password)
        newUser.username = this.nickname.trim()
        newUser.email = this.email
        newUser.registrationTime = Date.now()

        console.log('ä¿å­˜ç”¨æˆ·')
        await this.storage.saveUser(newUser)
        console.log('æ³¨å†ŒæˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ')
        router.replaceUrl({ url: 'pages/IndexNewModern' })
      }
    } catch (error) {
      console.error('æ³¨å†Œå¤±è´¥:', error)
      this.errorMessage = 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    } finally {
      this.isLoading = false
    }
  }

  private toggleMode() {
    this.isLoginMode = !this.isLoginMode
    this.clearForm()
  }

  private clearForm() {
    this.account = ''
    this.password = ''
    this.confirmPassword = ''
    this.nickname = ''
    this.email = ''
    this.agreeTerms = false
    this.errorMessage = ''
    this.showPassword = false
    this.showConfirmPassword = false
  }

  @Builder
  Header() {
    Column() {
      Row() {
        Button() {
          Text('â†')
            .fontSize(24)
            .fontColor(COLORS.text)
        }
        .width(48)
        .height(48)
        .backgroundColor(Color.Transparent)
        .onClick(() => router.back())

        Blank()

        Text(this.isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ')
          .fontSize(20)
          .fontWeight(FontWeight.Medium)
          .fontColor(COLORS.text)

        Blank().width(48)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 12, bottom: 12 })

      // LogoåŒºåŸŸ
      Column() {
        Text('HUAWEI')
          .fontSize(48)
          .fontWeight(FontWeight.Bold)
          .fontColor(COLORS.primary)
          .letterSpacing(4)

        Text('åä¸ºå•†åŸ')
          .fontSize(18)
          .fontColor(COLORS.secondary)
          .margin({ top: 8 })
      }
      .width('100%')
      .padding({ top: 40, bottom: 40 })
    }
    .width('100%')
    .backgroundColor(COLORS.background)
  }

  @Builder
  LoginForm() {
    Column() {
      // é”™è¯¯æç¤º
      if (this.errorMessage) {
        Text(this.errorMessage)
          .fontSize(14)
          .fontColor(COLORS.error)
          .width('100%')
          .textAlign(TextAlign.Center)
          .margin({ bottom: 20 })
          .padding(12)
          .backgroundColor('#FFE5E5')
          .borderRadius(8)
      }

      // è´¦å·è¾“å…¥
      Column() {
        Text('è´¦å·')
          .fontSize(14)
          .fontColor(COLORS.text)
          .width('100%')
          .margin({ bottom: 8 })

        Row() {
          TextInput({ placeholder: 'è¯·è¾“å…¥è´¦å·' })
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor(COLORS.text)
            .backgroundColor(COLORS.surface)
            .borderRadius(12)
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.account = value
              this.errorMessage = ''
            })
        }
      }
      .width('100%')
      .margin({ bottom: 20 })

      // å¯†ç è¾“å…¥
      Column() {
        Text('å¯†ç ')
          .fontSize(14)
          .fontColor(COLORS.text)
          .width('100%')
          .margin({ bottom: 8 })

        Row() {
          TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ' })
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor(COLORS.text)
            .backgroundColor(COLORS.surface)
            .borderRadius(12)
            .padding({ left: 16, right: 16 })
            .type(this.showPassword ? InputType.Normal : InputType.Password)
            .onChange((value: string) => {
              this.password = value
              this.errorMessage = ''
            })

          Button() {
            Text(this.showPassword ? 'ğŸ‘ï¸' : 'ğŸ™ˆ')
              .fontSize(20)
          }
          .width(48)
          .height(48)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showPassword = !this.showPassword
          })
        }
      }
      .width('100%')
      .margin({ bottom: 16 })

      // å¿˜è®°å¯†ç 
      if (this.isLoginMode) {
        Row() {
          Blank()
          Text('å¿˜è®°å¯†ç ï¼Ÿ')
            .fontSize(14)
            .fontColor(COLORS.primary)
            .onClick(() => {
              router.pushUrl({ url: 'pages/ForgotPasswordPage' })
            })
        }
        .width('100%')
        .margin({ bottom: 32 })
      }

      // æ˜µç§°è¾“å…¥ï¼ˆæ³¨å†Œæ¨¡å¼ï¼‰
      if (!this.isLoginMode) {
        Column() {
          Text('æ˜µç§°')
            .fontSize(14)
            .fontColor(COLORS.text)
            .width('100%')
            .margin({ bottom: 8 })

          TextInput({ placeholder: 'è¯·è¾“å…¥æ˜µç§°' })
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor(COLORS.text)
            .backgroundColor(COLORS.surface)
            .borderRadius(12)
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.nickname = value
              this.errorMessage = ''
            })
        }
        .width('100%')
        .margin({ bottom: 20 })

        // ç¡®è®¤å¯†ç 
        Column() {
          Text('ç¡®è®¤å¯†ç ')
            .fontSize(14)
            .fontColor(COLORS.text)
            .width('100%')
            .margin({ bottom: 8 })

          Row() {
            TextInput({ placeholder: 'è¯·å†æ¬¡è¾“å…¥å¯†ç ' })
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontColor(COLORS.text)
              .backgroundColor(COLORS.surface)
              .borderRadius(12)
              .padding({ left: 16, right: 16 })
              .type(this.showConfirmPassword ? InputType.Normal : InputType.Password)
              .onChange((value: string) => {
                this.confirmPassword = value
                this.errorMessage = ''
              })

            Button() {
              Text(this.showConfirmPassword ? 'ğŸ‘ï¸' : 'ğŸ™ˆ')
                .fontSize(20)
            }
            .width(48)
            .height(48)
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              this.showConfirmPassword = !this.showConfirmPassword
            })
          }
        }
        .width('100%')
        .margin({ bottom: 20 })
      }

      // é‚®ç®±è¾“å…¥ï¼ˆæ³¨å†Œæ¨¡å¼ï¼‰
      if (!this.isLoginMode) {
        Column() {
          Text('é‚®ç®±ï¼ˆé€‰å¡«ï¼‰')
            .fontSize(14)
            .fontColor(COLORS.text)
            .width('100%')
            .margin({ bottom: 8 })

          TextInput({ placeholder: 'è¯·è¾“å…¥é‚®ç®±' })
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontColor(COLORS.text)
            .backgroundColor(COLORS.surface)
            .borderRadius(12)
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.email = value
            })
        }
        .width('100%')
        .margin({ bottom: 20 })
      }

      // ç”¨æˆ·åè®®ï¼ˆæ³¨å†Œæ¨¡å¼ï¼‰
      if (!this.isLoginMode) {
        Row() {
          Checkbox()
            .select(this.agreeTerms)
            .onChange((checked: boolean) => {
              this.agreeTerms = checked
            })

          Text('æˆ‘å·²é˜…è¯»å¹¶åŒæ„')
            .fontSize(14)
            .fontColor(COLORS.textSecondary)
            .margin({ left: 8 })

          Text('ã€Šç”¨æˆ·åè®®ã€‹')
            .fontSize(14)
            .fontColor(COLORS.primary)
            .onClick(() => {
              // æ‰“å¼€ç”¨æˆ·åè®®
            })

          Text('å’Œ')

          Text('ã€Šéšç§æ”¿ç­–ã€‹')
            .fontSize(14)
            .fontColor(COLORS.primary)
            .onClick(() => {
              // æ‰“å¼€éšç§æ”¿ç­–
            })
        }
        .width('100%')
        .margin({ bottom: 32 })
      }

      // ç™»å½•/æ³¨å†ŒæŒ‰é’®
      Button() {
        Text(this.isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      .height(48)
      .fontColor(Color.White)
      .backgroundColor(this.isLoginMode ? COLORS.primary : '#FF3B30')
      .borderRadius(12)
      .onClick(() => {
        console.log('æŒ‰é’®è¢«ç‚¹å‡»äº†!!!')
        if (!this.isLoginMode) {
          console.log('æ‰§è¡Œæ³¨å†Œæµç¨‹')
          this.handleRegister()
        } else {
          this.handleLogin()
        }
      })

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Row() {
          LoadingProgress()
            .width(20)
            .height(20)
            .color(Color.White)
          Text(this.isLoginMode ? 'ç™»å½•ä¸­...' : 'æ³¨å†Œä¸­...')
            .fontSize(14)
            .fontColor(Color.White)
            .margin({ left: 8 })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ top: 16 })
      }
    }
    .width('100%')
    .padding(20)
  }

  @Builder
  Footer() {
    Column() {
      // ç¬¬ä¸‰æ–¹ç™»å½•
      if (this.isLoginMode) {
        Column() {
          Text('å…¶ä»–ç™»å½•æ–¹å¼')
            .fontSize(14)
            .fontColor(COLORS.textSecondary)
            .margin({ bottom: 20 })

          Row({ space: 20 }) {
            Button() {
              Text('ğŸ“±')
                .fontSize(24)
            }
            .width(48)
            .height(48)
            .backgroundColor('#1DAF57')
            .borderRadius(24)
            .onClick(() => {
              // å¾®ä¿¡ç™»å½•
            })

            Button() {
              Text('â˜ï¸')
                .fontSize(24)
            }
            .width(48)
            .height(48)
            .backgroundColor('#4A90E2')
            .borderRadius(24)
            .onClick(() => {
              // QQç™»å½•
            })

            Button() {
              Text('ğŸ')
                .fontSize(24)
            }
            .width(48)
            .height(48)
            .backgroundColor('#000000')
            .borderRadius(24)
            .onClick(() => {
              // Apple IDç™»å½•
            })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        }
      }

      // åˆ‡æ¢ç™»å½•/æ³¨å†Œ
      Row() {
        Text(this.isLoginMode ? 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ' : 'å·²æœ‰è´¦å·ï¼Ÿ')
          .fontSize(14)
          .fontColor(COLORS.textSecondary)

        Button(this.isLoginMode ? 'ç«‹å³æ³¨å†Œ' : 'ç«‹å³ç™»å½•')
          .fontSize(14)
          .fontColor(COLORS.primary)
          .backgroundColor(Color.Transparent)
          .onClick(() => this.toggleMode())
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .margin({ top: 40, bottom: 20 })
    }
    .width('100%')
    .padding(20)
  }

  build() {
    Column() {
      // é¡¶éƒ¨
      this.Header()

      // è¡¨å•
      Scroll() {
        Column() {
          this.LoginForm()
        }
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      // åº•éƒ¨
      this.Footer()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(COLORS.background)
  }
}