import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import { ProductModel, MockData } from '../model/ProductModel'
import { CartService } from '../services/CartService'

@Entry
@Component
struct ProductDetailPage {
  @State product: ProductModel | null = null
  @State quantity: number = 1
  @State selectedColor: string = 'é›…å·é’'
  @State selectedStorage: string = '512GB'
  @State isLoading: boolean = true

  // æœåŠ¡å®ä¾‹
  private cartService: CartService = CartService.getInstance()

  // æ¨¡æ‹Ÿçš„è§„æ ¼æ•°æ®
  private colors: string[] = ['é›…å·é’', 'ç™½æ²™é“¶', 'å—ç³¯ç´«', 'é›…ä¸¹é»‘']
  private storages: string[] = ['256GB', '512GB', '1TB']

  aboutToAppear() {
    // 1. è·å–é¦–é¡µä¼ é€’è¿‡æ¥çš„å‚æ•°
    const params = router.getParams() as Record<string, Object>

    let productId = ''
    if (params && params.productId) {
      productId = (params.productId as string)
    }
    // å…œåº•é€»è¾‘ï¼šå¦‚æœå‚æ•°ä¸å¯¹ï¼Œé»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªå•†å“ï¼Œé˜²æ­¢ç™½å±
    this.loadProductDetails(productId)
  }

  private loadProductDetails(id: string) {
    setTimeout(() => {
      const allProducts = MockData.generateProducts()
      // å°è¯•æ‰¾åˆ°å¯¹åº”å•†å“ï¼Œæ‰¾ä¸åˆ°å°±ç”¨ç¬¬ä¸€ä¸ª
      this.product = allProducts.find(p => p.id === id) || allProducts[0]
      this.isLoading = false
    }, 500)
  }

  private async addToCart() {
    if (this.product) {
      await this.cartService.addToCart(this.product, this.quantity)
      promptAction.showToast({ message: 'å·²æˆåŠŸåŠ å…¥è´­ç‰©è½¦' })
    }
  }

  private buyNow() {
    promptAction.showDialog({
      title: 'ç¡®è®¤è®¢å•',
      message: `æ‚¨é€‰æ‹©äº†ï¼š\n${this.product?.name}\né¢œè‰²ï¼š${this.selectedColor}\nå®¹é‡ï¼š${this.selectedStorage}\n\nåŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼`,
      buttons: [{ text: 'å¥½çš„', color: '#CF0A2C' }]
    })
  }

  @Builder
  NavBar() {
    Row() {
      Button({ type: ButtonType.Circle }) {
        Text('<')
          .fontSize(20)
          .fontColor('#1a1a1a')
      }
      .width(40)
      .height(40)
      .backgroundColor('rgba(255,255,255,0.8)')
      .onClick(() => router.back())

      Blank()

      Button({ type: ButtonType.Circle }) {
        Text('ğŸ›’')
          .fontSize(20)
      }
      .width(40)
      .height(40)
      .backgroundColor('rgba(255,255,255,0.8)')
      .onClick(() => router.pushUrl({ url: 'pages/CartPage' }))
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12 })
    .position({ x: 0, y: 0 })
    .zIndex(10)
  }

  build() {
    Stack() {
      if (this.product) {
        Column() {
          Scroll() {
            Column() {
              // 1. å•†å“å¤§å›¾
              Image(this.product.image)
                .width('100%')
                .height(400)
                .objectFit(ImageFit.Contain)
                .backgroundColor('#F5F5F5')

              // 2. ä»·æ ¼ä¸æ ‡é¢˜åŒºåŸŸ
              Column() {
                Row() {
                  Text('Â¥')
                    .fontSize(18)
                    .fontColor('#CF0A2C')
                    .margin({ top: 4 })
                  Text(`${this.product.price}`)
                    .fontSize(32)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#CF0A2C')

                  if (this.product.originalPrice > this.product.price) {
                    Text(`Â¥${this.product.originalPrice}`)
                      .fontSize(14)
                      .fontColor('#999')
                      .decoration({ type: TextDecorationType.LineThrough })
                      .margin({ left: 10, top: 10 })
                  }
                }
                .width('100%')
                .margin({ bottom: 12 })

                Text(this.product.name)
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#1a1a1a')
                  .margin({ bottom: 8 })

                Text(this.product.description)
                  .fontSize(14)
                  .fontColor('#666')
                  .lineHeight(20)
              }
              .padding(20)
              .backgroundColor(Color.White)
              .borderRadius({ topLeft: 24, topRight: 24 })
              .margin({ top: -20 })

              // 3. è§„æ ¼é€‰æ‹©
              Column() {
                Text('é¢œè‰²é€‰æ‹©')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 12 })

                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.colors, (color: string) => {
                    Text(color)
                      .fontSize(14)
                      .fontColor(this.selectedColor === color ? '#CF0A2C' : '#333')
                      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                      .backgroundColor(this.selectedColor === color ? 'rgba(207, 10, 44, 0.1)' : '#F5F5F5')
                      .borderRadius(16)
                      .border({ width: 1, color: this.selectedColor === color ? '#CF0A2C' : 'transparent' })
                      .margin({ right: 12, bottom: 12 })
                      .onClick(() => this.selectedColor = color)
                  })
                }
                .margin({ bottom: 20 })

                Text('ç‰ˆæœ¬é€‰æ‹©')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 12 })

                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.storages, (storage: string) => {
                    Text(storage)
                      .fontSize(14)
                      .fontColor(this.selectedStorage === storage ? '#CF0A2C' : '#333')
                      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                      .backgroundColor(this.selectedStorage === storage ? 'rgba(207, 10, 44, 0.1)' : '#F5F5F5')
                      .borderRadius(16)
                      .border({ width: 1, color: this.selectedStorage === storage ? '#CF0A2C' : 'transparent' })
                      .margin({ right: 12, bottom: 12 })
                      .onClick(() => this.selectedStorage = storage)
                  })
                }
              }
              .width('100%')
              .padding(20)
              .backgroundColor(Color.White)
              .margin({ top: 12 })

              // åº•éƒ¨ç•™ç™½
              Blank().height(80)
            }
          }
          .width('100%')
          .height('100%')
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#F5F5F5')

        // åº•éƒ¨è´­ä¹°æ 
        Row() {
          Column() {
            Text('ğŸ§')
              .fontSize(20)
            Text('å®¢æœ')
              .fontSize(10)
              .fontColor('#666')
          }
          .margin({ right: 20 })

          Column() {
            Text('â­')
              .fontSize(20)
            Text('æ”¶è—')
              .fontSize(10)
              .fontColor('#666')
          }
          .margin({ right: 20 })

          Button('åŠ å…¥è´­ç‰©è½¦')
            .backgroundColor('#FF9500')
            .fontSize(14)
            .height(40)
            .layoutWeight(1)
            .margin({ right: 10 })
            .onClick(() => this.addToCart())

          Button('ç«‹å³è´­ä¹°')
            .backgroundColor('#CF0A2C')
            .fontSize(14)
            .height(40)
            .layoutWeight(1)
            .onClick(() => this.buyNow())
        }
        .width('100%')
        .height(60)
        .backgroundColor(Color.White)
        .position({ x: 0, y: '100%' })
        .translate({ x: 0, y: -60 })
        .padding({ left: 16, right: 16 })
        .shadow({ radius: 10, color: 'rgba(0,0,0,0.1)', offsetY: -5 })

      } else {
        // åŠ è½½ä¸­
        Column() {
          LoadingProgress().width(50).height(50).color('#CF0A2C')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      }

      // é¡¶éƒ¨æ‚¬æµ®å¯¼èˆª
      this.NavBar()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}