import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { CartService } from '../services/CartService'
import { CommentSectionNew } from '../components/CommentSectionNew'

@Entry
@Component
struct ProductDetailPage {
  @State product: ProductModel | null = null
  @State currentImageIndex: number = 0
  @State quantity: number = 1
  @State isLoading: boolean = true
  @State showCartDialog: boolean = false
  @State showAlreadyInCartDialog: boolean = false
  @State scrollY: number = 0
  @State imageHeight: number = 375 // å›¾ç‰‡é«˜åº¦ï¼Œç±»ä¼¼äº¬ä¸œ/æ·˜å®
  private cartService: CartService = CartService.getInstance()

  aboutToAppear() {
    this.loadProductData()
  }

  private loadProductData() {
    interface RouteParams {
      productId: string
    }
    const params = router.getParams() as RouteParams
    if (params && params.productId) {
      const products = MockData.generateProducts()
      this.product = products.find(p => p.id === params.productId) || null
    }
    this.isLoading = false
  }

  private onImageChange(index: number) {
    this.currentImageIndex = index
  }

  private onQuantityChange(change: number) {
    const newQuantity = this.quantity + change
    if (newQuantity >= 1 && newQuantity <= (this.product?.stock || 0)) {
      this.quantity = newQuantity
    }
  }

  private onAddToCart() {
    if (!this.product) return

    if (this.quantity > this.product.stock) {
      console.error('åº“å­˜ä¸è¶³')
      return
    }

    try {
      if (this.cartService.isProductInCart(this.product.id)) {
        // å•†å“å·²åœ¨è´­ç‰©è½¦ä¸­ï¼Œæ˜¾ç¤ºæç¤ºå¯¹è¯æ¡†
        this.showAlreadyInCartDialog = true
      } else {
        const success = this.cartService.addToCart(this.product, this.quantity)
        if (!success) {
          console.error('æ·»åŠ åˆ°è´­ç‰©è½¦å¤±è´¥')
          return
        }
        console.log('æ·»åŠ åˆ°è´­ç‰©è½¦æˆåŠŸ')
        this.showCartSuccessDialog()
      }
    } catch (error) {
      console.error('æ·»åŠ åˆ°è´­ç‰©è½¦å¼‚å¸¸:', error)
    }
  }

  private showCartSuccessDialog(): void {
    this.showCartDialog = true
  }

  private goToCart(): void {
    this.showCartDialog = false
    router.pushUrl({ url: 'pages/CartPageNew' })
  }

  private continueShopping(): void {
    this.showCartDialog = false
  }

  private closeAlreadyInCartDialog(): void {
    this.showAlreadyInCartDialog = false
  }

  private onBuyNow() {
    if (!this.product) return
    console.log('ç«‹å³è´­ä¹°:', this.product.name, 'æ•°é‡:', this.quantity)
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Button() {
            Row() {
              Text('â†')
                .fontSize(18)
                .fontColor($r('app.color.text_primary'))
              Text('è¿”å›ž')
                .fontSize(16)
                .fontColor($r('app.color.text_primary'))
                .margin({ left: 4 })
            }
          }
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            try {
              router.back()
            } catch (error) {
              console.error('è¿”å›žå¤±è´¥:', error)
            }
          })

          Blank().layoutWeight(1)

          Text(this.product?.name || 'å•†å“è¯¦æƒ…')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('40%')

          Blank().layoutWeight(1)

          // è´­ç‰©è½¦æŒ‰é’®
          Button() {
            Row() {
              Text('ðŸ›’')
                .fontSize(20)
              Text('è´­ç‰©è½¦')
                .fontSize(10)
                .margin({ left: 4 })
            }
          }
          .fontSize(12)
          .fontColor($r('app.color.text_primary'))
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.goToCart()
          })
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor($r('app.color.white'))
        .shadow({
          radius: 2,
          color: '#1A000000',
          offsetX: 0,
          offsetY: 1
        })
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)

        // ä¸»å†…å®¹ - å¯æ»šåŠ¨
        Scroll() {
          Column() {
            // å•†å“å›¾ç‰‡è½®æ’­
            Column() {
              Swiper() {
                ForEach(this.product?.images || [], (image: string, index: number) => {
                  Image(image)
                    .width('100%')
                    .height(this.imageHeight)
                    .objectFit(ImageFit.Contain)
                    .backgroundColor('#f5f5f5')
                    .alt('å•†å“å›¾ç‰‡')
                })
              }
              .width('100%')
              .height(this.imageHeight)
              .loop(true)
              .indicator(true)
              .indicatorStyle({
                size: 8,
                color: 'rgba(255,255,255,0.5)',
                selectedColor: '#ffffff'
              })
              .onChange(this.onImageChange.bind(this))
            }
            .backgroundColor($r('app.color.white'))

            // å•†å“åŸºæœ¬ä¿¡æ¯
            Column() {
              // å•†å“åç§°å’Œä»·æ ¼
              Column() {
                Text(this.product?.name || '')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))
                  .width('100%')
                  .margin({ bottom: 12 })

                Row() {
                  Text(`Â¥${this.product?.price || 0}`)
                    .fontSize(24)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#ff4444')

                  if (this.product?.originalPrice && this.product.originalPrice > this.product.price) {
                    Text(`Â¥${this.product.originalPrice}`)
                      .fontSize(14)
                      .fontColor($r('app.color.text_secondary'))
                      .decoration({ type: TextDecorationType.LineThrough })
                      .margin({ left: 12, top: 4 })
                  }
                }
                .width('100%')
                .alignItems(VerticalAlign.Bottom)
                .margin({ bottom: 12 })

                // è¯„åˆ†ã€é”€é‡ã€åº“å­˜
                Row() {
                  Row() {
                    Text('â­')
                      .fontSize(14)
                    Text(`${this.product?.rating?.toFixed(1) || '5.0'}`)
                      .fontSize(14)
                      .fontColor($r('app.color.text_secondary'))
                    Text(`(${this.product?.reviewCount || 0}æ¡è¯„ä»·)`)
                      .fontSize(12)
                      .fontColor($r('app.color.text_secondary'))
                      .margin({ left: 4 })
                  }

                  Text(`åº“å­˜ ${this.product?.stock || 0}`)
                    .fontSize(12)
                    .fontColor((this.product?.stock || 0) > 50 ? '#52c41a' : '#faad14')
                    .margin({ left: 20 })
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
              }
              .width('100%')
              .padding(16)
              .backgroundColor($r('app.color.white'))
              .borderRadius(12)
              .margin({ top: 8, left: 12, right: 12 })

              // è¿è´¹ä¿¡æ¯
              Row() {
                Text('âš¡')
                  .fontSize(16)
                Text('å…è¿è´¹')
                  .fontSize(14)
                  .fontColor($r('app.color.primary'))
                  .margin({ left: 4 })
                Text('é¢„è®¡24å°æ—¶å†…å‘è´§')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ left: 8 })
              }
              .width('100%')
              .padding(16)
              .backgroundColor($r('app.color.white'))
              .borderRadius(12)
              .margin({ top: 8, left: 12, right: 12 })
              .justifyContent(FlexAlign.Start)

              // å•†å“ç‰¹ç‚¹æ ‡ç­¾
              Column() {
                Text('å•†å“ç‰¹ç‚¹')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .width('100%')
                  .margin({ bottom: 12 })

                Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
                  ForEach(this.product?.tags || [], (tag: string) => {
                    Text(tag)
                      .fontSize(12)
                      .fontColor($r('app.color.primary'))
                      .backgroundColor('#f0f8ff')
                      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                      .borderRadius(16)
                      .margin({ right: 8, bottom: 8 })
                  })
                }
                .width('100%')
              }
              .width('100%')
              .padding(16)
              .backgroundColor($r('app.color.white'))
              .borderRadius(12)
              .margin({ top: 8, left: 12, right: 12 })

              // å•†å“è¯¦ç»†æè¿°
              Column() {
                Text('å•†å“è¯¦æƒ…')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .width('100%')
                  .margin({ bottom: 12 })

                Text(this.product?.detailDescription || 'æš‚æ— è¯¦ç»†æè¿°')
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
                  .lineHeight(24)
                  .width('100%')
              }
              .width('100%')
              .padding(16)
              .backgroundColor($r('app.color.white'))
              .borderRadius(12)
              .margin({ top: 8, left: 12, right: 12 })

              // ç”¨æˆ·è¯„ä»·åŒºåŸŸ
              Column() {
                Text('ç”¨æˆ·è¯„ä»·')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .width('100%')
                  .margin({ bottom: 12 })

                CommentSectionNew({ productId: this.product?.id || '' })
              }
              .width('100%')
              .padding(16)
              .backgroundColor($r('app.color.white'))
              .borderRadius(12)
              .margin({ top: 8, left: 12, right: 12, bottom: 120 }) // åº•éƒ¨ç©ºé—´ç»™è´­ä¹°æŒ‰é’®
            }
          }
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .onScroll((xOffset: number, yOffset: number) => {
          this.scrollY = yOffset
        })
      }
      .width('100%')
      .height('100%')

      // åº•éƒ¨è´­ä¹°æ  - å›ºå®šåœ¨å±å¹•æœ€åº•éƒ¨
      if (this.product) {
        Row() {
          // æ•°é‡é€‰æ‹©å™¨
          Column() {
            Text('æ•°é‡')
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 4 })
            Row() {
              Button('-')
                .width(32)
                .height(28)
                .fontSize(14)
                .backgroundColor($r('app.color.background'))
                .fontColor(this.quantity > 1 ? $r('app.color.text_primary') : $r('app.color.text_secondary'))
                .enabled(this.quantity > 1)
                .onClick(() => this.onQuantityChange(-1))

              Text(this.quantity.toString())
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .width(40)
                .textAlign(TextAlign.Center)

              Button('+')
                .width(32)
                .height(28)
                .fontSize(14)
                .backgroundColor($r('app.color.background'))
                .fontColor(this.quantity < this.product.stock ? $r('app.color.text_primary') : $r('app.color.text_secondary'))
                .enabled(this.quantity < this.product.stock)
                .onClick(() => this.onQuantityChange(1))
            }
          }
          .width(80)

          Blank().layoutWeight(1)

          Button('åŠ å…¥è´­ç‰©è½¦')
            .height(48)
            .fontSize(14)
            .backgroundColor('#ff9500')
            .fontColor(Color.White)
            .borderRadius(24)
            .layoutWeight(1)
            .margin({ right: 8 })
            .onClick(() => this.onAddToCart())

          Button('ç«‹å³è´­ä¹°')
            .height(48)
            .fontSize(14)
            .backgroundColor($r('app.color.primary'))
            .fontColor(Color.White)
            .borderRadius(24)
            .layoutWeight(1)
            .onClick(() => this.onBuyNow())
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .backgroundColor($r('app.color.white'))
        .shadow({
          radius: 4,
          color: '#1A000000',
          offsetX: 0,
          offsetY: -2
        })
        .position({ x: 0, y: '100%' })
        .translate({ x: 0, y: -64 })
        .zIndex(1001)
      }

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor($r('app.color.background'))
      }

      // åŠ å…¥è´­ç‰©è½¦æˆåŠŸå¼¹çª—
      if (this.showCartDialog) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.continueShopping()
            })

          // å¼¹çª—å†…å®¹
          Column() {
            Text('âœ“')
              .fontSize(48)
              .fontColor('#52c41a')
              .margin({ bottom: 16 })

            Text('åŠ å…¥è´­ç‰©è½¦æˆåŠŸ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 8 })

            Text('å•†å“å·²æˆåŠŸæ·»åŠ åˆ°è´­ç‰©è½¦')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 24 })

            Row() {
              Button('ç»§ç»­è´­ç‰©')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.background'))
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.continueShopping()
                })

              Button('åŽ»è´­ç‰©è½¦')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => {
                  this.goToCart()
                })
            }
            .width('100%')
          }
          .width(300)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .padding(24)
          .position({ x: '50%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(9999)
      }

      // å•†å“å·²åœ¨è´­ç‰©è½¦æç¤ºå¼¹çª—
      if (this.showAlreadyInCartDialog) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.closeAlreadyInCartDialog()
            })

          // å¼¹çª—å†…å®¹
          Column() {
            Text('ðŸ›’')
              .fontSize(48)
              .fontColor('#ff9500')
              .margin({ bottom: 16 })

            Text('å•†å“å·²åœ¨è´­ç‰©è½¦ä¸­')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 8 })

            Text('è¯¥å•†å“å·²ç»æ·»åŠ åˆ°è´­ç‰©è½¦ï¼Œå¯ä»¥å‰å¾€è´­ç‰©è½¦æŸ¥çœ‹æˆ–è°ƒæ•´æ•°é‡')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 24 })

            Row() {
              Button('ç»§ç»­è´­ç‰©')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.background'))
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.closeAlreadyInCartDialog()
                })

              Button('æŸ¥çœ‹è´­ç‰©è½¦')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => {
                  this.closeAlreadyInCartDialog()
                  this.goToCart()
                })
            }
            .width('100%')
          }
          .width(320)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .padding(24)
          .position({ x: '50%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(9999)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}