import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { CartService } from '../services/CartService'
// âœ… å¦‚æœæš‚æ—¶ä¸ç”¨ CommentSectionï¼Œè¯·æ³¨é‡Šæ‰ importï¼Œå¦åˆ™ä¼šæŠ¥"æœªä½¿ç”¨"é”™è¯¯
import { CommentSection } from '../components/CommentSection'

@Entry
@Component
struct ProductDetailPage {
  @State product: ProductModel | null = null
  @State currentImageIndex: number = 0
  @State quantity: number = 1
  @State isLoading: boolean = true
  @State showCartDialog: boolean = false
  @State showAlreadyInCartDialog: boolean = false
  @State scrollY: number = 0
  @State imageHeight: number = 375

  // è·å–è´­ç‰©è½¦æœåŠ¡å•ä¾‹
  private cartService: CartService = CartService.getInstance()

  aboutToAppear() {
    this.loadProductData()
  }

  private loadProductData() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>
    if (params) {
      if (params['product']) {
        // å¦‚æœä¼ é€’äº†å®Œæ•´å¯¹è±¡
        this.product = params['product'] as ProductModel
      } else if (params['productId']) {
        // å¦‚æœåªä¼ äº† IDï¼Œå» MockData æŸ¥æ‰¾
        const products = MockData.generateProducts()
        this.product = products.find(p => p.id === params['productId']) || null
      }
    }
    this.isLoading = false
  }

  private onImageChange(index: number) {
    this.currentImageIndex = index
  }

  private onQuantityChange(change: number) {
    if (!this.product) return
    const newQuantity = this.quantity + change
    if (newQuantity >= 1 && newQuantity <= (this.product.stock || 999)) {
      this.quantity = newQuantity
    }
  }

  private async onAddToCart() {
    if (!this.product) return

    // è°ƒç”¨ CartService æ·»åŠ åˆ°è´­ç‰©è½¦
    const success = await this.cartService.addToCart(this.product, this.quantity)

    if (success) {
      this.showCartSuccessDialog()
    } else {
      console.error('æ·»åŠ å¤±è´¥ï¼Œå¯èƒ½æœªç™»å½•')
      // è¿™é‡Œå¯ä»¥åŠ ä¸€ä¸ªæç¤ºï¼Œæ¯”å¦‚å¼¹çª—æç¤ºå»ç™»å½•
    }
  }

  private showCartSuccessDialog(): void {
    this.showCartDialog = true
  }

  private goToCart(): void {
    this.showCartDialog = false
    router.pushUrl({ url: 'pages/CartPage' })
  }

  private continueShopping(): void {
    this.showCartDialog = false
  }

  private onBuyNow() {
    if (!this.product) return
    // å…ˆåŠ è´­ç‰©è½¦ï¼Œå†è·³
    this.onAddToCart().then(() => {
      this.goToCart()
    })
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Button() {
            Row() {
              Text('â†').fontSize(18).fontColor('#333')
              Text('è¿”å›').fontSize(16).fontColor('#333').margin({ left: 4 })
            }
          }
          .backgroundColor(Color.Transparent)
          .onClick(() => router.back())

          Blank().layoutWeight(1)
          Text(this.product?.name || 'å•†å“è¯¦æƒ…')
            .fontSize(18).fontWeight(FontWeight.Bold).fontColor('#333')
            .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis }).width('40%')
          Blank().layoutWeight(1)

          Button() {
            Row() {
              Text('ğŸ›’').fontSize(20)
              Text('è´­ç‰©è½¦').fontSize(10).margin({ left: 4 })
            }
          }
          .fontSize(12).fontColor('#333').backgroundColor(Color.Transparent)
          .onClick(() => this.goToCart())
        }
        .width('100%').height(56).padding({ left: 16, right: 16 })
        .backgroundColor(Color.White)
        .shadow({ radius: 2, color: '#1A000000', offsetX: 0, offsetY: 1 })
        .justifyContent(FlexAlign.SpaceBetween)

        // ä¸»å†…å®¹
        Scroll() {
          Column() {
            // è½®æ’­å›¾
            if (this.product && this.product.images && this.product.images.length > 0) {
              Swiper() {
                ForEach(this.product.images, (image: Resource) => {
                  Image(image)
                    .width('100%').height(this.imageHeight).objectFit(ImageFit.Contain).backgroundColor('#f5f5f5')
                })
              }
              .width('100%').height(this.imageHeight).loop(true).indicator(true)
              .onChange((index) => this.onImageChange(index))
            } else if (this.product) {
              Image(this.product.image).width('100%').height(this.imageHeight).objectFit(ImageFit.Contain)
            }

            // ä¿¡æ¯åŒº
            Column() {
              Text(this.product?.name || '').fontSize(18).fontWeight(FontWeight.Bold).width('100%').margin({ bottom: 12 })

              Row() {
                Text(`Â¥${this.product?.price || 0}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#ff4444')
                if (this.product?.originalPrice && this.product.originalPrice > this.product.price) {
                  Text(`Â¥${this.product.originalPrice}`).fontSize(14).fontColor('#999')
                    .decoration({ type: TextDecorationType.LineThrough }).margin({ left: 12, top: 4 })
                }
              }
              .width('100%').alignItems(VerticalAlign.Bottom).margin({ bottom: 12 })

              // æ ‡ç­¾
              if (this.product?.tags) {
                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.product.tags, (tag: string) => {
                    Text(tag).fontSize(12).fontColor('#007aff').backgroundColor('#f0f8ff')
                      .padding({ left: 12, right: 12, top: 6, bottom: 6 }).borderRadius(16).margin({ right: 8, bottom: 8 })
                  })
                }
              }

              // è¯¦æƒ…
              Text('å•†å“è¯¦æƒ…').fontSize(16).fontWeight(FontWeight.Bold).width('100%').margin({ top: 20, bottom: 12 })
              Text(this.product?.detailDescription || 'æš‚æ— è¯¦ç»†æè¿°').fontSize(14).lineHeight(24).width('100%')

              // âœ… æ¢å¤è¯„è®ºåŒºç»„ä»¶ (å·²å¯¼å…¥ CommentSection)
              if (this.product) {
                CommentSection({ productId: this.product.id })
              }

              Column().height(100) // åº•éƒ¨å«é«˜
            }
            .padding(16).backgroundColor(Color.White).borderRadius(12).margin(12)
          }
        }
        .layoutWeight(1).backgroundColor('#f5f5f5')
      }

      // åº•éƒ¨æ“ä½œæ 
      if (this.product) {
        Row() {
          Column() {
            Text('æ•°é‡').fontSize(12).fontColor('#999').margin({ bottom: 4 })
            Row() {
              Button('-').width(32).height(28).fontSize(14).backgroundColor('#f5f5f5')
                .fontColor(this.quantity > 1 ? '#333' : '#ccc').enabled(this.quantity > 1)
                .onClick(() => this.onQuantityChange(-1))
              Text(`${this.quantity}`).fontSize(14).width(40).textAlign(TextAlign.Center)
              Button('+').width(32).height(28).fontSize(14).backgroundColor('#f5f5f5')
                .onClick(() => this.onQuantityChange(1))
            }
          }.width(80)

          Blank().layoutWeight(1)
          Button('åŠ å…¥è´­ç‰©è½¦').height(48).fontSize(14).backgroundColor('#ff9500').fontColor(Color.White)
            .borderRadius(24).layoutWeight(1).margin({ right: 8 }).onClick(() => this.onAddToCart())
          Button('ç«‹å³è´­ä¹°').height(48).fontSize(14).backgroundColor('#cf0a2c').fontColor(Color.White)
            .borderRadius(24).layoutWeight(1).onClick(() => this.onBuyNow())
        }
        .width('100%').padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .backgroundColor(Color.White).position({ x: 0, y: '100%' }).translate({ x: 0, y: -64 })
      }

      // å¼¹çª—é€»è¾‘
      if (this.showCartDialog) {
        Column() {
          Column().width('100%').height('100%').backgroundColor('rgba(0,0,0,0.5)').onClick(() => this.continueShopping())
          Column() {
            Text('âœ“').fontSize(48).fontColor('#52c41a').margin({ bottom: 16 })
            Text('åŠ å…¥æˆåŠŸ').fontSize(18).fontWeight(FontWeight.Bold).margin({ bottom: 24 })
            Row() {
              Button('ç»§ç»­è´­ç‰©').layoutWeight(1).margin({ right: 8 }).backgroundColor('#f5f5f5').fontColor('#333').onClick(() => this.continueShopping())
              Button('å»è´­ç‰©è½¦').layoutWeight(1).margin({ left: 8 }).backgroundColor('#007aff').onClick(() => this.goToCart())
            }
            .width('100%')
          }
          .width(300).backgroundColor(Color.White).borderRadius(12).padding(24)
          .position({ x: '50%', y: '50%' }).translate({ x: '-50%', y: '-50%' })
        }
        .zIndex(9999)
      }
    }
    .width('100%').height('100%').backgroundColor('#f5f5f5')
  }
}