import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import { ProductModel, MockData } from '../model/ProductModel'
import { CartService } from '../services/CartService'
import { AuthService } from '../services/AuthService'
import { CommentSection } from '../components/CommentSection'

@Entry
@Component
struct ProductDetailPage {
  @State product: ProductModel | null = null
  @State quantity: number = 1
  @State isLoading: boolean = true
  @State showCartDialog: boolean = false
  private imageHeight: number = 375

  private cartService: CartService = CartService.getInstance()
  private authService: AuthService = AuthService.getInstance()

  aboutToAppear() {
    // åªæœ‰è¿™é‡Œä¼šè¢«æ‰§è¡Œï¼Œç¡®ä¿å®ƒåªæ‰§è¡Œæ•°æ®åŠ è½½ï¼Œç»å¯¹ä¸åŒ…å«è·³è½¬é€»è¾‘
    this.loadProductData()
  }

  private loadProductData() {
    const params = router.getParams() as Record<string, Object>
    if (params) {
      if (params['product']) {
        this.product = params['product'] as ProductModel
      } else if (params['productId']) {
        const products = MockData.generateProducts()
        this.product = products.find(p => p.id === params['productId']) || null
      }
    }
    this.isLoading = false
    // æ­¤å¤„ç»ä¸æ·»åŠ  router è·³è½¬
  }

  // âœ… é€»è¾‘ï¼šæ•°é‡åŠ å‡ï¼ˆå¢å¼ºå¯¹æ¯”åº¦ï¼Œè§£å†³çœ‹ä¸è§çš„é—®é¢˜ï¼‰
  private onQuantityChange(change: number) {
    if (!this.product) return
    const newQuantity = this.quantity + change
    if (newQuantity >= 1 && newQuantity <= (this.product.stock || 999)) {
      this.quantity = newQuantity
    } else if (newQuantity > (this.product.stock || 999)) {
      promptAction.showToast({ message: 'è¶…å‡ºåº“å­˜èŒƒå›´' })
    }
  }

  // âœ… é€»è¾‘ï¼šç™»å½•æ‹¦æˆª
  private async checkAuthAndExecute(action: () => Promise<void>) {
    const account = this.authService.getCurrentAccount()
    if (account && account.trim() !== '') {
      action()
    } else {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•åæ“ä½œ' })
      router.pushUrl({ url: 'pages/LoginPage' })
    }
  }

  // âœ… ä¿®æ­£åçš„åŠ å…¥è´­ç‰©è½¦é€»è¾‘
  private async onAddToCart() {
    if (!this.product) return

    // æ ¡éªŒç™»å½•é€»è¾‘
    const account = this.authService.getCurrentAccount()
    if (!account) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' })
      router.pushUrl({ url: 'pages/LoginPage' })
      return
    }

    // 1. å¼‚æ­¥å†™å…¥æ•°æ®åº“
    const success = await this.cartService.addToCart(this.product, this.quantity)
    if (success) {
      // 2. æ ¸å¿ƒï¼šå†™å…¥åç«‹å³è§¦å‘ Service åˆ·æ–°å†…å­˜ï¼Œä¿è¯è´­ç‰©è½¦é¡µé¢èƒ½è¯»åˆ°
      await this.cartService.refreshCart()
      promptAction.showToast({ message: 'å·²æˆåŠŸåŠ å…¥è´­ç‰©è½¦' })
    }
  }

  // âœ… ç«‹å³è´­ä¹°é€»è¾‘
  private async onBuyNow() {
    if (!this.product) return
    const success = await this.cartService.addToCart(this.product, this.quantity)
    if (success) {
      // åªæœ‰è´­ä¹°æ‰ä¼šè§¦å‘è·³è½¬
      router.pushUrl({ url: 'pages/CartPage' })
    }
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆª (åŸå°ä¸åŠ¨)
        Row() {
          Button() { Row() { Text('â†').fontSize(18).fontColor('#333'); Text('è¿”å›').fontSize(16).fontColor('#333').margin({ left: 4 }) } }
          .backgroundColor(Color.Transparent).onClick(() => router.back())
          Blank().layoutWeight(1)
          Text(this.product?.name || 'å•†å“è¯¦æƒ…').fontSize(18).fontWeight(FontWeight.Bold).maxLines(1).width('40%')
          Blank().layoutWeight(1)
          Button() { Row() { Text('ğŸ›’').fontSize(20); Text('è´­ç‰©è½¦').fontSize(10).margin({ left: 4 }) } }
          .backgroundColor(Color.Transparent).onClick(() => router.pushUrl({ url: 'pages/CartPage' }))
        }
        .width('100%').height(56).padding({ left: 16, right: 16 }).backgroundColor(Color.White)

        Scroll() {
          Column() {
            if (this.product) {
              Image(this.product.image).width('100%').height(this.imageHeight).objectFit(ImageFit.Contain)
              Column() {
                Text(this.product.name).fontSize(18).fontWeight(FontWeight.Bold).width('100%').margin({ bottom: 12 })
                Row() {
                  Text(`Â¥${this.product.price}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#ff4444')
                }.width('100%').margin({ bottom: 12 })

                Text('å•†å“è¯¦æƒ…').fontSize(16).fontWeight(FontWeight.Bold).width('100%').margin({ top: 20, bottom: 12 })
                Text(this.product.detailDescription || 'æš‚æ— è¯¦ç»†æè¿°').fontSize(14).lineHeight(24).width('100%')

                CommentSection({ productId: this.product.id })
              }.padding(16).backgroundColor(Color.White).borderRadius(12).margin(12)
            }
          }
        }.layoutWeight(1)
      }

      // åº•éƒ¨æ“ä½œæ  (æ ·å¼å®Œå…¨ä¿ç•™ï¼Œé¢œè‰²æ·±åº¦åŠ å¼º)
      if (this.product) {
        Row() {
          Column() {
            Text('è´­ä¹°æ•°é‡').fontSize(10).fontColor('#999').margin({ bottom: 4 })
            Row() {
              // å‡å·ï¼šæ·±ç°è‰²èƒŒæ™¯ï¼Œé»‘è‰²æ–‡å­—
              Button('-').width(32).height(28).fontSize(18).fontWeight(FontWeight.Bold)
                .backgroundColor('#E8E8E8').fontColor(this.quantity > 1 ? '#333' : '#AAA')
                .onClick(() => this.onQuantityChange(-1))

              Text(`${this.quantity}`).fontSize(14).width(40).textAlign(TextAlign.Center).fontColor('#333')

              // åŠ å·ï¼šæ·±è‰²æ˜¾ç¤º
              Button('+').width(32).height(28).fontSize(18).fontWeight(FontWeight.Bold)
                .backgroundColor('#E8E8E8').fontColor('#333')
                .onClick(() => this.onQuantityChange(1))
            }
          }.width(110)

          Blank().layoutWeight(1)

          Button('åŠ å…¥è´­ç‰©è½¦').height(48).fontSize(14).backgroundColor('#ff9500').fontColor(Color.White).borderRadius(24).layoutWeight(1).margin({ right: 8 })
            .onClick(() => this.onAddToCart())

          Button('ç«‹å³è´­ä¹°').height(48).fontSize(14).backgroundColor('#cf0a2c').fontColor(Color.White).borderRadius(24).layoutWeight(1)
            .onClick(() => this.onBuyNow())
        }
        .width('100%').padding(16).backgroundColor(Color.White).position({ x: 0, y: '100%' }).translate({ y: -64 })
      }
    }.width('100%').height('100%').backgroundColor('#f5f5f5')
  }
}