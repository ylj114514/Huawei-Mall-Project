import router from '@ohos.router'
import { DatabaseManager } from '../database/DatabaseManager'
import { ProductModel, MockData } from '../model/ProductModel'
import common from '@ohos.app.ability.common'

interface Statistics {
  total: number
  totalValue: number
  lowStock: number
}

@Entry
@Component
struct AdminDashboard {
  @State products: ProductModel[] = []
  @State filteredProducts: ProductModel[] = []
  @State searchText: string = ''
  @State selectedCategory: string = 'ÂÖ®ÈÉ®'
  @State isLoading: boolean = true
  @State statistics: Statistics = { total: 0, totalValue: 0, lowStock: 0 }

  private categories: string[] = ['ÂÖ®ÈÉ®', 'ÊâãÊú∫', 'Âπ≥Êùø', 'ÁîµËÑë', 'ËÄ≥Êú∫', 'Êô∫ËÉΩÊâãË°®', 'ÂÖ∂‰ªñ']
  private dbManager: DatabaseManager = DatabaseManager.getInstance()

  aboutToAppear() {
    this.loadData()
  }

  // È°µÈù¢ÊòæÁ§∫Êó∂Âà∑Êñ∞Êï∞ÊçÆ
  onPageShow() {
    this.loadData()
  }

  private async loadData() {
    try {
      this.isLoading = true
      // ‚úÖ 1. Ëé∑Âèñ‰∏ä‰∏ãÊñáÂπ∂ÂàùÂßãÂåñ DB
      const context = getContext(this) as common.UIAbilityContext
      await this.dbManager.init(context)

      // ‚úÖ 2. Ëé∑ÂèñÊï∞ÊçÆ
      const rows = await this.dbManager.getAllProducts()
      const mockProducts = MockData.generateProducts() // Áî®‰∫éÊÅ¢Â§çÂõæÁâá

      // ‚úÖ 3. ËΩ¨Êç¢ÈÄªËæë (‰∏•Ê†ºÂåπÈÖç‰Ω†ÁöÑ ProductModel ÊûÑÈÄ†ÂáΩÊï∞)
      this.products = rows.map(row => {
        // Â∞ùËØïÊâæÂõû Resource ÂõæÁâá
        const match = mockProducts.find(m => m.id === row.id)
        const images = match ? match.images : [$r('app.media.APP')]

        // ÊûÑÈÄ†ÂáΩÊï∞ÂèÇÊï∞È°∫Â∫èÔºö
        // id, name, price, originalPrice, description, detailDescription, images, category, tags, rating, reviewCount, stock
        const p = new ProductModel(
          row.id,
          row.name,
          row.price,
          row.originalPrice,
          row.description,
          row.detailDescription,
          images, // ‚úÖ ‰º†ÂÖ• Resource[]
          row.category,
          row.tags,
          row.rating,
          row.reviewCount,
          row.stock
        )

        // Ë°•ÂÖ®ÂÖ∂‰ªñÂ≠óÊÆµ
        p.image = images.length > 0 ? images[0] : $r('app.media.APP')
        p.sales = row.sales
        p.isNew = row.isNew
        p.status = row.status
        return p
      })

      this.filteredProducts = this.products
      // ÈáçÊñ∞Â∫îÁî®ÂΩìÂâçÁöÑÊêúÁ¥¢/Á≠õÈÄâ
      this.filterProducts()
      this.calculateStatistics()
    } catch (error) {
      console.error('Âä†ËΩΩÂêéÂè∞Êï∞ÊçÆÂ§±Ë¥•:', error)
    } finally {
      this.isLoading = false
    }
  }

  private calculateStatistics() {
    this.statistics.total = this.products.length
    this.statistics.totalValue = this.products.reduce((sum, p) => sum + (p.price * p.stock), 0)
    this.statistics.lowStock = this.products.filter(p => p.stock < 10).length
  }

  private filterProducts() {
    let filtered = this.products

    if (this.selectedCategory !== 'ÂÖ®ÈÉ®') {
      filtered = filtered.filter(product => product.category === this.selectedCategory)
    }

    if (this.searchText.trim() !== '') {
      const query = this.searchText.toLowerCase()
      filtered = filtered.filter(product =>
      product.name.toLowerCase().includes(query) ||
      (product.description || '').toLowerCase().includes(query)
      )
    }

    this.filteredProducts = filtered
  }

  private onSearch(text: string) {
    this.searchText = text
    this.filterProducts()
  }

  private onCategorySelect(category: string) {
    this.selectedCategory = category
    this.filterProducts()
  }

  private onAddProduct() {
    router.pushUrl({
      url: 'pages/ProductEditPage'
    })
  }

  private onEditProduct(product: ProductModel) {
    router.pushUrl({
      url: 'pages/ProductEditPage',
      params: { product: product }
    })
  }

  private async onDeleteProduct(product: ProductModel) {
    try {
      AlertDialog.show({
        title: 'Á°ÆËÆ§Âà†Èô§',
        message: `Á°ÆÂÆöË¶ÅÂà†Èô§ÂïÜÂìÅ"${product.name}"ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
        primaryButton: {
          value: 'ÂèñÊ∂à',
          action: () => {}
        },
        secondaryButton: {
          value: 'Âà†Èô§',
          fontColor: '#ff4444',
          action: async () => {
            try {
              // ‚úÖ ‰øÆÊ≠£Ôºö‰ΩøÁî® setProductStatus ËΩØÂà†Èô§ÔºåÁõ¥Êé•‰º†Â≠óÁ¨¶‰∏≤IDÔºå‰∏çËΩ¨Êç¢ parseInt
              await this.dbManager.setProductStatus(product.id, 'deleted')
              console.info('ÂïÜÂìÅÂà†Èô§ÊàêÂäü')
              this.loadData()
            } catch (error) {
              console.error('Âà†Èô§Â§±Ë¥•:', error)
            }
          }
        }
      })
    } catch (error) {
      console.error('Âà†Èô§Êìç‰ΩúÂ§±Ë¥•:', error)
    }
  }

  // --- UI ÈÉ®ÂàÜ (ÂéüÂ∞Å‰∏çÂä®) ---

  @Builder
  StatisticsCard() {
    Column() {
      Text('Êï∞ÊçÆÊ¶ÇËßà')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1a1a1a')
        .width('100%')
        .margin({ bottom: 20 })

      Row() {
        Column() {
          Text(`${this.statistics.total}`)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#007aff')
          Text('ÂïÜÂìÅÊÄªÊï∞')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 4 })
        }
        .layoutWeight(1)

        Column() {
          Text(`¬•${this.statistics.totalValue.toFixed(0)}`)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#34c759')
          Text('Â∫ìÂ≠òÊÄªÂÄº')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 4 })
        }
        .layoutWeight(1)

        Column() {
          Text(`${this.statistics.lowStock}`)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#ff9500')
          Text('‰ΩéÂ∫ìÂ≠ò')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(20)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  SearchBar() {
    Row() {
      Row() {
        Text('üîç')
          .fontSize(18)
          .fontColor('#666666')
          .margin({ left: 16 })
        TextInput({
          placeholder: 'ÊêúÁ¥¢ÂïÜÂìÅÂêçÁß∞',
          text: this.searchText
        })
          .fontSize(16)
          .fontColor('#1a1a1a')
          .backgroundColor(Color.Transparent)
          .layoutWeight(1)
          .placeholderColor('#666666')
          .onChange((value: string) => {
            this.onSearch(value)
          })
      }
      .width('60%')
      .height(48)
      .backgroundColor('#f5f5f7')
      .borderRadius(24)
      .padding({ right: 16 })

      Button('Êñ∞Â¢ûÂïÜÂìÅ')
        .fontSize(16)
        .fontColor(Color.White)
        .backgroundColor('#007aff')
        .borderRadius(24)
        .padding({ left: 24, right: 24 })
        .onClick(() => this.onAddProduct())
    }
    .width('100%')
    .padding(20)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  CategoryFilter() {
    Scroll() {
      Row({ space: 12 }) {
        ForEach(this.categories, (category: string) => {
          Button(category)
            .fontSize(14)
            .fontColor(this.selectedCategory === category ? Color.White : '#1a1a1a')
            .backgroundColor(this.selectedCategory === category ? '#007aff' : '#f0f0f0')
            .borderRadius(20)
            .padding({ left: 24, right: 24, top: 12, bottom: 12 })
            .onClick(() => this.onCategorySelect(category))
        })
      }
      .width('100%')
      .padding({ left: 20, right: 20 })
    }
    .width('100%')
    .scrollBar(BarState.Off)
    .scrollable(ScrollDirection.Horizontal)
    .height(50)
    .margin({ bottom: 20 })
  }

  @Builder
  ProductListItem(product: ProductModel) {
    Row() {
      // ÂïÜÂìÅÂõæÁâá
      Image(product.image)
        .width(80)
        .height(80)
        .objectFit(ImageFit.Cover)
        .borderRadius(12)
        .backgroundColor('#f0f0f0')

      Column() {
        Text(product.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1a1a1a')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')

        Text(product.category)
          .fontSize(12)
          .fontColor('#666666')
          .margin({ top: 4 })

        Row() {
          Text(`¬•${product.price}`)
            .fontSize(16)
            .fontColor('#ff4444')
            .fontWeight(FontWeight.Bold)

          Text(`Â∫ìÂ≠ò: ${product.stock || 100}`)
            .fontSize(12)
            .fontColor((product.stock || 100) < 10 ? '#ff9500' : '#666666')
            .margin({ left: 12 })
        }
        .width('100%')
        .margin({ top: 8 })
      }
      .layoutWeight(1)
      .margin({ left: 12 })
      .alignItems(HorizontalAlign.Start)

      // Êìç‰ΩúÊåâÈíÆ
      Column() {
        Button('ÁºñËæë')
          .fontSize(12)
          .fontColor('#007aff')
          .backgroundColor('#007aff20')
          .borderRadius(16)
          .padding({ left: 16, right: 16 })
          .margin({ bottom: 8 })
          .onClick(() => this.onEditProduct(product))

        Button('Âà†Èô§')
          .fontSize(12)
          .fontColor('#ff4444')
          .backgroundColor('#ff444420')
          .borderRadius(16)
          .padding({ left: 16, right: 16 })
          .onClick(() => this.onDeleteProduct(product))
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({
      radius: 4,
      color: '#00000008',
      offsetX: 0,
      offsetY: 2
    })
    .margin({ bottom: 12 })
  }

  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™Ê†è
      Row() {
        Text('ÁÆ°ÁêÜÂëòÂêéÂè∞')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1a1a1a')

        Blank()

        Button('ËøîÂõûÂïÜÂüé')
          .fontSize(14)
          .fontColor('#007aff')
          .backgroundColor(Color.Transparent)
          .onClick(() => router.back())
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20 })

      // ‰∏ªÂÜÖÂÆπ
      Scroll() {
        Column() {
          // ÁªüËÆ°Âç°Áâá
          Column() {
            this.StatisticsCard()
          }
          .margin({ top: 12 })

          // ÊêúÁ¥¢Ê†è
          this.SearchBar()

          // ÂàÜÁ±ªÁ≠õÈÄâ
          this.CategoryFilter()

          // ÂïÜÂìÅÂàóË°®Ê†áÈ¢ò
          Row() {
            Text(`ÂïÜÂìÅÂàóË°® (${this.filteredProducts.length})`)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1a1a1a')
            Blank()
          }
          .width('100%')
          .padding({ left: 20, right: 20 })
          .margin({ bottom: 12 })

          // ÂïÜÂìÅÂàóË°®
          if (this.filteredProducts.length > 0) {
            Column() {
              ForEach(this.filteredProducts, (product: ProductModel) => {
                this.ProductListItem(product)
              })
            }
            .width('100%')
            .padding({ left: 20, right: 20 })
          } else if (!this.isLoading) {
            Column() {
              Text('üì¶')
                .fontSize(60)
                .margin({ bottom: 16 })
              Text('ÊöÇÊó†ÂïÜÂìÅ')
                .fontSize(16)
                .fontColor('#666666')
            }
            .width('100%')
            .height(200)
            .justifyContent(FlexAlign.Center)
          }

          // Â∫ïÈÉ®Èó¥Ë∑ù
          Column()
            .width('100%')
            .height(100)
        }
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#f5f5f7')

      // Âä†ËΩΩÁä∂ÊÄÅ
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('Âä†ËΩΩ‰∏≠...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#f5f5f7')
        .position({ x: 0, y: 0 })
        .zIndex(1000)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f7')
  }
}