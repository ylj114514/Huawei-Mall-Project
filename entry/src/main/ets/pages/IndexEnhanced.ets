import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { SearchBarEnhanced } from '../components/SearchBarEnhanced'
import { ProductCardEnhanced } from '../components/ProductCardEnhanced'
import { BottomNavBar } from '../components/BottomNavBar'
import { AppService } from '../services/AppService'
import { CartService } from '../services/CartService'

interface BannerItem {
  title: string
  subtitle: string
  color: string
}

@Entry
@Component
struct IndexEnhanced {
  @State products: ProductModel[] = []
  @State filteredProducts: ProductModel[] = []
  @State searchText: string = ''
  @State selectedCategory: string = 'å…¨éƒ¨'
  @State isLoading: boolean = true
  @State isSearching: boolean = false
  @State categories: string[] = ['å…¨éƒ¨', 'æ‰‹æœº', 'å¹³æ¿', 'ç”µè„‘', 'è€³æœº', 'æ™ºèƒ½æ‰‹è¡¨', 'é…ä»¶']
  @State showScrollTop: boolean = false
  private appService: AppService = AppService.getInstance()
  private cartService: CartService = CartService.getInstance()
  private scrollScroller: Scroller = new Scroller()

  aboutToAppear() {
    this.initApp()
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨
   */
  private async initApp(): Promise<void> {
    try {
      // åˆå§‹åŒ–AppServiceï¼ˆåŒ…å«æ•°æ®åº“åˆå§‹åŒ–ï¼‰
      await this.appService.init(getContext(this))
      console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ')

      // åŠ è½½é¡µé¢æ•°æ®
      this.loadData()
    } catch (error) {
      console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error)
      // å³ä½¿åˆå§‹åŒ–å¤±è´¥ï¼Œä¹ŸåŠ è½½åŸºæœ¬æ•°æ®
      this.loadData()
    }
  }

  private loadData() {
    // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
    setTimeout(() => {
      this.products = MockData.generateProducts()
      this.filteredProducts = this.products
      this.isLoading = false
    }, 800)
  }

  /**
   * æœç´¢å¤„ç†
   */
  private onSearch(text: string) {
    this.searchText = text
    this.isSearching = text.trim() !== ''
    this.filterProducts()
  }

  /**
   * ç­›é€‰å•†å“
   */
  private filterProducts() {
    let filtered = this.products

    // æŒ‰åˆ†ç±»ç­›é€‰
    if (this.selectedCategory !== 'å…¨éƒ¨') {
      filtered = filtered.filter(product => {
        if (product.category === this.selectedCategory) {
          return true
        }
        // åŒ¹é…åˆ†ç±»åˆ«å
        if (this.selectedCategory === 'æ‰‹æœº' && product.category === 'æ™ºèƒ½æ‰‹æœº') {
          return true
        }
        if (this.selectedCategory === 'æ™ºèƒ½æ‰‹è¡¨' && product.category === 'æ™ºèƒ½ç©¿æˆ´') {
          return true
        }
        if (this.selectedCategory === 'å¹³æ¿' && product.category === 'å¹³æ¿ç”µè„‘') {
          return true
        }
        if (this.selectedCategory === 'ç”µè„‘' && (product.category === 'ç¬”è®°æœ¬' || product.category === 'å°å¼æœº')) {
          return true
        }
        if (this.selectedCategory === 'è€³æœº' && (product.category === 'éŸ³é¢‘' || product.name.includes('è€³æœº') || product.name.includes('FreeBuds'))) {
          return true
        }
        return false
      })
    }

    // æŒ‰æœç´¢å…³é”®è¯ç­›é€‰
    if (this.searchText.trim() !== '') {
      const query = this.searchText.toLowerCase()
      filtered = filtered.filter(product =>
        product.name.toLowerCase().includes(query) ||
        product.description.toLowerCase().includes(query) ||
        product.tags.some(tag => tag.toLowerCase().includes(query))
      )
    }

    this.filteredProducts = filtered
  }

  /**
   * é€‰æ‹©åˆ†ç±»
   */
  private onCategorySelect(category: string) {
    this.selectedCategory = category
    this.filterProducts()
    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    this.scrollScroller.scrollTo({ xOffset: 0, yOffset: 0 })
  }

  /**
   * ç‚¹å‡»å•†å“
   */
  private onProductClick(product: ProductModel) {
    router.pushUrl({
      url: 'pages/ProductDetailPageEnhanced',
      params: {
        productId: product.id
      }
    })
  }

  /**
   * å¿«é€ŸåŠ è´­
   */
  private async onQuickAddToCart(product: ProductModel) {
    try {
      if (this.cartService.isProductInCart(product.id)) {
        console.log('å•†å“å·²åœ¨è´­ç‰©è½¦ä¸­')
      } else {
        const success = await this.cartService.addToCart(product, 1)
        if (success) {
          console.log('å¿«é€ŸåŠ è´­æˆåŠŸ')
        }
      }
    } catch (error) {
      console.error('å¿«é€ŸåŠ è´­å¤±è´¥:', error)
    }
  }

  /**
   * æ»šåŠ¨åˆ°é¡¶éƒ¨
   */
  private scrollToTop() {
    this.scrollScroller.scrollTo({ xOffset: 0, yOffset: 0 })
  }

  /**
   * ç›‘å¬æ»šåŠ¨äº‹ä»¶
   */
  private onScroll(xOffset: number, yOffset: number) {
    this.showScrollTop = yOffset > 500
  }

  @Builder
  HeaderBanner() {
    Swiper() {
      ForEach([
        { title: 'æ–°å“é¦–å‘', subtitle: 'åä¸ºMate 60 Pro', color: '#3B82F6' } as BannerItem,
        { title: 'é™æ—¶ä¼˜æƒ ', subtitle: 'å…¨åœº8.8æŠ˜èµ·', color: '#F97316' } as BannerItem,
        { title: 'å“è´¨ç”Ÿæ´»', subtitle: 'æ™ºèƒ½å®¶å±…ä¸“åœº', color: '#10B981' } as BannerItem
      ], (banner: BannerItem) => {
        Column() {
          Text(banner.title)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .margin({ bottom: 8 })

          Text(banner.subtitle)
            .fontSize(16)
            .fontColor(Color.White)
            .opacity(0.9)
        }
        .width('100%')
        .height(120)
        .backgroundColor(banner.color)
        .borderRadius(12)
        .justifyContent(FlexAlign.Center)
      })
    }
    .width('100%')
    .height(120)
    .loop(true)
    .autoPlay(true)
    .interval(3000)
    .indicator(true)
    .indicatorStyle({
      size: 6,
      color: 'rgba(255,255,255,0.4)',
      selectedColor: 'rgba(255,255,255,0.9)'
    })
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨åŒºåŸŸ
        Column() {
          // æœç´¢æ 
          SearchBarEnhanced({
            onSearch: this.onSearch.bind(this),
            onTextChange: (value: string) => {
              this.searchText = value
            }
          })

          // è½®æ’­æ¨ªå¹…
          this.HeaderBanner()
        }
        .backgroundColor($r('app.color.white'))
        .padding({ top: 12, bottom: 12 })

        // åˆ†ç±»æ ‡ç­¾
        Column() {
          Scroll() {
            Row({ space: 12 }) {
              ForEach(this.categories, (category: string) => {
                Button(category)
                  .fontSize(14)
                  .fontColor(this.selectedCategory === category ? Color.White : $r('app.color.text_primary'))
                  .backgroundColor(this.selectedCategory === category ? $r('app.color.primary') : $r('app.color.background_gray'))
                  .borderRadius(18)
                  .padding({ left: 20, right: 20, top: 10, bottom: 10 })
                  .onClick(() => this.onCategorySelect(category))
                  .shadow(this.selectedCategory === category ? {
                    radius: 6,
                    color: $r('app.color.shadow_light'),
                    offsetX: 0,
                    offsetY: 2
                  } : undefined)
                  .animation({
                    duration: 200,
                    curve: Curve.EaseInOut
                  })
              })
            }
            .width('100%')
            .padding({ left: 16, right: 16 })
          }
          .width('100%')
          .height(50)
          .scrollBar(BarState.Off)
          .scrollable(ScrollDirection.Horizontal)
          .edgeEffect(EdgeEffect.Spring)
        }
        .backgroundColor($r('app.color.white'))
        .padding({ top: 8, bottom: 8 })

        // æœç´¢çŠ¶æ€æç¤º
        if (this.isSearching && this.searchText.trim() !== '') {
          Row() {
            Text(`æœç´¢"${this.searchText}"`)
              .fontSize(14)
              .fontColor($r('app.color.text_primary'))
              .fontWeight(FontWeight.Medium)
            Text(` å…±æ‰¾åˆ°${this.filteredProducts.length}ä¸ªå•†å“`)
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ left: 8 })
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor($r('app.color.white'))
          .borderRadius(8)
          .margin({ left: 16, right: 16, top: 8 })
        }

        // å•†å“ç½‘æ ¼åˆ—è¡¨
        if (this.filteredProducts.length > 0) {
          Grid() {
            ForEach(this.filteredProducts, (product: ProductModel) => {
              GridItem() {
                ProductCardEnhanced({
                  product: product,
                  onProductClick: this.onProductClick.bind(this),
                  onQuickAddToCart: this.onQuickAddToCart.bind(this)
                })
              }
              .animation({
                duration: 300,
                delay: 100,
                curve: Curve.EaseInOut
              })
            }, (product: ProductModel) => product.id)
          }
          .columnsTemplate('1fr 1fr')
          .rowsGap(12)
          .columnsGap(12)
          .padding(16)
          .width('100%')
          .layoutWeight(1)
          .scrollBar(BarState.Off)
          .edgeEffect(EdgeEffect.Spring)
          .onScroll((xOffset: number, yOffset: number) => {
            this.onScroll(xOffset, yOffset)
          })
        } else if (!this.isLoading) {
          // ç©ºçŠ¶æ€
          Column() {
            Text('ğŸ“¦')
              .fontSize(80)
              .fontColor($r('app.color.text_tertiary'))
              .margin({ bottom: 16 })

            Text(this.searchText.trim() !== '' ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“' : 'æš‚æ— å•†å“')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 8 })

            Text(this.searchText.trim() !== '' ? 'è¯•è¯•è°ƒæ•´æœç´¢å…³é”®è¯æˆ–ç­›é€‰æ¡ä»¶' : 'å•†å“æ­£åœ¨è·¯ä¸Šï¼Œæ•¬è¯·æœŸå¾…')
              .fontSize(14)
              .fontColor($r('app.color.text_tertiary'))
              .margin({ bottom: 24 })

            if (this.searchText.trim() !== '') {
              Button('æ¸…é™¤æœç´¢æ¡ä»¶')
                .height(40)
                .fontSize(14)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .borderRadius(20)
                .padding({ left: 24, right: 24 })
                .onClick(() => {
                  this.searchText = ''
                  this.selectedCategory = 'å…¨éƒ¨'
                  this.filterProducts()
                })
            }
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .margin({ left: 16, right: 16, top: 16 })
        } else {
          // åŠ è½½çŠ¶æ€ - éª¨æ¶å±
          Column() {
            Grid() {
              ForEach(Array(6), (_: null, index: number) => {
                GridItem() {
                  Column() {
                    Column()
                      .width('100%')
                      .height(200)
                      .backgroundColor($r('app.color.background_gray'))
                      .borderRadius({ topLeft: 16, topRight: 16 })
                      .shimmer(true)

                    Column() {
                      Column()
                        .width('80%')
                        .height(16)
                        .backgroundColor($r('app.color.background_gray'))
                        .borderRadius(4)
                        .margin({ bottom: 8 })
                        .shimmer(true)

                      Column()
                        .width('60%')
                        .height(12)
                        .backgroundColor($r('app.color.background_gray'))
                        .borderRadius(4)
                        .shimmer(true)
                    }
                    .width('100%')
                    .padding(16)
                    .layoutWeight(1)
                  }
                  .width('100%')
                  .height(340)
                  .backgroundColor($r('app.color.white'))
                  .borderRadius(16)
                }
              })
            }
            .columnsTemplate('1fr 1fr')
            .rowsGap(12)
            .columnsGap(12)
            .padding(16)
            .width('100%')
          }
          .width('100%')
          .layoutWeight(1)
          .backgroundColor($r('app.color.background'))
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.background'))

      // åº•éƒ¨å¯¼èˆªæ 
      BottomNavBar()
        .position({ x: 0, y: '100%' })
        .translate({ x: 0, y: -60 })

      // å›åˆ°é¡¶éƒ¨æŒ‰é’®
      if (this.showScrollTop) {
        Button() {
          Text('â†‘')
            .fontSize(20)
            .fontColor(Color.White)
        }
        .width(48)
        .height(48)
        .backgroundColor($r('app.color.primary'))
        .borderRadius(24)
        .position({ x: '92%', y: '85%' })
        .shadow({
          radius: 8,
          color: $r('app.color.shadow_medium'),
          offsetX: 0,
          offsetY: 4
        })
        .onClick(() => this.scrollToTop())
        .animation({
          duration: 300,
          curve: Curve.EaseInOut
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}

// æ‰©å±•Columnç»„ä»¶ä»¥æ”¯æŒshimmeræ•ˆæœ
@Extend(Column)
function shimmer(value: boolean) {
  .animation({
    duration: 1500,
    curve: Curve.EaseInOut,
    iterations: -1,
    playMode: PlayMode.Alternate,
    onFinish: () => {
    }
  })
  .backgroundColor(value ? $r('app.color.background_gray') : $r('app.color.white'))
}