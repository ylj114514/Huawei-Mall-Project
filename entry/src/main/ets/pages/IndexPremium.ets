import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { StorageManager } from '../utils/StorageManager'
import { User } from '../model/DataModel'

// å¸¸é‡å®šä¹‰
const BACKGROUND_COLOR = '#F1F3F5'
const CARD_BACKGROUND = '#FFFFFF'
const TEXT_PRIMARY = '#000000'
const TEXT_SECONDARY = '#666666'
const TEXT_TERTIARY = '#999999'
const HUAWEI_RED = '#FF0000'
const BORDER_COLOR = '#E5E5E5'
const SHADOW_COLOR = 'rgba(0,0,0,0.05)'
const SEARCH_BAR_HEIGHT = 56

@Entry
@Component
struct IndexPremium {
  @State products: ProductModel[] = []
  @State filteredProducts: ProductModel[] = []
  @State searchText: string = ''
  @State selectedCategory: string = 'å…¨éƒ¨'
  @State isLoading: boolean = true
  @State scrollOffset: number = 0
  @State searchOpacity: number = 0
  @State user: User | null = null
  @State cartCount: number = 0

  private categories: string[] = ['å…¨éƒ¨', 'æ‰‹æœº', 'å¹³æ¿', 'ç¬”è®°æœ¬', 'æ‰‹è¡¨', 'è€³æœº']
  private scroller: Scroller = new Scroller()
  private storage: StorageManager = StorageManager.getInstance()

  aboutToAppear() {
    this.loadData()
    this.checkLoginStatus()
  }

  private async loadData() {
    setTimeout(() => {
      this.products = MockData.generateProducts()
      this.filteredProducts = this.products
      this.isLoading = false
    }, 800)
  }

  private async checkLoginStatus() {
    try {
      this.user = await this.storage.loadUser()
    } catch (error) {
      console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error)
    }
  }

  private onScroll(offset: number) {
    this.scrollOffset = offset
    // æœç´¢æ é€æ˜åº¦æ’å€¼ï¼š0-100pxé€æ˜ï¼Œ100pxä»¥ä¸Šä¸é€æ˜
    this.searchOpacity = Math.max(0, Math.min(1, (100 - offset) / 100))
  }

  private onSearch(value: string) {
    this.searchText = value
    this.filterProducts()
  }

  private filterProducts() {
    let filtered = this.products

    // æŒ‰åˆ†ç±»ç­›é€‰
    if (this.selectedCategory !== 'å…¨éƒ¨') {
      filtered = filtered.filter(product =>
        product.category === this.selectedCategory
      )
    }

    // æŒ‰æœç´¢å…³é”®è¯ç­›é€‰
    if (this.searchText.trim()) {
      const query = this.searchText.toLowerCase()
      filtered = filtered.filter(product =>
        product.name.toLowerCase().includes(query) ||
        product.description.toLowerCase().includes(query)
      )
    }

    this.filteredProducts = filtered
  }

  private onCategorySelect(category: string) {
    this.selectedCategory = category
    this.filterProducts()
  }

  private onProductClick(product: ProductModel) {
    router.pushUrl({
      url: 'pages/ProductDetailComplete',
      params: {
        productId: product.id
      }
    })
  }

  private onSearchClick() {
    if (this.searchText) {
      this.filterProducts()
    }
  }

  @Builder
  SearchBar() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ å ä½
      Row().width('100%').height(44)

      // æœç´¢æ å®¹å™¨
      Row() {
        Row() {
          Text('ğŸ”')
            .fontSize(20)
            .fontColor(TEXT_TERTIARY)
            .margin({ left: 20 })

          TextInput({
            placeholder: 'æœç´¢äº§å“ã€å‹å·ã€åŠŸèƒ½',
            text: this.searchText
          })
            .fontSize(16)
            .fontColor(TEXT_PRIMARY)
            .backgroundColor(Color.Transparent)
            .layoutWeight(1)
            .placeholderColor(TEXT_TERTIARY)
            .onChange((value: string) => {
              this.onSearch(value)
            })
            .onSubmit(() => {
              this.onSearchClick()
            })

          if (this.searchText) {
            Button() {
              Text('âœ•')
                .fontSize(16)
                .fontColor(TEXT_TERTIARY)
            }
            .width(40)
            .height(40)
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              this.searchText = ''
              this.onSearch('')
            })
          }
        }
        .width('100%')
        .height(48)
        .backgroundColor('#FAFAFA')
        .borderRadius(24)
        .border({
          width: 1,
          color: BORDER_COLOR
        })
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 16 })
    }
    .width('100%')
    .backgroundColor(`rgba(241, 243, 245, ${this.searchOpacity})`)
    .backdropBlur(this.searchOpacity > 0.5 ? 10 : 0)
    .border({
      width: { bottom: this.searchOpacity > 0 ? 0.5 : 0 },
      color: BORDER_COLOR
    })
    .zIndex(1000)
    .position({ x: 0, y: 0 })
    .transition({ type: TransitionType.All })
  }

  @Builder
  HeroBanner() {
    Swiper() {
      ForEach([
        { title: 'åä¸º Mate 60 Pro', desc: 'å›å½’å·…å³°', image: 'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/mkt/imgs/2024/01/mate-60-pro-list-kv.png' },
        { title: 'é¸¿è’™ç”Ÿæ€', desc: 'ä¸‡ç‰©äº’è”', image: 'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/mkt/imgs/2023/08/harmonyos-pc-kv.png' },
        { title: 'æ™ºæ…§å±', desc: 'å¤§å±ç²¾å½©', image: 'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/mkt/imgs/2024/01/v85-kv.png' }
      ], (banner: Record<string, string>, index: number) => {
        Stack() {
          Image(banner.image)
            .width('100%')
            .height(200)
            .objectFit(ImageFit.Cover)
            .borderRadius(20)

          Column() {
            Text(banner.title)
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .margin({ bottom: 8 })

            Text(banner.desc)
              .fontSize(16)
              .fontColor('rgba(255,255,255,0.9)')
          }
          .width('100%')
          .padding(24)
          .position({ x: 0, y: 0 })
        }
      })
    }
    .width('100%')
    .height(200)
    .autoPlay(true)
    .interval(3000)
    .indicatorStyle({
      size: 8,
      color: 'rgba(255,255,255,0.5)',
      selectedColor: Color.White
    })
    .margin({ left: 20, right: 20 })
  }

  @Builder
  CategorySection() {
    Column() {
      Row() {
        Text('äº§å“åˆ†ç±»')
          .fontSize(20)
          .fontWeight(FontWeight.Medium)
          .fontColor(TEXT_PRIMARY)

        Blank()
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 20 })

      Row() {
        ForEach(this.categories, (category: string) => {
          Button(category)
            .fontSize(14)
            .fontColor(this.selectedCategory === category ? Color.White : TEXT_PRIMARY)
            .backgroundColor(this.selectedCategory === category ? HUAWEI_RED : CARD_BACKGROUND)
            .borderRadius(20)
            .padding({ left: 24, right: 24, top: 12, bottom: 12 })
            .height(44)
            .border({
              width: 1,
              color: this.selectedCategory === category ? HUAWEI_RED : BORDER_COLOR
            })
            .onClick(() => {
              this.onCategorySelect(category)
            })
        })
      }
      .width('100%')
      .padding({ left: 20, right: 20 })
      .justifyContent(FlexAlign.SpaceEvenly)
    }
    .width('100%')
    .backgroundColor(CARD_BACKGROUND)
    .borderRadius(20)
    .margin({ left: 20, right: 20, bottom: 24 })
  }

  @Builder
  ProductGrid() {
    Column() {
      if (this.filteredProducts.length > 0) {
        Grid() {
          ForEach(this.filteredProducts, (product: ProductModel) => {
            GridItem() {
              this.ProductCard(product)
            }
          })
        }
        .columnsTemplate('1fr 1fr')
        .rowsGap(20)
        .columnsGap(20)
        .padding({ left: 20, right: 20, bottom: 140 })
      } else if (!this.isLoading) {
        // ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ“¦')
            .fontSize(64)
            .fontColor(TEXT_TERTIARY)
            .margin({ bottom: 16 })

          Text('æš‚æ— ç›¸å…³å•†å“')
            .fontSize(16)
            .fontColor(TEXT_SECONDARY)
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
  }

  @Builder
  ProductCard(product: ProductModel) {
    Column() {
      // å›¾ç‰‡å®¹å™¨
      Stack() {
        Image(product.image)
          .width('100%')
          .height(200)
          .objectFit(ImageFit.Cover)
          .backgroundColor('#F5F5F5')
          .borderRadius({ topLeft: 20, topRight: 20 })

        // æŠ˜æ‰£æ ‡ç­¾
        if (product.originalPrice && product.originalPrice > product.price) {
          Text(`${Math.floor(((product.originalPrice - product.price) / product.originalPrice) * 100)}%`)
            .fontSize(12)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .backgroundColor(HUAWEI_RED)
            .padding({ left: 10, right: 10, top: 5, bottom: 5 })
            .borderRadius({ bottomLeft: 12, topRight: 20 })
            .position({ x: 0, y: 0 })
        }
      }

      // å•†å“ä¿¡æ¯
      Column() {
        Text(product.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(TEXT_PRIMARY)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .margin({ top: 16, bottom: 8 })

        // æ ‡ç­¾
        if (product.tags && product.tags.length > 0) {
          Text(product.tags[0])
            .fontSize(12)
            .fontColor(TEXT_TERTIARY)
            .backgroundColor('#F5F5F5')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(4)
            .width('100%')
            .margin({ bottom: 12 })
        }

        // ä»·æ ¼
        Row() {
          Row() {
            Text('Â¥')
              .fontSize(12)
              .fontColor(HUAWEI_RED)
              .margin({ top: 2 })
            Text(`${product.price}`)
              .fontSize(20)
              .fontColor(HUAWEI_RED)
              .fontWeight(FontWeight.Bold)
          }
          .alignItems(VerticalAlign.Bottom)

          Blank()

          // é”€é‡æç¤º
          Text(`æœˆé”€ ${Math.floor(Math.random() * 1000 + 100)}`)
            .fontSize(12)
            .fontColor(TEXT_TERTIARY)
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('100%')
      .padding(16)
    }
    .width('100%')
    .backgroundColor(CARD_BACKGROUND)
    .borderRadius(20)
    .shadow({
      radius: 8,
      color: SHADOW_COLOR,
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.onProductClick(product)
    })
  }

  @Builder
  BottomNav() {
    Row() {
      // é¦–é¡µ
      Column() {
        Text('ğŸ ')
          .fontSize(24)
          .margin({ bottom: 4 })
        Text('é¦–é¡µ')
          .fontSize(12)
          .fontColor(HUAWEI_RED)
      }
      .width('50%')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        // å½“å‰é¡µé¢ï¼Œæ— éœ€æ“ä½œ
      })

      // ä¸ªäººä¸­å¿ƒ
      Column() {
        Text(this.user ? 'ğŸ‘¤' : 'ğŸ‘¤')
          .fontSize(24)
          .margin({ bottom: 4 })
        Text(this.user ? 'æˆ‘çš„' : 'ç™»å½•')
          .fontSize(12)
          .fontColor(TEXT_SECONDARY)
      }
      .width('50%')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        if (!this.user) {
          router.pushUrl({ url: 'pages/LoginPage' })
        } else {
          router.pushUrl({ url: 'pages/UserCenterPage' })
        }
      })
    }
    .width('100%')
    .height(60)
    .backgroundColor(CARD_BACKGROUND)
    .border({
      width: { top: 0.5 },
      color: BORDER_COLOR
    })
    .position({ x: 0, y: '100%' })
    .translate({ x: 0, y: -60 })
  }

  build() {
    Stack() {
      // ä¸»å†…å®¹æ»šåŠ¨åŒºåŸŸ
      Scroll(this.scroller) {
        Column() {
          // é¡¶éƒ¨å ä½ï¼ˆä¸ºæœç´¢æ ç•™ç©ºé—´ï¼‰
          Row().width('100%').height(SEARCH_BAR_HEIGHT + 44)

          // Hero Banner
          this.HeroBanner()

          // åˆ†ç±»å¯¼èˆª
          this.CategorySection()

          // å•†å“æ ‡é¢˜
          Row() {
            Text(`çƒ­é—¨å•†å“ (${this.filteredProducts.length})`)
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .fontColor(TEXT_PRIMARY)
            Blank()
          }
          .width('100%')
          .padding({ left: 20, right: 20, bottom: 16 })

          // å•†å“ç½‘æ ¼
          this.ProductGrid()
        }
        .width('100%')
      }
      .width('100%')
      .height('100%')
      .backgroundColor(BACKGROUND_COLOR)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
      .onScroll((xOffset: number, yOffset: number) => {
        this.onScroll(yOffset)
      })

      // æœç´¢æ ï¼ˆå›ºå®šåœ¨é¡¶éƒ¨ï¼‰
      this.SearchBar()

      // åº•éƒ¨å¯¼èˆª
      this.BottomNav()

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color(HUAWEI_RED)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor(TEXT_SECONDARY)
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor(BACKGROUND_COLOR)
        .zIndex(1001)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(BACKGROUND_COLOR)
  }
}