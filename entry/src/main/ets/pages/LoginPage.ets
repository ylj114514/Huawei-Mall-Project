import router from '@ohos.router'
import { User } from '../model/DataModel'
import { StorageManager } from '../utils/StorageManager'
import common from '@ohos.app.ability.common'

@Entry
@Component
struct LoginPage {
  @State account: string = ''
  @State password: string = ''
  @State confirmPassword: string = ''
  @State isLoginMode: boolean = true
  @State isLoading: boolean = false
  @State showUnregisteredDialog: boolean = false
  @State showOtherLoginMethods: boolean = false
  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
      console.log('StorageManageråˆå§‹åŒ–æˆåŠŸ')
    } catch (error) {
      console.error('StorageManageråˆå§‹åŒ–å¤±è´¥:', error)
    }
  }

  // éªŒè¯è´¦å·æ ¼å¼
  private validateAccount(account: string): boolean {
    return account.length >= 3 && /^[a-zA-Z0-9_]+$/.test(account)
  }

  // éªŒè¯å¯†ç æ ¼å¼
  private validatePassword(password: string): boolean {
    return password.length >= 6
  }

  // ç™»å½•
  private async login(): Promise<void> {
    if (!this.validateAccount(this.account)) {
      console.error('è¯·è¾“å…¥æ­£ç¡®çš„è´¦å·æ ¼å¼ï¼ˆè‡³å°‘3ä½ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰')
      return
    }

    if (!this.validatePassword(this.password)) {
      console.error('å¯†ç è‡³å°‘6ä½')
      return
    }

    this.isLoading = true

    try {
      // ä»å­˜å‚¨ä¸­æŸ¥æ‰¾ç”¨æˆ·
      const existingUser = await this.loadUserByAccount(this.account)

      if (existingUser && existingUser.password === this.password) {
        // ç™»å½•æˆåŠŸ
        await this.storage.saveUser(existingUser)
        console.log('ç™»å½•æˆåŠŸ:', existingUser.username)
        router.replaceUrl({ url: 'pages/IndexLuxury' })
      } else if (existingUser) {
        console.error('å¯†ç é”™è¯¯')
      } else {
        // å¼¹å‡ºæœªæ³¨å†Œæç¤º
        this.showUnregisteredDialogMsg()
      }
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  // æ³¨å†Œ
  private async register(): Promise<void> {
    console.log('å¼€å§‹æ³¨å†Œï¼Œè´¦å·:', this.account)

    if (!this.validateAccount(this.account)) {
      console.error('è¯·è¾“å…¥æ­£ç¡®çš„è´¦å·æ ¼å¼ï¼ˆè‡³å°‘3ä½ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰')
      return
    }

    if (!this.validatePassword(this.password)) {
      console.error('å¯†ç è‡³å°‘6ä½')
      return
    }

    if (this.password !== this.confirmPassword) {
      console.error('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´')
      return
    }


    this.isLoading = true

    try {
      // æ£€æŸ¥è´¦å·æ˜¯å¦å·²æ³¨å†Œ
      console.log('æ£€æŸ¥è´¦å·æ˜¯å¦å·²å­˜åœ¨...')
      const existingUser = await this.loadUserByAccount(this.account)

      if (existingUser) {
        console.error('è¯¥è´¦å·å·²æ³¨å†Œ')
      } else {
        // åˆ›å»ºæ–°ç”¨æˆ·
        console.log('åˆ›å»ºæ–°ç”¨æˆ·...')
        const newUser = new User(this.account, this.password)
        // è®¾ç½®é»˜è®¤ç”¨æˆ·å
        newUser.username = this.account
        await this.storage.saveUser(newUser)
        console.log('æ³¨å†ŒæˆåŠŸ:', newUser.username)
        router.replaceUrl({ url: 'pages/IndexSimple' })
      }
    } catch (error) {
      console.error('æ³¨å†Œå¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  // æ ¹æ®è´¦å·åŠ è½½ç”¨æˆ·ï¼ˆä»æœ¬åœ°æ•°æ®åº“æŸ¥è¯¢ï¼‰
  private async loadUserByAccount(account: string): Promise<User | null> {
    try {
      // ä½¿ç”¨StorageManagerçš„æ–°æ–¹æ³•æŸ¥æ‰¾ç”¨æˆ·
      return await this.storage.findUserByAccount(account)
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error)
      return null
    }
  }

  // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ¨¡å¼
  private toggleMode(): void {
    this.isLoginMode = !this.isLoginMode
    this.resetForm()
  }

  // é‡ç½®è¡¨å•
  private resetForm(): void {
    this.account = ''
    this.password = ''
    this.confirmPassword = ''
  }

  // æ˜¾ç¤ºæœªæ³¨å†Œæç¤ºå¼¹çª—
  private showUnregisteredDialogMsg(): void {
    this.showUnregisteredDialog = true
  }

  // å…³é—­æç¤ºå¼¹çª—ï¼Œåˆ‡æ¢åˆ°æ³¨å†Œæ¨¡å¼
  private goToRegister(): void {
    this.showUnregisteredDialog = false
    this.isLoginMode = false
  }

  // å…³é—­æç¤ºå¼¹çª—
  private closeDialog(): void {
    this.showUnregisteredDialog = false
  }

  build() {
    Stack() {
      // ä¸»è¦å†…å®¹
      Column() {
        // Cookieæç¤ºæ¡
        Row() {
          Text('æœ¬ç½‘ç«™ä½¿ç”¨CookieåŠŸèƒ½ï¼Œä¸ºæ‚¨æä¾›æœ€ä½³çš„ç”¨æˆ·ä½“éªŒã€‚äº†è§£æ›´å¤š')
            .fontSize(12)
            .fontColor('#999999')
            .layoutWeight(1)
            .textAlign(TextAlign.Start)
          Button('Ã—')
            .width(30)
            .height(30)
            .backgroundColor(Color.Transparent)
            .fontColor('#999999')
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#FFFFFF')

        // é¡¶éƒ¨å¯¼èˆª
        Row() {
          Button('â†')
            .width(40)
            .height(40)
            .backgroundColor(Color.Transparent)
            .fontColor($r('app.color.text_primary'))
            .onClick(() => {
              router.replaceUrl({url:'pages/IndexLuxury'})
            })

          Text('åä¸ºè´¦å·-ç™»å½•')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Blank().width(40)
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)

        // ä¸»è¦å†…å®¹åŒºåŸŸ
        Scroll() {
          Column() {
            // Logoå’Œæ ‡é¢˜
            Column() {
              // åä¸ºLogo - ä½¿ç”¨çº¢è‰²èƒŒæ™¯å’Œç™½è‰²HUAWEIæ–‡å­—æ¨¡æ‹Ÿ
              Row() {
                Column() {
                  Text('HUAWEI')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Color.White)
                }
                .width(60)
                .height(60)
                .backgroundColor('#CF0A2C')
                .borderRadius(12)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
              }
              .margin({ bottom: 24 })

              Text('åä¸ºè´¦å·')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .margin({ bottom: 8 })

              Text('ç™»å½•åä¸ºè´¦å·ä»¥ä½¿ç”¨äº‘ç©ºé—´ã€åä¸ºåº”ç”¨åŠæ›´å¤šæœåŠ¡')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .margin({ bottom: 40 })
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .padding({ top: 60 })
            .alignItems(HorizontalAlign.Center)

            // è¡¨å•åŒºåŸŸ
            Column() {
              // è´¦å·è¾“å…¥ï¼ˆç®€åŒ–ï¼Œä¸æ˜¾ç¤ºæ ‡ç­¾ï¼‰
              TextInput({ placeholder: 'æ‰‹æœºå·/é‚®ä»¶åœ°å€/åä¸ºå·' })
                .width('100%')
                .height(48)
                .fontSize(16)
                .backgroundColor('#FFFFFF')
                .borderRadius(0)
                .padding({ left: 16 })
                .border({ width: 1, color: '#E5E5E5' })
                .onChange((value: string) => {
                  this.account = value
                })

              // å¯†ç è¾“å…¥ï¼ˆç®€åŒ–ï¼Œä¸æ˜¾ç¤ºæ ‡ç­¾ï¼‰
              TextInput({ placeholder: 'å¯†ç ' })
                .width('100%')
                .height(48)
                .fontSize(16)
                .backgroundColor('#FFFFFF')
                .borderRadius(0)
                .padding({ left: 16 })
                .border({ width: 1, color: '#E5E5E5' })
                .borderTop({ width: 0 })
                .type(InputType.Password)
                .onChange((value: string) => {
                  this.password = value
                })

              // è¾…åŠ©é“¾æ¥
              Row() {
                Text('çŸ­ä¿¡éªŒè¯ç ç™»å½•')
                  .fontSize(14)
                  .fontColor('#007DFF')
                  .layoutWeight(1)
                  .textAlign(TextAlign.Start)

                Text('å¿˜è®°å¯†ç ')
                  .fontSize(14)
                  .fontColor('#007DFF')
                  .margin({ right: 16 })

                Text('ç«‹å³æ³¨å†Œ')
                  .fontSize(14)
                  .fontColor('#007DFF')
                  .textAlign(TextAlign.End)
                  .onClick(() => this.toggleMode())
              }
              .width('100%')
              .margin({ top: 16, bottom: 24 })

              // ç™»å½•/æ³¨å†ŒæŒ‰é’®
              Button(this.isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ')
                .width('100%')
                .height(50)
                .fontSize(16)
                .backgroundColor('#007DFF')
                .fontColor(Color.White)
                .borderRadius(0)
                .enabled(!this.isLoading && this.account.length >= 3 && this.password.length >= 6 &&
                        (this.isLoginMode || this.confirmPassword.length >= 6))
                .onClick(() => {
                  if (this.isLoginMode) {
                    this.login()
                  } else {
                    this.register()
                  }
                })

              // åŠ è½½çŠ¶æ€
              if (this.isLoading) {
                Row() {
                  LoadingProgress()
                    .width(20)
                    .height(20)
                  Text(this.isLoginMode ? 'ç™»å½•ä¸­...' : 'æ³¨å†Œä¸­...')
                    .fontSize(14)
                    .fontColor($r('app.color.text_secondary'))
                    .margin({ left: 8 })
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .margin({ top: 16 })
              }
            }
            .width('100%')
            .padding(24)

            // å…¶ä»–ç™»å½•æ–¹å¼åˆ‡æ¢æŒ‰é’®
            Row() {
              Text(this.showOtherLoginMethods ? 'æ”¶èµ·å…¶ä»–ç™»å½•æ–¹å¼' : 'å…¶ä»–ç™»å½•æ–¹å¼')
                .fontSize(14)
                .fontColor('#666666')
                .onClick(() => this.showOtherLoginMethods = !this.showOtherLoginMethods)
            }
            .width('100%')
            .margin({ top: 16, bottom: 16 })
            .justifyContent(FlexAlign.Center)

            // å…¶ä»–ç™»å½•æ–¹å¼å¡ç‰‡ - é»˜è®¤éšè—
            if (this.showOtherLoginMethods) {
              Column() {
                Text('ç¬¬ä¸‰æ–¹è´¦å·ç™»å½•')
                  .fontSize(16)
                  .fontColor('#666666')
                  .margin({ bottom: 16 })

                Row() {
                  // å¾®ä¿¡ç™»å½•
                  Column() {
                    Text('ğŸ’¬')
                      .fontSize(48)
                    Text('å¾®ä¿¡')
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 8 })
                  }
                  .width('33.33%')
                  .alignItems(HorizontalAlign.Center)
                  .onClick(() => {
                    console.log('å¾®ä¿¡ç™»å½•')
                  })

                  // QQç™»å½•
                  Column() {
                    Text('ğŸ§')
                      .fontSize(48)
                    Text('QQ')
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 8 })
                  }
                  .width('33.33%')
                  .alignItems(HorizontalAlign.Center)
                  .onClick(() => {
                    console.log('QQç™»å½•')
                  })

                  // å¾®åšç™»å½•
                  Column() {
                    Text('ğŸ“±')
                      .fontSize(48)
                    Text('å¾®åš')
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 8 })
                  }
                  .width('33.33%')
                  .alignItems(HorizontalAlign.Center)
                  .onClick(() => {
                    console.log('å¾®åšç™»å½•')
                  })
                }
              }
              .width('100%')
              .padding(24)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .shadow({
                radius: 10,
                color: 'rgba(0, 0, 0, 0.08)',
                offsetX: 0,
                offsetY: 2
              })
              .margin({ bottom: 20 })
            }

            // åº•éƒ¨æ³¨å†ŒæŒ‰é’® - ç™»å½•æ¨¡å¼ä¸‹æ˜¾ç¤º
            if (this.isLoginMode) {
              Button('æ³¨å†Œè´¦å·')
                .width('100%')
                .height(50)
                .fontSize(16)
                .backgroundColor(Color.Transparent)
                .fontColor('#007DFF')
                .border({ width: 1, color: '#007DFF' })
                .borderRadius(0)
                .margin({ left: 24, right: 24, bottom: 40 })
                .onClick(() => this.toggleMode())
            }
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
      }
      .width('100%')
      .height('100%')

      // æœªæ³¨å†Œæç¤ºå¼¹çª—
      if (this.showUnregisteredDialog) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.closeDialog()
            })

          // å¼¹çª—å†…å®¹
          Column() {
            Text('âš ï¸')
              .fontSize(48)
              .fontColor('#faad14')
              .margin({ bottom: 16 })

            Text('æ‚¨æœªæ³¨å†Œ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 8 })

            Text('è¯¥è´¦å·æœªæ³¨å†Œï¼Œæ˜¯å¦ç°åœ¨æ³¨å†Œï¼Ÿ')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 24 })

            Row() {
              Button('å–æ¶ˆ')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.background'))
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.closeDialog()
                })

              Button('ç«‹å³æ³¨å†Œ')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => {
                  this.goToRegister()
                })
            }
            .width('100%')
          }
          .width(300)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .padding(24)
          .position({ x: '50%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(1000)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}