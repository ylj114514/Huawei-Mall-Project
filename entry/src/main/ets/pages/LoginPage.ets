import router from '@ohos.router'
import promptAction from '@ohos.promptAction' // âœ… è¡¥å……æç¤ºå·¥å…·
import { User } from '../model/DataModel'
import { DatabaseManager, UserProfilePatch } from '../database/DatabaseManager'
import { AuthService } from '../services/AuthService'
import common from '@ohos.app.ability.common'
import notification from '@ohos.notification'

// âœ… è§„èŒƒåŒ–é€šçŸ¥æŽ¥å£å®šä¹‰ï¼Œç¡®ä¿ç¬¦åˆ ArkTS æ£€æŸ¥
interface VerifyCodeNormalContent {
  title: string
  text: string
}

interface VerifyCodeNotificationContent {
  contentType: notification.ContentType
  normal: VerifyCodeNormalContent
}

interface VerifyCodeNotificationRequest {
  id: number
  slotType: notification.SlotType
  content: VerifyCodeNotificationContent
}

@Entry
@Component
struct LoginPage {
  @State account: string = ''
  @State password: string = ''
  @State confirmPassword: string = ''
  @State isLoginMode: boolean = true
  @State isLoading: boolean = false
  @State showUnregisteredDialog: boolean = false
  @State showOtherLoginMethods: boolean = false

  // éªŒè¯ç ç™»å½•ç›¸å…³çŠ¶æ€
  @State isCodeLogin: boolean = false
  @State verifyCode: string = ''
  @State generatedCode: string = ''
  @State countdown: number = 0

  private timer: number = -1
  private db: DatabaseManager = DatabaseManager.getInstance()
  private authService: AuthService = AuthService.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
  }

  aboutToDisappear() {
    this.clearCountdownTimer()
  }

  private clearCountdownTimer() {
    if (this.timer !== -1) {
      clearInterval(this.timer)
      this.timer = -1
    }
  }

  private async initStorage() {
    try {
      await this.db.init(this.context)
    } catch (error) {
      console.error('DatabaseManageråˆå§‹åŒ–å¤±è´¥:', error)
    }
  }

  private validateAccount(account: string): boolean {
    return account.length >= 3
  }

  private validatePassword(password: string): boolean {
    return password.length >= 6
  }

  // âœ… é€»è¾‘ä¿®æ­£ï¼šå‘å¸ƒé€šçŸ¥çš„é€»è¾‘æ›´åŠ ä¸¥è°¨
  private async publishVerifyCodeNotification(code: string) {
    try {
      const request: VerifyCodeNotificationRequest = {
        id: Math.floor(Math.random() * 1000),
        slotType: notification.SlotType.SERVICE_INFORMATION,
        content: {
          contentType: notification.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: 'éªŒè¯ç é€šçŸ¥',
            text: `æ‚¨çš„ç™»å½•éªŒè¯ç æ˜¯ï¼š${code}ï¼Œè¯·å‹¿æ³„éœ²ã€‚`
          }
        }
      }

      await notification.publish(request)
    } catch (e) {
      console.error('å‘é€éªŒè¯ç é€šçŸ¥å¤±è´¥:', e)
    }
  }

  private sendVerifyCode() {
    if (!this.account) {
      return
    }

    const code = Math.floor(100000 + Math.random() * 900000).toString()
    this.generatedCode = code
    this.publishVerifyCodeNotification(code)

    this.countdown = 60
    this.clearCountdownTimer()
    this.timer = setInterval(() => {
      this.countdown--
      if (this.countdown <= 0) {
        this.clearCountdownTimer()
      }
    }, 1000)
  }

  private async loginByCode() {
    if (this.verifyCode !== this.generatedCode || !this.generatedCode) {
      return
    }
    this.isLoading = true
    try {
      let user = await this.db.getUserByAccount(this.account)
      if (!user) {
        const success = await this.db.registerUser(this.account, '123456')
        if (success) {
          user = await this.db.getUserByAccount(this.account)
        }
      }
      if (user) {
        this.authService.setCurrentAccount(user.account)
        router.replaceUrl({ url: 'pages/Index' })
      }
    } catch (e) {
      console.error('éªŒè¯ç ç™»å½•å¤±è´¥', e)
    } finally {
      this.isLoading = false
    }
  }

  private async login(): Promise<void> {
    if (this.isCodeLogin) {
      await this.loginByCode() // âœ… ä¿®æ­£ï¼šå¿…é¡»åŠ  await
      return
    }

    if (!this.validateAccount(this.account)) return
    if (!this.validatePassword(this.password)) return

    this.isLoading = true

    try {
      const user = await this.db.login(this.account, this.password)
      if (user) {
        this.authService.setCurrentAccount(user.account)
        router.replaceUrl({ url: 'pages/Index' })
      } else {
        const existingUser = await this.db.getUserByAccount(this.account)
        if (!existingUser) {
          this.showUnregisteredDialogMsg()
        }
      }
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  private async register(): Promise<void> {
    if (!this.validateAccount(this.account)) return
    if (!this.validatePassword(this.password)) return
    if (this.password !== this.confirmPassword) return

    this.isLoading = true
    try {
      const existingUser = await this.db.getUserByAccount(this.account)
      if (!existingUser) {
        const success = await this.db.registerUser(this.account, this.password)
        if (success) {
          this.authService.setCurrentAccount(this.account)
          router.replaceUrl({ url: 'pages/Index' })
        }
      }
    } catch (error) {
      console.error('æ³¨å†Œå¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  private toggleMode(): void {
    this.isLoginMode = !this.isLoginMode
    this.resetForm()
  }

  private resetForm(): void {
    this.account = ''; this.password = ''; this.confirmPassword = ''
    this.verifyCode = ''; this.generatedCode = ''; this.countdown = 0
    this.clearCountdownTimer()
  }

  private showUnregisteredDialogMsg(): void { this.showUnregisteredDialog = true }
  private goToRegister(): void { this.showUnregisteredDialog = false; this.isLoginMode = false }
  private closeDialog(): void { this.showUnregisteredDialog = false }

  // ----------------------------------------------------------------
  // âœ… UI éƒ¨åˆ†ï¼šä¸¥æ ¼ä¿ç•™ä½ æä¾›çš„æ‰€æœ‰å‰ç«¯ä»£ç ï¼Œä¸æ”¹åŠ¨ä»»ä½•å¸ƒå±€å’Œæ ·å¼
  // ----------------------------------------------------------------
  build() {
    Stack() {
      Column() {
        Row() {
          Text('æœ¬ç½‘ç«™ä½¿ç”¨CookieåŠŸèƒ½ï¼Œä¸ºæ‚¨æä¾›æœ€ä½³çš„ç”¨æˆ·ä½“éªŒã€‚äº†è§£æ›´å¤š')
            .fontSize(12).fontColor('#999999').layoutWeight(1).textAlign(TextAlign.Start)
          Button('Ã—').width(30).height(30).backgroundColor(Color.Transparent).fontColor('#999999')
        }.width('100%').padding(12).backgroundColor('#FFFFFF')

        Row() {
          Button('â†').width(40).height(40).backgroundColor(Color.Transparent).fontColor($r('app.color.text_primary'))
            .onClick(() => { router.replaceUrl({url:'pages/Index'}) })
          Text(this.isCodeLogin ? 'éªŒè¯ç ç™»å½•' : 'åŽä¸ºè´¦å·-ç™»å½•').fontSize(18).fontWeight(FontWeight.Bold).layoutWeight(1).textAlign(TextAlign.Center)
          Blank().width(40)
        }.width('100%').height(56).padding({ left: 16, right: 16 }).justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center)

        Scroll() {
          Column() {
            Column() {
              Row() {
                Column() {
                  Text('HUAWEI').fontSize(16).fontWeight(FontWeight.Bold).fontColor(Color.White)
                }.width(60).height(60).backgroundColor('#CF0A2C').borderRadius(12).justifyContent(FlexAlign.Center).alignItems(HorizontalAlign.Center)
              }.margin({ bottom: 24 })
              Text('åŽä¸ºè´¦å·').fontSize(24).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary')).margin({ bottom: 8 })
              Text('ç™»å½•åŽä¸ºè´¦å·ä»¥ä½¿ç”¨äº‘ç©ºé—´ã€åŽä¸ºåº”ç”¨åŠæ›´å¤šæœåŠ¡').fontSize(14).fontColor($r('app.color.text_secondary')).margin({ bottom: 40 }).textAlign(TextAlign.Center)
            }.width('100%').padding({ top: 60 }).alignItems(HorizontalAlign.Center)

            Column() {
              TextInput({ placeholder: 'æ‰‹æœºå·/é‚®ä»¶åœ°å€/åŽä¸ºå·', text: this.account }).width('100%').height(48).fontSize(16).backgroundColor('#FFFFFF').borderRadius(0).padding({ left: 16 }).border({ width: 1, color: '#E5E5E5' }).onChange((value) => { this.account = value })

              if (this.isCodeLogin) {
                Row() {
                  TextInput({ placeholder: 'è¯·è¾“å…¥éªŒè¯ç ', text: this.verifyCode }).layoutWeight(1).height(48).fontSize(16).backgroundColor('#FFFFFF').borderRadius(0).padding({ left: 16 }).border({ width: { top: 0, right: 0, bottom: 1, left: 1 }, color: '#E5E5E5' }).onChange((value) => this.verifyCode = value)
                  Button(this.countdown > 0 ? `${this.countdown}s` : 'èŽ·å–éªŒè¯ç ').width(110).height(48).fontSize(14).backgroundColor('#FFFFFF').fontColor(this.countdown > 0 ? '#999' : '#007DFF').borderRadius(0).border({ width: { top: 0, right: 1, bottom: 1, left: 0 }, color: '#E5E5E5' }).enabled(this.countdown === 0).onClick(() => this.sendVerifyCode())
                }.width('100%')
              } else {
                TextInput({ placeholder: 'å¯†ç ', text: this.password }).width('100%').height(48).fontSize(16).backgroundColor('#FFFFFF').borderRadius(0).padding({ left: 16 }).border({ width: { top: 0, right: 1, bottom: 1, left: 1 }, color: '#E5E5E5', style: BorderStyle.Solid }).type(InputType.Password).onChange((value) => { this.password = value })
              }

              if (!this.isLoginMode && !this.isCodeLogin) {
                TextInput({ placeholder: 'ç¡®è®¤å¯†ç ', text: this.confirmPassword }).width('100%').height(48).fontSize(16).backgroundColor('#FFFFFF').borderRadius(0).padding({ left: 16 }).border({ width: { top: 0, right: 1, bottom: 1, left: 1 }, color: '#E5E5E5', style: BorderStyle.Solid }).type(InputType.Password).onChange((value) => { this.confirmPassword = value })
              }

              Row() {
                Text(this.isCodeLogin ? 'å¯†ç ç™»å½•' : 'çŸ­ä¿¡éªŒè¯ç ç™»å½•').fontSize(14).fontColor('#007DFF').layoutWeight(1).textAlign(TextAlign.Start).onClick(() => { this.isCodeLogin = !this.isCodeLogin; this.isLoginMode = true })
                if (!this.isCodeLogin) {
                  Text('å¿˜è®°å¯†ç ').fontSize(14).fontColor('#007DFF').margin({ right: 16 })
                  Text(this.isLoginMode ? 'ç«‹å³æ³¨å†Œ' : 'è¿”å›žç™»å½•').fontSize(14).fontColor('#007DFF').textAlign(TextAlign.End).onClick(() => this.toggleMode())
                }
              }.width('100%').margin({ top: 16, bottom: 24 })

              Button(this.isCodeLogin ? 'ç™»å½• / æ³¨å†Œ' : (this.isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ')).width('100%').height(50).fontSize(16).backgroundColor('#007DFF').fontColor(Color.White).borderRadius(0).enabled(!this.isLoading)
                .onClick(() => { if (this.isLoginMode) { this.login() } else { this.register() } })

              if (this.isLoading) {
                Row() { LoadingProgress().width(20).height(20); Text(this.isLoginMode ? 'ç™»å½•ä¸­...' : 'æ³¨å†Œä¸­...').fontSize(14).fontColor($r('app.color.text_secondary')).margin({ left: 8 }) }.width('100%').justifyContent(FlexAlign.Center).margin({ top: 16 })
              }
            }.width('100%').padding(24)

            Row() { Text(this.showOtherLoginMethods ? 'æ”¶èµ·å…¶ä»–ç™»å½•æ–¹å¼' : 'å…¶ä»–ç™»å½•æ–¹å¼').fontSize(14).fontColor('#666666').onClick(() => this.showOtherLoginMethods = !this.showOtherLoginMethods) }.width('100%').margin({ top: 16, bottom: 16 }).justifyContent(FlexAlign.Center)

            if (this.showOtherLoginMethods) {
              Column() {
                Text('ç¬¬ä¸‰æ–¹è´¦å·ç™»å½•').fontSize(16).fontColor('#666666').margin({ bottom: 16 })
                Row() {
                  this.ThirdPartyItem('ðŸ’¬', 'å¾®ä¿¡'); this.ThirdPartyItem('ðŸ§', 'QQ'); this.ThirdPartyItem('ðŸ“±', 'å¾®åš')
                }
              }.width('100%').padding(24).backgroundColor('#FFFFFF').borderRadius(12).shadow({ radius: 10, color: 'rgba(0, 0, 0, 0.08)', offsetX: 0, offsetY: 2 }).margin({ bottom: 20 })
            }

            if (this.isLoginMode && !this.isCodeLogin) {
              Button('æ³¨å†Œè´¦å·').width('100%').height(50).fontSize(16).backgroundColor(Color.Transparent).fontColor('#007DFF').border({ width: 1, color: '#007DFF' }).borderRadius(0).margin({ left: 24, right: 24, bottom: 40 }).onClick(() => this.toggleMode())
            }
          }.width('100%')
        }.width('100%').layoutWeight(1).scrollBar(BarState.Off).edgeEffect(EdgeEffect.Spring)
      }.width('100%').height('100%')

      if (this.showUnregisteredDialog) {
        this.UnregisteredDialog()
      }
    }.width('100%').height('100%').backgroundColor($r('app.color.background'))
  }

  @Builder ThirdPartyItem(icon: string, label: string) {
    Column() { Text(icon).fontSize(48); Text(label).fontSize(14).fontColor('#666666').margin({ top: 8 }) }.width('33.33%').alignItems(HorizontalAlign.Center)
  }

  @Builder UnregisteredDialog() {
    Stack() {
      Column().width('100%').height('100%').backgroundColor('rgba(0,0,0,0.5)').onClick(() => this.closeDialog())
      Column() {
        Text('âš ï¸').fontSize(48).fontColor('#faad14').margin({ bottom: 16 })
        Text('æ‚¨æœªæ³¨å†Œ').fontSize(18).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary')).margin({ bottom: 8 })
        Text('è¯¥è´¦å·æœªæ³¨å†Œï¼Œæ˜¯å¦çŽ°åœ¨æ³¨å†Œï¼Ÿ').fontSize(14).fontColor($r('app.color.text_secondary')).margin({ bottom: 24 })
        Row() {
          Button('å–æ¶ˆ').height(44).fontSize(16).backgroundColor($r('app.color.background')).fontColor($r('app.color.text_primary')).layoutWeight(1).margin({ right: 8 }).onClick(() => this.closeDialog())
          Button('ç«‹å³æ³¨å†Œ').height(44).fontSize(16).backgroundColor($r('app.color.primary')).fontColor(Color.White).layoutWeight(1).margin({ left: 8 }).onClick(() => this.goToRegister())
        }.width('100%')
      }.width(300).backgroundColor($r('app.color.white')).borderRadius(12).padding(24)
    }.width('100%').height('100%').zIndex(1000)
  }
}