import router from '@ohos.router'
import { User } from '../model/DataModel'
// âœ… ä½¿ç”¨ DatabaseManager
import { DatabaseManager } from '../database/DatabaseManager'
// âœ… ä½¿ç”¨ AuthService
import { AuthService } from '../services/AuthService'
import common from '@ohos.app.ability.common'

@Entry
@Component
struct LoginPage {
  @State account: string = ''
  @State password: string = ''
  @State confirmPassword: string = ''
  @State isLoginMode: boolean = true
  @State isLoading: boolean = false
  @State showUnregisteredDialog: boolean = false
  @State showOtherLoginMethods: boolean = false

  // âœ… æ–°å¢ï¼šéªŒè¯ç ç™»å½•ç›¸å…³çŠ¶æ€
  @State isCodeLogin: boolean = false
  @State verifyCode: string = ''
  @State generatedCode: string = ''
  @State countdown: number = 0
  private timer: number = -1

  private db: DatabaseManager = DatabaseManager.getInstance()
  private authService: AuthService = AuthService.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
  }

  private async initStorage() {
    try {
      await this.db.init(this.context)
      console.info('DatabaseManageråˆå§‹åŒ–æˆåŠŸ')
    } catch (error) {
      console.error('DatabaseManageråˆå§‹åŒ–å¤±è´¥:', error)
    }
  }

  // éªŒè¯è´¦å·æ ¼å¼
  private validateAccount(account: string): boolean {
    return account.length >= 3
  }

  // éªŒè¯å¯†ç æ ¼å¼
  private validatePassword(password: string): boolean {
    return password.length >= 6
  }

  // âœ… æ–°å¢ï¼šæ¨¡æ‹Ÿå‘é€éªŒè¯ç 
  private sendVerifyCode() {
    if (!this.account) {
      AlertDialog.show({ message: 'è¯·è¾“å…¥è´¦å·/æ‰‹æœºå·/é‚®ç®±' })
      return
    }
    const code = Math.floor(100000 + Math.random() * 900000).toString()
    this.generatedCode = code

    // æŠ€å·§ï¼šæ‰“å°åˆ°æ§åˆ¶å°
    console.info(`ã€æ¨¡æ‹Ÿé‚®ä»¶ã€‘å‘ ${this.account} å‘é€éªŒè¯ç : ${code}`)
    AlertDialog.show({
      title: 'éªŒè¯ç å·²å‘é€',
      message: `(æ¨¡æ‹Ÿç¯å¢ƒ) éªŒè¯ç : ${code}\nå·²å‘é€è‡³Logæ§åˆ¶å°`,
      confirm: { value: 'çŸ¥é“äº†', action: () => {} }
    })

    this.countdown = 60
    this.timer = setInterval(() => {
      this.countdown--
      if (this.countdown <= 0) {
        clearInterval(this.timer)
      }
    }, 1000)
  }

  // âœ… æ–°å¢ï¼šéªŒè¯ç ç™»å½•é€»è¾‘
  private async loginByCode() {
    if (this.verifyCode !== this.generatedCode || !this.generatedCode) {
      AlertDialog.show({ message: 'éªŒè¯ç é”™è¯¯' })
      return
    }
    this.isLoading = true
    try {
      let user = await this.db.getUserByAccount(this.account)
      if (!user) {
        // è‡ªåŠ¨æ³¨å†Œ
        const success = await this.db.registerUser(this.account, '123456')
        if (success) {
          user = await this.db.getUserByAccount(this.account)
          console.info('éªŒè¯ç ç™»å½•ï¼šè‡ªåŠ¨æ³¨å†Œæ–°ç”¨æˆ·')
        }
      }
      if (user) {
        this.authService.setCurrentAccount(user.account)
        router.replaceUrl({ url: 'pages/Index' })
      }
    } catch (e) {
      console.error('éªŒè¯ç ç™»å½•å¤±è´¥', e)
    } finally {
      this.isLoading = false
    }
  }

  // ç™»å½•
  private async login(): Promise<void> {
    // âœ… å¦‚æœæ˜¯éªŒè¯ç æ¨¡å¼ï¼Œèµ°éªŒè¯ç é€»è¾‘
    if (this.isCodeLogin) {
      this.loginByCode()
      return
    }

    if (!this.validateAccount(this.account)) {
      console.error('è¯·è¾“å…¥æ­£ç¡®çš„è´¦å·æ ¼å¼')
      return
    }

    if (!this.validatePassword(this.password)) {
      console.error('å¯†ç è‡³å°‘6ä½')
      return
    }

    this.isLoading = true

    try {
      // âœ… ä½¿ç”¨ DatabaseManager
      const user = await this.db.login(this.account, this.password)

      if (user) {
        // ç™»å½•æˆåŠŸ
        this.authService.setCurrentAccount(user.account)
        console.info('ç™»å½•æˆåŠŸ:', user.username)
        // âœ… ä¿®æ­£è·³è½¬
        router.replaceUrl({ url: 'pages/Index' })
      } else {
        const existingUser = await this.db.getUserByAccount(this.account)
        if (existingUser) {
          AlertDialog.show({ message: 'å¯†ç é”™è¯¯' })
        } else {
          this.showUnregisteredDialogMsg()
        }
      }
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  // æ³¨å†Œ
  private async register(): Promise<void> {
    if (!this.validateAccount(this.account)) return

    if (!this.validatePassword(this.password)) return

    if (this.password !== this.confirmPassword) {
      AlertDialog.show({ message: 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´' })
      return
    }

    this.isLoading = true

    try {
      // æ£€æŸ¥è´¦å·æ˜¯å¦å·²æ³¨å†Œ
      const existingUser = await this.db.getUserByAccount(this.account)

      if (existingUser) {
        AlertDialog.show({ message: 'è¯¥è´¦å·å·²æ³¨å†Œ' })
      } else {
        // åˆ›å»ºæ–°ç”¨æˆ·
        const success = await this.db.registerUser(this.account, this.password)
        if (success) {
          this.authService.setCurrentAccount(this.account)
          router.replaceUrl({ url: 'pages/Index' })
        }
      }
    } catch (error) {
      console.error('æ³¨å†Œå¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ¨¡å¼
  private toggleMode(): void {
    this.isLoginMode = !this.isLoginMode
    this.resetForm()
  }

  // é‡ç½®è¡¨å•
  private resetForm(): void {
    this.account = ''
    this.password = ''
    this.confirmPassword = ''
    this.verifyCode = ''
  }

  // æ˜¾ç¤ºæœªæ³¨å†Œæç¤ºå¼¹çª—
  private showUnregisteredDialogMsg(): void {
    this.showUnregisteredDialog = true
  }

  // å…³é—­æç¤ºå¼¹çª—ï¼Œåˆ‡æ¢åˆ°æ³¨å†Œæ¨¡å¼
  private goToRegister(): void {
    this.showUnregisteredDialog = false
    this.isLoginMode = false
  }

  // å…³é—­æç¤ºå¼¹çª—
  private closeDialog(): void {
    this.showUnregisteredDialog = false
  }

  build() {
    Stack() {
      // ä¸»è¦å†…å®¹
      Column() {
        // Cookieæç¤ºæ¡ (ä¿ç•™)
        Row() {
          Text('æœ¬ç½‘ç«™ä½¿ç”¨CookieåŠŸèƒ½ï¼Œä¸ºæ‚¨æä¾›æœ€ä½³çš„ç”¨æˆ·ä½“éªŒã€‚äº†è§£æ›´å¤š')
            .fontSize(12)
            .fontColor('#999999')
            .layoutWeight(1)
            .textAlign(TextAlign.Start)
          Button('Ã—')
            .width(30)
            .height(30)
            .backgroundColor(Color.Transparent)
            .fontColor('#999999')
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#FFFFFF')

        // é¡¶éƒ¨å¯¼èˆª (ä¿ç•™)
        Row() {
          Button('â†')
            .width(40)
            .height(40)
            .backgroundColor(Color.Transparent)
            .fontColor($r('app.color.text_primary'))
            .onClick(() => {
              // âœ… ä¿®æ­£è·³è½¬
              router.replaceUrl({url:'pages/Index'})
            })

          // âœ… æ ‡é¢˜åŠ¨æ€æ˜¾ç¤º
          Text(this.isCodeLogin ? 'éªŒè¯ç ç™»å½•' : 'åä¸ºè´¦å·-ç™»å½•')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Blank().width(40)
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)

        // ä¸»è¦å†…å®¹åŒºåŸŸ
        Scroll() {
          Column() {
            // Logoå’Œæ ‡é¢˜ (ä¿ç•™)
            Column() {
              // åä¸ºLogo
              Row() {
                Column() {
                  Text('HUAWEI')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Color.White)
                }
                .width(60)
                .height(60)
                .backgroundColor('#CF0A2C')
                .borderRadius(12)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
              }
              .margin({ bottom: 24 })

              Text('åä¸ºè´¦å·')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .margin({ bottom: 8 })

              Text('ç™»å½•åä¸ºè´¦å·ä»¥ä½¿ç”¨äº‘ç©ºé—´ã€åä¸ºåº”ç”¨åŠæ›´å¤šæœåŠ¡')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .margin({ bottom: 40 })
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .padding({ top: 60 })
            .alignItems(HorizontalAlign.Center)

            // è¡¨å•åŒºåŸŸ
            Column() {
              // è´¦å·è¾“å…¥ (é€šç”¨)
              TextInput({ placeholder: 'æ‰‹æœºå·/é‚®ä»¶åœ°å€/åä¸ºå·', text: this.account })
                .width('100%')
                .height(48)
                .fontSize(16)
                .backgroundColor('#FFFFFF')
                .borderRadius(0)
                .padding({ left: 16 })
                .border({ width: 1, color: '#E5E5E5' })
                .onChange((value: string) => {
                  this.account = value
                })

              // âœ… æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒè¾“å…¥æ¡†
              if (this.isCodeLogin) {
                // éªŒè¯ç æ¨¡å¼
                Row() {
                  TextInput({ placeholder: 'è¯·è¾“å…¥éªŒè¯ç ', text: this.verifyCode })
                    .layoutWeight(1)
                    .height(48)
                    .fontSize(16)
                    .backgroundColor('#FFFFFF')
                    .borderRadius(0)
                    .padding({ left: 16 })
                    // âœ… ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„ border è¯­æ³•
                    .border({ width: { top: 0, right: 0, bottom: 1, left: 1 }, color: '#E5E5E5' })
                    .onChange((value) => this.verifyCode = value)

                  Button(this.countdown > 0 ? `${this.countdown}s` : 'è·å–éªŒè¯ç ')
                    .width(110)
                    .height(48)
                    .fontSize(14)
                    .backgroundColor('#FFFFFF')
                    .fontColor(this.countdown > 0 ? '#999' : '#007DFF')
                    .borderRadius(0)
                    // âœ… ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„ border è¯­æ³•
                    .border({ width: { top: 0, right: 1, bottom: 1, left: 0 }, color: '#E5E5E5' })
                    .enabled(this.countdown === 0)
                    .onClick(() => this.sendVerifyCode())
                }
                .width('100%')
              } else {
                // å¯†ç æ¨¡å¼
                TextInput({ placeholder: 'å¯†ç ', text: this.password })
                  .width('100%')
                  .height(48)
                  .fontSize(16)
                  .backgroundColor('#FFFFFF')
                  .borderRadius(0)
                  .padding({ left: 16 })
                  // âœ… ä¿®å¤ï¼šä¿®å¤ borderTop æŠ¥é”™ï¼Œä½¿ç”¨æ ‡å‡† border å†™æ³•
                  .border({
                    width: { top: 0, right: 1, bottom: 1, left: 1 },
                    color: '#E5E5E5',
                    style: BorderStyle.Solid
                  })
                  .type(InputType.Password)
                  .onChange((value: string) => {
                    this.password = value
                  })
              }

              // ç¡®è®¤å¯†ç ï¼ˆä»…æ³¨å†Œæ¨¡å¼ï¼‰
              if (!this.isLoginMode && !this.isCodeLogin) {
                TextInput({ placeholder: 'ç¡®è®¤å¯†ç ', text: this.confirmPassword })
                  .width('100%')
                  .height(48)
                  .fontSize(16)
                  .backgroundColor('#FFFFFF')
                  .borderRadius(0)
                  .padding({ left: 16 })
                  // âœ… ä¿®å¤ï¼šåŒä¸Šï¼Œç§»é™¤ borderTop
                  .border({
                    width: { top: 0, right: 1, bottom: 1, left: 1 },
                    color: '#E5E5E5',
                    style: BorderStyle.Solid
                  })
                  .type(InputType.Password)
                  .onChange((value: string) => {
                    this.confirmPassword = value
                  })
              }

              // è¾…åŠ©é“¾æ¥
              Row() {
                // âœ… åˆ‡æ¢æ¨¡å¼æŒ‰é’®
                Text(this.isCodeLogin ? 'å¯†ç ç™»å½•' : 'çŸ­ä¿¡éªŒè¯ç ç™»å½•')
                  .fontSize(14)
                  .fontColor('#007DFF')
                  .layoutWeight(1)
                  .textAlign(TextAlign.Start)
                  .onClick(() => {
                    this.isCodeLogin = !this.isCodeLogin
                    this.isLoginMode = true
                  })

                if (!this.isCodeLogin) {
                  Text('å¿˜è®°å¯†ç ')
                    .fontSize(14)
                    .fontColor('#007DFF')
                    .margin({ right: 16 })

                  Text(this.isLoginMode ? 'ç«‹å³æ³¨å†Œ' : 'è¿”å›ç™»å½•')
                    .fontSize(14)
                    .fontColor('#007DFF')
                    .textAlign(TextAlign.End)
                    .onClick(() => this.toggleMode())
                }
              }
              .width('100%')
              .margin({ top: 16, bottom: 24 })

              // ç™»å½•/æ³¨å†ŒæŒ‰é’®
              Button(this.isCodeLogin ? 'ç™»å½• / æ³¨å†Œ' : (this.isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ'))
                .width('100%')
                .height(50)
                .fontSize(16)
                .backgroundColor('#007DFF')
                .fontColor(Color.White)
                .borderRadius(0)
                .enabled(!this.isLoading)
                .onClick(() => {
                  if (this.isLoginMode) {
                    this.login()
                  } else {
                    this.register()
                  }
                })

              // åŠ è½½çŠ¶æ€
              if (this.isLoading) {
                Row() {
                  LoadingProgress()
                    .width(20)
                    .height(20)
                  Text(this.isLoginMode ? 'ç™»å½•ä¸­...' : 'æ³¨å†Œä¸­...')
                    .fontSize(14)
                    .fontColor($r('app.color.text_secondary'))
                    .margin({ left: 8 })
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .margin({ top: 16 })
              }
            }
            .width('100%')
            .padding(24)

            // å…¶ä»–ç™»å½•æ–¹å¼åˆ‡æ¢æŒ‰é’® (ä¿ç•™)
            Row() {
              Text(this.showOtherLoginMethods ? 'æ”¶èµ·å…¶ä»–ç™»å½•æ–¹å¼' : 'å…¶ä»–ç™»å½•æ–¹å¼')
                .fontSize(14)
                .fontColor('#666666')
                .onClick(() => this.showOtherLoginMethods = !this.showOtherLoginMethods)
            }
            .width('100%')
            .margin({ top: 16, bottom: 16 })
            .justifyContent(FlexAlign.Center)

            // å…¶ä»–ç™»å½•æ–¹å¼å¡ç‰‡ (ä¿ç•™)
            if (this.showOtherLoginMethods) {
              Column() {
                Text('ç¬¬ä¸‰æ–¹è´¦å·ç™»å½•')
                  .fontSize(16)
                  .fontColor('#666666')
                  .margin({ bottom: 16 })

                Row() {
                  // å¾®ä¿¡ç™»å½•
                  Column() {
                    Text('ğŸ’¬')
                      .fontSize(48)
                    Text('å¾®ä¿¡')
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 8 })
                  }
                  .width('33.33%')
                  .alignItems(HorizontalAlign.Center)

                  // QQç™»å½•
                  Column() {
                    Text('ğŸ§')
                      .fontSize(48)
                    Text('QQ')
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 8 })
                  }
                  .width('33.33%')
                  .alignItems(HorizontalAlign.Center)

                  // å¾®åšç™»å½•
                  Column() {
                    Text('ğŸ“±')
                      .fontSize(48)
                    Text('å¾®åš')
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 8 })
                  }
                  .width('33.33%')
                  .alignItems(HorizontalAlign.Center)
                }
              }
              .width('100%')
              .padding(24)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .shadow({
                radius: 10,
                color: 'rgba(0, 0, 0, 0.08)',
                offsetX: 0,
                offsetY: 2
              })
              .margin({ bottom: 20 })
            }

            // åº•éƒ¨æ³¨å†ŒæŒ‰é’® - ç™»å½•æ¨¡å¼ä¸‹æ˜¾ç¤º (ä¿ç•™)
            if (this.isLoginMode && !this.isCodeLogin) {
              Button('æ³¨å†Œè´¦å·')
                .width('100%')
                .height(50)
                .fontSize(16)
                .backgroundColor(Color.Transparent)
                .fontColor('#007DFF')
                .border({ width: 1, color: '#007DFF' })
                .borderRadius(0)
                .margin({ left: 24, right: 24, bottom: 40 })
                .onClick(() => this.toggleMode())
            }
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
      }
      .width('100%')
      .height('100%')

      // æœªæ³¨å†Œæç¤ºå¼¹çª— (ä¿ç•™)
      if (this.showUnregisteredDialog) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.closeDialog()
            })

          // å¼¹çª—å†…å®¹
          Column() {
            Text('âš ï¸')
              .fontSize(48)
              .fontColor('#faad14')
              .margin({ bottom: 16 })

            Text('æ‚¨æœªæ³¨å†Œ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 8 })

            Text('è¯¥è´¦å·æœªæ³¨å†Œï¼Œæ˜¯å¦ç°åœ¨æ³¨å†Œï¼Ÿ')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 24 })

            Row() {
              Button('å–æ¶ˆ')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.background'))
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.closeDialog()
                })

              Button('ç«‹å³æ³¨å†Œ')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => {
                  this.goToRegister()
                })
            }
            .width('100%')
          }
          .width(300)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .padding(24)
          .position({ x: '50%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(1000)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}