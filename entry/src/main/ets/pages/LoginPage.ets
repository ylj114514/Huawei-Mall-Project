import router from '@ohos.router'
import { User } from '../model/DataModel'
import { DatabaseManager } from '../database/DatabaseManager'
import { AuthService } from '../services/AuthService'
import common from '@ohos.app.ability.common'
import promptAction from '@ohos.promptAction' // å»ºè®®ä½¿ç”¨ promptAction æ›¿ä»£ AlertDialogï¼Œä½“éªŒæ›´å¥½

@Entry
@Component
struct LoginPage {
  @State account: string = ''
  @State password: string = ''
  @State confirmPassword: string = ''
  @State isLoginMode: boolean = true
  @State isLoading: boolean = false
  @State showUnregisteredDialog: boolean = false
  @State showOtherLoginMethods: boolean = false

  // éªŒè¯ç ç™»å½•ç›¸å…³çŠ¶æ€
  @State isCodeLogin: boolean = false
  @State verifyCode: string = ''
  @State generatedCode: string = ''
  @State countdown: number = 0
  private timer: number = -1

  private db: DatabaseManager = DatabaseManager.getInstance()
  private authService: AuthService = AuthService.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext
  private isDbReady: boolean = false

  aboutToAppear() {
    this.initStorage()
  }

  aboutToDisappear() {
    // é¡µé¢é”€æ¯æ—¶æ¸…ç†å®šæ—¶å™¨
    if (this.timer !== -1) {
      clearInterval(this.timer)
    }
  }

  private async initStorage() {
    try {
      await this.db.init(this.context)
      this.isDbReady = true
      console.info('DatabaseManageråˆå§‹åŒ–æˆåŠŸ')
    } catch (error) {
      console.error('DatabaseManageråˆå§‹åŒ–å¤±è´¥:', JSON.stringify(error))
      promptAction.showToast({ message: 'æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡å¯åº”ç”¨' })
    }
  }

  // éªŒè¯è´¦å·æ ¼å¼
  private validateAccount(account: string): boolean {
    return account.length >= 3
  }

  // éªŒè¯å¯†ç æ ¼å¼
  private validatePassword(password: string): boolean {
    return password.length >= 6
  }

  // æ¨¡æ‹Ÿå‘é€éªŒè¯ç 
  private sendVerifyCode() {
    if (!this.account) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥è´¦å·/æ‰‹æœºå·/é‚®ç®±' })
      return
    }
    // ç®€å•æ¨¡æ‹Ÿé˜²æŠ–
    if (this.countdown > 0) return

    const code = Math.floor(100000 + Math.random() * 900000).toString()
    this.generatedCode = code

    console.info(`ã€æ¨¡æ‹Ÿé‚®ä»¶ã€‘å‘ ${this.account} å‘é€éªŒè¯ç : ${code}`)
    AlertDialog.show({
      title: 'éªŒè¯ç å·²å‘é€',
      message: `(æ¨¡æ‹Ÿç¯å¢ƒ) éªŒè¯ç : ${code}`,
      confirm: { value: 'çŸ¥é“äº†', action: () => {} }
    })

    this.countdown = 60
    this.timer = setInterval(() => {
      this.countdown--
      if (this.countdown <= 0) {
        clearInterval(this.timer)
        this.timer = -1
      }
    }, 1000)
  }

  // éªŒè¯ç ç™»å½•é€»è¾‘
  private async loginByCode() {
    if (!this.isDbReady) {
      promptAction.showToast({ message: 'ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨å...' })
      return
    }
    if (!this.account) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥è´¦å·' })
      return
    }
    if (this.verifyCode !== this.generatedCode || !this.generatedCode) {
      promptAction.showToast({ message: 'éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ' })
      return
    }

    this.isLoading = true
    try {
      let user = await this.db.getUserByAccount(this.account)
      // å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨æ³¨å†Œ
      if (!user) {
        console.info('éªŒè¯ç ç™»å½•ï¼šç”¨æˆ·ä¸å­˜åœ¨ï¼Œå°è¯•è‡ªåŠ¨æ³¨å†Œ')
        // éªŒè¯ç ç™»å½•é»˜è®¤å¯†ç è®¾ä¸ºéšæœºæˆ–ç‰¹å®šå€¼ï¼Œè¿™é‡Œè®¾ä¸º'123456'æ–¹ä¾¿è®°å¿†ï¼Œå®é™…åº”å¼ºåˆ¶ä¿®æ”¹
        const registerSuccess = await this.db.registerUser(this.account, '123456')
        if (registerSuccess) {
          // æ³¨å†ŒæˆåŠŸåé‡æ–°è·å–ç”¨æˆ·å¯¹è±¡
          user = await this.db.getUserByAccount(this.account)
        } else {
          promptAction.showToast({ message: 'è‡ªåŠ¨æ³¨å†Œå¤±è´¥ï¼Œè¯·å°è¯•æ™®é€šæ³¨å†Œ' })
          return
        }
      }

      if (user) {
        // ä¿å­˜ç™»å½•çŠ¶æ€
        this.authService.setCurrentAccount(user.account)
        promptAction.showToast({ message: 'ç™»å½•æˆåŠŸ' })
        router.replaceUrl({ url: 'pages/Index' })
      }
    } catch (e) {
      console.error('éªŒè¯ç ç™»å½•å¼‚å¸¸:', JSON.stringify(e))
      promptAction.showToast({ message: 'ç™»å½•å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•' })
    } finally {
      this.isLoading = false
    }
  }

  // æ™®é€šå¯†ç ç™»å½•
  private async login(): Promise<void> {
    if (this.isCodeLogin) {
      this.loginByCode()
      return
    }

    if (!this.isDbReady) {
      promptAction.showToast({ message: 'ç³»ç»Ÿåˆå§‹åŒ–ä¸­...' })
      return
    }

    if (!this.validateAccount(this.account)) {
      promptAction.showToast({ message: 'è´¦å·é•¿åº¦éœ€å¤§äº3ä½' })
      return
    }

    if (!this.validatePassword(this.password)) {
      promptAction.showToast({ message: 'å¯†ç é•¿åº¦éœ€å¤§äº6ä½' })
      return
    }

    this.isLoading = true

    try {
      // å°è¯•ç™»å½•
      const user = await this.db.login(this.account, this.password)

      if (user) {
        // ç™»å½•æˆåŠŸï¼šå†™å…¥Sessionï¼Œè·³è½¬
        this.authService.setCurrentAccount(user.account)
        console.info('ç™»å½•æˆåŠŸ:', user.username || user.account)
        promptAction.showToast({ message: 'ç™»å½•æˆåŠŸ' })

        // å»¶è¿Ÿè·³è½¬ï¼Œæå‡ä½“éªŒ
        setTimeout(() => {
          router.replaceUrl({ url: 'pages/Index' })
        }, 500)
      } else {
        // ç™»å½•å¤±è´¥ï¼šåˆ¤æ–­æ˜¯ å¯†ç é”™è¯¯ è¿˜æ˜¯ æœªæ³¨å†Œ
        const existingUser = await this.db.getUserByAccount(this.account)
        if (existingUser) {
          promptAction.showToast({ message: 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•' })
        } else {
          // è´¦å·ä¸å­˜åœ¨ï¼Œå¼•å¯¼æ³¨å†Œ
          this.showUnregisteredDialogMsg()
        }
      }
    } catch (error) {
      console.error('ç™»å½•å¼‚å¸¸:', JSON.stringify(error))
      promptAction.showToast({ message: 'ç™»å½•å¤±è´¥ï¼Œç³»ç»Ÿé”™è¯¯' })
    } finally {
      this.isLoading = false
    }
  }

  // æ³¨å†Œ
  private async register(): Promise<void> {
    if (!this.isDbReady) {
      promptAction.showToast({ message: 'ç³»ç»Ÿåˆå§‹åŒ–ä¸­...' })
      return
    }
    if (!this.validateAccount(this.account)) {
      promptAction.showToast({ message: 'è´¦å·é•¿åº¦éœ€å¤§äº3ä½' })
      return
    }
    if (!this.validatePassword(this.password)) {
      promptAction.showToast({ message: 'å¯†ç é•¿åº¦éœ€å¤§äº6ä½' })
      return
    }
    if (this.password !== this.confirmPassword) {
      promptAction.showToast({ message: 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´' })
      return
    }

    this.isLoading = true

    try {
      // æ£€æŸ¥è´¦å·æ˜¯å¦å·²æ³¨å†Œ
      const existingUser = await this.db.getUserByAccount(this.account)

      if (existingUser) {
        promptAction.showToast({ message: 'è¯¥è´¦å·å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•' })
      } else {
        // åˆ›å»ºæ–°ç”¨æˆ·
        const success = await this.db.registerUser(this.account, this.password)
        if (success) {
          // æ³¨å†ŒæˆåŠŸåï¼Œç›´æ¥è§†ä¸ºå·²ç™»å½•
          this.authService.setCurrentAccount(this.account)
          promptAction.showToast({ message: 'æ³¨å†ŒæˆåŠŸ' })

          setTimeout(() => {
            router.replaceUrl({ url: 'pages/Index' })
          }, 500)
        } else {
          promptAction.showToast({ message: 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•' })
        }
      }
    } catch (error) {
      console.error('æ³¨å†Œå¼‚å¸¸:', JSON.stringify(error))
      promptAction.showToast({ message: 'æ³¨å†Œå‘ç”Ÿé”™è¯¯' })
    } finally {
      this.isLoading = false
    }
  }

  // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ¨¡å¼
  private toggleMode(): void {
    this.isLoginMode = !this.isLoginMode
    this.resetForm()
  }

  // é‡ç½®è¡¨å•
  private resetForm(): void {
    // ä¿ç•™è´¦å·ï¼Œæ–¹ä¾¿ç”¨æˆ·åˆ‡æ¢
    this.password = ''
    this.confirmPassword = ''
    this.verifyCode = ''
  }

  // æ˜¾ç¤ºæœªæ³¨å†Œæç¤ºå¼¹çª—
  private showUnregisteredDialogMsg(): void {
    this.showUnregisteredDialog = true
  }

  // å…³é—­æç¤ºå¼¹çª—ï¼Œåˆ‡æ¢åˆ°æ³¨å†Œæ¨¡å¼
  private goToRegister(): void {
    this.showUnregisteredDialog = false
    this.isLoginMode = false
  }

  // å…³é—­æç¤ºå¼¹çª—
  private closeDialog(): void {
    this.showUnregisteredDialog = false
  }

  // ----------------------------------------------------------
  // ä¸‹é¢æ˜¯æ‚¨è¦æ±‚ä¿ç•™çš„å‰ç«¯ build() éƒ¨åˆ†ï¼Œè¯·ç›´æ¥ç²˜è´´æ‚¨çš„ build ä»£ç 
  // ----------------------------------------------------------
  build() {
    // ... è¯·åœ¨æ­¤å¤„ç²˜è´´æ‚¨åŸæœ¬çš„ build() ä»£ç  ...
    // ä¸ºäº†å®Œæ•´æ€§ï¼Œå¦‚æœæ‚¨ç›´æ¥è¦†ç›–æ–‡ä»¶ï¼Œè¯·ç¡®ä¿æ‚¨çš„ build() æ–¹æ³•åœ¨è¿™é‡Œ
    Stack() {
      // ... (æ‚¨çš„å‰ç«¯ä»£ç )
      // è¿™é‡Œçœç•¥ï¼Œå®Œå…¨å¤ç”¨æ‚¨æä¾›çš„ä»£ç å³å¯
      Column() {
        Row() {
          Text('æœ¬ç½‘ç«™ä½¿ç”¨CookieåŠŸèƒ½ï¼Œä¸ºæ‚¨æä¾›æœ€ä½³çš„ç”¨æˆ·ä½“éªŒã€‚äº†è§£æ›´å¤š')
            .fontSize(12)
            .fontColor('#999999')
            .layoutWeight(1)
            .textAlign(TextAlign.Start)
          Button('Ã—')
            .width(30)
            .height(30)
            .backgroundColor(Color.Transparent)
            .fontColor('#999999')
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#FFFFFF')

        Row() {
          Button('â†')
            .width(40)
            .height(40)
            .backgroundColor(Color.Transparent)
            .fontColor($r('app.color.text_primary'))
            .onClick(() => {
              router.replaceUrl({url:'pages/Index'})
            })

          Text(this.isCodeLogin ? 'éªŒè¯ç ç™»å½•' : 'åä¸ºè´¦å·-ç™»å½•')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Blank().width(40)
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)

        Scroll() {
          Column() {
            Column() {
              Row() {
                Column() {
                  Text('HUAWEI')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(Color.White)
                }
                .width(60)
                .height(60)
                .backgroundColor('#CF0A2C')
                .borderRadius(12)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
              }
              .margin({ bottom: 24 })

              Text('åä¸ºè´¦å·')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .margin({ bottom: 8 })

              Text('ç™»å½•åä¸ºè´¦å·ä»¥ä½¿ç”¨äº‘ç©ºé—´ã€åä¸ºåº”ç”¨åŠæ›´å¤šæœåŠ¡')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .margin({ bottom: 40 })
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .padding({ top: 60 })
            .alignItems(HorizontalAlign.Center)

            Column() {
              TextInput({ placeholder: 'æ‰‹æœºå·/é‚®ä»¶åœ°å€/åä¸ºå·', text: this.account })
                .width('100%')
                .height(48)
                .fontSize(16)
                .backgroundColor('#FFFFFF')
                .borderRadius(0)
                .padding({ left: 16 })
                .border({ width: 1, color: '#E5E5E5' })
                .onChange((value: string) => {
                  this.account = value
                })

              if (this.isCodeLogin) {
                Row() {
                  TextInput({ placeholder: 'è¯·è¾“å…¥éªŒè¯ç ', text: this.verifyCode })
                    .layoutWeight(1)
                    .height(48)
                    .fontSize(16)
                    .backgroundColor('#FFFFFF')
                    .borderRadius(0)
                    .padding({ left: 16 })
                    .border({ width: { top: 0, right: 0, bottom: 1, left: 1 }, color: '#E5E5E5' })
                    .onChange((value) => this.verifyCode = value)

                  Button(this.countdown > 0 ? `${this.countdown}s` : 'è·å–éªŒè¯ç ')
                    .width(110)
                    .height(48)
                    .fontSize(14)
                    .backgroundColor('#FFFFFF')
                    .fontColor(this.countdown > 0 ? '#999' : '#007DFF')
                    .borderRadius(0)
                    .border({ width: { top: 0, right: 1, bottom: 1, left: 0 }, color: '#E5E5E5' })
                    .enabled(this.countdown === 0)
                    .onClick(() => this.sendVerifyCode())
                }
                .width('100%')
              } else {
                TextInput({ placeholder: 'å¯†ç ', text: this.password })
                  .width('100%')
                  .height(48)
                  .fontSize(16)
                  .backgroundColor('#FFFFFF')
                  .borderRadius(0)
                  .padding({ left: 16 })
                  .border({
                    width: { top: 0, right: 1, bottom: 1, left: 1 },
                    color: '#E5E5E5',
                    style: BorderStyle.Solid
                  })
                  .type(InputType.Password)
                  .onChange((value: string) => {
                    this.password = value
                  })
              }

              if (!this.isLoginMode && !this.isCodeLogin) {
                TextInput({ placeholder: 'ç¡®è®¤å¯†ç ', text: this.confirmPassword })
                  .width('100%')
                  .height(48)
                  .fontSize(16)
                  .backgroundColor('#FFFFFF')
                  .borderRadius(0)
                  .padding({ left: 16 })
                  .border({
                    width: { top: 0, right: 1, bottom: 1, left: 1 },
                    color: '#E5E5E5',
                    style: BorderStyle.Solid
                  })
                  .type(InputType.Password)
                  .onChange((value: string) => {
                    this.confirmPassword = value
                  })
              }

              Row() {
                Text(this.isCodeLogin ? 'å¯†ç ç™»å½•' : 'çŸ­ä¿¡éªŒè¯ç ç™»å½•')
                  .fontSize(14)
                  .fontColor('#007DFF')
                  .layoutWeight(1)
                  .textAlign(TextAlign.Start)
                  .onClick(() => {
                    this.isCodeLogin = !this.isCodeLogin
                    this.isLoginMode = true
                  })

                if (!this.isCodeLogin) {
                  Text('å¿˜è®°å¯†ç ')
                    .fontSize(14)
                    .fontColor('#007DFF')
                    .margin({ right: 16 })

                  Text(this.isLoginMode ? 'ç«‹å³æ³¨å†Œ' : 'è¿”å›ç™»å½•')
                    .fontSize(14)
                    .fontColor('#007DFF')
                    .textAlign(TextAlign.End)
                    .onClick(() => this.toggleMode())
                }
              }
              .width('100%')
              .margin({ top: 16, bottom: 24 })

              Button(this.isCodeLogin ? 'ç™»å½• / æ³¨å†Œ' : (this.isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ'))
                .width('100%')
                .height(50)
                .fontSize(16)
                .backgroundColor('#007DFF')
                .fontColor(Color.White)
                .borderRadius(0)
                .enabled(!this.isLoading)
                .onClick(() => {
                  if (this.isLoginMode) {
                    this.login()
                  } else {
                    this.register()
                  }
                })

              if (this.isLoading) {
                Row() {
                  LoadingProgress()
                    .width(20)
                    .height(20)
                  Text(this.isLoginMode ? 'ç™»å½•ä¸­...' : 'æ³¨å†Œä¸­...')
                    .fontSize(14)
                    .fontColor($r('app.color.text_secondary'))
                    .margin({ left: 8 })
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .margin({ top: 16 })
              }
            }
            .width('100%')
            .padding(24)

            Row() {
              Text(this.showOtherLoginMethods ? 'æ”¶èµ·å…¶ä»–ç™»å½•æ–¹å¼' : 'å…¶ä»–ç™»å½•æ–¹å¼')
                .fontSize(14)
                .fontColor('#666666')
                .onClick(() => this.showOtherLoginMethods = !this.showOtherLoginMethods)
            }
            .width('100%')
            .margin({ top: 16, bottom: 16 })
            .justifyContent(FlexAlign.Center)

            if (this.showOtherLoginMethods) {
              Column() {
                Text('ç¬¬ä¸‰æ–¹è´¦å·ç™»å½•')
                  .fontSize(16)
                  .fontColor('#666666')
                  .margin({ bottom: 16 })

                Row() {
                  Column() {
                    Text('ğŸ’¬')
                      .fontSize(48)
                    Text('å¾®ä¿¡')
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 8 })
                  }
                  .width('33.33%')
                  .alignItems(HorizontalAlign.Center)

                  Column() {
                    Text('ğŸ§')
                      .fontSize(48)
                    Text('QQ')
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 8 })
                  }
                  .width('33.33%')
                  .alignItems(HorizontalAlign.Center)

                  Column() {
                    Text('ğŸ“±')
                      .fontSize(48)
                    Text('å¾®åš')
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 8 })
                  }
                  .width('33.33%')
                  .alignItems(HorizontalAlign.Center)
                }
              }
              .width('100%')
              .padding(24)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .shadow({
                radius: 10,
                color: 'rgba(0, 0, 0, 0.08)',
                offsetX: 0,
                offsetY: 2
              })
              .margin({ bottom: 20 })
            }

            if (this.isLoginMode && !this.isCodeLogin) {
              Button('æ³¨å†Œè´¦å·')
                .width('100%')
                .height(50)
                .fontSize(16)
                .backgroundColor(Color.Transparent)
                .fontColor('#007DFF')
                .border({ width: 1, color: '#007DFF' })
                .borderRadius(0)
                .margin({ left: 24, right: 24, bottom: 40 })
                .onClick(() => this.toggleMode())
            }
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
      }
      .width('100%')
      .height('100%')

      if (this.showUnregisteredDialog) {
        Column() {
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.closeDialog()
            })

          Column() {
            Text('âš ï¸')
              .fontSize(48)
              .fontColor('#faad14')
              .margin({ bottom: 16 })

            Text('æ‚¨æœªæ³¨å†Œ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 8 })

            Text('è¯¥è´¦å·æœªæ³¨å†Œï¼Œæ˜¯å¦ç°åœ¨æ³¨å†Œï¼Ÿ')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 24 })

            Row() {
              Button('å–æ¶ˆ')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.background'))
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.closeDialog()
                })

              Button('ç«‹å³æ³¨å†Œ')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => {
                  this.goToRegister()
                })
            }
            .width('100%')
          }
          .width(300)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .padding(24)
          .position({ x: '50%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(1000)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}