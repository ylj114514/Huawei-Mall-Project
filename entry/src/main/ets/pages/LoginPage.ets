import router from '@ohos.router'
import { User } from '../model/DataModel'
import { StorageManager } from '../utils/StorageManager'
import common from '@ohos.app.ability.common'

@Entry
@Component
struct LoginPage {
  @State account: string = ''
  @State password: string = ''
  @State confirmPassword: string = ''
  @State isLoginMode: boolean = true
  @State isLoading: boolean = false
  @State showUnregisteredDialog: boolean = false
  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
      console.log('StorageManageråˆå§‹åŒ–æˆåŠŸ')
    } catch (error) {
      console.error('StorageManageråˆå§‹åŒ–å¤±è´¥:', error)
    }
  }

  // éªŒè¯è´¦å·æ ¼å¼
  private validateAccount(account: string): boolean {
    return account.length >= 3 && /^[a-zA-Z0-9_]+$/.test(account)
  }

  // éªŒè¯å¯†ç æ ¼å¼
  private validatePassword(password: string): boolean {
    return password.length >= 6
  }

  // ç™»å½•
  private async login(): Promise<void> {
    if (!this.validateAccount(this.account)) {
      console.error('è¯·è¾“å…¥æ­£ç¡®çš„è´¦å·æ ¼å¼ï¼ˆè‡³å°‘3ä½ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰')
      return
    }

    if (!this.validatePassword(this.password)) {
      console.error('å¯†ç è‡³å°‘6ä½')
      return
    }

    this.isLoading = true

    try {
      // ä»å­˜å‚¨ä¸­æŸ¥æ‰¾ç”¨æˆ·
      const existingUser = await this.loadUserByAccount(this.account)

      if (existingUser && existingUser.password === this.password) {
        // ç™»å½•æˆåŠŸ
        await this.storage.saveUser(existingUser)
        console.log('ç™»å½•æˆåŠŸ:', existingUser.username)
        router.replaceUrl({ url: 'pages/IndexLuxury' })
      } else if (existingUser) {
        console.error('å¯†ç é”™è¯¯')
      } else {
        // å¼¹å‡ºæœªæ³¨å†Œæç¤º
        this.showUnregisteredDialogMsg()
      }
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  // æ³¨å†Œ
  private async register(): Promise<void> {
    console.log('å¼€å§‹æ³¨å†Œï¼Œè´¦å·:', this.account)

    if (!this.validateAccount(this.account)) {
      console.error('è¯·è¾“å…¥æ­£ç¡®çš„è´¦å·æ ¼å¼ï¼ˆè‡³å°‘3ä½ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰')
      return
    }

    if (!this.validatePassword(this.password)) {
      console.error('å¯†ç è‡³å°‘6ä½')
      return
    }

    if (this.password !== this.confirmPassword) {
      console.error('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´')
      return
    }

    this.isLoading = true

    try {
      // æ£€æŸ¥è´¦å·æ˜¯å¦å·²æ³¨å†Œ
      console.log('æ£€æŸ¥è´¦å·æ˜¯å¦å·²å­˜åœ¨...')
      const existingUser = await this.loadUserByAccount(this.account)

      if (existingUser) {
        console.error('è¯¥è´¦å·å·²æ³¨å†Œ')
      } else {
        // åˆ›å»ºæ–°ç”¨æˆ·
        console.log('åˆ›å»ºæ–°ç”¨æˆ·...')
        const newUser = new User(this.account, this.password)
        // è®¾ç½®é»˜è®¤ç”¨æˆ·å
        newUser.username = this.account
        await this.storage.saveUser(newUser)
        console.log('æ³¨å†ŒæˆåŠŸ:', newUser.username)
        router.replaceUrl({ url: 'pages/IndexSimple' })
      }
    } catch (error) {
      console.error('æ³¨å†Œå¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  // æ ¹æ®è´¦å·åŠ è½½ç”¨æˆ·ï¼ˆä»æœ¬åœ°æ•°æ®åº“æŸ¥è¯¢ï¼‰
  private async loadUserByAccount(account: string): Promise<User | null> {
    try {
      // ä½¿ç”¨StorageManagerçš„æ–°æ–¹æ³•æŸ¥æ‰¾ç”¨æˆ·
      return await this.storage.findUserByAccount(account)
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error)
      return null
    }
  }

  // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ¨¡å¼
  private toggleMode(): void {
    this.isLoginMode = !this.isLoginMode
    this.resetForm()
  }

  // é‡ç½®è¡¨å•
  private resetForm(): void {
    this.account = ''
    this.password = ''
    this.confirmPassword = ''
  }

  // æ˜¾ç¤ºæœªæ³¨å†Œæç¤ºå¼¹çª—
  private showUnregisteredDialogMsg(): void {
    this.showUnregisteredDialog = true
  }

  // å…³é—­æç¤ºå¼¹çª—ï¼Œåˆ‡æ¢åˆ°æ³¨å†Œæ¨¡å¼
  private goToRegister(): void {
    this.showUnregisteredDialog = false
    this.isLoginMode = false
  }

  // å…³é—­æç¤ºå¼¹çª—
  private closeDialog(): void {
    this.showUnregisteredDialog = false
  }

  build() {
    Stack() {
      // ä¸»è¦å†…å®¹
      Column() {
        // é¡¶éƒ¨å¯¼èˆª
        Row() {
          Button('â†')
            .width(40)
            .height(40)
            .backgroundColor(Color.Transparent)
            .fontColor($r('app.color.text_primary'))
            .onClick(() => {
              router.replaceUrl({url:'pages/IndexLuxury'})
            })

          Text(this.isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Blank().width(40)
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)

        // ä¸»è¦å†…å®¹åŒºåŸŸ
        Scroll() {
          Column() {
            // Logoå’Œæ ‡é¢˜
            Column() {
              Text('ğŸª')
                .fontSize(80)
                .margin({ bottom: 24 })

              Text('åä¸ºå•†åŸ')
                .fontSize(28)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.primary'))
                .margin({ bottom: 8 })

              Text(this.isLoginMode ? 'æ¬¢è¿å›æ¥' : 'åˆ›å»ºè´¦å·å¼€å§‹è´­ç‰©')
                .fontSize(16)
                .fontColor($r('app.color.text_secondary'))
                .margin({ bottom: 40 })
            }
            .width('100%')
            .padding({ top: 60 })

            // è¡¨å•åŒºåŸŸ
            Column() {
              // è´¦å·è¾“å…¥
              Column() {
                Text('è´¦å·')
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
                  .width('100%')
                  .margin({ bottom: 8 })

                TextInput({ placeholder: 'è¯·è¾“å…¥è´¦å·ï¼ˆå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰' })
                  .width('100%')
                  .height(48)
                  .fontSize(16)
                  .backgroundColor($r('app.color.background'))
                  .borderRadius(8)
                  .padding({ left: 16 })
                  .onChange((value: string) => {
                    this.account = value
                  })
              }
              .width('100%')
              .margin({ bottom: 16 })

              // å¯†ç è¾“å…¥
              Column() {
                Text('å¯†ç ')
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
                  .width('100%')
                  .margin({ bottom: 8 })

                TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ' })
                  .width('100%')
                  .height(48)
                  .fontSize(16)
                  .backgroundColor($r('app.color.background'))
                  .borderRadius(8)
                  .padding({ left: 16 })
                  .type(InputType.Password)
                  .onChange((value: string) => {
                    this.password = value
                  })
              }
              .width('100%')
              .margin({ bottom: 16 })

              // ç¡®è®¤å¯†ç ï¼ˆæ³¨å†Œæ¨¡å¼ï¼‰
              if (!this.isLoginMode) {
                Column() {
                  Text('ç¡®è®¤å¯†ç ')
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                    .width('100%')
                    .margin({ bottom: 8 })

                  TextInput({ placeholder: 'è¯·å†æ¬¡è¾“å…¥å¯†ç ' })
                    .width('100%')
                    .height(48)
                    .fontSize(16)
                    .backgroundColor($r('app.color.background'))
                    .borderRadius(8)
                    .padding({ left: 16 })
                    .type(InputType.Password)
                    .onChange((value: string) => {
                      this.confirmPassword = value
                    })
                }
                .width('100%')
                .margin({ bottom: 24 })
              }

              // ç™»å½•/æ³¨å†ŒæŒ‰é’®
              Button(this.isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ')
                .width('100%')
                .height(50)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .borderRadius(25)
                .enabled(!this.isLoading && this.account.length >= 3 && this.password.length >= 6 &&
                        (this.isLoginMode || this.confirmPassword.length >= 6))
                .onClick(() => {
                  if (this.isLoginMode) {
                    this.login()
                  } else {
                    this.register()
                  }
                })

              // åŠ è½½çŠ¶æ€
              if (this.isLoading) {
                Row() {
                  LoadingProgress()
                    .width(20)
                    .height(20)
                  Text(this.isLoginMode ? 'ç™»å½•ä¸­...' : 'æ³¨å†Œä¸­...')
                    .fontSize(14)
                    .fontColor($r('app.color.text_secondary'))
                    .margin({ left: 8 })
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .margin({ top: 16 })
              }
            }
            .width('100%')
            .padding(24)

            // åˆ‡æ¢æ¨¡å¼
            Row() {
              Text(this.isLoginMode ? 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ' : 'å·²æœ‰è´¦å·ï¼Ÿ')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))

              Button(this.isLoginMode ? 'ç«‹å³æ³¨å†Œ' : 'ç«‹å³ç™»å½•')
                .height(32)
                .fontSize(14)
                .backgroundColor(Color.Transparent)
                .fontColor($r('app.color.primary'))
                .onClick(() => this.toggleMode())
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ top: 24, bottom: 40 })
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
      }
      .width('100%')
      .height('100%')

      // æœªæ³¨å†Œæç¤ºå¼¹çª—
      if (this.showUnregisteredDialog) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => {
              this.closeDialog()
            })

          // å¼¹çª—å†…å®¹
          Column() {
            Text('âš ï¸')
              .fontSize(48)
              .fontColor('#faad14')
              .margin({ bottom: 16 })

            Text('æ‚¨æœªæ³¨å†Œ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 8 })

            Text('è¯¥è´¦å·æœªæ³¨å†Œï¼Œæ˜¯å¦ç°åœ¨æ³¨å†Œï¼Ÿ')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ bottom: 24 })

            Row() {
              Button('å–æ¶ˆ')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.background'))
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.closeDialog()
                })

              Button('ç«‹å³æ³¨å†Œ')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .fontColor(Color.White)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => {
                  this.goToRegister()
                })
            }
            .width('100%')
          }
          .width(300)
          .backgroundColor($r('app.color.white'))
          .borderRadius(12)
          .padding(24)
          .position({ x: '50%', y: '50%' })
          .translate({ x: '-50%', y: '-50%' })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(1000)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}