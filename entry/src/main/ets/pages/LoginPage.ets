import router from '@ohos.router'
import { User } from '../model/DataModel'
import { DatabaseManager } from '../database/DatabaseManager'
import { AuthService } from '../services/AuthService'
import common from '@ohos.app.ability.common'
import promptAction from '@ohos.promptAction'
import notificationManager from '@ohos.notificationManager';
import notification from '@ohos.notification';

@Entry
@Component
struct LoginPage {
  @State account: string = ''
  @State password: string = ''
  @State confirmPassword: string = ''
  @State isLoginMode: boolean = true
  @State isLoading: boolean = false
  @State showUnregisteredDialog: boolean = false
  @State showOtherLoginMethods: boolean = false

  // éªŒè¯ç ç™»å½•ç›¸å…³
  @State isCodeLogin: boolean = true
  @State verifyCode: string = ''
  @State countdown: number = 0
  private timer: number = -1

  private db: DatabaseManager = DatabaseManager.getInstance()
  private authService: AuthService = AuthService.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext
  private isDbReady: boolean = false

  aboutToAppear() {
    this.initStorage()
  }

  aboutToDisappear() {
    if (this.timer !== -1) {
      clearInterval(this.timer)
    }
  }

  private async initStorage() {
    try {
      await this.db.init(this.context)
      this.isDbReady = true
    } catch (error) {
      // å¿½ç•¥
    }
  }

  // âœ… æ ¸å¿ƒä¿®æ”¹ï¼šå‘é€éªŒè¯ç é€»è¾‘
  private async sendVerifyCode() {
    if (this.account.length === 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æ‰‹æœºå·' })
      return
    }
    if (this.countdown > 0) return

    promptAction.showToast({ message: 'æ­£åœ¨è¯·æ±‚éªŒè¯ç ...' })

    try {
      // 1. è°ƒç”¨ AuthService å‘é€è¯·æ±‚ (è¿æ¥åä¸ºäº‘)
      await this.authService.requestVerifyCode('86', this.account);
      promptAction.showToast({ message: 'è¯·æ±‚æˆåŠŸ' })

      // 2. æ¨¡æ‹Ÿå¼¹çª—é€šçŸ¥ (è¿™é‡Œä¿ç•™æ‚¨çš„åŸé€»è¾‘ï¼Œæ–¹ä¾¿ç»™è€å¸ˆæ¼”ç¤º)
      this.showSimulationNotification();

      // 3. å¼€å§‹å€’è®¡æ—¶
      this.startCountdown();

    } catch (error) {
      console.error('å‘é€éªŒè¯ç å‡ºé”™:', JSON.stringify(error));
      // ä¸ºäº†æ¼”ç¤ºæµç•…ï¼Œå³ä½¿æŠ¥é”™ä¹Ÿæç¤ºæ£€æŸ¥ç½‘ç»œ
      promptAction.showToast({ message: 'å‘é€è¯·æ±‚å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®' });
      // å¦‚æœæ˜¯ä¸ºäº†æµ‹è¯•UIï¼Œæ‚¨å¯ä»¥å–æ¶ˆä¸‹é¢è¿™ä¸€è¡Œçš„æ³¨é‡Šå¼ºåˆ¶å€’è®¡æ—¶ï¼š
      // this.startCountdown();
    }
  }

  // âœ… æ ¸å¿ƒä¿®æ”¹ï¼šéªŒè¯ç ç™»å½•é€»è¾‘
  private async loginByCode() {
    if (!this.account) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æ‰‹æœºå·' })
      return
    }
    if (!this.verifyCode) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥éªŒè¯ç ' })
      return
    }

    this.isLoading = true

    try {
      // è°ƒç”¨ AuthService è¿›è¡ŒçœŸå®ç™»å½•
      const success = await this.authService.loginWithPhone('86', this.account, this.verifyCode);

      if (success) {
        promptAction.showToast({ message: 'ç™»å½•æˆåŠŸ' })
        setTimeout(() => {
          router.replaceUrl({ url: 'pages/Index' })
        }, 500)
      } else {
        promptAction.showToast({ message: 'ç™»å½•å¤±è´¥' })
      }
    } catch (e) {
      console.error('ç™»å½•å¼‚å¸¸:', JSON.stringify(e));
      promptAction.showToast({ message: 'éªŒè¯ç é”™è¯¯æˆ–è¿‡æœŸ' })
    } finally {
      this.isLoading = false
    }
  }

  // è¾…åŠ©ï¼šæ¨¡æ‹Ÿé€šçŸ¥ (ä¿æŒä¸å˜)
  private async showSimulationNotification() {
    try {
      const isEnabled = await notificationManager.isNotificationEnabled();
      if (!isEnabled) {
        promptAction.showDialog({
          title: 'æµ‹è¯•æç¤º',
          message: 'éªŒè¯ç å·²å‘é€ (æµ‹è¯•ç : 666666)',
          buttons: [{ text: 'å¥½çš„', color: '#007AFF' }]
        });
        return;
      }
      let notificationRequest: notificationManager.NotificationRequest = {
        id: 1001,
        content: {
          contentType: notification.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: 'ã€åä¸ºå•†åŸã€‘å®‰å…¨éªŒè¯',
            text: `æ‚¨çš„éªŒè¯ç æ˜¯ï¼š666666`,
            additionalText: 'æµ‹è¯•æ¨¡å¼'
          }
        }
      }
      await notificationManager.publish(notificationRequest)
    } catch (err) {}
  }

  private startCountdown() {
    this.countdown = 60
    this.timer = setInterval(() => {
      this.countdown--
      if (this.countdown <= 0) {
        clearInterval(this.timer)
        this.timer = -1
        this.countdown = 0
      }
    }, 1000)
  }

  // -----------------------------------------------------------------------
  // â¬‡ï¸ ä¸‹æ–¹ä»£ç ä¿æŒåŸæ · (å¯†ç ç™»å½•ã€æ³¨å†Œé€»è¾‘ã€UIæ„å»º) â¬‡ï¸
  // -----------------------------------------------------------------------

  private async login(): Promise<void> {
    if (this.isCodeLogin) {
      this.loginByCode()
      return
    }
    if (!this.isDbReady) return
    this.isLoading = true
    try {
      const user = await this.db.login(this.account, this.password)
      if (user) {
        promptAction.showToast({ message: 'ç™»å½•æˆåŠŸ' })
        setTimeout(() => { router.replaceUrl({ url: 'pages/Index' }) }, 500)
      } else {
        const exists = await this.db.getUserByAccount(this.account)
        if (exists) promptAction.showToast({ message: 'å¯†ç é”™è¯¯' })
        else this.showUnregisteredDialogMsg()
      }
    } catch (error) {
      promptAction.showToast({ message: 'ç³»ç»Ÿé”™è¯¯' })
    } finally {
      this.isLoading = false
    }
  }

  private async register(): Promise<void> {
    if (!this.isDbReady) return
    if (this.password !== this.confirmPassword) {
      promptAction.showToast({ message: 'å¯†ç ä¸ä¸€è‡´' })
      return
    }
    this.isLoading = true
    try {
      const exists = await this.db.getUserByAccount(this.account)
      if (exists) {
        promptAction.showToast({ message: 'è´¦å·å·²å­˜åœ¨' })
      } else {
        const success = await this.db.registerUser(this.account, this.password)
        if (success) {
          promptAction.showToast({ message: 'æ³¨å†ŒæˆåŠŸ' })
          setTimeout(() => { router.replaceUrl({ url: 'pages/Index' }) }, 500)
        }
      }
    } catch (error) {
      promptAction.showToast({ message: 'æ³¨å†Œé”™è¯¯' })
    } finally {
      this.isLoading = false
    }
  }

  private toggleMode(): void {
    this.isLoginMode = !this.isLoginMode
    this.resetForm()
  }

  private resetForm(): void {
    this.password = ''
    this.confirmPassword = ''
    this.verifyCode = ''
  }

  private showUnregisteredDialogMsg(): void {
    this.showUnregisteredDialog = true
  }

  private goToRegister(): void {
    this.showUnregisteredDialog = false
    this.isLoginMode = false
  }

  private closeDialog(): void {
    this.showUnregisteredDialog = false
  }

  // âš ï¸ é‡ç‚¹ï¼šæ­¤ build æ–¹æ³•å®Œå…¨ä¿ç•™äº†æ‚¨åŸç‰ˆçš„å‰ç«¯ä»£ç ï¼Œæœªåšä¿®æ”¹
  build() {
    Stack() {
      Column() {
        Row() {
          Text('æœ¬ç½‘ç«™ä½¿ç”¨CookieåŠŸèƒ½ï¼Œä¸ºæ‚¨æä¾›æœ€ä½³çš„ç”¨æˆ·ä½“éªŒã€‚äº†è§£æ›´å¤š')
            .fontSize(12).fontColor('#999').layoutWeight(1).textAlign(TextAlign.Start)
          Button('Ã—').width(30).height(30).backgroundColor(Color.Transparent).fontColor('#999')
        }
        .width('100%').padding(12).backgroundColor('#FFFFFF')

        Row() {
          Button('â†').width(40).height(40).backgroundColor(Color.Transparent).fontColor($r('app.color.text_primary'))
            .onClick(() => { router.replaceUrl({url:'pages/Index'}) })
          Text(this.isCodeLogin ? 'éªŒè¯ç ç™»å½•' : 'åä¸ºè´¦å·-ç™»å½•')
            .fontSize(18).fontWeight(FontWeight.Bold).layoutWeight(1).textAlign(TextAlign.Center)
          Blank().width(40)
        }
        .width('100%').height(56).padding({ left: 16, right: 16 }).justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center)

        Scroll() {
          Column() {
            Column() {
              Row() {
                Column() {
                  Text('HUAWEI').fontSize(16).fontWeight(FontWeight.Bold).fontColor(Color.White)
                }
                .width(60).height(60).backgroundColor('#CF0A2C').borderRadius(12)
                .justifyContent(FlexAlign.Center).alignItems(HorizontalAlign.Center)
              }
              .margin({ bottom: 24 })

              Text('åä¸ºè´¦å·').fontSize(24).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary')).margin({ bottom: 8 })
              Text('ç™»å½•åä¸ºè´¦å·ä»¥ä½¿ç”¨äº‘ç©ºé—´ã€åä¸ºåº”ç”¨åŠæ›´å¤šæœåŠ¡').fontSize(14).fontColor($r('app.color.text_secondary')).margin({ bottom: 40 }).textAlign(TextAlign.Center)
            }
            .width('100%').padding({ top: 60 }).alignItems(HorizontalAlign.Center)

            Column() {
              TextInput({ placeholder: 'æ‰‹æœºå·/é‚®ä»¶åœ°å€/åä¸ºå·', text: this.account })
                .width('100%').height(48).fontSize(16).backgroundColor('#FFFFFF').borderRadius(0).padding({ left: 16 })
                .border({ width: 1, color: '#E5E5E5' }).onChange((value) => { this.account = value })

              if (this.isCodeLogin) {
                Row() {
                  TextInput({ placeholder: 'è¯·è¾“å…¥éªŒè¯ç ', text: this.verifyCode })
                    .layoutWeight(1).height(48).fontSize(16).backgroundColor('#FFFFFF').borderRadius(0).padding({ left: 16 })
                    .border({ width: { top: 0, right: 0, bottom: 1, left: 1 }, color: '#E5E5E5' }).onChange((value) => this.verifyCode = value)
                  Button(this.countdown > 0 ? `${this.countdown}s` : 'è·å–éªŒè¯ç ')
                    .width(110).height(48).fontSize(14).backgroundColor('#FFFFFF').fontColor(this.countdown > 0 ? '#999' : '#007DFF')
                    .borderRadius(0).border({ width: { top: 0, right: 1, bottom: 1, left: 0 }, color: '#E5E5E5' })
                    .enabled(this.countdown === 0).onClick(() => this.sendVerifyCode())
                }
                .width('100%')
              } else {
                TextInput({ placeholder: 'å¯†ç ', text: this.password })
                  .width('100%').height(48).fontSize(16).backgroundColor('#FFFFFF').borderRadius(0).padding({ left: 16 })
                  .border({ width: { top: 0, right: 1, bottom: 1, left: 1 }, color: '#E5E5E5' }).type(InputType.Password)
                  .onChange((value) => { this.password = value })
              }

              if (!this.isLoginMode && !this.isCodeLogin) {
                TextInput({ placeholder: 'ç¡®è®¤å¯†ç ', text: this.confirmPassword })
                  .width('100%').height(48).fontSize(16).backgroundColor('#FFFFFF').borderRadius(0).padding({ left: 16 })
                  .border({ width: { top: 0, right: 1, bottom: 1, left: 1 }, color: '#E5E5E5' }).type(InputType.Password)
                  .onChange((value) => { this.confirmPassword = value })
              }

              Row() {
                Text(this.isCodeLogin ? 'å¯†ç ç™»å½•' : 'çŸ­ä¿¡éªŒè¯ç ç™»å½•')
                  .fontSize(14).fontColor('#007DFF').layoutWeight(1).textAlign(TextAlign.Start)
                  .onClick(() => { this.isCodeLogin = !this.isCodeLogin; this.isLoginMode = true })

                if (!this.isCodeLogin) {
                  Text('å¿˜è®°å¯†ç ').fontSize(14).fontColor('#007DFF').margin({ right: 16 })
                  Text(this.isLoginMode ? 'ç«‹å³æ³¨å†Œ' : 'è¿”å›ç™»å½•').fontSize(14).fontColor('#007DFF').textAlign(TextAlign.End)
                    .onClick(() => this.toggleMode())
                }
              }
              .width('100%').margin({ top: 16, bottom: 24 })

              Button(this.isCodeLogin ? 'ç™»å½• / æ³¨å†Œ' : (this.isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ'))
                .width('100%').height(50).fontSize(16).backgroundColor('#007DFF').fontColor(Color.White).borderRadius(0)
                .enabled(!this.isLoading).onClick(() => { if (this.isLoginMode) this.login(); else this.register() })

              if (this.isLoading) {
                Row() {
                  LoadingProgress().width(20).height(20)
                  Text(this.isLoginMode ? 'ç™»å½•ä¸­...' : 'æ³¨å†Œä¸­...').fontSize(14).fontColor($r('app.color.text_secondary')).margin({ left: 8 })
                }
                .width('100%').justifyContent(FlexAlign.Center).margin({ top: 16 })
              }
            }
            .width('100%').padding(24)

            Row() {
              Text(this.showOtherLoginMethods ? 'æ”¶èµ·å…¶ä»–ç™»å½•æ–¹å¼' : 'å…¶ä»–ç™»å½•æ–¹å¼').fontSize(14).fontColor('#666')
                .onClick(() => this.showOtherLoginMethods = !this.showOtherLoginMethods)
            }
            .width('100%').margin({ top: 16, bottom: 16 }).justifyContent(FlexAlign.Center)

            if (this.showOtherLoginMethods) {
              Column() {
                Text('ç¬¬ä¸‰æ–¹è´¦å·ç™»å½•').fontSize(16).fontColor('#666').margin({ bottom: 16 })
                Row() {
                  Column() { Text('ğŸ’¬').fontSize(48); Text('å¾®ä¿¡').fontSize(14).fontColor('#666').margin({ top: 8 }) }.width('33.33%').alignItems(HorizontalAlign.Center)
                  Column() { Text('ğŸ§').fontSize(48); Text('QQ').fontSize(14).fontColor('#666').margin({ top: 8 }) }.width('33.33%').alignItems(HorizontalAlign.Center)
                  Column() { Text('ğŸ“±').fontSize(48); Text('å¾®åš').fontSize(14).fontColor('#666').margin({ top: 8 }) }.width('33.33%').alignItems(HorizontalAlign.Center)
                }
              }
              .width('100%').padding(24).backgroundColor('#FFFFFF').borderRadius(12).shadow({ radius: 10, color: 'rgba(0,0,0,0.08)', offsetY: 2 }).margin({ bottom: 20 })
            }

            if (this.isLoginMode && !this.isCodeLogin) {
              Button('æ³¨å†Œè´¦å·').width('100%').height(50).fontSize(16).backgroundColor(Color.Transparent)
                .fontColor('#007DFF').border({ width: 1, color: '#007DFF' }).borderRadius(0).margin({ left: 24, right: 24, bottom: 40 })
                .onClick(() => this.toggleMode())
            }
          }
        }
        .width('100%').layoutWeight(1).scrollBar(BarState.Off).edgeEffect(EdgeEffect.Spring)
      }
      .width('100%').height('100%')

      if (this.showUnregisteredDialog) {
        Column() {
          Column().width('100%').height('100%').backgroundColor('rgba(0,0,0,0.5)').onClick(() => { this.closeDialog() })
          Column() {
            Text('âš ï¸').fontSize(48).fontColor('#faad14').margin({ bottom: 16 })
            Text('æ‚¨æœªæ³¨å†Œ').fontSize(18).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary')).margin({ bottom: 8 })
            Text('è¯¥è´¦å·æœªæ³¨å†Œï¼Œæ˜¯å¦ç°åœ¨æ³¨å†Œï¼Ÿ').fontSize(14).fontColor($r('app.color.text_secondary')).margin({ bottom: 24 })
            Row() {
              Button('å–æ¶ˆ').height(44).fontSize(16).backgroundColor($r('app.color.background')).fontColor($r('app.color.text_primary')).layoutWeight(1).margin({ right: 8 }).onClick(() => this.closeDialog())
              Button('ç«‹å³æ³¨å†Œ').height(44).fontSize(16).backgroundColor($r('app.color.primary')).fontColor(Color.White).layoutWeight(1).margin({ left: 8 }).onClick(() => this.goToRegister())
            }
            .width('100%')
          }
          .width(300).backgroundColor($r('app.color.white')).borderRadius(12).padding(24).position({ x: '50%', y: '50%' }).translate({ x: '-50%', y: '-50%' })
        }
        .width('100%').height('100%').position({ x: 0, y: 0 }).zIndex(1000)
      }
    }
    .width('100%').height('100%').backgroundColor($r('app.color.background'))
  }
}