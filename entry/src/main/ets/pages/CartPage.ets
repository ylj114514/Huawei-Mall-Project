import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
// âœ… æ ¸å¿ƒä¿®æ­£ï¼šå¼•å…¥æ­£ç¡®çš„ Model å’Œ Service
import { CartService } from '../services/CartService'
import { CartItem } from '../model/DataModel'

// é¢œè‰²å¸¸é‡ (ä¿ç•™ä½ çš„è®¾è®¡)
class ColorPalette {
  static primary: string = '#1A1A1A'
  static text_primary: string = '#2C3E50'
  static text_secondary: string = '#7F8C8D'
  static white: string = '#FFFFFF'
  static background: string = '#F5F7FA'
  static price: string = '#FF3B30'
}

@Entry
@Component
struct CartPage {
  @State cartItems: CartItem[] = []
  @State isLoading: boolean = true
  @State totalAmount: number = 0
  @State isAllSelected: boolean = false

  // âœ… ä½¿ç”¨ä½ ä¸Šä¼ æ–‡ä»¶ä¸­å®šä¹‰çš„ Service å®žä¾‹
  private cartService: CartService = CartService.getInstance()

  async aboutToAppear() {
    this.isLoading = true
    try {
      // âœ… æ ¸å¿ƒä¿®æ­£ï¼šå¿…é¡»å…ˆå¼‚æ­¥åˆå§‹åŒ– Serviceï¼Œå¦åˆ™å†…å­˜æ•°ç»„ä¸ºç©º
      await this.cartService.init()
      await this.refreshData()
    } catch (e) {
      console.error('è´­ç‰©è½¦åˆå§‹åŒ–å¤±è´¥')
    } finally {
      this.isLoading = false
    }
  }

  onPageShow() {
    this.refreshData()
  }

  private async refreshData() {
    // âœ… é€»è¾‘ä¿®æ­£ï¼šå¼ºåˆ¶ Service ä»Ž RDB æ•°æ®åº“é‡æ–°åŒæ­¥æ•°æ®
    await this.cartService.refreshCart()

    // èŽ·å– Service åŒæ­¥åŽçš„æ•°æ®
    this.cartItems = [...this.cartService.getCartItems()]
    this.totalAmount = this.cartService.getTotalAmount()

    // æ›´æ–°å…¨é€‰çŠ¶æ€
    const selectedItems = this.cartService.getSelectedItems()
    this.isAllSelected = this.cartItems.length > 0 && selectedItems.length === this.cartItems.length
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª (ä¿ç•™åŽŸ UI)
      Row() {
        Button('â†').fontSize(24).fontColor(ColorPalette.text_primary).backgroundColor(Color.Transparent)
          .onClick(() => router.back())
        Text('è´­ç‰©è½¦').fontSize(20).fontWeight(FontWeight.Medium).layoutWeight(1).textAlign(TextAlign.Center)
        Blank().width(60)
      }.width('100%').height(56).padding({ left: 16, right: 16 }).backgroundColor(ColorPalette.white)

      if (this.isLoading) {
        LoadingProgress().width(40).height(40).margin({ top: 100 })
      } else if (this.cartItems.length === 0) {
        // ç©ºçŠ¶æ€ (ä¿ç•™åŽŸ UI)
        Column() {
          Text('ðŸ›’').fontSize(80).margin({ bottom: 20 })
          Text('è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ').fontSize(16).fontColor(ColorPalette.text_secondary)
          Button('åŽ»é€›é€›').margin({ top: 20 }).backgroundColor(ColorPalette.primary)
            .onClick(() => router.back())
        }.width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column() {
            ForEach(this.cartItems, (item: CartItem) => {
              Row() {
                // âœ… è¡¥å…¨ï¼šå¤é€‰æ¡†é€»è¾‘
                Toggle({ type: ToggleType.Checkbox, isOn: item.selected })
                  .selectedColor(ColorPalette.primary)
                  .onChange(async () => {
                    await this.cartService.toggleSelected(item.id)
                    this.refreshData()
                  })

                Image(item.product.image).width(90).height(90).borderRadius(8).margin({ left: 12, right: 12 })

                Column() {
                  Text(item.product.name).fontSize(15).maxLines(2).fontColor(ColorPalette.text_primary)

                  // âœ… ä¿®æ­£ï¼šCartItem æ²¡å®šä¹‰ specï¼Œè¯»å– product é‡Œçš„å±žæ€§
                  Text(`è§„æ ¼: ${item.product.spec || 'æ ‡å‡†ç‰ˆ'}`).fontSize(12).fontColor(ColorPalette.text_secondary).margin({ top: 4 })

                  Row() {
                    Text(`Â¥${item.product.price}`).fontSize(18).fontWeight(FontWeight.Bold).fontColor(ColorPalette.price)
                    Blank()
                    // âœ… ä¿®æ­£ï¼šåŠ å‡å·é¢œè‰²å¢žå¼º
                    Row() {
                      Button('-').width(28).height(24).backgroundColor('#F0F0F0').fontColor('#333')
                        .onClick(async () => {
                          if (item.quantity > 1) {
                            await this.cartService.updateQuantity(item.id, item.quantity - 1)
                            this.refreshData()
                          }
                        })
                      Text(`${item.quantity}`).width(30).textAlign(TextAlign.Center).fontSize(14)
                      Button('+').width(28).height(24).backgroundColor('#F0F0F0').fontColor('#333')
                        .onClick(async () => {
                          await this.cartService.updateQuantity(item.id, item.quantity + 1)
                          this.refreshData()
                        })
                    }
                  }.width('100%').margin({ top: 8 })
                }.layoutWeight(1).alignItems(HorizontalAlign.Start)
              }
              .padding(16).backgroundColor(ColorPalette.white).borderRadius(12).margin({ bottom: 12, left: 16, right: 16 })
            })
          }.padding({ top: 16, bottom: 100 })
        }.layoutWeight(1).backgroundColor(ColorPalette.background)

        // åº•æ 
        Row() {
          Toggle({ type: ToggleType.Checkbox, isOn: this.isAllSelected }).onChange(() => {
            this.cartService.toggleAllSelected(!this.isAllSelected) // âœ… ä½¿ç”¨å…¼å®¹æ–¹æ³•
            this.refreshData()
          })
          Text('å…¨é€‰').fontSize(14).margin({ left: 8 })
          Blank()
          Text(`åˆè®¡: Â¥${this.totalAmount.toFixed(2)}`).fontSize(18).fontWeight(FontWeight.Bold).fontColor(ColorPalette.price)
          Button('ç»“ç®—').width(100).height(40).backgroundColor(ColorPalette.primary).margin({ left: 16 }).borderRadius(20)
            .onClick(() => { if(this.totalAmount > 0) router.pushUrl({ url: 'pages/OrderConfirmPage' }) })
        }.width('100%').padding(16).backgroundColor(ColorPalette.white).shadow({ radius: 8, color: '#10000000', offsetY: -4 })
      }
    }.width('100%').height('100%').backgroundColor(ColorPalette.background)
  }
}