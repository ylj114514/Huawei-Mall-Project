import router from '@ohos.router'
import { CartItem } from '../model/DataModel'
import { CartService } from '../services/CartService'

@Entry
@Component
struct CartPage {
  @State cartItems: CartItem[] = []
  @State allSelected: boolean = false
  @State totalAmount: number = 0
  @State selectedCount: number = 0
  @State isLoading: boolean = true
  @State editingMode: boolean = false
  @State refreshing: boolean = false
  private cartService: CartService = CartService.getInstance()

  aboutToAppear() {
    this.loadCartData()
  }

  loadCartData() {
    try {
      this.isLoading = true
      this.cartItems = this.cartService.getCartItems()
      this.updateSummary()
      this.isLoading = false
    } catch (error) {
      console.error('åŠ è½½è´­ç‰©è½¦æ•°æ®å¤±è´¥:', error)
      this.isLoading = false
    }
  }

  private updateSummary() {
    this.allSelected = this.cartItems.length > 0 && this.cartItems.every(item => item.selected)
    this.selectedCount = this.cartService.getSelectedCount()
    this.totalAmount = this.cartService.getSelectedTotal()
  }

  // åˆ‡æ¢å•†å“é€‰ä¸­çŠ¶æ€
  toggleItemSelection(item: CartItem) {
    this.cartService.toggleSelected(item.id)
    this.cartItems = this.cartService.getCartItems()
    this.updateSummary()
  }

  // å…¨é€‰/å…¨ä¸é€‰
  toggleAllSelection() {
    this.cartService.toggleAllSelected(!this.allSelected)
    this.cartItems = this.cartService.getCartItems()
    this.updateSummary()
  }

  // æ›´æ–°å•†å“æ•°é‡
  async updateItemQuantity(item: CartItem, quantity: number) {
    try {
      const success = await this.cartService.updateQuantity(item.id, quantity)
      if (success) {
        this.cartItems = this.cartService.getCartItems()
        this.updateSummary()
      } else {
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        console.error('æ›´æ–°æ•°é‡å¤±è´¥ï¼Œå¯èƒ½åº“å­˜ä¸è¶³')
      }
    } catch (error) {
      console.error('æ›´æ–°æ•°é‡å¤±è´¥:', error)
    }
  }

  // åˆ é™¤å•†å“
  removeItem(item: CartItem) {
    // è¿™é‡Œå¯ä»¥æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
    this.cartService.removeFromCart(item.id)
    this.cartItems = this.cartService.getCartItems()
    this.updateSummary()
  }

  // æ‰¹é‡åˆ é™¤é€‰ä¸­å•†å“
  removeSelectedItems() {
    // è¿™é‡Œå¯ä»¥æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
    for (const item of this.cartItems) {
      if (item.selected) {
        this.cartService.removeFromCart(item.id)
      }
    }
    this.cartItems = this.cartService.getCartItems()
    this.updateSummary()
  }

  // æ¸…ç©ºè´­ç‰©è½¦
  clearCart() {
    this.cartService.clearCart()
    this.cartItems = []
    this.updateSummary()
  }

  // ç»“ç®—
  checkout() {
    if (!this.cartService.hasSelectedItems()) {
      console.error('è¯·é€‰æ‹©è¦ç»“ç®—çš„å•†å“')
      return
    }

    try {
      // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°ç»“ç®—é¡µé¢
      console.log('ç»“ç®—å•†å“æ•°é‡:', this.selectedCount)
      console.log('ç»“ç®—æ€»é‡‘é¢:', this.totalAmount)

      // æ¸…ç©ºé€‰ä¸­çš„å•†å“
      this.cartService.clearSelected()
      this.cartItems = this.cartService.getCartItems()
      this.updateSummary()

      console.log('ç»“ç®—æˆåŠŸ')
    } catch (error) {
      console.error('ç»“ç®—å¤±è´¥:', error)
    }
  }

  // åˆ·æ–°è´­ç‰©è½¦
  refresh() {
    this.refreshing = true
    this.cartItems = this.cartService.getCartItems()
    this.updateSummary()
    setTimeout(() => {
      this.refreshing = false
    }, 1000)
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â†')
          .width(40)
          .height(40)
          .backgroundColor(Color.Transparent)
          .fontColor($r('app.color.text_primary'))
          .onClick(() => {
            router.back()
          })

        Text('è´­ç‰©è½¦')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        if (this.cartItems.length > 0) {
          Button('ç¼–è¾‘')
            .height(40)
            .backgroundColor(Color.Transparent)
            .fontColor($r('app.color.primary'))
            .onClick(() => {
              this.editingMode = !this.editingMode
            })
        } else {
          Blank().width(40)
        }
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
      .backgroundColor($r('app.color.white'))

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½è´­ç‰©è½¦ä¸­...')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.cartItems.length === 0) {
        // ç©ºè´­ç‰©è½¦çŠ¶æ€
        Column() {
          Text('ðŸ›’')
            .fontSize(80)
            .margin({ bottom: 24 })
          Text('è´­ç‰©è½¦æ˜¯ç©ºçš„')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_secondary'))
            .margin({ bottom: 12 })
          Text('å¿«åŽ»æŒ‘é€‰å¿ƒä»ªçš„å•†å“å§')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ bottom: 32 })

          Button('åŽ»è´­ç‰©')
            .height(44)
            .padding({ left: 32, right: 32 })
            .backgroundColor($r('app.color.primary'))
            .onClick(() => {
              router.replaceUrl({ url: 'pages/Index' })
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        // è´­ç‰©è½¦å•†å“åˆ—è¡¨
        List() {
          ForEach(this.cartItems, (item: CartItem) => {
            ListItem() {
              Row() {
                // é€‰æ‹©æ¡†
                Button() {
                  Circle({ width: 20, height: 20 })
                    .fill(item.selected ? $r('app.color.primary') : Color.Transparent)
                    .stroke(item.selected ? Color.Transparent : $r('app.color.text_secondary'))
                    .strokeWidth(2)
                    .margin({ right: 12 })
                }
                .backgroundColor(Color.Transparent)
                .onClick(() => this.toggleItemSelection(item))

                // å•†å“å›¾ç‰‡
                Image(item.product.image)
                  .width(80)
                  .height(80)
                  .borderRadius(8)
                  .objectFit(ImageFit.Cover)
                  .backgroundColor($r('app.color.background'))
                  .margin({ right: 12 })

                // å•†å“ä¿¡æ¯
                Column() {
                  Text(item.product.name)
                    .fontSize(14)
                    .fontWeight(FontWeight.Medium)
                    .fontColor($r('app.color.text_primary'))
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .width('100%')

                  Text(item.product.spec)
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary'))
                    .margin({ top: 4 })

                  Row() {
                    Text(`Â¥${item.product.price}`)
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .fontColor($r('app.color.price'))

                    if (item.product.originalPrice > item.product.price) {
                      Text(`Â¥${item.product.originalPrice}`)
                        .fontSize(12)
                        .fontColor($r('app.color.text_secondary'))
                        .decoration({ type: TextDecorationType.LineThrough })
                        .margin({ left: 8 })
                    }
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.Start)
                  .alignItems(VerticalAlign.Bottom)
                  .margin({ top: 8 })
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)

                // æ•°é‡é€‰æ‹©å™¨
                if (!this.editingMode) {
                  Column() {
                    Row() {
                      Button('-')
                        .width(28)
                        .height(28)
                        .fontSize(14)
                        .backgroundColor($r('app.color.background'))
                        .fontColor(item.quantity > 1 ? $r('app.color.text_primary') : $r('app.color.text_secondary'))
                        .enabled(item.quantity > 1)
                        .onClick(() => this.updateItemQuantity(item, item.quantity - 1))

                      Text(item.quantity.toString())
                        .fontSize(14)
                        .fontColor($r('app.color.text_primary'))
                        .width(32)
                        .textAlign(TextAlign.Center)

                      Button('+')
                        .width(28)
                        .height(28)
                        .fontSize(14)
                        .backgroundColor($r('app.color.background'))
                        .fontColor(item.quantity < item.product.stock ? $r('app.color.text_primary') : $r('app.color.text_secondary'))
                        .enabled(item.quantity < item.product.stock)
                        .onClick(() => this.updateItemQuantity(item, item.quantity + 1))
                    }
                    .margin({ top: 8 })
                  }

                  // åˆ é™¤æŒ‰é’®
                  if (this.editingMode) {
                    Button('åˆ é™¤')
                      .height(32)
                      .fontSize(12)
                      .backgroundColor($r('app.color.error'))
                      .fontColor(Color.White)
                      .margin({ top: 8 })
                      .onClick(() => this.removeItem(item))
                  }
                }
              }
              .width('100%')
              .padding(16)
              .backgroundColor($r('app.color.white'))
              .borderRadius(8)
              .margin({ left: 16, right: 16, bottom: 8 })
            }
          })
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor($r('app.color.background'))

        // åº•éƒ¨æ“ä½œæ 
        Column() {
          // å…¨é€‰å’Œåˆ é™¤
          Row() {
            Button() {
              Row() {
                Circle({ width: 20, height: 20 })
                  .fill(this.allSelected ? $r('app.color.primary') : Color.Transparent)
                  .stroke(this.allSelected ? Color.Transparent : $r('app.color.text_secondary'))
                  .strokeWidth(2)
                  .margin({ right: 8 })
                Text('å…¨é€‰')
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
              }
            }
            .backgroundColor(Color.Transparent)
            .onClick(() => this.toggleAllSelection())

            Blank()

            if (this.editingMode) {
              Button('åˆ é™¤é€‰ä¸­')
                .height(36)
                .fontSize(14)
                .backgroundColor($r('app.color.error'))
                .enabled(this.selectedCount > 0)
                .onClick(() => this.removeSelectedItems())
            } else {
              Column() {
                Row() {
                  Text(`åˆè®¡: `)
                    .fontSize(14)
                    .fontColor($r('app.color.text_secondary'))
                  Text(`Â¥${this.totalAmount.toFixed(2)}`)
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor($r('app.color.price'))
                }
                Text(`å·²é€‰${this.selectedCount}ä»¶å•†å“`)
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
              .alignItems(HorizontalAlign.End)

              Button('ç»“ç®—')
                .height(44)
                .fontSize(16)
                .backgroundColor($r('app.color.primary'))
                .padding({ left: 24, right: 24 })
                .margin({ left: 16 })
                .enabled(this.selectedCount > 0)
                .onClick(() => this.checkout())
            }
          }
          .width('100%')
          .height(60)
          .padding({ left: 16, right: 16 })
          .backgroundColor($r('app.color.white'))
          .shadow({
            radius: 4,
            color: '#1A000000',
            offsetX: 0,
            offsetY: -2
          })
          .justifyContent(FlexAlign.SpaceBetween)
          .alignItems(VerticalAlign.Center)
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }
}