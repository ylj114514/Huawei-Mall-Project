import router from '@ohos.router'
import { CartService } from '../services/CartService' // âœ… æ¢æˆ Service
import { CartItem } from '../model/DataModel' // âœ… æ¢æˆç»Ÿä¸€ Model
// import { ProductModel } from '../model/ProductModel'

// é¢œè‰²å¸¸é‡ (ä¿ç•™ä½ çš„è®¾è®¡)
class ColorPalette {
  static primary: string = '#1A1A1A'
  static text_primary: string = '#2C3E50'
  static text_secondary: string = '#7F8C8D'
  static white: string = '#FFFFFF'
  static background: string = '#F5F7FA'
  static price: string = '#FF3B30'
  static error: string = '#E74C3C'
}

@Entry
@Component
struct CartPage {
  @State cartItems: CartItem[] = []
  @State isLoading: boolean = true
  @State totalAmount: number = 0

  // âœ… è·å– Service å®ä¾‹
  private cartService: CartService = CartService.getInstance()

  // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°ï¼Œä¿è¯æ•°æ®æœ€æ–°
  onPageShow() {
    this.refreshData()
  }

  // âœ… æ ¸å¿ƒä¿®æ”¹ï¼šä» Service æ‹‰å–æ•°æ®
  private async refreshData() {
    this.isLoading = true
    try {
      await this.cartService.refreshCart()
      this.cartItems = this.cartService.getCartItems()
      this.calculateTotal()
    } catch (error) {
      console.error('åŠ è½½è´­ç‰©è½¦å¤±è´¥:', error)
    } finally {
      this.isLoading = false
    }
  }

  private calculateTotal() {
    // ç®€å•è®¡ç®—ï¼šé€‰ä¸­å•†å“çš„æ€»ä»· (å¦‚æœæ²¡æœ‰é€‰ä¸­çŠ¶æ€ï¼Œå°±è®¡ç®—å…¨éƒ¨)
    // ä½ çš„ Service é‡Œå¯èƒ½æœ‰ getSelectedItemsï¼Œè¿™é‡Œç®€å•ç´¯åŠ 
    this.totalAmount = this.cartItems.reduce((sum, item) => {
      // å‡è®¾ item.selected ä¸º true æ‰ç®—ï¼Œæˆ–è€…å…¨ç®—
      return sum + (item.product.price * item.quantity)
    }, 0)
  }

  private async updateQuantity(item: CartItem, newQuantity: number) {
    if (newQuantity <= 0) return
    await this.cartService.updateQuantity(item.id, newQuantity)
    this.refreshData() // åˆ·æ–° UI
  }

  private async removeItem(item: CartItem) {
    await this.cartService.removeFromCart(item.id)
    this.refreshData()
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ  (ä¿ç•™)
      Row() {
        Button() {
          Text('â†').fontSize(24).fontColor(ColorPalette.text_primary)
        }
        .width(60).height(48).backgroundColor(Color.Transparent)
        .onClick(() => router.back())

        Text('è´­ç‰©è½¦')
          .fontSize(20).fontWeight(FontWeight.Medium).fontColor(ColorPalette.text_primary)
          .layoutWeight(1).textAlign(TextAlign.Center)

        Text('ç®¡ç†').fontSize(16).fontColor(ColorPalette.primary).width(60).textAlign(TextAlign.End)
          .visibility(this.cartItems.length > 0 ? Visibility.Visible : Visibility.Hidden)
      }
      .width('100%').padding({ left: 16, right: 16 }).height(56).backgroundColor(ColorPalette.white)

      if (this.isLoading) {
        Column() {
          LoadingProgress().width(40).height(40)
          Text('åŠ è½½ä¸­...').fontSize(14).fontColor(ColorPalette.text_secondary).margin({ top: 16 })
        }.width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else if (this.cartItems.length === 0) {
        // ç©ºçŠ¶æ€ (ä¿ç•™)
        Column() {
          Text('ğŸ›’').fontSize(80).margin({ bottom: 24 })
          Text('è´­ç‰©è½¦æ˜¯ç©ºçš„').fontSize(18).fontWeight(FontWeight.Medium).fontColor(ColorPalette.text_secondary).margin({ bottom: 12 })
          Button('å»è´­ç‰©').fontSize(16).fontColor(Color.White).backgroundColor(ColorPalette.primary)
            .padding({ left: 32, right: 32, top: 12, bottom: 12 }).borderRadius(24)
            .onClick(() => router.back())
        }.width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).backgroundColor(ColorPalette.background)
      } else {
        // åˆ—è¡¨ (ä¿ç•™æ ·å¼)
        Scroll() {
          Column() {
            ForEach(this.cartItems, (item: CartItem) => {
              Row() {
                // å›¾ç‰‡
                Image(item.product.image).width(100).height(100).borderRadius(8).objectFit(ImageFit.Contain)
                  .backgroundColor('#F8F9FA').margin({ right: 16 })

                // ä¿¡æ¯
                Column() {
                  Text(item.product.name).fontSize(16).fontColor(ColorPalette.text_primary).maxLines(2).width('100%')
                  Text(`è§„æ ¼ï¼š${item.product.spec || 'æ ‡å‡†ç‰ˆ'}`).fontSize(14).fontColor(ColorPalette.text_secondary).margin({ top: 4 })
                  Row() {
                    Text(`Â¥${item.product.price}`).fontSize(18).fontWeight(FontWeight.Bold).fontColor(ColorPalette.price)
                  }
                  .width('100%').margin({ top: 8 })
                }
                .layoutWeight(1).alignItems(HorizontalAlign.Start)

                // æ“ä½œ
                Column() {
                  Row() {
                    Button('-').width(32).height(32).fontSize(16).backgroundColor('#F0F0F0')
                      .fontColor(item.quantity > 1 ? ColorPalette.text_primary : ColorPalette.text_secondary)
                      .enabled(item.quantity > 1)
                      .onClick(() => this.updateQuantity(item, item.quantity - 1))

                    Text(item.quantity.toString()).fontSize(16).fontColor(ColorPalette.text_primary).width(40).textAlign(TextAlign.Center)

                    Button('+').width(32).height(32).fontSize(16).backgroundColor('#F0F0F0').fontColor(ColorPalette.text_primary)
                      .onClick(() => this.updateQuantity(item, item.quantity + 1))
                  }
                  .margin({ bottom: 12 })

                  Button('åˆ é™¤').fontSize(12).fontColor(ColorPalette.error).backgroundColor(Color.Transparent)
                    .border({ width: 1, color: ColorPalette.error })
                    .onClick(() => this.removeItem(item))
                }
                .justifyContent(FlexAlign.SpaceBetween).height('100%')
              }
              .width('100%').padding(16).backgroundColor(ColorPalette.white).borderRadius(8)
              .margin({ left: 16, right: 16, bottom: 8 })
            })
          }
          .width('100%').padding({ top: 16, bottom: 120 })
        }
        .width('100%').layoutWeight(1).backgroundColor(ColorPalette.background)
      }

      // åº•æ  (ä¿ç•™)
      if (this.cartItems.length > 0) {
        Row() {
          Column() {
            Row() {
              Text('åˆè®¡ï¼š').fontSize(14).fontColor(ColorPalette.text_secondary)
              Text(`Â¥${this.totalAmount.toFixed(2)}`).fontSize(20).fontWeight(FontWeight.Bold).fontColor(ColorPalette.price)
            }
            Text(`å…±${this.cartItems.reduce((a,b)=>a+b.quantity,0)}ä»¶å•†å“`).fontSize(12).fontColor(ColorPalette.text_secondary).margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.End)

          Button('ç»“ç®—').fontSize(16).fontColor(Color.White).backgroundColor(ColorPalette.primary)
            .width(100).height(44).borderRadius(22).margin({ left: 20 })
            .onClick(() => {
              // ç»“ç®—é€»è¾‘
            })
        }
        .width('100%').padding({ left: 20, right: 20 }).height(80).backgroundColor(ColorPalette.white)
        .justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center)
        .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: -2 })
        .position({ x: 0, y: '100%' }).translate({ y: -80 })
      }
    }
    .width('100%').height('100%').backgroundColor(ColorPalette.background)
  }
}