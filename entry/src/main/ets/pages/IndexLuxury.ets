import router from '@ohos.router'
import { ProductModel, MockData } from '../model/ProductModel'
import { StorageManager } from '../utils/StorageManager'
import { User } from '../model/DataModel'
import { AuthGuard } from '../components/AuthGuard.ets'
import common from '@ohos.app.ability.common'

// å¥¢åé…è‰²æ–¹æ¡ˆ
interface ColorScheme {
  background: string
  primary: string
  accent: string
  secondary: string
  cardBg: string
  gold: string
  shadow: string
  overlay: string
}

const COLORS: ColorScheme = {
  background: '#FAFAFA',
  primary: '#000000',
  accent: '#CF0A2C',
  secondary: '#666666',
  cardBg: '#FFFFFF',
  gold: '#D4AF37',
  shadow: 'rgba(0, 0, 0, 0.08)',
  overlay: 'rgba(0, 0, 0, 0.04)'
}

@Entry
@Component
struct IndexLuxury {
  @State products: ProductModel[] = []
  @State filteredProducts: ProductModel[] = []
  @State searchText: string = ''
  @State selectedCategory: string = 'å…¨éƒ¨'
  @State isLoading: boolean = true
  @State scrollOffset: number = 0
  @State searchExpanded: boolean = false
  @State user: User | null = null
  @State cartCount: number = 0

  private categories: string[] = ['å…¨éƒ¨', 'æ‰‹æœº', 'å¹³æ¿', 'ç¬”è®°æœ¬', 'æ‰‹è¡¨', 'è€³æœº']
  private scroller: Scroller = new Scroller()
  private storage: StorageManager = StorageManager.getInstance()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  aboutToAppear() {
    this.initStorage()
    this.loadData()
    this.checkLoginStatus()
  }

  private async initStorage() {
    try {
      await this.storage.init(this.context)
      console.log('IndexLuxury: StorageManageråˆå§‹åŒ–æˆåŠŸ')
    } catch (error) {
      console.error('IndexLuxury: StorageManageråˆå§‹åŒ–å¤±è´¥:', error)
    }
  }

  private async loadData() {
    setTimeout(() => {
      this.products = MockData.generateProducts()
      this.filteredProducts = this.products
      this.isLoading = false
    }, 1200)
  }

  private async checkLoginStatus() {
    try {
      this.user = await this.storage.loadUser()
    } catch (error) {
      console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error)
    }
  }

  private onScroll(offset: number) {
    this.scrollOffset = offset
    this.searchExpanded = offset > 50
  }

  private onSearch(value: string) {
    this.searchText = value
    this.filterProducts()
  }

  private filterProducts() {
    let filtered = this.products

    if (this.selectedCategory !== 'å…¨éƒ¨') {
      filtered = filtered.filter(product =>
        product.category === this.selectedCategory
      )
    }

    if (this.searchText.trim()) {
      const query = this.searchText.toLowerCase()
      filtered = filtered.filter(product =>
        product.name.toLowerCase().includes(query) ||
        product.description.toLowerCase().includes(query)
      )
    }

    this.filteredProducts = filtered
  }

  private onCategorySelect(category: string) {
    this.selectedCategory = category
    this.filterProducts()
  }

  private onProductClick(product: ProductModel) {
    router.pushUrl({
      url: 'pages/ProductDetailComplete',
      params: {
        productId: product.id
      }
    })
  }

  @Builder
  FloatingSearchBar() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ å ä½
      Row().width('100%').height(44)

      // æµ®åŠ¨æœç´¢æ 
      Column() {
        Row() {
          // èœå•æŒ‰é’®
          Button() {
            Text('â˜°')
              .fontSize(24)
              .fontColor(COLORS.primary)
          }
          .width(48)
          .height(48)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            // ä¾§è¾¹èœå•é€»è¾‘
          })

          // æœç´¢æ¡†
          Row() {
            Text('ğŸ”')
              .fontSize(18)
              .fontColor(COLORS.secondary)
              .margin({ left: 16 })

            TextInput({
              placeholder: 'æ¢ç´¢åä¸ºç§‘æŠ€',
              text: this.searchText
            })
              .fontSize(16)
              .fontColor(COLORS.primary)
              .backgroundColor(Color.Transparent)
              .layoutWeight(1)
              .placeholderColor(COLORS.secondary)
              .margin({ left: 12 })
              .onChange((value: string) => {
                this.onSearch(value)
              })

            if (this.searchText) {
              Button() {
                Text('âœ•')
                  .fontSize(14)
                  .fontColor(COLORS.secondary)
              }
              .width(36)
              .height(36)
              .backgroundColor(Color.Transparent)
              .onClick(() => {
                this.searchText = ''
                this.onSearch('')
              })
            }
          }
          .width('100%')
          .height(48)
          .backgroundColor(COLORS.cardBg)
          .borderRadius(24)
          .shadow({
            radius: 20,
            color: COLORS.shadow,
            offsetX: 0,
            offsetY: 4
          })

          // é€šçŸ¥æŒ‰é’®
          Button() {
            Text('ğŸ””')
              .fontSize(20)
              .fontColor(COLORS.primary)
          }
          .width(48)
          .height(48)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            // é€šçŸ¥é€»è¾‘
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 20 })
      .backgroundColor(`rgba(250, 250, 250, ${this.searchExpanded ? 1 : 0.95})`)
      .backdropBlur(this.searchExpanded ? 20 : 10)
      .border({
        width: { bottom: this.searchExpanded ? 0.5 : 0 },
        color: 'rgba(0,0,0,0.08)'
      })
      .transition({ type: TransitionType.All })
    }
    .width('100%')
    .position({ x: 0, y: 0 })
    .zIndex(1000)
  }

  @Builder
  HeroSection() {
    Column() {
      // å“ç‰Œæ ‡è¯­
      Text('HUAWEI')
        .fontSize(48)
        .fontWeight(FontWeight.Bold)
        .fontColor(COLORS.primary)
        .letterSpacing(8)
        .margin({ bottom: 8 })

      Text('æ„å»ºä¸‡ç‰©äº’è”çš„æ™ºèƒ½ä¸–ç•Œ')
        .fontSize(18)
        .fontColor(COLORS.secondary)
        .margin({ bottom: 40 })

      // è½®æ’­å›¾
      Swiper() {
        ForEach([
          {
            title: 'Mate 60 Pro',
            subtitle: 'ç‹è€…å½’æ¥',
            desc: 'éº’éºŸèŠ¯ç‰‡ Â· å«æ˜Ÿé€šè¯',
            color: '#000000',
            bg: 'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/mkt/imgs/2024/01/mate-60-pro-list-kv.png'
          },
          {
            title: 'HarmonyOS',
            subtitle: 'æ–°ä¸€ä»£æ“ä½œç³»ç»Ÿ',
            desc: 'æµç•… Â· å®‰å…¨ Â· ä¸‡ç‰©äº’è”',
            color: '#CF0A2C',
            bg: 'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/mkt/imgs/2023/08/harmonyos-pc-kv.png'
          },
          {
            title: 'WATCH GT 4',
            subtitle: 'ä¸“ä¸šè¿åŠ¨å¥åº·',
            desc: 'ç»­èˆª14å¤© Â· ç²¾å‡†å®šä½',
            color: '#D4AF37',
            bg: 'https://consumer-img.huawei.com/content/dam/huawei-cbg-site/cn/mkt/imgs/2023/09/watch-gt4-kv.png'
          }
        ], (item: Record<string, string>) => {
          Stack() {
            // èƒŒæ™¯æ¸å˜
            Column()
              .width('100%')
              .height(400)
              .linearGradient({
                direction: GradientDirection.Bottom,
                colors: [
                  [item.color || COLORS.primary, 0.1],
                  ['#FFFFFF', 1]
                ]
              })

            Column() {
              Text(item.subtitle || '')
                .fontSize(16)
                .fontColor(item.color || COLORS.primary)
                .margin({ bottom: 8 })

              Text(item.title || '')
                .fontSize(42)
                .fontWeight(FontWeight.Bold)
                .fontColor(item.color || COLORS.primary)
                .margin({ bottom: 12 })

              Text(item.desc || '')
                .fontSize(16)
                .fontColor(COLORS.secondary)
                .lineHeight(24)
            }
            .width('100%')
            .padding(32)
            .alignItems(HorizontalAlign.Start)
          }
        })
      }
      .width('100%')
      .height(400)
      .autoPlay(true)
      .interval(4000)
      .indicatorStyle({
        size: 6,
        left: 32,
        bottom: 32,
        color: 'rgba(0,0,0,0.2)',
        selectedColor: COLORS.primary
      })
      .borderRadius(32)
      .margin({ left: 20, right: 20 })
      .shadow({
        radius: 30,
        color: COLORS.shadow,
        offsetX: 0,
        offsetY: 10
      })
    }
    .width('100%')
    .padding({ top: 100, bottom: 40 })
  }

  @Builder
  CategoryPills() {
    Column() {
      Row() {
        ForEach(this.categories, (category: string, index: number) => {
          Column() {
            Text(category)
              .fontSize(15)
              .fontWeight(this.selectedCategory === category ? FontWeight.Bold : FontWeight.Normal)
              .fontColor(this.selectedCategory === category ? Color.White : COLORS.primary)
              .padding({ left: 28, right: 28, top: 14, bottom: 14 })
          }
          .backgroundColor(this.selectedCategory === category ? COLORS.primary : COLORS.cardBg)
          .borderRadius(25)
          .shadow({
            radius: this.selectedCategory === category ? 15 : 8,
            color: COLORS.shadow,
            offsetX: 0,
            offsetY: this.selectedCategory === category ? 6 : 3
          })
          .transition({ type: TransitionType.All })
          .onClick(() => {
            this.onCategorySelect(category)
          })
          .margin({ left: index === 0 ? 0 : 12 })
        })
      }
      .width('100%')
      .padding({ left: 20, right: 20 })
      .justifyContent(FlexAlign.Start)
    }
    .width('100%')
    .margin({ bottom: 40 })
  }

  @Builder
  ProductCard(product: ProductModel) {
    Column() {
      // å›¾ç‰‡å®¹å™¨
      Stack() {
        // èƒŒæ™¯è£…é¥°
        Column()
          .width('100%')
          .height(240)
          .backgroundColor(COLORS.overlay)
          .borderRadius(24)
          .position({ x: 0, y: 8 })

        Image(product.image)
          .width('100%')
          .height(240)
          .objectFit(ImageFit.Contain)
          .backgroundColor('#FFFFFF')
          .borderRadius(24)
          .padding(20)

        // æ–°å“æ ‡ç­¾
        if (product.isNew) {
          Column() {
            Text('NEW')
              .fontSize(12)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .backgroundColor(COLORS.accent)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .borderRadius(12)
          }
          .position({ x: 16, y: 16 })
        }

        // æ”¶è—æŒ‰é’®
        Button() {
          Text('â™¡')
            .fontSize(24)
            .fontColor(COLORS.accent)
        }
        .width(44)
        .height(44)
        .backgroundColor('rgba(255,255,255,0.9)')
        .borderRadius(22)
        .position({ x: '100%', y: 16 })
        .translate({ x: -60, y: 0 })
        .shadow({
          radius: 12,
          color: COLORS.shadow,
          offsetX: 0,
          offsetY: 2
        })
      }
      .margin({ bottom: 20 })

      // äº§å“ä¿¡æ¯
      Column() {
        Text(product.name)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor(COLORS.primary)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .margin({ bottom: 8 })

        // æ ‡ç­¾
        Row() {
          if (product.tags && product.tags.length > 0) {
            ForEach(product.tags.slice(0, 2), (tag: string) => {
              Text(tag)
                .fontSize(12)
                .fontColor(COLORS.secondary)
                .backgroundColor(COLORS.overlay)
                .padding({ left: 10, right: 10, top: 5, bottom: 5 })
                .borderRadius(8)
                .margin({ right: 8 })
            })
          }
        }
        .width('100%')
        .margin({ bottom: 16 })

        // ä»·æ ¼åŒºåŸŸ
        Row() {
          Row() {
            Text('Â¥')
              .fontSize(16)
              .fontColor(COLORS.accent)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 4 })
            Text(`${product.price}`)
              .fontSize(28)
              .fontColor(COLORS.accent)
              .fontWeight(FontWeight.Bold)
          }
          .alignItems(VerticalAlign.Bottom)

          Blank()

          // è´­ä¹°æŒ‰é’®
          Button() {
            Text('è´­ä¹°')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(Color.White)
          }
          .width(80)
          .height(36)
          .backgroundColor(COLORS.primary)
          .borderRadius(18)
          .shadow({
            radius: 10,
            color: COLORS.shadow,
            offsetX: 0,
            offsetY: 3
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('100%')
      .padding(24)
    }
    .width('100%')
    .backgroundColor(COLORS.cardBg)
    .borderRadius(32)
    .shadow({
      radius: 20,
      color: COLORS.shadow,
      offsetX: 0,
      offsetY: 8
    })
    .onClick(() => {
      this.onProductClick(product)
    })
    .transition({ type: TransitionType.All })
  }

  @Builder
  ProductList() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('æ¢ç´¢äº§å“')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor(COLORS.primary)
        Blank()
        Text(`å…± ${this.filteredProducts.length} ä»¶`)
          .fontSize(16)
          .fontColor(COLORS.secondary)
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 32 })

      // äº§å“ç½‘æ ¼
      if (this.filteredProducts.length > 0) {
        Grid() {
          ForEach(this.filteredProducts, (product: ProductModel) => {
            GridItem() {
              this.ProductCard(product)
            }
          })
        }
        .columnsTemplate('1fr')
        .rowsGap(32)
        .padding({ left: 20, right: 20, bottom: 140 })
      } else {
        Column() {
          Text('æœªæ‰¾åˆ°ç›¸å…³äº§å“')
            .fontSize(18)
            .fontColor(COLORS.secondary)
            .margin({ top: 80 })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
  }

  @Builder
  BottomNavigation() {
    Row() {
      // é¦–é¡µ
      Column() {
        Text('ğŸ ')
          .fontSize(28)
          .margin({ bottom: 4 })
        Text('é¦–é¡µ')
          .fontSize(12)
          .fontColor(COLORS.primary)
          .fontWeight(FontWeight.Medium)
      }
      .width('33.33%')
      .height(70)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(COLORS.cardBg)

      // è´­ç‰©è½¦
      Column() {
        Stack() {
          Text('ğŸ›’')
            .fontSize(28)
            .margin({ bottom: 4 })

          if (this.cartCount > 0) {
            Text(`${this.cartCount}`)
              .fontSize(12)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
              .backgroundColor(COLORS.accent)
              .borderRadius(10)
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .position({ x: 16, y: -4 })
          }
        }
        Text('è´­ç‰©è½¦')
          .fontSize(12)
          .fontColor(COLORS.secondary)
          .fontWeight(FontWeight.Medium)
      }
      .width('33.33%')
      .height(70)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(COLORS.cardBg)
      .onClick(() => {
        router.pushUrl({ url: 'pages/CartPageNew' })
      })

      // æˆ‘çš„
      Column() {
        Text(this.user ? 'ğŸ‘¤' : 'ğŸ‘¤')
          .fontSize(28)
          .margin({ bottom: 4 })
        Text(this.user ? 'æˆ‘çš„' : 'ç™»å½•')
          .fontSize(12)
          .fontColor(COLORS.secondary)
          .fontWeight(FontWeight.Medium)
      }
      .width('33.33%')
      .height(70)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(COLORS.cardBg)
      .onClick(() => {
        if (!this.user) {
          router.pushUrl({ url: 'pages/LoginPage' })
        } else {
          router.pushUrl({ url: 'pages/UserCenterPage' })
        }
      })
    }
    .width('100%')
    .height(70)
    .backgroundColor(COLORS.cardBg)
    .border({
      width: { top: 0.5 },
      color: 'rgba(0,0,0,0.08)'
    })
    .position({ x: 0, y: '100%' })
    .translate({ x: 0, y: -70 })
    .shadow({
      radius: 20,
      color: COLORS.shadow,
      offsetX: 0,
      offsetY: -5
    })
  }

  build() {
    Column() {
      // ä¸»å†…å®¹
      Scroll(this.scroller) {
        Column() {
          // é¡¶éƒ¨å ä½
          Row().width('100%').height(120)

          // HeroåŒºåŸŸ
          this.HeroSection()

          // åˆ†ç±»é€‰æ‹©
          this.CategoryPills()

          // äº§å“åˆ—è¡¨
          this.ProductList()
        }
        .width('100%')
      }
      .width('100%')
      .height('100%')
      .backgroundColor(COLORS.background)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
      .onScroll((xOffset: number, yOffset: number) => {
        this.onScroll(yOffset)
      })

      // æµ®åŠ¨æœç´¢æ 
      this.FloatingSearchBar()

      // åº•éƒ¨å¯¼èˆª
      this.BottomNavigation()

      // åŠ è½½åŠ¨ç”»
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color(COLORS.primary)
          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor(COLORS.secondary)
            .margin({ top: 20 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor(COLORS.background)
        .zIndex(2000)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(COLORS.background)
  }
}